# 分层会话交互协议

> 版本: 1.0
> 创建: 2025-12-25
> 状态: 实验中

---

## 1. 架构概述

```
┌─────────────────────────────────────────────────────┐
│  高层会话 (Strategic)                                │
│  - 持有整体计划和进度状态                             │
│  - 决定"下一步做什么"                                │
│  - 汇总执行结果，更新状态                             │
└──────────────────────┬──────────────────────────────┘
                       │ 通过文件交换
                       ▼
┌─────────────────────────────────────────────────────┐
│  执行会话 (Tactical)                                 │
│  - 读取任务描述                                      │
│  - 执行具体工作（畅谈会/核查/起草）                    │
│  - 输出结果到文件                                    │
└─────────────────────────────────────────────────────┘
```

## 2. 文件约定

| 文件 | 方向 | 用途 |
|------|------|------|
| `current-task.md` | 高层 → 执行 | 当前任务描述 |
| `task-result.md` | 执行 → 高层 | 任务执行结果 |
| `session-state.md` | 高层维护 | 会话状态快照 |

## 3. 任务描述格式 (current-task.md)

```markdown
# 任务: <简短标题>

## 元信息
- **任务 ID**: T-YYYYMMDD-NN
- **类型**: 畅谈会 | 核查 | 起草 | 实施
- **优先级**: P0 | P1 | P2

## 背景
<为什么需要这个任务>

## 目标
<期望的产出>

## 输入文件
- `path/to/file1.md` — 说明
- `path/to/file2.md` — 说明

## 约束
- <时间/范围/质量约束>

## 完成标准
- [ ] 标准 1
- [ ] 标准 2
```

## 4. 结果报告格式 (task-result.md)

```markdown
# 任务结果: <任务标题>

## 元信息
- **任务 ID**: T-YYYYMMDD-NN
- **状态**: ✅ 完成 | ⚠️ 部分完成 | ❌ 失败
- **执行时间**: HH:MM

## 产出摘要
<关键产出的简要描述>

## 详细产出
| 产出 | 位置 | 说明 |
|------|------|------|
| ... | ... | ... |

## 发现的问题
| 问题 | 严重度 | 建议处理 |
|------|--------|----------|
| ... | ... | ... |

## 后续建议
- <建议 1>
- <建议 2>
```

## 5. 会话状态格式 (session-state.md)

```markdown
# 会话状态快照

> 最后更新: YYYY-MM-DD HH:MM

## 今日目标
- [ ] 目标 1
- [ ] 目标 2

## 已完成任务
| ID | 标题 | 状态 | 产出 |
|----|------|------|------|
| T-01 | ... | ✅ | ... |

## 当前任务
- **ID**: T-XX
- **状态**: 进行中
- **预计完成**: HH:MM

## 待执行任务队列
1. 任务描述 1
2. 任务描述 2

## 阻塞项
- <如有>
```

## 6. 工作流程

### 高层会话职责
1. 维护 `session-state.md`
2. 编写 `current-task.md`
3. 读取 `task-result.md` 并汇总
4. 决定下一个任务

### 执行会话职责
1. 读取 `current-task.md`
2. 执行任务（可调用 runSubagent）
3. 写入 `task-result.md`
4. 不需要维护全局状态

### 监护人职责
1. 在两个会话之间切换
2. 确认任务交接（可选）
3. 处理需要会话外资源的请求
