# Snippet Variable Resolver (P2) Implementation Result

> **Date**: 2025-12-02  
> **Author**: Porter-CS  
> **Task**: Snippet Variable Resolver (P2 功能)  
> **Changefeed Anchor**: `#delta-2025-12-02-snippet-p2-variables`

## 实现摘要

实现了 Snippet Variable Resolver 框架，支持 `${VAR}` 和 `${VAR:default}` 语法解析。包含三个基础 resolver：`SelectionVariableResolver`（SELECTION, TM_SELECTED_TEXT）、`ModelVariableResolver`（TM_FILENAME）、以及 `FallbackVariableResolver`（unknown 变量静默返回空字符串）。添加 `CompositeVariableResolver` 支持多 resolver 组合。

## 文件变更

### 新增文件

- `src/TextBuffer/Cursor/SnippetVariableResolver.cs` (225 行) — Variable Resolver 接口和实现
  - `ISnippetVariableResolver` 接口
  - `CompositeVariableResolver` — 组合多个 resolver
  - `SelectionVariableResolver` — SELECTION, TM_SELECTED_TEXT
  - `ModelVariableResolver` — TM_FILENAME
  - `FallbackVariableResolver` — unknown 变量返回空字符串
  - `KnownSnippetVariableNames` — 已知变量名常量

### 修改文件

- `src/TextBuffer/Cursor/SnippetSession.cs`
  - 添加 `VariableResolver` 属性到 `SnippetInsertOptions`
  - 新增 `ResolveVariables()` 方法处理变量解析
  - 新增正则表达式 `s_variableSimplePattern` 和 `s_variableWithDefaultPattern`
  - 变量解析在 whitespace adjustment 之前执行

- `tests/TextBuffer.Tests/SnippetControllerTests.cs`
  - 新增 24 个 Variable Resolver 测试
  - 覆盖 SELECTION、TM_FILENAME、default value、composite resolver 场景

## TS 对齐说明

| TS 元素 | C# 实现 | 备注 |
|---------|---------|------|
| `VariableResolver` 接口 | `ISnippetVariableResolver` | 简化为单参数 `Resolve(string)` |
| `CompositeSnippetVariableResolver` | `CompositeVariableResolver` | 支持 params array 和 IEnumerable |
| `SelectionBasedVariableResolver` | `SelectionVariableResolver` | 仅支持 SELECTION/TM_SELECTED_TEXT |
| `ModelBasedVariableResolver` | `ModelVariableResolver` | 仅支持 TM_FILENAME |
| Unknown variable fallback | `FallbackVariableResolver` | 静默返回空字符串 |
| `${VAR}` 语法 | `s_variableSimplePattern` | 匹配大写变量名 |
| `${VAR:default}` 语法 | `s_variableWithDefaultPattern` | 支持默认值 |

## 测试结果

### Targeted 测试
```bash
export PIECETREE_DEBUG=0 && dotnet test --filter SnippetControllerTests --nologo
# Passed: 76, Skipped: 4, Total: 80
```

### Full 测试
```bash
export PIECETREE_DEBUG=0 && dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj --nologo
# Passed: 873, Skipped: 9, Total: 882 (≈100s)
```

## 新增测试用例

| 测试名 | 描述 |
|--------|------|
| `VariableResolver_SelectionVariable_ResolvesSelectedText` | SELECTION 解析选中文本 |
| `VariableResolver_SelectionVariable_EmptySelection` | 空选区返回空字符串 |
| `VariableResolver_SelectionVariable_ReturnsNullForUnknown` | 未知变量返回 null |
| `VariableResolver_ModelVariable_TmFilename` | TM_FILENAME 解析文件名 |
| `VariableResolver_ModelVariable_NullFilename` | 无文件名返回空字符串 |
| `VariableResolver_ModelVariable_ReturnsNullForUnknown` | 未知变量返回 null |
| `VariableResolver_Composite_FirstMatchWins` | 组合 resolver 返回首个匹配 |
| `VariableResolver_Composite_FallsThrough` | 组合 resolver 穿透 |
| `VariableResolver_Fallback_ReturnsEmptyString` | Fallback 返回空字符串 |
| `SnippetInsert_WithVariableResolver_ResolvesVariables` | 集成测试：变量解析 |
| `SnippetInsert_WithCompositeResolver` | 集成测试：组合 resolver |
| `SnippetInsert_UnknownVariable_ExpandsToEmpty` | 未知变量展开为空 |
| `SnippetInsert_VariableWithDefault_UsesDefaultWhenNotResolved` | 默认值使用 |
| `SnippetInsert_VariableWithDefault_UsesResolvedValue` | 解析值优先于默认值 |
| `SnippetInsert_VariableWithDefault_UsesDefaultForEmptySelection` | 空选区使用默认值 |
| `SnippetInsert_MultipleVariables` | 多变量解析 |
| `SnippetInsert_VariablesAndPlaceholders_Mixed` | 变量和占位符混合 |
| `SnippetInsert_SelectionVariable_WithActualSelection` | 实际选区解析 |
| `SnippetInsert_VariableExpansion` (Theory) | 变量展开边界测试 |
| `KnownSnippetVariableNames_IsKnown` | 已知变量名检查 |

## 已知差异

1. **简化的变量集合**：TS 支持 30+ 变量，C# 仅实现 SELECTION、TM_SELECTED_TEXT、TM_FILENAME
2. **无 Variable 类 AST**：TS 有完整的 Variable AST 节点，C# 使用正则表达式直接解析
3. **无多行选区缩进调整**：TS `SelectionBasedVariableResolver` 对多行选区有缩进调整逻辑，C# 未实现

## 遗留问题

1. **P3 变量扩展**：TM_FILENAME_BASE、TM_DIRECTORY、TM_FILEPATH 等变量
2. **P3 Selection 扩展**：TM_CURRENT_LINE、TM_CURRENT_WORD、TM_LINE_INDEX、TM_LINE_NUMBER
3. **P3 Cursor 变量**：CURSOR_INDEX、CURSOR_NUMBER（多光标场景）

## API 使用示例

```csharp
// 创建 resolver
var selResolver = new SelectionVariableResolver(model, selectionStart, selectionEnd);
var modelResolver = new ModelVariableResolver("MyClass.cs");
var composite = new CompositeVariableResolver(selResolver, modelResolver, FallbackVariableResolver.Instance);

// 使用 resolver
var options = new SnippetInsertOptions { VariableResolver = composite };
controller.InsertSnippetAt(position, "// ${TM_FILENAME}\n${SELECTION:default}", options);
```

## 相关锚点

- `#delta-2025-12-02-snippet-p1` — Snippet P0-P1 实现
- `#delta-2025-12-02-snippet-p1.5` — Placeholder Grouping
- `#delta-2025-11-26-aa4-cl7-cursor-core` — Cursor/Snippet backlog
- `agent-team/handoffs/INV-Snippet-Downgrade.md` — P2 优先级定义

---

*Generated by Porter-CS, 2025-12-02*
