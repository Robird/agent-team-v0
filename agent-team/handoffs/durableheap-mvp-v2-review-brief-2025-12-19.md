# å†³ç­–æ‘˜è¦ï¼šDurableHeap MVP v2 è®¾è®¡å®¡é˜…

> **æ—¥æœŸ**ï¼š2025-12-19 ~ 2025-12-20ï¼ˆå«ç›‘æŠ¤äººåé¦ˆè½®ï¼‰
> **æ¥æº**ï¼šç§˜å¯†åŸºåœ°ç•…è°ˆä¼šï¼ˆä¸‰ä½ DocUI Specialist å‚ä¸ï¼‰
> **æ–‡æ¡£**ï¼š`DurableHeap/docs/mvp-design-v2.md`

---

## èƒŒæ™¯ï¼ˆ2-3å¥ï¼‰

DurableHeap æ˜¯ä¸€ä¸ªå´©æºƒå¯æ¢å¤çš„å¯¹è±¡å›¾æŒä¹…åŒ–æ¡†æ¶ï¼ŒMVP æ–‡æ¡£å·²æ¥è¿‘"å¯å¼€å·¥è§„æ ¼"ã€‚æœ¬æ¬¡å®¡é˜…ç”±ä¸‰ä½ DocUI Specialistï¼ˆClaude/Gemini/GPTï¼‰ä»æ¦‚å¿µæ¡†æ¶ã€UX è®¾è®¡ã€è§„èŒƒå®¡è®¡ä¸‰ä¸ªè§†è§’è¿›è¡Œï¼Œç›®æ ‡æ˜¯ç¡®ä¿æ–‡æ¡£è‡ªæ´½ã€ä¸€è‡´ã€ç®€æ´ã€‚ç»è¿‡å››è½®è®¨è®ºï¼ˆå«ç›‘æŠ¤äººåé¦ˆè½®ï¼‰ï¼Œå·²è¾¾æˆæœ€ç»ˆå…±è¯†ã€‚

---

## é—®é¢˜æ¸…å•

### P0 é—®é¢˜ï¼ˆå¿…é¡»åœ¨å¼€å·¥å‰è§£å†³ï¼‰

| # | é—®é¢˜ | ä¸¥é‡åº¦ | æœ€ç»ˆæ–¹æ¡ˆ |
|---|------|--------|----------|
| 1 | `_isDirty` è¯­ä¹‰ä¸å®ç° | ğŸ”´ é«˜ | è¯­ä¹‰ä¸º"è¯­ä¹‰å·®å¼‚"ï¼›**å®ç°ç”¨ `ISet<ulong> _dirtyKeys`**ï¼ˆç›‘æŠ¤äººå»ºè®®é‡‡çº³ï¼‰ |
| 2 | Magic å“¨å…µç»“æ„ | ğŸ”´ é«˜ | **Magic ä¸ Record å¹¶åˆ—ï¼Œä½œä¸º Separator**ï¼ˆç›‘æŠ¤äººå»ºè®®é‡‡çº³ï¼‰ |
| 3 | `DataTail` æ˜¯å¦åŒ…å«å°¾å“¨å…µ | ğŸ”´ é«˜ | æ˜ç¡® `DataTail = EOF`ï¼ˆåŒ…å«å°¾ Magicï¼‰ |
| 4 | Value ç±»å‹ä¸ç¼–ç è¡¨ä¸ä¸€è‡´ | ğŸ”´ é«˜ | MVP æ”¶æ•›åˆ° null/varint/ObjRef/Ptr64ï¼›ç§»å‡º float/double/bool |
| 5 | `WritePendingDiff=false` æ—¶å¯¹è±¡å¡ä½ | ğŸ”´ é«˜ | ç”± #1 è§£å†³ï¼ˆ`_dirtyKeys` ä¸ºç©ºæ—¶ `HasChanges=false`ï¼‰ |
| 6 | `Commit(rootId)` çš„ Scoped Commit è¯¯è§£ | ğŸ”´ é«˜ | æ”¹åä¸º `CommitAll(newRootId: id)` |
| 7 | é¦–æ¬¡ commit / æ–°å»ºå¯¹è±¡è¯­ä¹‰æœªæ˜ç¡® | ğŸ”´ é«˜ | ç©ºä»“åº“ `Epoch=0`ï¼Œ`NextObjectId=1`ï¼Œé¦–ç‰ˆæœ¬ `PrevVersionPtr=0` |

### ç›‘æŠ¤äººåé¦ˆé‡‡çº³æƒ…å†µ

| åé¦ˆ | ç±»å‹ | é‡‡çº³ | è¯´æ˜ |
|------|------|------|------|
| `_dirtyKeys` é›†åˆ | ç–‘é—® | âœ… é‡‡çº³ | è§£å†³äº†"è¯­ä¹‰å·®å¼‚"å®šä¹‰ä¸é«˜æ•ˆå®ç°çš„å¼ åŠ› |
| Magic-as-Separator | å»ºè®® | âœ… é‡‡çº³ | æ¦‚å¿µæ›´ç®€æ´ï¼Œä¸éœ€åŒºåˆ† header/sentinel |

---

## æ¨èè¡ŒåŠ¨

- [x] é˜…è¯»æœ¬æ‘˜è¦
- [x] ç¬¬ä¸€è½®æ‰¹å‡† P0 è§£å†³æ–¹æ¡ˆï¼ˆæ€»ä½“èµæˆï¼‰
- [x] æå‡ºåé¦ˆï¼ˆ`_dirtyKeys` + Magic-as-Separatorï¼‰
- [ ] æœ€ç»ˆæ‰¹å‡†ä¿®è®¢åçš„æ–¹æ¡ˆ
- [ ] æˆæƒä¿®æ”¹ mvp-design-v2.md

---

## ä¸‰ä½ Specialist çš„æœ€ç»ˆå…±è¯†æŠ•ç¥¨

| é—®é¢˜ | Claude | Gemini | GPT | ç»“æœ |
|------|--------|--------|-----|------|
| P0-1 `_dirtyKeys` æ–¹æ¡ˆ | âœ… | âœ… | âœ… | **ä¸€è‡´é€šè¿‡** |
| P0-2 Magic-as-Separator | âœ… | âœ… | âœ… | **ä¸€è‡´é€šè¿‡** |
| P0-3 `DataTail=EOF` | âœ… | âœ… | âœ… | **ä¸€è‡´é€šè¿‡** |
| P0-4 Value ç±»å‹æ”¶æ•› | âœ… | âœ… | âœ… | **ä¸€è‡´é€šè¿‡** |
| P0-5 Dirty Set å¡ä½ | âœ… | âœ… | âœ… | **ä¸€è‡´é€šè¿‡** |
| P0-6 `CommitAll` | âœ… | âœ… | âœ… | **ä¸€è‡´é€šè¿‡** |
| P0-7 é¦–æ¬¡ commit | âœ… | âœ… | âœ… | **ä¸€è‡´é€šè¿‡** |

---

## å…³é”®ä¿®è®¢ç»†èŠ‚

### P0-1ï¼š`_isDirty` â†’ `_dirtyKeys`

```csharp
// æ¦‚å¿µå±‚è¯­ä¹‰ï¼ˆä¸å˜ï¼‰
HasChanges âŸº âˆƒ key: CurrentValue(key) â‰  CommittedValue(key)

// å®ç°å±‚ï¼ˆä¿®è®¢ï¼‰
private ISet<ulong> _dirtyKeys;
public bool HasChanges => _dirtyKeys.Count > 0;

void Upsert(ulong key, TValue value) {
    _current[key] = value;
    if (Equals(value, GetCommittedValue(key)))
        _dirtyKeys.Remove(key);  // æ¢å¤åŸçŠ¶
    else
        _dirtyKeys.Add(key);
}
```

### P0-2ï¼šMagic-as-Separator

```
åŸå®šä¹‰ï¼šRecord = [Magic][Len]...[CRC]ï¼Œå°¾å“¨å…µç‹¬ç«‹
ä¿®è®¢ï¼š  Magic ä¸ Record å¹¶åˆ—ï¼Œä½œä¸º Separator

æ–‡ä»¶ç»“æ„ï¼š[Magic][Record1][Magic][Record2]...[Magic]
å†™å…¥è§„åˆ™ï¼šç©ºæ–‡ä»¶å…ˆå†™ Magicï¼›æ¯æ¡ Record å†™å®Œåå†™ Magic
```

---

## æ„å¤–æ”¶è·

DurableHeap â†” DocUI æ¦‚å¿µæ˜ å°„ï¼š

| DurableHeap | DocUI | å…±åŒæ¨¡å¼ |
|-------------|-------|----------|
| Version Chain | Agent-History | Append-Only Log |
| Checkpoint Version | LOD Gist | Periodic Snapshot |
| Materialize | Context-Projection | State Reconstruction |

---

## å†³ç­–é€‰é¡¹

- [ ] **å…¨éƒ¨æ‰¹å‡†** â€” æˆæƒæŒ‰ä¸Šè¿°æœ€ç»ˆæ–¹æ¡ˆä¿®æ”¹æ–‡æ¡£
- [ ] **éƒ¨åˆ†æ‰¹å‡†** â€” è¯·è¯´æ˜éœ€è¦è°ƒæ•´çš„éƒ¨åˆ†
- [ ] **éœ€è¦æ›´å¤šä¿¡æ¯** â€” è¯·è¯´æ˜éœ€è¦è¡¥å……çš„å†…å®¹

---

**ç›‘æŠ¤äººæ‰¹ç¤º**ï¼š________________

---

*æ‘˜è¦ç”± SageWeaver (DocUI è§„èŒƒèµ·è‰å§”å‘˜ä¼šæ‰§è¡Œå§”å‘˜ä¼šä¸»å¸­) å‡†å¤‡*
*ä¼šè®®è®°å½•ï¼š`agent-team/meeting/2025-12-19-durableheap-mvp-review.md`*
*æ›´æ–°æ—¶é—´ï¼š2025-12-20*

