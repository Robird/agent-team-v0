# AA4-003 – CL7 Cursor Word/Snippet/Multi-Selection Audit

## Overview
Refreshed on 2025-11-26 (Sprint 03 Run R40). CL7 still owns cursor word navigation, multi-selection/column selection, and snippet placeholder parity. This pass re-reviewed the TypeScript sources (`ts/src/vs/editor/common/cursor/*.ts`, `ts/src/vs/editor/contrib/snippet/browser/snippetController2.ts`, related tests under `ts/src/vs/editor/contrib/*/test/browser`) against the latest C# port (`src/TextBuffer/Cursor/**/*`, `src/TextBuffer/TextModel.cs`, `src/TextBuffer/Rendering/MarkdownRenderer.cs`, `tests/TextBuffer.Tests/*`). Findings below supersede the 2025-11-20 notes and feed `docs/reports/audit-checklist-aa4.md#cl7` plus Sprint R40.

## Findings
| # | Severity | Focus | TS references | Current C# behavior | Details & proposed fix notes |
| --- | --- | --- | --- | --- | --- |
| F1 | High | Multi-cursor controller, recovery & doc events | `ts/src/vs/editor/common/cursor/cursor.ts`, `cursorCollection.ts`, `cursorContext.ts`, `cursorEvents.ts` | `src/TextBuffer/Cursor/CursorCollection.cs`, `CursorContext.cs`, `CursorState.cs`, `TextModel.cs` | TS drives all cursor state through `CursorsController`, `CursorConfiguration`, and `CursorContext`, normalizes overlaps, enforces `multiCursorLimit`, and rehydrates cursors from markers after every `TextModel` event. The C# port exposes bare `Cursor` objects in `CursorCollection`, never wires `_cursorCollection` back into `TextModel`, and `CursorContext.ComputeAfterCursorState` simply echoes the current positions ignoring `inverseChanges`. No `CursorChangeReason`, `ICursorSimpleModel`, injected-text recovery, or decoration sync exists, so multi-c edits drift and Markdown snapshots always show one cursor. **Fix:** Port `CursorsController`, `CursorConfiguration`, and marker-backed recovery; thread `CursorStateComputer` results into `EditStack`; emit proper owner IDs so `MarkdownRenderer` can render each cursor/selection. Use changefeed `#delta-2025-11-26-aa4-cl7-cursor-core` for this tranche. |
| F2 | High | Word navigation/selection + Intl boundaries | `ts/src/vs/editor/common/cursor/cursorWordOperations.ts`, `ts/src/vs/editor/common/core/wordCharacterClassifier.ts`, `ts/src/vs/editor/contrib/wordOperations/test/browser/wordOperations*.test.ts` | `src/TextBuffer/Cursor/WordOperations.cs`, `WordCharacterClassifier.cs`, `Cursor.cs` | TS supports `WordNavigationType` (`WordStart`, `WordStartFast`, `WordEnd`, `WordAccessibility`), camelCase/snake_case `wordPart*` moves, word-delete contexts, and hooks `Intl.Segmenter` + cached classifiers keyed by `EditorOption.wordSeparators/wordSegmenterLocales`. C# only exposes three helpers (MoveWordLeft/Right, DeleteWordLeft), defines a different `WordNavigationType` enum that is never used, duplicates a minimalist classifier (no locales, no cache) and never reads `TextModelOptions` for separators. `DeleteWordLeft` bypasses the TS `DeleteOperations` heuristics (auto-closing/whitespace). **Fix:** Share the `PieceTree.TextBuffer.Core.WordCharacterClassifier` implementation (or extend it) with cursor code, add Intl segmentation fallback, surface editor options for separators/locales, implement the full `WordOperations` + `DeleteOperations` suite, and port TS tests. Track via `#delta-2025-11-26-aa4-cl7-wordops`. |
| F3 | High | Column selection, visible column math, select-line | `ts/src/vs/editor/common/cursor/cursorColumnSelection.ts`, `cursorMoveOperations.ts`, `cursorCommon.ts` (`SelectionStartKind`,`ColumnSelectData`) | `src/TextBuffer/Cursor/Cursor.cs`, `CursorColumns.cs`, `src/TextBuffer/TextModel.cs` | TS relies on `CursorConfiguration` + `CursorColumns` and a large set of `TextModel` helpers (`getLineMin/MaxColumn`, `getLineFirst/LastNonWhitespaceColumn`, `getLineIndentColumn`, `normalizePosition`, injected text aware conversions) to implement Alt+drag columns, `columnSelect{Up,Down,Left,Right}`, and sticky tab stops (`SelectionStartKind`). The C# model only has `GetLineContent/MaxColumn`; `Cursor` tracks `_isColumnSelecting` with two fields and no `_columnSelectData`, leftover columns, or command entry points. `CursorColumns` ignores `SelectionStartKind` and the `multiCursorModifier` rules, so select-line/column copy commands cannot be layered. **Fix:** Port the missing `TextModel` helpers, bring over `CursorConfiguration`/`ColumnSelectData`, implement the column-select commands + select-line/home/end variants, and update Markdown snapshots to display column blocks. Suggested changefeed `#delta-2025-11-26-aa4-cl7-column-nav`. |
| F4 | High | Snippet controller/session & placeholder stickiness | `ts/src/vs/editor/contrib/snippet/browser/snippetController2.ts`, `snippetSession.ts`, `snippetParser.ts`, snippet tests | `src/TextBuffer/Cursor/SnippetController.cs`, `SnippetSession.cs`, `Rendering/MarkdownRenderer.cs` | TS snippet stack plugs into the editor, registers context keys (`inSnippetMode`, `hasNext/PrevTabstop`), manages undo stops, clipboard/overtyping, TextMate-style parsing (variables, transforms, choices, nested placeholders), and uses decoration options with explicit `TrackedRangeStickiness`. The C# session only parses `${n:text}`, discards choices/transforms/$0, allocates generic decorations (default stickiness = `AlwaysGrows` → placeholders stretch), never moves cursors when navigating tabstops, lacks commands, and instantiates a fresh session per insertion with no merge/undo semantics. Markdown snapshots therefore never show placeholder owners, and snippet placeholder stickiness is incorrect. **Fix:** Port the snippet parser/session/controller trio, add context hooks (even if DocUI-hosted), set decoration stickiness to match TS, implement Tab/Shift+Tab navigation + choice completions, and wire multi-c insertions. Track via `#delta-2025-11-26-aa4-cl7-snippet`. |
| F5 | Medium-High | Command surface, select-word/line, TestMatrix accuracy | `ts/src/vs/editor/common/cursor/cursorMoveCommands.ts`, `cursorDeleteOperations.ts`, `cursorTypeOperations.ts`, `ts/src/vs/editor/contrib/multicursor/test/browser/multicursor.test.ts`, `snippetController2.test.ts` | `src/TextBuffer/Cursor/*`, `tests/TextBuffer.Tests/Cursor*.cs`, `tests/TextBuffer.Tests/TestMatrix.md` | The TS command layer glues cursor ops to Ctrl+D, Shift+Alt+Arrow, SelectAllMatches, `addSecondaryCursor`, etc., and TS test suites cover unicode word splits, overlapping cursors, injected text, and DocUI snapshots. C# never ported the command modules, has no `AddSecondaryCursor`/merge logic, and the handful of tests (`CursorWordOperationsTests`, `CursorMultiSelectionTests`, `ColumnSelectionTests`, `SnippetControllerTests`) only cover ASCII happy paths. `tests/TextBuffer.Tests/TestMatrix.md` still labels CL7 rows as “Verified” even though the majority of TS suites (wordPart, intl, delete operations, snippet choices, Markdown renderer multi-c snapshot) are absent and Markdown renderer coverage row is marked “Pending”. **Fix:** port the TS command modules + tests, downgrade the TestMatrix rows to “Gap” until parity suites exist, and add DocUI/Markdown renderer snapshots once snippet/column data are wired. Add changefeed `#delta-2025-11-26-aa4-cl7-commands-tests` when coverage lands. |
| F6 | Medium | Intl.Segmenter dependency & cursor/snippet fuzz coverage | `ts/src/vs/editor/common/core/wordCharacterClassifier.ts` (Intl), `ts/src/vs/editor/contrib/wordOperations/test/browser/wordOperations.intl.test.ts`, `ts/src/vs/editor/contrib/snippet/test/browser/snippetSession.test.ts`, `ts/src/vs/editor/test/common/controller/cursorWordOperations.random.test.ts` | `src/TextBuffer/Cursor/WordCharacterClassifier.cs`, `tests/TextBuffer.Tests/CursorWordOperationsTests.cs`, `SnippetMultiCursorFuzzTests.cs` | VS Code delegates unicode boundaries to `Intl.Segmenter`, keeps an LRU cache keyed by locales, and runs intl/fuzz suites (CJK, emoji, combining marks, random cursor moves). The C# classifier is ASCII-only, duplicates the search classifier, and `SnippetMultiCursorFuzzTests` merely insert GUID-based snippets without mirroring TS random scripts or verifying placeholder transforms. No intl/fuzz suites exist, so regressions around emoji, RTL text, or snippet nesting go undetected. **Fix:** decide on a .NET equivalent for `Intl.Segmenter` (e.g., ICU via `System.Text.Segmentation` or a managed fallback), expose locales through `TextModelOptions`, and port the intl + fuzz suites for both word navigation and snippets. |

## Recommended remediation (Porter-CS / QA / Docs / Info)
1. **Cursor core delta (`#delta-2025-11-26-aa4-cl7-cursor-core`)** – Port `CursorsController`, marker recovery, `CursorConfiguration`, column-select metadata, and connect them to `TextModel` events. Update `MarkdownRenderer` and DocUI samples to render multiple cursor owners.
2. **Word & delete operations (`#delta-2025-11-26-aa4-cl7-wordops`)** – Share the unicode-aware classifier from `PieceTree.TextBuffer.Core.SearchTypes`, add Intl segmentation + locale plumbing, implement the full TS `WordOperations`/`DeleteOperations` surface, and thread `EditorOption.wordSeparators/wordSegmenterLocales` through `TextModelOptions`.
3. **Column-navigation / select-line (`#delta-2025-11-26-aa4-cl7-column-nav`)** – Add the missing `TextModel` helpers, implement `columnSelect{Up,Down,Left,Right}` and select-line/home/end commands, and ensure leftover visible columns survive edits/injected text.
4. **Snippet parity (`#delta-2025-11-26-aa4-cl7-snippet`)** – Port `SnippetSession` + parser + controller, hook them to undo stack/context keys/multi-c, set placeholder stickiness to TS defaults, and emit snippet owner decorations so Markdown snapshots/tests can assert DocUI output.
5. **Test & doc alignment (`#delta-2025-11-26-aa4-cl7-commands-tests`)** – Port TS suites (`wordOperations*.test.ts`, `multicursor.test.ts`, `snipppetController2.test.ts`, Markdown renderer snapshots), reclassify the CL7 rows inside `tests/TextBuffer.Tests/TestMatrix.md` as “Gap” until the suites pass, and update `docs/reports/migration-log.md`, `agent-team/indexes/README.md`, and Sprint/Task Board when each delta lands.

## Validation hooks / TS suites to mirror
- `ts/src/vs/editor/contrib/wordOperations/test/browser/wordOperations.test.ts` and `wordOperations.intl.test.ts` → expand `CursorWordOperationsTests` (wordPart, Intl boundaries, word accessibility, delete contexts).
- `ts/src/vs/editor/contrib/multicursor/test/browser/multicursor.test.ts` + `cursorColumnSelection.test.ts` → new `CursorMultiSelectionTests` modules covering add/remove cursors, injected text adjustments, overlapping merges, column copy/paste.
- `ts/src/vs/editor/contrib/snippet/test/browser/snippetController2.test.ts` & `snippetSession.test.ts` → `SnippetControllerTests` / `SnippetSessionTests` validating undo stops, placeholder transforms, choices, `$0`, nested snippets.
- `ts/src/vs/editor/common/cursor/cursorMoveCommands.test.ts` (and delete/type operation tests) → command-Layer tests ensuring select-line, column select, and word navigation commands route through the new controller.
- `ts/src/vs/editor/test/common/controller/cursorWordOperations.random.test.ts` (and related fuzz) → deterministic cursor/snippet fuzz harness similar to existing PieceTree fuzz infrastructure.
- Markdown snapshot parity: once snippet + multi-c owners land, add `MarkdownRendererTests.MultiCursorAndSnippet` to assert doc output ties to Porter’s DocUI flows (currently “Pending” in the TestMatrix).

## Dependencies / blockers
- **Intl.Segmenter:** need agreement on using ICU/`System.Globalization` to emulate `Intl.Segmenter`. Planner/Porter to decide whether to bundle a managed fallback or add a host dependency; Investigator flagged this as the remaining blocker for wordBoundary parity.
- **Editor options plumbing:** `TextModelResolvedOptions` does not expose `wordSeparators`, `wordSegmenterLocales`, or `multiCursorLimit`. Porter must extend the options model (and serialization) before cursor configuration can honor user settings.
- **Snippet host services:** SnippetController2 depends on context keys, clipboard service, undo stack, and suggestion integration. Clarify whether these live in DocUI host or inside the TextBuffer assembly so deterministic tests remain possible.
- **Docs/TestMatrix:** CL7 rows presently read “Verified”. Until the above deltas land, DocMaintainer should flip them back to “Gap” to avoid masking missing functionality. QA to log rerun commands once the new suites exist.

## Notes for downstream teams
- **Porter-CS:** Sequence the four deltas above, emit changefeed entries, and keep `docs/reports/migration-log.md` + `agent-team/indexes/README.md` in sync. Column/word/snippet work blocks CL7 signoff.
- **QA-Automation:** Prepare new test classes under `tests/TextBuffer.Tests/Cursor/` & `/Snippets/`, plus Markdown renderer snapshots. Mirror TS naming to simplify cross-reference.
- **Info-Indexer / DocMaintainer:** Once Porter lands each delta, publish the matching `#delta-2025-11-26-aa4-cl7-*` anchors and update AGENTS/Sprint/Task Board/TestMatrix to reflect the restored coverage.
