# B3-PieceTree-Fuzz – Investigator Memo (R23)

- **Date:** 2025-11-24
- **Owner:** Investigator-TS
- **Sprint Link:** `docs/sprints/sprint-03.md`
- **Plan Link:** `docs/plans/ts-test-alignment.md` (Live Checkpoints + Appendix A entry for PieceTree fuzz)
- **Changefeed Anchor:** `#delta-2025-11-23-b3-piecetree-fuzz` *(placeholder – to be published once Porter/QA land the suite)*

## 1. TS Test Cases & Helpers Still Missing in C#
| Bucket | TS Source & Intent | Current C# Status | Gap / Porting Notes |
| --- | --- | --- | --- |
| Deterministic insert/delete regressions | `suite('inserts and deletes')` incl. random test {1..3}, random delete {1..3}, prefix sum bug repros, `random insert/delete \r bug {1..5}` (rooted in `assertTreeInvariants` + `testLinesContent`) (ts/src/vs/editor/test/common/model/pieceTreeTextBuffer/pieceTreeTextBuffer.test.ts) | Only basic cases ported to `tests/TextBuffer.Tests/PieceTreeBaseTests.cs` and `tests/TextBuffer.Tests/UnitTest1.cs`; fuzz loops merely assert final `GetText()` equality | Need deterministic fixtures that replay the TS sequences verbatim, asserting `GetLineCount`, `GetLineContent`, `GetPositionAt`, and `GetOffsetAt` after each mutation so we mirror `testLineStarts`/`testLinesContent` coverage |
| Prefix-sum / offset mapping invariants | `suite('prefix sum for line feed')`, `suite('offset 2 position')` (ts/.../pieceTreeTextBuffer.test.ts) ensures `getPositionAt`/`getOffsetAt` stay bijective while edits shuffle CR/LF boundaries | `tests/TextBuffer.Tests/UnitTest1.cs` only checks a single static example; no edit-after-assert cycle | Port TS scenarios that interleave insert/delete + prefix-sum validation, and wire them into a reusable helper (`PieceTreeFuzzHarness.AssertLineMapping`) so QA can extend later |
| `getValueInRange` / range diffing | `suite('get text in range')` (ts/.../pieceTreeTextBuffer.test.ts) verifies `getValueInRange` and `getLineRawContent` via random edits | C# never calls `PieceTreeBuffer.GetValueInRange`; coverage limited to DocUI tests (`tests/TextBuffer.Tests/DocUI/DocUIFindDecorationsTests.cs`) | Add range-diff assertions + helper to compare trimmed LF outputs; ensures `GetValueInRange` honors CRLF normalization |
| CRLF edge suites (two flavors) | `suite('CRLF')` and `suite('centralized lineStarts with CRLF')` mix inserts/deletes across normalized vs non-normalized builders to reproduce prefix-sum bugs (ts/.../pieceTreeTextBuffer.test.ts) | Partial fuzz via `tests/TextBuffer.Tests/CRLFFuzzTests.cs` + `PieceTreeNormalizationTests.cs`, but we dont replay targeted sequences or assert `splitLines` parity | Port TS sequences as deterministic tests so we catch regressions earlier (especially `_lineStarts` replication inside `ChunkBuffer`). |
| Random unsupervised fuzz | `suite('random is unsupervised')` (`random insert delete`, `random chunks`, `random chunks 2`) runs 1k ops per seed and checks both `testLineStarts` and `assertTreeInvariants` every iteration (ts/.../pieceTreeTextBuffer.test.ts) | C# fuzz (`tests/TextBuffer.Tests/PieceTreeModelTests.cs`) focuses on CR/LF metadata but only validates final text + total LF count; no seed parameterization or per-iteration invariants | Need a deterministic harness that (a) reads `PIECETREE_FUZZ_SEED` env, (b) logs operations via `FuzzLogCollector`, (c) replays TS-style checks (`GetLineContent`, `LineStarts`, `NodeColor` balance) each step |
| Buffer API smoke (equal, nearest chunk, char codes) | `suite('buffer api')` + `getLineCharCode` + `getNearestChunk` (ts/.../pieceTreeTextBuffer.test.ts) | `tests/TextBuffer.Tests/UnitTest1.cs` covers char codes but never exercises `PieceTreeBuffer.Equal` or `GetNearestChunk` | Port the equality and chunk-neighbor tests plus the regression for `getLineCharCode` (#45735/#47733) so future refactors keep buffer comparisons viable |
| Search offset cache + chunk search | `suite('search offset cache')` + `suite('chunk based search')` ensure `findMatchesLineByLine` stays within node boundaries and handles empty buffers (ts/.../pieceTreeTextBuffer.test.ts) | Search coverage today lives in `tests/TextBuffer.Tests/TextModelSearchTests.cs` (text model level) and DocUI tests; no low-level `PieceTreeBuffer.findMatchesLineByLine` parity | Need adapter exposing the internal search method (or a friend accessor) plus tests that mirror TS bug #45770/#45892 scenarios |
| Snapshot immutability matrix | `suite('snapshot')` (bug #45564 + immutable variations) (ts/.../pieceTreeTextBuffer.test.ts) | `tests/TextBuffer.Tests/PieceTreeSnapshotTests.cs` covers read + single mutation, but were missing the double-snapshot replay (createSnapshot twice before editing) | Port the remaining TS tests so we guarantee snapshots dont observe later edits even when edits delete/reinsert CRLF couples |

> **Note:** Every bucket above should ultimately be listed under the existing Appendix A row for PieceTree tests plus mirrored inside `tests/TextBuffer.Tests/TestMatrix.md` once Porter/QA land their changes.

## 2. Required C# Infrastructure / Adapters
1. **Reusable PieceTree fuzz harness:** wrap `PieceTreeBuffer` + `StringBuilder` expected state, drive deterministic RNG (`System.Random(seed)`) sourced from env (`PIECETREE_FUZZ_SEED`) and persist replay logs through `tests/TextBuffer.Tests/Helpers/FuzzLogCollector.cs`. Adds opt-in stress hooks for `GetLineCount`, `GetLineContent`, `GetValueInRange`, `GetPositionAt`, and `GetOffsetAt` so we match TS helpers (`testLinesContent` / `testLineStarts`).
2. **Tree invariant inspector:** extend `src/TextBuffer/Core/PieceTreeModel.cs::AssertPieceIntegrity()` (or add a sister helper) to validate RB-color balance, sentinel wiring, and per-node `SizeLeft` / `LineFeedsLeft` similar to TS `assertTreeInvariants` / `assertValidNode` (ts/.../pieceTreeTextBuffer.test.ts). This gives fuzz tests immediate, actionable failures instead of latent metadata mismatches.
3. **Range diff utilities:** add small helpers under `tests/TextBuffer.Tests/Helpers/` to fetch trimmed range text + `LineStarts` arrays so deterministic suites can express expectations without duplicating boilerplate.
4. **Internal search adapter:** expose `PieceTreeBuffer.FindMatchesLineByLine` (parallel to TS `findMatchesLineByLine`) either via `internal` accessor or a `FriendAccessAllowed` test shim so we can port the search offset cache tests verbatim (ts/.../pieceTreeTextBuffer.test.ts). Today only `TextModel` exercises search (`tests/TextBuffer.Tests/TextModelSearchTests.cs`).
5. **Snapshot comparison shim:** extend `PieceTreeSnapshotTests` (tests/TextBuffer.Tests/PieceTreeSnapshotTests.cs) with a helper that enumerates entire snapshots to ensure the “double snapshot before edits” scenario from TS is exercised, matching `bug #45564` expectations.

## 3. Proposed runSubAgent Sequence (Investigator → Porter → QA)
| Step | Owner | Objective | Dependencies / Notes | Est. |
| --- | --- | --- | --- | --- |
| R24 – Harness & invariants | Porter-CS | Implement `PieceTreeFuzzHarness`, env-driven RNG seed, enhanced tree integrity checks, and range diff helpers (touch `PieceTreeModel.AssertPieceIntegrity`, new helpers under `tests/TextBuffer.Tests/Helpers/`) | Requires Investigator spec (this memo) + agreement from Planner on extending internals | 0.5d |
| R25 – Deterministic suites batch 1 | Porter-CS | Port TS deterministic insert/delete + prefix-sum + range tests into `PieceTreeBaseTests`, `PieceTreeModelTests`, and a new `PieceTreeRangeTests` file; wire harness assertions each iteration | Depends on R24 harness; cite `ts/src/vs/editor/test/common/model/pieceTreeTextBuffer/pieceTreeTextBuffer.test.ts` sections 1–5 | 1.0d |
| R26 – CRLF + search suites | Porter-CS | Port both CRLF suites, buffer API, search offset cache, chunk-based search, and remaining snapshot cases; expose internal search adapter as needed | Depends on R24 for invariants + range helpers; may require minor product hooks | 1.0d |
| R27 – QA validation | QA-Automation | Extend `tests/TextBuffer.Tests/TestMatrix.md` with the new suites, run targeted fuzz commands (`dotnet test --filter PieceTree*Fuzz`) under multiple seeds, archive failing operation logs | Requires R24–R26 merged; ensure `#delta-2025-11-23-b3-piecetree-fuzz` published | 0.5d |
| R28 – DocMaintainer / Info-Indexer | DocMaintainer + Info-Indexer | Publish changefeed (`#delta-2025-11-23-b3-piecetree-fuzz`), update `docs/plans/ts-test-alignment.md` Live Checkpoints, `TestMatrix`, Task Board, AGENTS | Blocks on QA sign-off | 0.5d |

## 4. Risks & Open Questions
1. **Planner:** confirm whether the remaining B3 scope still fits Sprint 03 – Live Checkpoints already warned that Fuzz/Diff may slip to Sprint 04; if we cannot secure two Porter slots this week, we should officially move `B3-PieceTree-Fuzz` to Sprint 04 to avoid silent scope creep (`docs/plans/ts-test-alignment.md`).
2. **DocMaintainer:** once tests land, well need a dedicated row inside Appendix A + `TestMatrix` that enumerates each fuzz seed / deterministic suite; please confirm preferred naming (e.g., `CL2.PieceTree.Fuzz`) before QA runs begin.
3. **Search adapter exposure:** enabling tests to call `FindMatchesLineByLine` may require internal access modifiers; need confirmation from Planner/Lead that exposing this under `InternalsVisibleTo` is acceptable.
4. **RNG reproducibility policy:** we currently log operations via `FuzzLogCollector` (tests/TextBuffer.Tests/Helpers/FuzzLogCollector.cs) but there is no documented retention or env toggle; QA needs guidance (maybe via `docs/reports/migration-log.md`) on how many seeds to run nightly vs per-PR.
5. **Metadata diff tooling:** converting TS `testLinesContent` expectations into C# will likely inflate test runtimes; we may need to add a lightweight `PieceTreeLineSnapshot` cache to avoid O(n^2) string rebuilds during fuzz – Planner should confirm acceptable runtime budget.

---
**Next Action:** Await Planner/Porter confirmation on R24 start time; once tooling work is scheduled we can update `docs/sprints/sprint-03.md` and `TestMatrix` to reflect the committed substeps for `B3-PieceTree-Fuzz`.
