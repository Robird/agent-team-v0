# T-P5-03a CommitAll 核心流程 Implementation Result

## 实现摘要

实现了 Two-Phase Commit 的 Phase 1（写 Data）：
1. 新增 `CommitContext.cs` 作为提交上下文收集器
2. 修改 `Workspace.cs` 添加 `PrepareCommit()` 方法和相关字段
3. 新增 9 个测试用例覆盖 PrepareCommit 的各种场景

## 文件变更

- `atelia/src/StateJournal/Commit/CommitContext.cs` — 新增提交上下文类
- `atelia/src/StateJournal/Workspace/Workspace.cs` — 添加 PrepareCommit 方法、VersionIndex 字段、辅助方法
- `atelia/tests/StateJournal.Tests/Workspace/WorkspaceTests.cs` — 新增 PrepareCommit 测试

## 源码对齐说明

| 规范条款 | 实现 | 备注 |
|---------|------|------|
| `[A-COMMITALL-DIRTY-ITERATION]` | `foreach (var obj in _dirtySet.GetAll())` | 遍历所有脏对象 |
| `[A-COMMITALL-WRITE-DIFF]` | `obj.WritePendingDiff(buffer)` | 调用 WritePendingDiff 序列化 |
| `[A-COMMITALL-UPDATE-VERSIONINDEX]` | `_versionIndex.SetObjectVersionPtr(obj.ObjectId, position)` | 更新 VersionIndex 映射 |

## 关键实现细节

### CommitContext
- `EpochSeq`: 当前 epoch 序号
- `DataTail`: 模拟的写入位置
- `VersionIndexPtr`: VersionIndex 的位置指针
- `WriteObjectVersion()`: 模拟 RbfFramer.Write，返回写入位置

### Workspace.PrepareCommit()
1. 遍历 DirtySet 中所有 `HasChanges == true` 的对象
2. 对每个对象：
   - 写入 PrevVersionPtr（8 bytes LE）
   - 调用 `WritePendingDiff` 序列化 diff
   - 写入 CommitContext 并获取位置
   - 更新 VersionIndex
3. 如果 VersionIndex 有变更，写入 VersionIndex 本身
4. 返回 CommitContext 供 Phase 2 使用

### 新增字段
- `_versionIndex`: VersionIndex 实例
- `_versionIndexPtr`: 当前 VersionIndex 位置
- `_epochSeq`: 当前 epoch 序号
- `_dataTail`: data file 当前尾部

## 测试结果

- Targeted: `dotnet test --filter "FullyQualifiedName~WorkspaceTests"` → 33/33 ✅
- Full: `dotnet test tests/StateJournal.Tests` → 561/561 ✅

## 测试用例覆盖

| 测试用例 | 描述 |
|---------|------|
| `PrepareCommit_EmptyDirtySet_ReturnsEmptyContext` | 空 DirtySet 返回空 context |
| `PrepareCommit_SingleDirtyObject_WritesRecord` | 单个脏对象写入记录 |
| `PrepareCommit_UpdatesVersionIndex` | 更新 VersionIndex |
| `PrepareCommit_MultipleDirtyObjects_WritesAllRecords` | 多对象写入全部记录 |
| `PrepareCommit_EpochSeq_Increments` | EpochSeq 递增 |
| `PrepareCommit_DataTail_IncrementsAfterWrites` | DataTail 递增 |
| `PrepareCommit_VersionIndexPtr_UpdatedAfterWrite` | VersionIndexPtr 更新 |
| `PrepareCommit_WrittenRecords_ContainCorrectObjectIds` | 记录包含正确 ObjectId |
| `PrepareCommit_NoChanges_DoesNotWriteVersionIndex` | 无变更不写入 |

## 已知差异

- MVP 阶段 `GetFrameTag()` 只返回 `DictVersion`，未来需要根据对象类型动态确定

## 遗留问题

1. Phase 2（写 Meta）待实现
2. `OnCommitSucceeded()` 调用（Finalize 阶段）待实现
3. DirtySet 清理逻辑待实现

## Changefeed Anchor

`#delta-2025-12-26-commitall-phase1`
