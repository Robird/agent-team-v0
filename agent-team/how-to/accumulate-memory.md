# 记忆积累规范 (Memory Accumulation Specification)

> **版本**：1.1
> **日期**：2026-01-01
> **状态**：Published
> **来源**：[2025-12-22 全员畅谈会](../meeting/2025-12-22-memory-accumulation-reflection.md)
> **维护者**：MemoryPalaceKeeper
>
> **依赖关系**：
> - DependsOn: [maintain-memory.md]
> - SeeAlso: [organize-deep-maintenance.md, batch-process-inbox.md]

---

## 适用信号

当你需要：
- 会话结束时将认知收获写入持久记忆
- 避免记忆文件退化为append-only日志
- 实施结构化记忆提交流程
- 区分不同层级的记忆内容（L0-L3）
- 确保记忆积累符合规范要求

## 不适用信号

如果你：
- 只需要简单的笔记记录
- 记忆内容不需要长期保存和复用
- 缺乏时间进行结构化处理
- 内容过于简单，不需要分层存储
- 正在进行实时协作，需要保持过程完整性

## 核心洞察

1. **结构化提交**：将OnSessionEnd从写日志变为提交流程 `[ACCUM-01]`
2. **四层框架**：L0(原始)→L1(分类)→L2(摘要)→L3(归档) `[ACCUM-02]`
3. **变更分类**：使用CLASSIFY矩阵区分内容类型 `[ACCUM-03]`
4. **分流路由**：根据分类结果路由到不同记忆层 `[ACCUM-04]`
5. **写入操作**：按规范格式写入目标记忆文件 `[ACCUM-05]`

---

## 1. 概述

### 1.1 目的与定位

本规范定义 AI Team 成员在会话结束时（OnSessionEnd）如何将认知收获写入持久记忆文件。

**核心问题**：
> "更新"一词缺乏可执行定义，LLM 默认行为退化为 append-only 日志。

**解决方案**：
> 将 OnSessionEnd 从"写日志"转变为**结构化提交流程**（Memory Commit Protocol）。

### 1.2 与记忆维护技能书的关系

| 文档 | 职责 | 隐喻 |
|:-----|:-----|:-----|
| **本规范（记忆积累）** | 定义日常写入机制 | 日常整理习惯 |
| [记忆维护技能书](memory-maintenance-skill.md) | 定义定期清理流程 | 定期大扫除 |

> **治本 vs 治标**：积累机制好，维护就轻松；积累机制差，维护再努力也痛苦。

### 1.3 核心原则

| 原则 | 说明 |
|:-----|:-----|
| **可执行性** | 每条规则都有明确的触发条件和动作 |
| **分类优先** | 先判断"这是什么类型的变更"，再决定如何写入 |
| **SSOT** | Single Source of Truth — 同一实体只有一个权威位置 |
| **外置详情** | 详情写外部文件，index.md 只留指针 |

---

## 2. 术语定义

| 术语 | 定义 |
|:-----|:-----|
| **记忆文件** | 成员的持久认知存储，位于 `agent-team/members/<name>/` |
| **主记忆** | `index.md`，冷启动时首先加载的认知入口 |
| **写入操作** | 对记忆文件的修改动作（OVERWRITE/APPEND/MERGE/REWRITE/TOMBSTONE） |
| **分流** | 根据内容类型选择写入哪个文件 |
| **SSOT 区块** | 只允许覆盖写的唯一真相区域（如"当前任务"、"项目状态"） |
| **Memory Commit** | 一次完整的记忆写入事务 |

---

## 3. Memory Commit Protocol

### 3.1 三步流程

```
OnSessionEnd
    │
    ▼
┌─────────────────────────────────────────────────────────┐
│  Step 1: CLASSIFY (分类)                                │
│  ─────────────────────────────────────────────────────  │
│  问：本次会话产生了什么类型的变更？                      │
│                                                         │
│  ┌─ No-Op ────────→ 无持久化价值，不写入               │
│  ├─ State-Update ─→ 当前状态变更（项目进度、任务等）    │
│  ├─ Knowledge ────→ 新知识/洞见/经验                   │
│  ├─ Log-Only ─────→ 纯过程记录（会议发言、调试日志）    │
│  └─ Mixed ────────→ 混合类型，需拆分处理               │
└─────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────┐
│  Step 2: ROUTE (路由)                                   │
│  ─────────────────────────────────────────────────────  │
│  问：这个内容应该写到哪个文件？                          │
│                                                         │
│  L1 索引层 ← index.md (≤300行)                         │
│  L2 摘要层 ← meta-cognition.md / knowledge/*.md        │
│  L3 详情层 ← handoffs/ / meeting/ / archive/           │
└─────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────┐
│  Step 3: APPLY (执行)                                   │
│  ─────────────────────────────────────────────────────  │
│  问：用什么操作写入？                                    │
│                                                         │
│  OVERWRITE ─ 覆盖旧值（状态更新）                       │
│  APPEND ──── 追加新条目（独立新知识）                   │
│  MERGE ───── 合并到旧条目（旧知识精炼）                 │
│  REWRITE ─── 改正旧条目（事实性纠错）                   │
│  TOMBSTONE ─ 标记废弃（术语/方案翻转）                  │
│                                                         │
│  + 留下 Memory Commit Message                           │
└─────────────────────────────────────────────────────────┘
```

### 3.2 60 秒完成原则

Memory Commit 应在 **60 秒内完成**。如果需要更长时间，说明：
- 要么本次产出过多（考虑拆分会话）
- 要么分类/路由规则不清晰（需要改进规范）

---

## 4. 变更分类 (CLASSIFY)

### 4.1 分类决策树

```
本次会话产生了什么？
    │
    ├─ 什么都没产生 ──────────────────────→ No-Op
    │
    ├─ 只是讨论/探索，没有结论 ───────────→ Log-Only
    │
    ├─ 项目状态/任务进度有变化 ───────────→ State-Update
    │
    ├─ 获得了新的洞见/方法论/经验 ────────→ Knowledge
    │   │
    │   ├─ 这是全新的独立概念 ────────────→ Knowledge-Discovery
    │   ├─ 这是对旧概念的更深理解 ────────→ Knowledge-Refinement
    │   └─ 这是对旧认知的纠错 ────────────→ Knowledge-Correction
    │
    └─ 以上多种情况都有 ──────────────────→ Mixed (拆分处理)
```

### 4.2 各分类判断标准

| 分类 | 判断问题 | 示例 |
|:-----|:---------|:-----|
| **No-Op** | 本次会话是否产生了任何值得持久化的内容？ | 简单问答、查阅已有文档 |
| **State-Update** | 项目/任务的"当前状态"是否变了？ | 任务完成、项目更名、新增交付物 |
| **Knowledge-Discovery** | 这是一个全新的、独立的洞见吗？ | 首次发现某个模式、新术语定义 |
| **Knowledge-Refinement** | 这是对已有洞见的补充/深化吗？ | 更好的类比、更精确的表述 |
| **Knowledge-Correction** | 之前的认知是否有事实性错误？ | 路径错误、概念混淆 |
| **Log-Only** | 这只是过程记录，没有结论性内容？ | 会议发言、调试过程、探索尝试 |
| **Mixed** | 以上多种情况同时存在？ | 完成任务 + 获得新洞见 |

---

## 5. 分流路由 (ROUTE)

### 5.1 三层架构

```
┌─────────────────────────────────────────────────────────┐
│  L1 索引层 (index.md)                                   │
│  ─────────────────────────────────────────────────────  │
│  隐喻: Dashboard / L1 Cache                             │
│  原则: ≤300 行，只放指针和摘要                          │
│  内容: 身份、当前任务、洞见索引（不展开）、链接          │
│                                                         │
│  读取频率: 每次会话                                     │
│  写入频率: 高（但每次写入量小）                          │
└─────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────┐
│  L2 摘要层 (meta-cognition.md / knowledge/*.md)         │
│  ─────────────────────────────────────────────────────  │
│  隐喻: Settings / Wiki                                  │
│  原则: 主题聚类，非时序排列                              │
│  内容: 思维方式、方法论、领域特定知识                    │
│                                                         │
│  读取频率: 按需加载                                     │
│  写入频率: 中（主题更新时）                              │
└─────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────┐
│  L3 详情层 (handoffs/ / meeting/ / archive/)            │
│  ─────────────────────────────────────────────────────  │
│  隐喻: History Log / Tape Backup                        │
│  原则: Write-once, Read-rarely                          │
│  内容: 完整报告、会议记录、归档内容                      │
│                                                         │
│  读取频率: 极少（需要时检索）                            │
│  写入频率: 每次任务完成                                  │
└─────────────────────────────────────────────────────────┘
```

### 5.2 路由规则表

| 内容类型 | 目标层级 | 目标文件 | 备注 |
|:---------|:---------|:---------|:-----|
| 身份/职责定义 | L1 | `index.md` | SSOT，只能覆盖 |
| 当前任务状态 | L1 | `index.md` | SSOT，只能覆盖 |
| 洞见摘要（1-3行） | L1 | `index.md` | 带链接指向详情 |
| 思维方式/偏好 | L2 | `meta-cognition.md` | 相对静态 |
| 项目特定知识 | L2 | `knowledge/<project>.md` | 主题聚类 |
| Key-Note 消化 | L2 | `key-notes-digest.md` | 专用文件 |
| 实现报告 | L3 | `handoffs/*-IMP.md` | 外置详情 |
| 调查报告 | L3 | `handoffs/*-INV.md` | 外置详情 |
| 验证报告 | L3 | `handoffs/*-QA.md` | 外置详情 |
| 会议发言 | L3 | `meeting/*.md` | 不复制到 index.md |
| 过期内容 | L3 | `archive/*.md` | 维护时归档 |

### 5.3 20 行阈值规则

> **[MUST]** 超过 20 行的内容，必须外置到 L2/L3 层，index.md 只留摘要 + 链接。

**示例**：

❌ **错误**：把完整的实现报告（200行）写入 index.md

✅ **正确**：
```markdown
## 最近交付

- 2025-12-22: RBF 命名重构 → [详情](../../handoffs/2025-12-22-rbf-rename-IMP.md)
```

---

## 6. 写入操作 (APPLY)

### 6.1 操作语义总览

| 操作 | 数据库等价 | 触发条件 | 对旧内容的处理 |
|:-----|:-----------|:---------|:---------------|
| **OVERWRITE** | `UPDATE` | 当前真值变更 | 直接替换 |
| **APPEND** | `INSERT` | 新增独立知识 | 保留旧内容 |
| **MERGE** | `UPSERT` | 旧知识精炼 | 合并到旧条目 |
| **REWRITE** | `UPDATE` | 事实性纠错 | 改正旧条目 |
| **TOMBSTONE** | `UPDATE SET deprecated` | 弃用/翻转 | 标记废弃 |

### 6.2 各操作详解

#### OVERWRITE（覆盖）

**触发条件**：
- 项目状态变更（进行中 → 完成）
- 任务更新（新任务替代旧任务）
- 事实性信息变更（路径更新、名称更改）

**操作**：找到 SSOT 区块，直接替换内容。

**示例**：
```markdown
# 之前
## 当前任务
- [ ] 实现 RBF 解析器

# 之后（OVERWRITE）
## 当前任务
- [x] 实现 RBF 解析器 ✅ 2025-12-22
- [ ] 实现 RBF 写入器
```

#### APPEND（追加）

**触发条件**：
- 全新的、独立的洞见
- 新增的项目关联
- 新的交付物索引

**操作**：在对应区块末尾追加新条目。

**示例**：
```markdown
# 之前
## 方法论洞见
1. Primary Definition + Index 模式

# 之后（APPEND）
## 方法论洞见
1. Primary Definition + Index 模式
2. Memory Commit Protocol（分类→路由→执行）  ← 新增
```

#### MERGE（合并）

**触发条件**：
- 对已有洞见的更深理解
- 更好的表述/类比
- 补充细节

**操作**：找到旧条目，将新内容合并进去，更新时间戳。

**示例**：
```markdown
# 之前
## 方法论洞见
1. Primary Definition + Index 模式：术语应集中管理

# 之后（MERGE）
## 方法论洞见
1. Primary Definition + Index 模式：核心定义只在一处，其他地方用链接引用
   - 避免定义漂移
   - 更新只需改一处
   - (2025-12-20 refined: 从"集中管理"演进为"单一定义+索引")
```

#### REWRITE（重写）

**触发条件**：
- 发现之前记录的事实错误
- 路径/名称已过时
- 概念理解有误

**操作**：直接修正旧条目正文，末尾标注修正日期。

**示例**：
```markdown
# 之前
## 项目路径
- StateJournal 文档：`DurableHeap/docs/`  ← 错误！

# 之后（REWRITE）
## 项目路径
- StateJournal 文档：`atelia/docs/StateJournal/`
  (修正于 2025-12-21: DurableHeap 已更名并迁移)
```

#### TOMBSTONE（墓碑）

**触发条件**：
- 术语/方案被弃用
- 决策被翻转
- 旧概念不再适用

**操作**：对旧条目添加删除线 + Deprecated 标记 + 指向替代方案。

**示例**：
```markdown
# 之前
## 术语表
- **ELOG**：Extensible Log Framing

# 之后（TOMBSTONE）
## 术语表
- ~~**ELOG**~~：~~Extensible Log Framing~~ **[Deprecated 2025-12-22]**
  → 已更名为 **RBF** (Reversible Binary Framing)
- **RBF**：Reversible Binary Framing（新）
```

---

## 7. 关键规则

### 7.1 SSOT 唯一性

> **[MUST]** 以下区块是 SSOT，必须全局唯一，只能 OVERWRITE：

| SSOT 区块 | 说明 |
|:----------|:-----|
| 身份描述 | "我是谁" |
| 当前任务 | "我正在做什么" |
| 项目状态表 | 各项目的当前状态 |
| 关键路径 | 文件位置、入口点 |

**验证方法**：同一实体（如"StateJournal 状态"）在 index.md 中只应出现一次。

### 7.2 墓碑机制

> **[MUST]** 弃用的术语/方案，必须显式标记废弃，不能只是"不再提及"。

**原因**：LLM 可能在未来会话中"幻觉"出旧术语，显式墓碑利用 Negative Constraint 防止复发。

### 7.3 Memory Commit Message

> **[SHOULD]** 每次 Memory Commit 后，在 index.md 的"最后更新"区块留下简短 ChangeLog。

**格式**：
```markdown
## 最后更新

- 2025-12-23: Memory Commit - State(任务完成) + Knowledge(新增洞见#5)
- 2025-12-22: Memory Commit - Tombstone(ELOG→RBF)
```

### 7.4 链接完整性

> **[SHOULD]** 外置到 L3 层的内容，必须在 index.md 留下有效链接。

> **[SHOULD]** 定期检查链接是否失效（link rot）。

---

## 8. 系统提示词范本

以下是可直接嵌入各成员系统提示词的 OnSessionEnd 模板。

### 8.1 完整版（推荐用于首次部署）

```markdown
## ⚠️ 收尾协议 (OnSessionEnd)

在向用户输出最终回复**之前**，必须执行 Memory Commit Protocol：

### Step 1: CLASSIFY (分类)

判断本次会话产生了什么类型的变更：

| 分类 | 判断标准 | 下一步 |
|:-----|:---------|:-------|
| **No-Op** | 无持久化价值（简单问答、查阅文档） | 跳过写入 |
| **State-Update** | 任务/项目状态变更 | → Step 2 |
| **Knowledge** | 新洞见/方法论/经验 | → Step 2 |
| **Log-Only** | 纯过程记录，无结论 | 只写 meeting/，index.md 留索引 |
| **Mixed** | 多种类型 | 拆分后分别处理 |

### Step 2: ROUTE (路由)

根据内容类型选择目标文件：

| 内容 | 目标文件 | 行数限制 |
|:-----|:---------|:---------|
| 状态/身份/当前任务 | `index.md` | SSOT 区块 |
| 洞见摘要 | `index.md` | ≤3 行 |
| 洞见详情 | `knowledge/*.md` 或链接到 meeting/ | 无限制 |
| 思维方式/偏好 | `meta-cognition.md` | 主题聚类 |
| 完整报告 | `handoffs/` | 无限制 |

> **20 行阈值**：超过 20 行的内容 MUST 外置，index.md 只留链接。

### Step 3: APPLY (执行)

选择正确的写入操作：

| 情况 | 操作 | 动作 |
|:-----|:-----|:-----|
| 状态变更 | **OVERWRITE** | 替换 SSOT 区块 |
| 全新独立洞见 | **APPEND** | 追加新条目 |
| 旧洞见精炼 | **MERGE** | 合并到旧条目 |
| 事实性纠错 | **REWRITE** | 改正旧条目 |
| 术语/方案弃用 | **TOMBSTONE** | 标记 ~~废弃~~ |

### Step 4: Memory Commit Message

在 index.md 的"最后更新"区块留下记录：
```
- YYYY-MM-DD: Memory Commit - <分类>(<摘要>)
```

### 输出顺序纪律

1. **先完成所有工具调用**（包括 Memory Commit）
2. **最后一次性输出完整回复**
3. 不要在最终回复后再调用工具
```

### 8.2 精简版（适合空间受限的提示词）

```markdown
## ⚠️ OnSessionEnd: Memory Commit Protocol

**60秒内完成**：CLASSIFY → ROUTE → APPLY

### CLASSIFY (这是什么？)
- No-Op: 无价值 → 不写
- State: 状态变 → OVERWRITE
- Knowledge: 新洞见 → APPEND/MERGE
- Log: 过程 → 外置，留索引

### ROUTE (写到哪？)
- index.md: ≤300行，只放摘要+链接
- meta-cognition.md: 思维方式
- handoffs/meeting/: 详情外置

### APPLY (怎么写？)
| 操作 | 触发 |
|:-----|:-----|
| OVERWRITE | 状态真值变了 |
| APPEND | 新的独立洞见 |
| MERGE | 旧洞见更深理解 |
| REWRITE | 事实性纠错 |
| TOMBSTONE | 术语/方案废弃 |

> **20行规则**: >20行必须外置，index.md只留链接

**先写入，后回复。**
```

### 8.3 快速参考卡片（可贴在提示词末尾）

```markdown
---
## 📋 Memory Commit 快速参考

```
OnSessionEnd 检查清单：
□ 本次有持久化价值吗？(No → 跳过)
□ 是状态更新？→ OVERWRITE SSOT区块
□ 是新洞见？→ APPEND (独立) 或 MERGE (精炼)
□ 是纠错？→ REWRITE 改正文
□ 是废弃？→ TOMBSTONE 加删除线
□ 超过20行？→ 外置到 handoffs/meeting/
□ 更新"最后更新"区块
□ 先写入，后回复
```
---
```

---

## 附录 A：反模式检测

| 反模式 | 症状 | 检测方法 |
|:-------|:-----|:---------|
| **Append-Only 堆积** | index.md 无限增长 | `wc -l index.md` > 500 |
| **双真相** | 同一实体有多个矛盾条目 | grep 同一实体名，看是否多处 |
| **墓碑缺失** | 旧术语仍在使用 | grep 已废弃术语 |
| **详情内联** | index.md 有大段完整报告 | 检查是否有 >20 行的连续块 |
| **元信息漂移** | "最后更新"与实际不符 | 对比文件修改时间 |

---

## 附录 B：畅谈会贡献者

本规范整合自 2025-12-22 全员畅谈会的共识：

| 成员 | 核心贡献 |
|:-----|:---------|
| **Seeker** | 记忆 .gitignore 隐喻、分类决策树、覆盖规则 |
| **Curator** | Git Commit Wizard、Librarian Persona、渐进披露、三层架构 |
| **Craftsman** | MM-TRIG/MM-ROUTE/MM-WRITE 条款、可追溯协议 |
| **Implementer** | 实战痛点、60 秒原则、meta-cognition 定位 |
| **Investigator** | 过程产物外置模式、Brief 链接实践 |
| **QA** | 测试用例设计、数据库操作类比、NO-OP/EXTERNAL-REF |
| **DocOps** | 三层分类规范、Changefeed Anchor、索引健康度 |
| **CodexReviewer** | PR 门禁类比、SSOT 唯一性断言、REWRITE 语义 |

---

## 变更日志

| 版本 | 日期 | 变更 |
|:-----|:-----|:-----|
| 1.0 | 2025-12-23 | 初始版本，整合畅谈会共识 |
