# 外部记忆维护配方 (External Memory Maintenance Recipe)

> AI Team 外部记忆文件的维护方法论。
> 本文件是 Team Leader 维护认知文件系统的 SSOT。
>
> **版本**: 2.0.0
> **创建**: 2025-12-26
> **来源**: status.md 重构实践

---

## 概述

### 什么是外部记忆

AI Agent 的认知连续性依赖**外部记忆文件**——这些文件是 Agent 的"本体"，而非会话或模型。

> **核心隐喻**：外部记忆是 Agent 的"大脑皮层"，会话是"工作记忆"。
> 
> 工作记忆（上下文窗口）有限且易失，大脑皮层（外部文件）持久且可扩展。

### 为什么需要维护

外部记忆文件会自然**熵增**：
- 信息堆积但不整理
- 状态过时但不更新
- 细节淹没结构

**不维护的后果**：
- 新会话唤醒效率降低（读取大量过时信息）
- 决策依据不准确（基于过时状态）
- Token 浪费（加载无用内容）

### 核心原则

1. **活性知识内联（Active Knowledge Inlining）**
  - **MUST**：凡会影响“下一次同类决策”的知识，必须在 `index.md` 内联为可读的最小自包含片段（不依赖外链补全）。
  - **SHOULD**：外链仅承载“深挖细节/证据/历史上下文”。

2. **密度优先于行数（Density > Line Budget）**
  - **MUST**：维护目标首先是提高洞见密度，其次才是压缩行数。
  - **SHOULD**：允许不同角色在不同密度目标下拥有不同的行数区间。

3. **写入时分类（Write-time Classification）**
  - **MUST**：新内容写入时就归类到 Identity/Insight/Index/Inbox/Archive 之一。
  - **MUST NOT**：把已确认洞见长期堆在“最后更新/最近进展”区块。

4. **仪表盘可扫描（Scan-first Layout）**
  - **MUST**：`index.md` 的 H2/H3 结构应支持“扫描定位”，而非线性叙事。
  - **SHOULD**：优先表格/短列表/锚点化标题，降低连续段落比例。

5. **死知识归档与不可变历史（Archive as Immutable Evidence）**
  - **MUST**：会议记录等 Archive 类文件只追加不修改；`index.md` 只保留摘要与指针。
  - **SHOULD**：归档按主题组织（必要时可采用“两级归档”作为后悔药）。

6. **维护闭环（Close the Loop）**
  - **MUST**：每次维护结束写一条便签（inbox），记录本次维护触发信号、采取动作、结果指标。

---

## 增量维护 Quick Start

> 目标：把“维护”从低频大修，降级为高频小步。

### 模式定义

- **首次维护（First Maintenance / Deep Rewrite）**：结构不稳定或分类混乱，需要重建信息架构与写入纪律。
- **增量维护（Incremental Maintenance）**：结构稳定，只做提纯洞见、更新索引、清理噪声。

### 切换标准（满足则进入“增量维护常态”）

- **[SW-STRUCTURE-STABLE]**：`index.md` 已存在稳定结构（Identity/Insight/Index/Archive 指针），且最近 2 次维护未发生大幅重排。
- **[SW-WRITE-DISCIPLINE]**：最近 10 次新增内容中，≥ 80% 能直接落入 Insight/Index/Inbox（而不是堆到“最后更新/最近进展”）。
- **[SW-DENSITY-NOT-LOW]**：洞见密度不低于该角色最低线（见“洞见密度测量与角色化策略”）。

### 失稳信号 → 托住动作（对照表）

| 失稳信号（可观察） | 托住动作（可执行） |
|---|---|
| “最后更新/最近进展”连续堆积 ≥ 30 行 | 把已确认洞见提纯进 Insight；未确认内容保留在 Inbox |
| 同一概念出现 ≥ 2 条互相冲突表述 | 选定“当前结论”为主；旧结论移入 Archive 并保留指针 |
| 扫读 30 秒仍找不到“我是谁/我怎么决策/我最近学到什么” | 重排 H2/H3；把关键原则前置；压缩连续段落为表格/短列表 |
| 洞见密度跌破阈值 | 合并重复洞见；删除过程记录；把细节迁到 Archive |

### 深度重写门槛（满足其一 → 触发 First Maintenance）

- **MUST**：当结构层级无法稳定定位（同一内容多处重复且合并成本高）时，执行深度重写。
- **MUST**：当连续 2 次增量维护后洞见密度仍无法恢复到最低线时，执行深度重写。
- **SHOULD**：当角色/职责发生实质变更（Identity 不再成立）时，执行深度重写。

---

## 洞见密度测量与角色化策略

### 洞见密度定义

洞见密度：

$$
D = \frac{I}{L} \times 100\%
$$

- $I$：`index.md` 中以 `- [I-###]` 标记的洞见条目数量
- $L$：`index.md` 总行数

> **MUST**：若要使用密度指标，`index.md` 的洞见条目必须使用可机械计数的标记（推荐 `- [I-###]`）。

### 统计命令（grep 示例）

```bash
# L = 总行数
wc -l agent-team/members/<Name>/index.md

# I = 洞见数（按 - [I-###] 计数）
grep -nE '^\s*-\s*\[I-[0-9]+\]' agent-team/members/<Name>/index.md | wc -l
```

### 角色差异化阈值（最低线）

| 角色类型 | 描述 | 最低线 |
|---|---|---|
| **原则导向（Principle-oriented）** | 以方法论/透镜为主，追求高密度结晶 | **D ≥ 3%** |
| **情境导向（Context-oriented）** | 需要保留关键决策上下文与协作线索 | **D ≥ 1.5%** |
| **操作导向（Operation-oriented）** | 需要可执行步骤/边界条件/失败模式 | **D ≥ 1%** |

> **SHOULD**：阈值用于“是否失稳”的报警线，不是压缩竞赛。

### 冷启动三问测试（防止指标绑架）

> **MUST**：任何密度优化都必须通过该测试；未通过则回滚“为了数字而删减”的改动。

只读取 `index.md`，在 60 秒内能回答：
1. 我是谁？
2. 我怎么决策？
3. 我最近学到的 3 条可复用洞见是什么？

---

## 文件类型元模型

### 六种文件类型

| 类型 | 代表文件 | 隐喻 | 写入模式 | 维护策略 |
|:-----|:---------|:-----|:---------|:---------|
| **Dashboard** | status.md | 仪表盘 | 覆盖 | 定期刷新快照 |
| **Identity** | index.md | 身份证 | 积累+整理 | 定期 Rewrite |
| **TaskQueue** | todo.md, task-board.md | 待办清单 | 增删 | 完成即删除 |
| **Inbox** | inbox.md | 收件箱 | 只追加 | Keeper 整理 |
| **Archive** | meeting/*.md | 档案馆 | 只追加 | 不修改，可索引 |
| **Recipe** | how-to/*.md | 配方书 | 版本演进 | 持续完善 |

### 各类型详解

#### Dashboard（仪表盘类）

**代表**：`status.md`

**核心问题**：现在在哪里？

**特征**：
- 只反映"当前状态"，不记录历史
- 可以完全覆盖更新
- 应该能在 30 秒内扫完

**维护信号**：
- 最后更新超过 3 天
- 重大里程碑完成后
- 项目状态发生变化

**维护方法**：
1. 收集最新状态数据（可委派 Investigator）
2. 按仪表盘结构重写
3. 旧的详细内容移入归档或删除

**反模式**：
- ❌ 在"最近更新"里堆积多个里程碑
- ❌ 保留已完成的 Sprint 进度
- ❌ 详细的会议产出表格

---

#### Identity（身份认知类）

**代表**：`members/{specialist}/index.md`

**核心问题**：我是谁？我怎么工作？

**特征**：
- 核心身份相对稳定
- 近期洞见不断积累
- 需要定期整理压缩

**维护信号**：
- 洞见章节超过 10 条
- 有重复或冲突的内容
- 结构变得混乱

**维护方法**：
1. 保持核心身份章节稳定
2. 洞见章节定期归档（移入 lessons-learned.md）
3. 过时信息删除，有价值的压缩保留

---

#### TaskQueue（待办事项类）

**代表**：`todo.md`、`task-board.md`

**核心问题**：接下来做什么？

**特征**：
- 完成即删除
- 层次表达目标拆分
- 每个叶子节点应有上下文指针

**维护信号**：
- 存在已完成但未删除的任务
- 任务描述与当前状态不符
- 优先级需要调整

**维护方法**：
1. 删除已完成任务
2. 更新进行中任务的状态
3. 重新评估优先级

---

#### Inbox（便签收集类）

**代表**：`members/{specialist}/inbox.md`

**核心问题**：有什么新想法/经验？

**特征**：
- 只追加，不修改
- 写入门槛极低
- 由 MemoryPalaceKeeper 定期整理

**维护信号**：
- 便签数量超过 10 条
- 存在可归类的便签

**维护方法**：
- **Specialist**：只管写便签
- **MemoryPalaceKeeper**：定期整理归档

---

#### Archive（档案馆类）

**代表**：`meeting/*.md`、`archive/*.md`

**核心问题**：发生过什么？

**特征**：
- 只追加，不修改（历史不可变）
- 可以添加索引和摘要
- 完整保留原始记录

**维护信号**：
- 通常不需要维护
- 可以建立索引便于查找

**维护方法**：
- 不修改原始内容
- 可在独立索引文件中建立引用

---

#### Recipe（配方书类）

**代表**：`how-to/*.md`

**核心问题**：怎么做这件事？

**特征**：
- 版本演进
- 持续完善
- 应用经验反馈

**维护信号**：
- 实践中发现不足
- 有新的最佳实践
- 需要适应新场景

**维护方法**：
1. 记录版本变更
2. 保持向后兼容（或明确 breaking change）
3. 从实践中提炼改进

---

## 维护流程

### 识别维护需求

**主动检查**（建议每次会话开始）：

```
OnSessionStart:
  1. 读取 status.md → 检查最后更新日期
  2. 读取 inbox.md → 检查便签数量
  3. 读取 todo.md → 检查任务状态
  
  If 任一文件需要维护:
    优先级判断 → 决定是否本次会话处理
```

**被动触发**：
- 重大里程碑完成后
- 监护人明确要求
- 发现信息明显过时

### 标准维护流程

```
┌─────────────────────────────────────────────────────────┐
│  Phase 1: 诊断 (Diagnose)                               │
│  - 识别文件类型                                          │
│  - 评估过时程度                                          │
│  - 确定维护范围                                          │
└───────────────────────────┬─────────────────────────────┘
                            ▼
┌─────────────────────────────────────────────────────────┐
│  Phase 2: 设计 (Design)                                 │
│  - 可选：咨询 Advisor 设计策略                           │
│  - 确定新结构/内容                                       │
│  - 识别需要收集的数据                                    │
└───────────────────────────┬─────────────────────────────┘
                            ▼
┌─────────────────────────────────────────────────────────┐
│  Phase 3: 收集 (Collect)                                │
│  - 委派 Investigator 收集状态数据                        │
│  - 或自行读取相关文件                                    │
│  - 整理待更新的内容                                      │
└───────────────────────────┬─────────────────────────────┘
                            ▼
┌─────────────────────────────────────────────────────────┐
│  Phase 4: 执行 (Execute)                                │
│  - 按文件类型选择维护方法                                │
│  - Dashboard: 覆盖重写                                   │
│  - Identity: 整理压缩                                    │
│  - TaskQueue: 增删更新                                   │
└───────────────────────────┬─────────────────────────────┘
                            ▼
┌─────────────────────────────────────────────────────────┐
│  Phase 5: 闭环 (Close)                                  │
│  - 写便签记录本次维护经验                                │
│  - 如有方法论洞见，考虑更新 Recipe                        │
└─────────────────────────────────────────────────────────┘
```

### 委派模式

**何时委派**：
- 需要收集多项目状态 → Investigator
- 需要设计策略 → Seeker
- 需要验证一致性 → Craftsman

**何时自己做**：
- 简单的状态更新
- 删除已完成任务
- 小范围修改

---

## 便签写作规范

> 便签的"可整理性"80% 取决于写入时的结构。
> 好的便签是"对未来的自己的礼貌"。

### 最小规范（3 条）

#### [NOTE-SINGLE] 一条便签一件事

- **MUST**：每条便签只包含一个主题
- **MUST NOT**：把一天的工作流水全倒进一条便签

#### [NOTE-CLASSIFY] 自带分类标记

- **SHOULD**：便签开头用 `[State]`/`[Discovery]`/`[Question]` 标记类型
- **SHOULD**：如果是对已有洞见的补充，显式引用（如"关于 [I-S-007] 的补充"）

#### [NOTE-DISTILL] 洞见要提炼成可迁移形式

- **MUST**：如果便签包含洞见，至少写一句"可迁移的判断"

**示例**：

| ❌ 事件描述 | ✅ 事件 + 可迁移教训 |
|:-----------|:--------------------|
| "今天发现 DirtySet 有 Bug" | "DirtySet 同步 Bug 的根因是：状态更新时机早于事件发布。**教训：状态变更应在事件 handler 确认后再提交。**" |

### 分类信号词表

| 信号词 | 对应类型 | 目标区块 | 操作 |
|:-------|:---------|:---------|:-----|
| "完成了"、"已实现"、"搞定" | State | 状态区块 | OVERWRITE |
| "发现"、"原来"、"洞见"、"教训" | Discovery | 洞见区块 | APPEND |
| "补充"、"关于之前的"、"另外" | Refinement | 已有条目 | MERGE |
| "错了"、"应该是"、"纠正" | Correction | 已有条目 | REWRITE |
| "废弃"、"不再用"、"改为" | Tombstone | 旧条目 | 删除线 |

### 便签模板

```markdown
## 便签 YYYY-MM-DD HH:MM

**类型**：[State | Discovery | Refinement | Correction | Tombstone]

**内容**：
<你的内容>

**可迁移洞见**（如有）：
> <一句可复用的判断或教训>

---
```

### MERGE 判断启发式

| 情况 | 决策 | 理由 |
|:-----|:-----|:-----|
| 同一主题多条便签 | MERGE | 避免重复，保持信息密度 |
| 全新独立洞见 | APPEND | 新条目，不与旧内容混淆 |
| 对已有洞见的扩展 | MERGE | 增强而非重复 |
| 显式引用前一条便签 | MERGE | 信息凝聚力更高 |
| 包含多列对比表格 | APPEND | 表格本身就是压缩后的形式 |

> **经验法则**：如果新便签本质是"已有洞见的另一实例"，应 MERGE 而非 APPEND。

### 洞见标号规范

- **谁来打标**：MemoryPalaceKeeper 在整理时打标，便签作者无需关心
- **命名空间**：每个成员独立编号
  - Seeker 的洞见：`[I-S-001]`、`[I-S-002]`...
  - Craftsman 的洞见：`[I-C-001]`、`[I-C-002]`...
  - Implementer 的洞见：`[I-I-001]`、`[I-I-002]`...
- **不可回收**：废弃的洞见保留编号，加 Tombstone 标记

---

## Dashboard 维护详解

> Dashboard（仪表盘）是最常需要维护的类型，本节提供详细指南。

### 核心设计原则

> **"仪表盘，不是航行日志。"**
>
> 只回答"现在在哪里"，不回答"做过什么"或"要做什么"。

| 原则 | 说明 |
|:-----|:-----|
| **快照原则** | 可完全覆盖更新，而非追加 |
| **30 秒原则** | 应能在 30 秒内扫完核心状态 |
| **链接原则** | 详细信息通过链接访问 |

### 推荐结构

```markdown
# Project Status Snapshot

## 最近更新 (YYYY-MM-DD)
# ← 只保留最新一条里程碑

## 🎯 当前焦点
# ← 2-3 个当前推进中的工作流

## 📦 项目状态仪表盘
# ← 每个项目 2-4 行状态

## 🧠 团队/技术状态
# ← 相对稳定的结构信息

## 🔗 Key References
# ← 索引链接
```

### 每个项目的状态格式

```markdown
### ProjectName
| 维度 | 状态 |
|:-----|:-----|
| **Tier** | N — 状态描述 |
| **测试** | XXX passed |
| **入口** | [link](path) |

> 一句话描述
```

### 维护检查清单

- [ ] 最近更新只保留一条
- [ ] 当前焦点是真正的当前工作
- [ ] 每个项目状态反映最新情况
- [ ] 没有已完成的历史 Sprint 信息
- [ ] 没有详细的会议产出表格
- [ ] 链接都是有效的

---

## 常见问题

### Q1: 多久维护一次？

**Dashboard**：每次重大里程碑后，或超过 3 天未更新
**Identity**：每 1-2 周，或洞见超过 10 条
**TaskQueue**：每次任务完成后
**Inbox**：由 MemoryPalaceKeeper 定期处理

### Q2: 维护 vs 新建？

如果文件已严重过时（>50% 内容需要修改），考虑完全重写而非逐条修改。

### Q3: 如何避免维护负担？

- **即时原则**：完成任务后立即更新相关文件
- **便签缓冲**：不确定的内容先写便签，定期整理
- **委派分担**：利用 SubAgent 收集数据

### Q4: 历史信息如何保留？

- **Archive 类**：原样保留在 meeting/ 或 archive/
- **Dashboard 类**：压缩为里程碑表的一行
- **Identity 类**：移入 lessons-learned.md

---

## 附录

### 附录 A: 文件类型速查表

| 文件 | 类型 | 维护频率 | 维护方法 |
|:-----|:-----|:---------|:---------|
| status.md | Dashboard | 每里程碑 | 覆盖重写 |
| index.md | Identity | 1-2周 | 整理压缩 |
| todo.md | TaskQueue | 每任务 | 增删更新 |
| task-board.md | TaskQueue | 每任务 | 增删更新 |
| inbox.md | Inbox | Keeper处理 | 只追加 |
| meeting/*.md | Archive | 不维护 | 只追加 |
| how-to/*.md | Recipe | 按需 | 版本演进 |

---

## 变更日志

| 版本 | 日期 | 变更 |
|------|------|------|| 2.1.0 | 2026-01-02 | 新增"便签写作规范"章节（NOTE-SINGLE/NOTE-CLASSIFY/NOTE-DISTILL、信号词表、模板、MERGE启发式、洞见标号规范）|| 2.0.0 | 2026-01-02 | 重写核心原则（6条）；新增“增量维护 Quick Start”“洞见密度测量与角色化策略” |
| 1.0.0 | 2025-12-26 | 初始版本，来自 status.md 重构实践 |
