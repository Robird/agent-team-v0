# 外部记忆维护配方 (External Memory Maintenance Recipe)

> AI Team 外部记忆文件的维护方法论。
> 本文件是 Team Leader 维护认知文件系统的 SSOT。
>
> **版本**: 2.5.0
> **创建**: 2025-12-26
> **来源**: status.md 重构实践

---

## 维护入口与流程

本配方主要由 **[Batch Process Inbox](batch-process-inbox.md)** 流程在检测到记忆文件失稳时调用。

### 增量维护快速入口 (Quick Start)
**场景**：被调用维护 `index.md` (行数>500 或 密度低)。
**动作**：
1. 读取 `index.md`。
2. 参照「增量维护 Quick Start」章节的「失稳信号 → 托住动作」表执行。
3. 输出维护报告。

### 标准维护流程 (Standard Process)
**场景**：里程碑完成或进行深度重构时。
1. **诊断 (Diagnose)**：识别文件类型与过时程度。
2. **设计 (Design)**：确定新结构（可选咨询 Advisor）。
3. **收集 (Collect)**：获取状态数据（可选委派 Investigator）。
4. **执行 (Execute)**：按文件类型维护（Dashboard覆盖/Identity压缩/Task增删）。
5. **闭环 (Close)**：写便签记录经验。

---

## 概述

### 什么是外部记忆

AI Agent 的认知连续性依赖**外部记忆文件**——这些文件是 Agent 的"本体"，而非会话或模型。

> **核心隐喻**：外部记忆是 Agent 的"大脑皮层"，会话是"工作记忆"。
> 
> 工作记忆（上下文窗口）有限且易失，大脑皮层（外部文件）持久且可扩展。

### 为什么需要维护

外部记忆文件会自然**熵增**：
- 信息堆积但不整理
- 状态过时但不更新
- 细节淹没结构

**不维护的后果**：
- 新会话唤醒效率降低（读取大量过时信息）
- 决策依据不准确（基于过时状态）
- Token 浪费（加载无用内容）

### 核心原则

1. **活性知识内联（Active Knowledge Inlining）**
  - **MUST**：凡会影响“下一次同类决策”的知识，必须在 `index.md` 内联为可读的最小自包含片段（不依赖外链补全）。
  - **SHOULD**：外链仅承载“深挖细节/证据/历史上下文”。

2. **密度优先于行数（Density > Line Budget）**
  - **MUST**：维护目标首先是提高洞见密度，其次才是压缩行数。
  - **SHOULD**：允许不同角色在不同密度目标下拥有不同的行数区间。

3. **写入时分类（Write-time Classification）**
  - **MUST**：新内容写入时就归类到 Identity/Insight/Index/Inbox/Archive 之一。
  - **MUST NOT**：把已确认洞见长期堆在“最后更新/最近进展”区块。  - **澄清**：写入时分类 ≠ 立即归类——尚未成熟的洞见可先归入 Inbox 孵化，设"7天/下次维护必须处理"时限。
4. **仪表盘可扫描（Scan-first Layout）**
  - **MUST**：`index.md` 的 H2/H3 结构应支持“扫描定位”，而非线性叙事。
  - **SHOULD**：优先表格/短列表/锚点化标题，降低连续段落比例。

5. **死知识归档与不可变历史（Archive as Immutable Evidence）**
  - **MUST**：会议记录等 Archive 类文件只追加不修改；`index.md` 只保留摘要与指针。
  - **SHOULD**：归档按主题组织（必要时可采用“两级归档”作为后悔药）。

6. **维护闭环（Close the Loop）**
  - **MUST**：每次维护结束写一条便签（inbox），记录本次维护触发信号、采取动作、结果指标。

---

## 增量维护 Quick Start

> 目标：把“维护”从低频大修，降级为高频小步。

### 模式定义

- **首次维护（First Maintenance / Deep Rewrite）**：结构不稳定或分类混乱，需要重建信息架构与写入纪律。
- **增量维护（Incremental Maintenance）**：结构稳定，只做提纯洞见、更新索引、清理噪声。

### 切换标准（满足则进入“增量维护常态”）

- **[SW-STRUCTURE-STABLE]**：`index.md` 已存在稳定结构（Identity/Insight/Index/Archive 指针），且最近 2 次维护未发生大幅重排。
- **[SW-WRITE-DISCIPLINE]**：最近 10 次新增内容中，≥ 80% 能直接落入 Insight/Index/Inbox（而不是堆到“最后更新/最近进展”）。
- **[SW-DENSITY-NOT-LOW]**：洞见密度不低于该角色最低线（见“洞见密度测量与角色化策略”）。

### 失稳信号 → 托住动作（对照表）

| 失稳信号（可观察） | 托住动作（可执行） |
|---|---|
| “最后更新/最近进展”连续堆积 ≥ 30 行 | 把已确认洞见提纯进 Insight；未确认内容保留在 Inbox |
| 同一概念出现 ≥ 2 条互相冲突表述 | 选定"当前结论"为主；旧结论移入 Archive 并保留指针 |
| 洞见存在演进关系（A → B → C） | 保留最新版本为主；旧版本标注"演进自 X / 被 Y 取代"移 Archive |
| 扫读 30 秒仍找不到"我是谁/我怎么决策/我最近学到什么" | 重排 H2/H3；把关键原则前置；压缩连续段落为表格/短列表 |
| 洞见密度跌破阈值 | 合并重复洞见；删除过程记录；把细节迁到 Archive |

### 深度重写门槛（满足其一 → 触发 First Maintenance）

- **MUST**：当结构层级无法稳定定位（同一内容多处重复且合并成本高）时，执行深度重写。
- **MUST**：当连续 2 次增量维护后洞见密度仍无法恢复到最低线时，执行深度重写。
- **SHOULD**：当角色/职责发生实质变更（Identity 不再成立）时，执行深度重写。

---

## 洞见密度测量与角色化策略

### 洞见密度定义

洞见密度：

$$
D = \frac{I}{L} \times 100\%
$$

- $I$：`index.md` 中以 `- [I-###]` 标记的洞见条目数量
- $L$：`index.md` 总行数

> **MUST**：若要使用密度指标，`index.md` 的洞见条目必须使用可机械计数的标记（推荐 `- [I-###]`）。

### 非标准格式降级路径

> **适用场景**：使用层级标题/主题区块组织洞见，未采用 `[I-###]` 标记的用户。

**如果你的文件不符合标准标记格式**，跳过密度公式，改用**手工三问测试**：
1. 30秒内能定位"我是谁/我怎么决策"？
2. 能列出**最新或最重要**的 3 条可复用洞见？
3. 主干结构（H2/H3）是否清晰、无重复？

三问全通过 → 健康；有一问未通过 → 需要维护。

### 统计命令（grep 示例）

```bash
# L = 总行数
wc -l agent-team/members/<Name>/index.md

# I = 洞见数（按 - [I-###] 计数）
grep -nE '^\s*-\s*\[I-[0-9]+\]' agent-team/members/<Name>/index.md | wc -l
```

### 角色差异化阈值（最低线）

| 角色类型 | 描述 | 最低线 |
|---|---|---|
| **原则导向（Principle-oriented）** | 以方法论/透镜为主，追求高密度结晶 | **D ≥ 3%** |
| **情境导向（Context-oriented）** | 需要保留关键决策上下文与协作线索 | **D ≥ 1.5%** |
| **操作导向（Operation-oriented）** | 需要可执行步骤/边界条件/失败模式 | **D ≥ 1%** |

> **SHOULD**：阈值用于“是否失稳”的报警线，不是压缩竞赛。

### 冷启动三问测试（防止指标绑架）

> **MUST**：任何密度优化都必须通过该测试；未通过则回滚“为了数字而删减”的改动。

只读取 `index.md`，在 60 秒内能回答：
1. 我是谁？
2. 我怎么决策？
3. 我最近学到的 3 条可复用洞见是什么？

---

## 文件类型元模型

### 六种文件类型

| 类型 | 代表文件 | 隐喻 | 写入模式 | 维护策略 |
|:-----|:---------|:-----|:---------|:---------|
| **Dashboard** | status.md | 仪表盘 | 覆盖 | 定期刷新快照 |
| **Identity** | index.md | 身份证 | 积累+整理 | 定期 Rewrite |
| **TaskQueue** | todo.md, task-board.md | 待办清单 | 增删 | 完成即删除 |
| **Inbox** | inbox.md | 收件箱 | 只追加 | Keeper 整理 |
| **Archive** | meeting/*.md | 档案馆 | 只追加 | 不修改，可索引 |
| **Recipe** | how-to/*.md | 配方书 | 版本演进 | 持续完善 |

### 各类型详解

#### Dashboard（仪表盘类）

**代表**：`status.md` · **核心问题**：现在在哪里？

**原则**：快照（覆盖更新）、30秒可扫完、详情走链接。

**维护方法**：
1. **收集**：获取最新状态（可委派 Investigator）。
2. **重写**：按结构覆盖旧内容。
3. **清理**：旧细节移入归档或删除。

**推荐结构**：
```markdown
# Project Status Snapshot
## 最近更新 (YYYY-MM-DD) # ← 只保留最新一条里程碑
## 🎯 当前焦点 # ← 2-3 个当前推进中的工作流
## 📦 项目状态仪表盘 # ← 每个项目 2-4 行状态
## 🧠 团队/技术状态 # ← 相对稳定的结构信息
## 🔗 Key References # ← 索引链接
```

**检查清单**：
- [ ] 最近更新只保留一条
- [ ] 当前焦点是真正的当前工作
- [ ] 没有已完成的历史 Sprint 信息
- [ ] 链接都是有效的

---

#### Identity（身份认知类）

**代表**：`members/{specialist}/index.md`

**核心问题**：我是谁？我怎么工作？

##### 角色定位：驾驶舱仪表盘

> **核心隐喻**：index.md 既不是导航页（太薄），也不是完整手册（太厚），而是"唤醒后立即可用的决策支持系统"。

**关键约束**：
- **[HC-INDEX-ONLY]**：默认假设唤醒阶段只读取 `index.md`。
- **推论**：index.md 必须做到"自包含地支持当下决策"，链接仅用于"存在性标记/深入入口"。

**仪表盘特点**：一眼扫过即可判断状态，而非逐条阅读。

##### 四层结构

| 层级 | 内容 | 稳定性 |
|:-----|:-----|:-------|
| **Who I am** | 身份定位 | 固定 |
| **How I think** | 方法论和决策原则 | 相对稳定 |
| **What I remember** | 关键洞见精华（活性知识） | 动态积累 |
| **Where to find more** | 索引指针 | 需要时主动加载 |

##### "活性知识"判断：三个问题

决定一条知识是否应该保留在 index.md 时，问自己：

1. **下次被唤醒时，如果不记得这条，我会做出不同的决策吗？**
   - 是 → 活性知识，保留
   - 否 → 候选归档

2. **这条知识是"原则"还是"实例"？**
   - 原则（如"Error as Navigation"）→ 保留
   - 实例（如"12-26 会议中提出"）→ 归档

3. **这条知识有"生成新洞见"的能力吗？**
   - 能与新情境碰撞产生新想法 → 保留
   - 只是单次事件的记录 → 归档

##### 推荐结构模板

```markdown
# <Name> — 认知入口

> **身份三句话**（5秒内建立"我是谁"）

---

## 我是谁（Identity）

### 人格特质
（表格形式，一眼扫过）

### 在团队中的角色
（与他人的关系定位）

### 专长领域
（能力边界声明）

---

## 核心洞见（Insight）

### 1. <领域名>
> **核心理念**: 一句话。

- **<概念名>**: 解释 + 隐喻 + 可迁移原则
- ...

---

## 参与历史索引（Index）

（表格形式，提供"存在性信号"而非"完整内容"）

---

## 认知文件结构

（导航地图，知道更多内容在哪）
```

##### 特征

- 核心身份相对稳定
- 近期洞见不断积累
- 需要定期整理压缩

##### 维护信号

- 洞见章节超过 10 条
- 有重复或冲突的内容
- 结构变得混乱
- 扫读 30 秒仍找不到"我是谁/我怎么决策/我最近学到什么"

##### 维护方法

1. 保持核心身份章节稳定
2. 用"三个问题"判断知识活性，归档死知识
3. 洞见章节定期归档（移入 lessons-learned.md）
4. 过时信息删除，有价值的压缩保留

---

#### TaskQueue（待办事项类）

**代表**：`todo.md`、`task-board.md`

**核心问题**：接下来做什么？

**特征**：
- 完成即删除
- 层次表达目标拆分
- 每个叶子节点应有上下文指针

**维护信号**：
- 存在已完成但未删除的任务
- 任务描述与当前状态不符
- 优先级需要调整

**维护方法**：
1. 删除已完成任务
2. 更新进行中任务的状态
3. 重新评估优先级

---

#### Inbox（便签收集类）

**代表**：`members/{specialist}/inbox.md` · **核心问题**：有什么新想法/经验？

**特征**：只追加不修改，由 MemoryPalaceKeeper 定期整理。

**孵化功能**：Inbox 同时承担"洞见孵化器"角色——尚未成熟、跨越多主题、或需要延迟归类的内容可暂存于此，设 **7天/下次维护必须处理** 时限，届时提纯为 Insight 或移入 Archive。

**写作规范（3条）**：
1. **[NOTE-SINGLE]**：一条便签一件事。
2. **[NOTE-CLASSIFY]**：开头标记类型（`[State]`/`[Discovery]`/`[Question]`）。
3. **[NOTE-DISTILL]**：洞见需提炼为"可迁移判断"。

**信号词与操作**：
- "完成了/搞定" → `[State]` → 覆盖状态区块
- "发现/教训" → `[Discovery]` → 追加洞见区块
- "补充/纠正" → `[Refinement]` → 合并/重写已有条目

**便签模板**：
```markdown
## 便签 YYYY-MM-DD HH:MM
**类型**：[State | Discovery | Refinement | Correction | Tombstone]
**内容**：<你的内容>
**可迁移洞见**：> <一句可复用的判断或教训>
---
```

---

#### Archive（档案馆类）

**代表**：`meeting/*.md`、`archive/*.md`

**核心问题**：发生过什么？

**特征**：
- 只追加，不修改（历史不可变）
- 可以添加索引和摘要
- 完整保留原始记录

**维护信号**：
- 通常不需要维护
- 可以建立索引便于查找

**维护方法**：
- 不修改原始内容
- 可在独立索引文件中建立引用

---

#### Recipe（配方书类）

**代表**：`how-to/*.md`

**核心问题**：怎么做这件事？

**特征**：
- 版本演进
- 持续完善
- 应用经验反馈

**维护信号**：
- 实践中发现不足
- 有新的最佳实践
- 需要适应新场景

**维护方法**：
1. 记录版本变更
2. 保持向后兼容（或明确 breaking change）
3. 从实践中提炼改进

---

## 常见问题

### Q1: 维护 vs 新建？

如果文件已严重过时（>50% 内容需要修改），考虑完全重写而非逐条修改。

### Q2: 如何避免维护负担？

- **即时原则**：完成任务后立即更新相关文件
- **便签缓冲**：不确定的内容先写便签，定期整理
- **委派分担**：利用 SubAgent 收集数据

### Q3: 历史信息如何保留？

- **Archive 类**：原样保留在 meeting/ 或 archive/
- **Dashboard 类**：压缩为里程碑表的一行
- **Identity 类**：移入 lessons-learned.md

---

## 变更日志

| 版本 | 日期 | 变更 |
|------|------|------|
| 2.5.0 | 2026-01-03 | 四项改进：(1) 澄清"写入时分类≠立即归类"；(2) 新增"非标准格式降级路径"；(3) 失稳信号表增加"演进关系处理"；(4) Inbox 明确"孵化功能" |
| 2.4.0 | 2026-01-02 | 移除触发逻辑：维护触发权移交至 batch-process-inbox，精简本配方为纯执行指南 |
| 2.3.0 | 2026-01-02 | 新增「触发场景」章节：区分被动触发与主动检查入口，与 batch-process-inbox.md 形成信息流闭环 |
| 2.2.0 | 2026-01-02 | 重写 Identity 类型详解：新增"驾驶舱仪表盘"隐喻、四层结构、活性知识判断三问、结构模板、HC-INDEX-ONLY 约束 |
| 2.1.0 | 2026-01-02 | 新增"便签写作规范"章节（NOTE-SINGLE/NOTE-CLASSIFY/NOTE-DISTILL、信号词表、模板、MERGE启发式、洞见标号规范）|
| 2.0.0 | 2026-01-02 | 重写核心原则（6条）；新增"增量维护 Quick Start""洞见密度测量与角色化策略" |
| 1.0.0 | 2025-12-26 | 初始版本，来自 status.md 重构实践 |
