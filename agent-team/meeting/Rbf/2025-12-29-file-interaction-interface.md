# ç•…è°ˆä¼šï¼šRBF æ–‡ä»¶äº¤äº’æ¥å£è®¾è®¡

> **æ—¥æœŸ**ï¼š2025-12-29
> **æ ‡ç­¾**ï¼š#design
> **ä¸»æŒäºº**ï¼šåˆ˜å¾·æ™º (StandardsChair)
> **å‚ä¸è€…**ï¼šAdvisor-Claude, Advisor-DeepSeek, Auditor
> **çŠ¶æ€**ï¼šè¿›è¡Œä¸­

---

## èƒŒæ™¯

**é—®é¢˜æ¥æº**ï¼šImplementer åœ¨ç°æœ‰æ–‡æ¡£æŒ‡å¯¼ä¸‹å®ç° RBF å±‚æ—¶ä¸¥é‡åç¦»è®¾è®¡ï¼Œç›‘æŠ¤äººå‘ç°æ ¹æœ¬åŸå› æ˜¯æ–‡æ¡£å±‚çº§è¾¹ç•Œæ¨¡ç³Šâ€”â€”StateJournal æ–‡æ¡£ä¸ RBF å®ç°ç»†èŠ‚æ··åœ¨ä¸€èµ·ï¼Œå¯¼è‡´æ³¨æ„åŠ›æº¢å‡ºã€‚

**å·²å®Œæˆçš„å·¥ä½œ**ï¼š
- RBF å±‚æ–‡æ¡£å·²åˆ†ç¦»åˆ° `atelia/docs/Rbf/`
- æ—§å®ç°å·²å½’æ¡£ï¼Œ`atelia/src` å’Œ `atelia/tests` ç°åœ¨æ˜¯å¹²å‡€çš„
- `rbf-interface.md` å®šä¹‰äº† `IRbfFramer` / `IRbfScanner` æ¥å£

**å½“å‰ç¼ºå¤±**ï¼š
- æ–‡ä»¶æ‰“å¼€/åˆ›å»ºçš„æ¥å£å¥‘çº¦ï¼ˆå¦‚ä½•ä»è·¯å¾„è·å¾— Framer/Scannerï¼Ÿï¼‰
- Flush / DurableFlush çš„è¯­ä¹‰è¾¹ç•Œï¼ˆå±äºæ–‡ä»¶çº§è¿˜æ˜¯ Framer çº§ï¼Ÿï¼‰
- æ–‡ä»¶ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ˆæ‰“å¼€ã€å…³é—­ã€å¼‚å¸¸å¤„ç†ï¼‰

## æ ¸å¿ƒé—®é¢˜

**è®¾è®¡ç›®æ ‡**ï¼šä¸º RBF å±‚å¢è¡¥"æ–‡ä»¶äº¤äº’æ¥å£"ï¼Œä½¿ä¸Šå±‚ï¼ˆStateJournalï¼‰èƒ½å¤Ÿï¼š
1. ä»æ–‡ä»¶è·¯å¾„æ‰“å¼€/åˆ›å»º RBF æ–‡ä»¶
2. è·å¾— `IRbfFramer` ç”¨äºå†™å…¥å¸§
3. è·å¾— `IRbfScanner` ç”¨äºè¯»å–å¸§
4. æ§åˆ¶æŒä¹…åŒ–ï¼ˆFlush / DurableFlushï¼‰
5. æ­£ç¡®å…³é—­æ–‡ä»¶

**è®¾è®¡çº¦æŸ**ï¼ˆç›‘æŠ¤äººæ˜ç¡®ï¼‰ï¼š
- **æ’é™¤ä¼ å…¥ Backend æ–¹æ¡ˆ**ï¼šå³ä½¿å†…éƒ¨éœ€è¦ Backend æŠ½è±¡ï¼Œå¯¹å¤–ä¹Ÿä¸æš´éœ²
- **æ ¸å¿ƒç”¨ä¾‹**ï¼šAgent é‡å¯åï¼Œæ‰‹é‡Œåªæœ‰æ–‡ä»¶è·¯å¾„ï¼Œéœ€è¦é‡å»ºçŠ¶æ€
- **æœ¬è´¨åŠŸèƒ½**ï¼šä»è·¯å¾„æ‰“å¼€æ–‡ä»¶ â†’ ä»¥ Binary Frame ä¸ºå•ä½è¯»å†™

**å¾…è®¨è®ºçš„ç„¦ç‚¹**ï¼š
1. **æ¥å£å½¢çŠ¶**ï¼šå•ä¸€ `IRbfFile` è¿˜æ˜¯åˆ†ç¦»çš„å·¥å‚æ–¹æ³•ï¼Ÿ
2. **èµ„æºç®¡ç†**ï¼šFramer/Scanner çš„ç”Ÿå‘½å‘¨æœŸä¸æ–‡ä»¶å¥æŸ„çš„å…³ç³»ï¼Ÿ
3. **å¹¶å‘è¯­ä¹‰**ï¼šå…è®¸å¤šä¸ª Framer/Scanner å®ä¾‹å—ï¼Ÿ
4. **é”™è¯¯å¤„ç†**ï¼šæ–‡ä»¶æŸåã€æƒé™é”™è¯¯çš„å¼‚å¸¸ç­–ç•¥ï¼Ÿ

## ğŸ’¬ ç•…è°ˆè®°å½•

---

## ğŸ¯ ç»“è®ºåŒæ­¥å—ï¼ˆåŠ¨æ€æ›´æ–°ï¼‰

### éœ€æ±‚åˆ†æç»“è®ºï¼ˆåŸºäº StateJournal çœŸå®ç”¨ä¾‹ï¼‰

| éœ€æ±‚é¡¹ | å…·ä½“æè¿° | æ¥å£è¦æ±‚ |
|:-------|:---------|:---------|
| **åŒæ–‡ä»¶æ¨¡å¼** | Dataï¼ˆå¯¹è±¡ç‰ˆæœ¬ï¼‰+ Metaï¼ˆCommit æ—¥å¿—ï¼‰ | æ¯ä¸ªæ–‡ä»¶ç‹¬ç«‹ `IRbfFile` |
| **æ‰“å¼€æ—¶è¯»å–** | Meta é€†å‘æ‰«ææ‰¾ HEADï¼ˆå«æ’•è£‚æ£€æµ‹ `[R-META-AHEAD-BACKTRACK]`ï¼‰ | `ScanReverse()` |
| **è¿è¡Œæ—¶è¯»å–** | é€šè¿‡ Address64 éšæœºè¯»å–ï¼ˆLazy Load è§¦å‘ï¼‰| `TryReadAt(Address64)` |
| **Commit æµç¨‹** | 2 æ¬¡ DurableFlushï¼ˆData â†’ Meta é¡ºåºï¼‰ | `DurableFlush()` |
| **æ¢å¤æµç¨‹** | æŒ‰ DataTail æˆªæ–­ Data æ–‡ä»¶ | `Truncate(newLength)` + `LengthBytes` |
| **ç”Ÿå‘½å‘¨æœŸ** | é•¿æœŸæŒæœ‰æ–‡ä»¶å¥æŸ„ï¼ˆè¿›ç¨‹çº§ï¼‰ | `Dispose()` |

### å·²å½¢æˆå…±è¯†

| å†³ç­–ç‚¹ | å…±è¯† | æ”¯æŒè€… |
|:-------|:-----|:-------|
| **å…¥å£ç‚¹å½¢çŠ¶** | `IRbfFile` å•ä¸€å…¥å£ç‚¹ | Claude, DeepSeek, Auditor |
| **åˆ›å»ºæ–¹å¼** | `CreateNew` vs `OpenExisting` æ˜¾å¼åˆ†ç¦» | Claude, DeepSeek, ç›‘æŠ¤äºº |
| **æŒä¹…åŒ–æ§åˆ¶** | `DurableFlush()` åœ¨æ–‡ä»¶çº§ | Claude, DeepSeek, Auditor |
| **Dispose å¹‚ç­‰æ€§** | å¿…é¡»å¹‚ç­‰ | Auditor |
| **D2: Create å¯¹å·²æœ‰æ–‡ä»¶** | **FailIfExists** | **ç›‘æŠ¤äººè£å†³** |
| **D3: Scanner å®ä¾‹æ•°** | **å•ä¾‹**ï¼ˆè‡³å°‘ MVPï¼‰ | **ç›‘æŠ¤äººè£å†³** |

### å…³é”®çº æ­£ï¼ˆAuditorï¼‰

| åŸåˆ¤æ–­ | çº æ­£ |
|:-------|:-----|
| "è·Ÿéšè§†å›¾ä¸éœ€è¦" | ä»…å¯¹ `ScanReverse` æˆç«‹ï¼›`TryReadAt` **å¿…é¡»**æ”¯æŒæ–‡ä»¶å¢é•¿æœŸé—´è¯»å– |
| "Scanner æ˜¯ä¸€æ¬¡æ€§å·¥å…·" | Scanner æ˜¯"é•¿æœŸéšæœºè¯»è€…"ï¼ˆLazy Load çƒ­è·¯å¾„ï¼‰ |
| "åŠŸèƒ½å®Œå¤‡" | **ç¼ºå¤±** `LengthBytes` å’Œ `Truncate(newLength)` |

### MVP æ¥å£æ”¶æ•›

```csharp
public interface IRbfFile : IDisposable {
    string Path { get; }
    ulong LengthBytes { get; }              // â† æ–°å¢ï¼ˆDataTail æ ¡éªŒï¼‰
    
    IRbfFramer CreateFramer();              // å•ä¾‹ï¼ˆç¬¬äºŒæ¬¡è°ƒç”¨æŠ›å¼‚å¸¸ï¼‰
    IRbfScanner CreateScanner();            // å•ä¾‹ï¼ˆMVPï¼‰
    
    void DurableFlush();
    void Truncate(ulong newLengthBytes);    // â† æ–°å¢ï¼ˆæ¢å¤æˆªæ–­ï¼‰
}

public static class RbfFile {
    public static IRbfFile CreateNew(string path);       // FailIfExists
    public static IRbfFile OpenExisting(string path);    // éªŒè¯ Genesis
}
```

### å¾…è§„èŒƒåŒ–çš„å…³é”®å¥‘çº¦ï¼ˆAuditor è¯†åˆ«ï¼‰

| # | å¥‘çº¦ | å¯åˆ¤å®šæ€§è¦æ±‚ |
|:--|:-----|:-------------|
| 1 | `TryReadAt(Address64)` åœ¨æ–‡ä»¶å¢é•¿æœŸé—´çš„è¡Œä¸º | ä»¥"è°ƒç”¨æ—¶åˆ»"æ–‡ä»¶å†…å®¹ä¸ºå‡†ï¼›EOF å¤–è¿”å› `false` |
| 2 | `ScanReverse()` æ‰«æçª—å£ | å½“å‰ï¼šå¹¶å‘ä¿®æ”¹æœªå®šä¹‰ï¼›å¯è€ƒè™‘ï¼šå›ºå®šä¸ºè°ƒç”¨æ—¶ EOF |
| 3 | `DurableFlush()` è¾¹ç•Œ | åªä¿è¯æœ¬æ–‡ä»¶ï¼›ä¸å½±å“å…¶ä»–æ–‡ä»¶å®ä¾‹ |
| 4 | `Truncate(newLength)` å Address64 å¤±æ•ˆè¯­ä¹‰ | è¢«æˆªæ–­åŒºé—´çš„åœ°å€åç»­ `TryReadAt` å¿…é¡»è¿”å› `false` |
| 5 | `CreateFramer()` ç¬¬äºŒæ¬¡è°ƒç”¨ | æŠ› `InvalidOperationException` |
| 6 | `LengthBytes` è¯­ä¹‰ | OS è§†è§’çš„å½“å‰æ–‡ä»¶é•¿åº¦ï¼ˆbyteï¼‰ |

### è§„èŒƒå·¥ä½œé‡ï¼ˆæ›´æ–°ï¼‰

- **æ–°å¢æ¥å£æˆå‘˜**ï¼š`LengthBytes` + `Truncate(newLength)`
- **æ–°å¢æ¡æ¬¾**ï¼š12-18 æ¡ï¼ˆå« 6 ä¸ªå…³é”®å¥‘çº¦ï¼‰
- **ä¿®è®¢æ¡æ¬¾**ï¼š1-3 æ¡ï¼ˆ`IRbfFramer.Flush()` remarksï¼‰
- **æ–°å¢ç¤ºä¾‹**ï¼š3-5 ä¸ªï¼ˆOpenâ†’æ‰«æâ†’éšæœºè¯»ï¼›Commit æµç¨‹ï¼›æ¢å¤æˆªæ–­ï¼‰

---

## ç¬¬äºŒè½®æ¶æ„å…±è¯†

### ç›‘æŠ¤äººæè®®ï¼ˆç¬¬äºŒè½®ï¼‰

| æè®® | æè¿° |
|:-----|:-----|
| **åˆ†å±‚** | Aå±‚ï¼ˆæ ¼å¼ç»„ä»¶ï¼Œå¯æµ‹è¯•ï¼‰+ Bå±‚ï¼ˆå¥æŸ„ç®¡ç†ï¼Œæå°‘å•å…ƒæµ‹è¯•ï¼‰ |
| **FaÃ§ade** | å¸¸è§„è·¯å¾„ç®€åŒ– + ç¾éš¾æ¢å¤ç‹¬ç«‹ ToolKit |
| **FramePtr** | å‡çº§ Address64ï¼Œå«åç§»é‡+é•¿åº¦ï¼Œæ‰“åŒ…ä¸º ulong |
| **åº•å±‚ API** | RandomAccess vs Streamï¼Ÿç¼“å­˜ç­–ç•¥ï¼Ÿå¯æµ‹è¯•æ€§ï¼Ÿ |

### å‚è°‹å…±è¯†ï¼ˆç¬¬äºŒè½®ï¼‰

| å†³ç­–ç‚¹ | å…±è¯† | æ”¯æŒè€… |
|:-------|:-----|:-------|
| **åˆ†å±‚åˆç†æ€§** | âœ… ç¬¦åˆä¾èµ–å€’ç½®ï¼Œæµ‹è¯•æ€§è¾¹ç•Œæ¸…æ™° | Claude, DeepSeek |
| **FaÃ§ade æ¨¡å¼** | âœ… å¸¸è§„ vs é«˜çº§åˆ†ç¦»æ­£ç¡®ï¼Œéœ€æ¥å£éš”ç¦»é˜² God Object | Claude, DeepSeek |
| **FramePtr Bit åˆ†é…** | âœ… 44:20ï¼ˆ64TB / 4MBï¼‰ï¼Œæ»¡è¶³éœ€æ±‚ | Claude, Auditor |
| **åº•å±‚ API** | âœ… RandomAccessï¼ˆæ— çŠ¶æ€ï¼Œé…åˆ FramePtrï¼‰ | Claude, DeepSeek |
| **ç¼“å­˜ç­–ç•¥** | âœ… æš‚ä¸å®ç°ï¼ˆè¿‡æ—©ä¼˜åŒ–ï¼‰ | Claude, DeepSeek |
| **å¯æµ‹è¯•æ€§** | âœ… Aå±‚å†…å­˜æµ‹è¯•ï¼ŒBå±‚é›†æˆæµ‹è¯• | DeepSeek |

### å…³é”®è£å†³ç‚¹ï¼ˆAuditor è¯†åˆ«ï¼‰

| # | é—®é¢˜ | å½±å“ |
|:--|:-----|:-----|
| **R1** | Address64 â†’ FramePtr æ˜¯å®Œå…¨æ›¿æ¢è¿˜æ˜¯å¹¶å­˜ï¼Ÿ | Breaking change èŒƒå›´ |
| **R2** | è¶…è¿‡ 4MB çš„å¸§å¦‚ä½•å¤„ç†ï¼Ÿ | æ„é€ æœŸæ‹’ç» vs è¿è¡Œæ—¶æˆªæ–­ |
| **R3** | å‘åå…¼å®¹ç­–ç•¥ï¼šè½¯å…¼å®¹ï¼ˆé€æ˜è½¬æ¢ï¼‰vs ç¡¬è¿ç§»ï¼ˆæ˜¾å¼ç‰ˆæœ¬ï¼‰ï¼Ÿ | è¿ç§»è·¯å¾„ |

---

### ä¸»æŒäººå¼€åœº (åˆ˜å¾·æ™º)

å„ä½å‚è°‹ï¼Œè¿™æ˜¯ä¸€ä¸ªç›¸å¯¹çº¯ç²¹çš„æŠ€æœ¯æ¶æ„é—®é¢˜ã€‚æˆ‘ä¼šä¸ºæ¯ä½å‘è¨€è€…æä¾›ä»¥ä¸‹èƒŒæ™¯æ–‡ä»¶ï¼š
- `atelia/docs/Rbf/rbf-interface.md` â€” å½“å‰æ¥å£å¥‘çº¦ï¼ˆç¼ºæ–‡ä»¶äº¤äº’éƒ¨åˆ†ï¼‰
- `atelia/docs/Rbf/rbf-format.md` â€” RBF çº¿æ ¼å¼è§„èŒƒ
- `atelia/src/Data/IReservableBufferWriter.cs` â€” æ ¸å¿ƒæŠ½è±¡
- `atelia/src/Data/ChunkedReservableWriter.cs` â€” å®ç°å‚è€ƒï¼ˆæ³¨æ„ï¼šè¿™æ˜¯å”¯ä¸€ä¿ç•™çš„æ—§ä»£ç ï¼Œå› ä¸ºå®ƒæ˜¯é€šç”¨ç»„ä»¶ï¼‰

è¯·å…ˆä¸è¦æ€¥äºæå‡ºå®Œæ•´æ–¹æ¡ˆã€‚ç¬¬ä¸€è½®å‘è¨€ï¼Œæˆ‘å¸Œæœ›å¬åˆ°ï¼š
- **ä½ è®¤ä¸ºè¿™ä¸ªè®¾è®¡çš„å…³é”®å¼ åŠ›åœ¨å“ªé‡Œï¼Ÿ**ï¼ˆä»€ä¹ˆå› ç´ åœ¨ç›¸äº’åˆ¶çº¦ï¼Ÿï¼‰
- **æœ‰å“ªäº›éšå«çš„å‡è®¾éœ€è¦æ˜¾å¼åŒ–ï¼Ÿ**ï¼ˆä¾‹å¦‚ï¼šæ–‡ä»¶ç‹¬å ï¼Ÿè¯»å†™åˆ†ç¦»ï¼Ÿï¼‰
- **æœ‰å“ªäº›ç±»ä¼¼ç³»ç»Ÿçš„å‚è€ƒï¼Ÿ**ï¼ˆä¸å¿…æ˜¯ C#ï¼Œå¯ä»¥æ˜¯ä»»ä½•é¢†åŸŸçš„è®¾è®¡ï¼‰

ç°åœ¨é‚€è¯· Advisor-Claude å…ˆå‘è¨€ã€‚

---

### Advisor-Claude å‘è¨€ï¼ˆåŸºäºéœ€æ±‚é‡æ–°è®¾è®¡ï¼‰

> **åŸºäº**ï¼šStateJournal çœŸå®éœ€æ±‚è°ƒæŸ¥ï¼ˆÂ§ éœ€æ±‚åˆ†æç»“è®ºã€Auditor éªŒè¯ï¼‰
> **é‡ç‚¹**ï¼šæ¥å£å½¢çŠ¶è®¾è®¡ä¸å®ç°è¡”æ¥

#### 1. æ¥å£å½¢çŠ¶è®¾è®¡

```csharp
/// <summary>
/// RBF æ–‡ä»¶äº¤äº’å…¥å£ã€‚æŒæœ‰æ–‡ä»¶å¥æŸ„ï¼Œæä¾› Framer/Scanner è§†å›¾ä¸ durability æ§åˆ¶ã€‚
/// </summary>
public interface IRbfFile : IDisposable {
    /// <summary>æ–‡ä»¶è·¯å¾„ï¼ˆè¯Šæ–­ç”¨ï¼‰</summary>
    string Path { get; }
    
    /// <summary>å½“å‰æ–‡ä»¶é•¿åº¦ï¼ˆOS è§†è§’ï¼Œç”¨äº DataTail æ ¡éªŒï¼‰</summary>
    ulong LengthBytes { get; }
    
    /// <summary>åˆ›å»ºå†™å…¥å™¨ï¼ˆå•ä¾‹ï¼šç¬¬äºŒæ¬¡è°ƒç”¨æŠ› InvalidOperationExceptionï¼‰</summary>
    IRbfFramer CreateFramer();
    
    /// <summary>åˆ›å»ºæ‰«æå™¨ï¼ˆMVPï¼šå•ä¾‹ï¼‰</summary>
    IRbfScanner CreateScanner();
    
    /// <summary>å¼ºåˆ¶æ•°æ®è½ç›˜ï¼ˆfsync ç­‰ä»·ï¼‰</summary>
    void DurableFlush();
    
    /// <summary>æˆªæ–­æ–‡ä»¶åˆ°æŒ‡å®šé•¿åº¦ï¼ˆæ¢å¤æµç¨‹ç”¨ï¼‰</summary>
    void Truncate(ulong newLengthBytes);
}

/// <summary>å·¥å‚æ–¹æ³•ï¼šæ˜¾å¼åŒºåˆ†åˆ›å»ºä¸æ‰“å¼€</summary>
public static class RbfFile {
    /// <summary>åˆ›å»ºæ–°æ–‡ä»¶ï¼ˆå†™å…¥ Genesis Fenceï¼‰ã€‚è‹¥æ–‡ä»¶å·²å­˜åœ¨åˆ™å¤±è´¥ã€‚</summary>
    public static IRbfFile CreateNew(string path);
    
    /// <summary>æ‰“å¼€å·²æœ‰æ–‡ä»¶ï¼ˆéªŒè¯ Genesis Fenceï¼‰ã€‚è‹¥ä¸å­˜åœ¨æˆ–æŸååˆ™å¤±è´¥ã€‚</summary>
    public static IRbfFile OpenExisting(string path);
}
```

**ä¸ç°æœ‰æ¥å£çš„å…³ç³»**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    IRbfFile (æ–°å¢)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ IRbfFramer  â”‚  â”‚ IRbfScanner â”‚  â”‚ DurableFlush()  â”‚  â”‚
â”‚  â”‚   (å·²æœ‰)     â”‚  â”‚   (å·²æœ‰)     â”‚  â”‚ Truncate()     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ LengthBytes     â”‚  â”‚
â”‚                                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- `IRbfFramer` / `IRbfScanner`ï¼š**ä¿æŒä¸å˜**ï¼Œç”± `IRbfFile` åˆ›å»ºå¹¶ç®¡ç†ç”Ÿå‘½å‘¨æœŸ
- `IRbfFile`ï¼š**æ–°å¢**ï¼Œä½œä¸ºæ–‡ä»¶çº§èµ„æºæŒæœ‰è€…

#### 2. å…³é”®è®¾è®¡å†³ç­–

**D1ï¼šä¸ºä»€ä¹ˆé€‰æ‹©å•ä¸€å…¥å£ç‚¹ï¼Ÿ**

| éœ€æ±‚ | æ¥å£å¦‚ä½•æ»¡è¶³ |
|:-----|:-------------|
| é•¿æœŸæŒæœ‰å¥æŸ„ | `IRbfFile` æ˜¯è¿›ç¨‹çº§å•ä¾‹ï¼Œ`Dispose()` ä»…åœ¨å…³é—­æ—¶è°ƒç”¨ |
| ä¸¤æ–‡ä»¶ç‹¬ç«‹ç®¡ç† | ä¸Šå±‚å„æŒæœ‰ä¸€ä¸ª `IRbfFile` å®ä¾‹ï¼ˆData + Metaï¼‰ |
| Commit é¡ºåºæ§åˆ¶ | ä¸Šå±‚åˆ†åˆ«è°ƒç”¨ `dataFile.DurableFlush()` â†’ `metaFile.DurableFlush()` |

**D2ï¼šå¦‚ä½•æ”¯æŒ `TryReadAt` çš„å¢é•¿å¯è§æ€§ï¼Ÿ**

| å¥‘çº¦ | è¯­ä¹‰ |
|:-----|:-----|
| `TryReadAt(addr)` | ä»¥**è°ƒç”¨æ—¶åˆ»**çš„æ–‡ä»¶å†…å®¹ä¸ºå‡† |
| `addr` è¶…å‡ºå½“å‰ EOF | è¿”å› `false`ï¼ˆä¸æŠ›å¼‚å¸¸ï¼‰ |
| æ–‡ä»¶å¢é•¿åå†æ¬¡è°ƒç”¨ | å¯èƒ½è¿”å› `true`ï¼ˆæ–°å†™å…¥åŒºåŸŸå¯è§ï¼‰ |

**ç†ç”±**ï¼šStateJournal æ˜¯"é•¿ç”Ÿå‘½å‘¨æœŸæŒæœ‰å¥æŸ„ã€æŒç»­ append"çš„ç³»ç»Ÿã€‚Commit åå¯¹æ–°åœ°å€çš„è¯»å–æ˜¯çƒ­è·¯å¾„ï¼ˆLazy Loadï¼‰ã€‚

**D3ï¼šå¦‚ä½•æ”¯æŒæ¢å¤æµç¨‹ï¼Ÿ**

```csharp
// æ¢å¤æµç¨‹ï¼ˆStateJournal Openï¼‰
var meta = RbfFile.OpenExisting(metaPath);
var data = RbfFile.OpenExisting(dataPath);

// 1. é€†å‘æ‰«æ Meta æ‰¾ HEAD
var metaScanner = meta.CreateScanner();
MetaCommitRecord? head = null;
foreach (var frame in metaScanner.ScanReverse()) {
    if (TryParseCommitRecord(frame, out var record) 
        && record.DataTail <= data.LengthBytes) {  // â† ä½¿ç”¨ LengthBytes
        head = record;
        break;
    }
}

// 2. æŒ‰ DataTail æˆªæ–­ Data æ–‡ä»¶ï¼ˆæ¸…ç†åƒåœ¾ï¼‰
if (head != null && head.DataTail < data.LengthBytes) {
    data.Truncate(head.DataTail);  // â† ä½¿ç”¨ Truncate
}
```

**D4ï¼šä¸ºä»€ä¹ˆ Framer/Scanner æ˜¯å•ä¾‹ï¼Ÿ**

| è€ƒè™‘ | å†³ç­– |
|:-----|:-----|
| å•è¯»è€…å•å†™è€… | StateJournal æ˜ç¡®åŒçº¿ç¨‹æ“ä½œï¼Œä¸éœ€è¦å¤šå®ä¾‹ |
| ç®€åŒ–å®ç° | é¿å…å¤šå®ä¾‹çŠ¶æ€åŒæ­¥å¤æ‚æ€§ |
| å¯æ‰©å±•æ€§ | MVP å•ä¾‹ä¸é˜»ç¢æœªæ¥æ”¾å®½ï¼ˆä½†ä¸æ‰¿è¯ºï¼‰ |

#### 3. ä¸ç°æœ‰è§„èŒƒçš„è¡”æ¥

**éœ€è¦æ–°å¢çš„ç« èŠ‚**ï¼ˆå»ºè®® rbf-interface.md Â§5ï¼‰ï¼š

```markdown
## 5. æ–‡ä»¶äº¤äº’æ¥å£

### 5.1 IRbfFile
[A-RBF-FILE-INTERFACE] â€” æ¥å£å®šä¹‰
[S-RBF-FILE-SINGLE-FRAMER] â€” CreateFramer() å•ä¾‹çº¦æŸ
[S-RBF-FILE-DISPOSE-IDEMPOTENT] â€” Dispose() å¹‚ç­‰
[S-RBF-FILE-DURABLEFLUSH-DISPOSED] â€” disposed å DurableFlush æŠ›å¼‚å¸¸
[S-RBF-FILE-TRYREADAT-EOF] â€” TryReadAt çš„ EOF è¾¹ç•Œè¯­ä¹‰
[S-RBF-FILE-TRUNCATE-INVALIDATE] â€” Truncate ååœ°å€å¤±æ•ˆè¯­ä¹‰

### 5.2 RbfFile å·¥å‚
[S-RBF-FILE-CREATE-FAIL-IF-EXISTS] â€” CreateNew å¯¹å·²æœ‰æ–‡ä»¶å¤±è´¥
[S-RBF-FILE-OPEN-VERIFY-GENESIS] â€” OpenExisting éªŒè¯ Genesis
```

**éœ€è¦ä¿®è®¢çš„æ¡æ¬¾**ï¼š

| ç°æœ‰æ¡æ¬¾ | ä¿®è®¢å†…å®¹ |
|:---------|:---------|
| `IRbfFramer.Flush()` remarks | å°†"ç”±ä¸Šå±‚åœ¨å…¶æŒæœ‰çš„åº•å±‚å¥æŸ„ä¸Šæ‰§è¡Œ durable flush"æ”¹ä¸º"é€šè¿‡ `IRbfFile.DurableFlush()` æ‰§è¡Œ" |

**ä¿æŒä¸å˜**ï¼š
- `[S-RBF-FRAMER-NO-FSYNC]` â€” Flush ä¸å« fsyncï¼ˆä¸æ–°è®¾è®¡ä¸€è‡´ï¼‰
- `[S-RBF-SCANREVERSE-CONCURRENT-MUTATION]` â€” å¹¶å‘ä¿®æ”¹æœªå®šä¹‰ï¼ˆScanReverse å†·è·¯å¾„ï¼Œæ— éœ€æ›´ä¸¥æ ¼æ‰¿è¯ºï¼‰
- æ‰€æœ‰ `IRbfFramer` / `IRbfScanner` / `RbfFrame` çš„ç°æœ‰æ¡æ¬¾

#### 4. å®ç°æç¤ºï¼ˆInformativeï¼‰

**`TryReadAt` å¢é•¿å¯è§æ€§çš„å®ç°**ï¼š

```csharp
// å…³é”®ï¼šä¸ç¼“å­˜æ–‡ä»¶é•¿åº¦ï¼Œæ¯æ¬¡è¯»å–æ—¶æ£€æŸ¥å½“å‰ EOF
public bool TryReadAt(Address64 address, out RbfFrame frame) {
    // è·å–å½“å‰æ–‡ä»¶é•¿åº¦ï¼ˆOS è§†è§’ï¼‰
    var currentLength = _fileStream.Length;
    
    if (address.Value >= (ulong)currentLength) {
        frame = default;
        return false;  // è¶…å‡ºå½“å‰ EOF
    }
    
    // æ­£å¸¸è¯»å–...
}
```

**`Truncate` ååœ°å€å¤±æ•ˆçš„å®ç°**ï¼š

```csharp
public void Truncate(ulong newLengthBytes) {
    _fileStream.SetLength((long)newLengthBytes);
    // æ— éœ€é¢å¤–è®°å½•â€”â€”TryReadAt è‡ªç„¶åŸºäºæ–°çš„ EOF åˆ¤æ–­
}
```

**Framer/Scanner å•ä¾‹çš„å®ç°**ï¼š

```csharp
private IRbfFramer? _framer;

public IRbfFramer CreateFramer() {
    if (_framer != null)
        throw new InvalidOperationException("Framer already created");
    _framer = new RbfFramer(/* internal writer */);
    return _framer;
}
```

---

> æœ¬è®¾è®¡åŸºäº StateJournal çš„çœŸå®éœ€æ±‚ï¼Œå»é™¤äº†é€šç”¨åŒ–å‡è®¾å¸¦æ¥çš„å¤æ‚æ€§ã€‚
> æ¥å£å½¢çŠ¶"åˆšå¥½å¤Ÿç”¨"â€”â€”MVP ä¼˜å…ˆç®€å•ç›´æ¥ã€‚

---

### Advisor-DeepSeek å‘è¨€ï¼ˆåŸºäºçœŸå®ç”¨ä¾‹é‡æ–°è®¾è®¡ï¼‰

> **åŸºäº**ï¼šStateJournal å¯åŠ¨æ¢å¤ã€Lazy Loadã€Commit æµç¨‹
> **é‡ç‚¹**ï¼šçœŸå®åœºæ™¯çš„ DX/UX è¯„ä¼°ä¸ä¼˜åŒ–

#### 1. çœŸå®åœºæ™¯çš„ API ä½“éªŒè¯„ä¼°

**åœºæ™¯ Aï¼šå¯åŠ¨æ—¶æ¢å¤ï¼ˆMeta é€†å‘æ‰«æ + Data æˆªæ–­ï¼‰**

```csharp
// StateJournal.OpenExisting() å†…éƒ¨æµç¨‹
var metaFile = RbfFile.OpenExisting("state.meta.rbf");
var dataFile = RbfFile.OpenExisting("state.data.rbf");

// 1. é€†å‘æ‰«ææ‰¾ HEADï¼ˆå«æ’•è£‚æ£€æµ‹ï¼‰
var metaScanner = metaFile.CreateScanner();
MetaCommitRecord? head = null;
foreach (var frame in metaScanner.ScanReverse()) {
    if (TryDeserialize(frame, out var record)) {
        // âœ… ä½“éªŒå¥½ï¼šLengthBytes è¯­ä¹‰æ¸…æ™°ï¼ˆOS è§†è§’æ–‡ä»¶é•¿åº¦ï¼‰
        if (record.DataTail <= dataFile.LengthBytes) {
            head = record;
            break;
        }
    }
}

// 2. æ¢å¤æˆªæ–­ï¼ˆæ¸…ç†åƒåœ¾ï¼‰
if (head != null && head.DataTail < dataFile.LengthBytes) {
    // âœ… ä½“éªŒå¥½ï¼šTruncate è¯­ä¹‰æ˜ç¡®ï¼ˆç¼©çŸ­æ–‡ä»¶ï¼‰
    dataFile.Truncate(head.DataTail);
}
```

**ä½“éªŒè¯„ä¼°**ï¼š
- âœ… **ç›´è§‚æ€§**ï¼š`ScanReverse()` åç§°æ¸…æ™°ä¼ é€’"ä»å°¾åˆ°å¤´"è¯­ä¹‰
- âœ… **æ­£ç¡®æ€§è¾…åŠ©**ï¼š`LengthBytes` ä¸ `DataTail` å¯¹æ¯”æ˜¯è‡ªç„¶çš„æ•°å€¼æ¯”è¾ƒ
- âœ… **é”™è¯¯å‹å¥½æ€§**ï¼š`Truncate` çš„å‰ç½®æ¡ä»¶ï¼ˆâ‰¤å½“å‰é•¿åº¦ï¼‰å®¹æ˜“ç†è§£
- âš ï¸ **æ½œåœ¨å›°æƒ‘**ï¼š`ScanReverse()` è¿”å›ä»€ä¹ˆç±»å‹ï¼Ÿèƒ½å¦å­˜å‚¨åˆ°å˜é‡ï¼Ÿï¼ˆè§ Â§2 åæ¨¡å¼ï¼‰

---

**åœºæ™¯ Bï¼šè¿è¡Œæ—¶ Lazy Loadï¼ˆAddress64 éšæœºè¯»å–ï¼‰**

```csharp
// StateJournal.LoadObject<T>() å†…éƒ¨æµç¨‹
public T LoadObject<T>(ObjectId id) {
    // 1. æŸ¥æ‰¾ VersionIndex
    var addr = _versionIndex.Lookup(id);
    
    // 2. éšæœºè¯»å–ï¼ˆæ³¨æ„ï¼šæ–‡ä»¶åœ¨æŒç»­å¢é•¿ï¼‰
    var dataScanner = _dataFile.CreateScanner();
    // âœ… ä½“éªŒå¥½ï¼šTryReadAt æ˜¯"è¯•æ¢æ€§è¯»å–"ï¼ŒEOF å¤–è¿”å› false
    if (!dataScanner.TryReadAt(addr, out var frame)) {
        throw new ObjectNotFoundException(id);
    }
    
    // 3. Deserialize + Materialize
    return Materialize<T>(frame.Payload);
}
```

**ä½“éªŒè¯„ä¼°**ï¼š
- âœ… **ç›´è§‚æ€§**ï¼š`TryReadAt` éµå¾ª .NET çš„ `TryXxx` æ¨¡å¼ï¼ˆè¿”å› `bool`ï¼‰
- âœ… **å¢é•¿å¯è§æ€§**ï¼šå¼€å‘è€…è‡ªç„¶æœŸå¾…"å½“å‰æ—¶åˆ»èƒ½è¯»åˆ°ä»€ä¹ˆå°±è¯»ä»€ä¹ˆ"ï¼ˆè€Œéå¿«ç…§ï¼‰
- âš ï¸ **Address64 å¤±æ•ˆè¾¹ç•Œ**ï¼šå¦‚æœæ–‡ä»¶è¢«æˆªæ–­ï¼ˆåœºæ™¯ Aï¼‰ï¼Œæ—§åœ°å€ä¼šå¤±æ•ˆï¼Œä½† API å¦‚ä½•ä¼ é€’è¿™ä¸ªä¿¡æ¯ï¼Ÿï¼ˆè§ Â§2 åæ¨¡å¼ï¼‰
- âš ï¸ **Scanner ç”Ÿå‘½å‘¨æœŸ**ï¼š`CreateScanner()` å¤šæ¬¡è°ƒç”¨æ˜¯åˆ›å»ºæ–°å®ä¾‹è¿˜æ˜¯è¿”å›åŒä¸€ä¸ªï¼Ÿï¼ˆè§ Â§3ï¼‰

---

**åœºæ™¯ Cï¼šCommit æµç¨‹ï¼ˆäºŒé˜¶æ®µæäº¤ï¼‰**

```csharp
// StateJournal.Commit() å†…éƒ¨æµç¨‹
public void Commit() {
    // Phase 1: Data æ–‡ä»¶
    var dataFramer = _dataFile.CreateFramer();
    foreach (var obj in dirtyObjects) {
        dataFramer.Append(SerializeObjectVersion(obj));
    }
    dataFramer.Flush();          // âœ… æ¨é€ RBF ç¼“å†²åˆ° OS
    _dataFile.DurableFlush();    // âœ… Data å…ˆè½ç›˜
    
    // Phase 2: Meta æ–‡ä»¶
    var metaFramer = _metaFile.CreateFramer();
    var metaCommit = new MetaCommitRecord {
        DataTail = _dataFile.LengthBytes,  // â† Commit Point çš„"å¿«ç…§"
        // ...
    };
    metaFramer.Append(SerializeMetaCommit(metaCommit));
    metaFramer.Flush();
    _metaFile.DurableFlush();    // âœ… Meta åè½ç›˜ â†’ Commit Point
}
```

**ä½“éªŒè¯„ä¼°**ï¼š
- âœ… **æŒä¹…åŒ–è¯­ä¹‰æ¸…æ™°**ï¼šä¸‰å±‚åˆ†ç¦»ï¼ˆ`Flush` â†’ `DurableFlush` â†’ Commit Pointï¼‰æ˜“äºç†è§£
- âœ… **é¡ºåºæ§åˆ¶æ˜ç¡®**ï¼šä¸¤æ¬¡ `DurableFlush` çš„è°ƒç”¨é¡ºåºç›´æ¥æ˜ å°„åˆ°"Data å…ˆæŒä¹…åŒ–"éœ€æ±‚
- âš ï¸ **Framer å¤šæ¬¡åˆ›å»º**ï¼šæ¯æ¬¡ Commit éƒ½è°ƒç”¨ `CreateFramer()`ï¼Œæ˜¯å¦ä¼šå¤±è´¥ï¼Ÿï¼ˆè§ Â§2 åæ¨¡å¼ï¼‰
- âš ï¸ **LengthBytes æ—¶æœº**ï¼š`DataTail = _dataFile.LengthBytes` æ˜¯åœ¨ `DurableFlush()` ä¹‹å‰è¿˜æ˜¯ä¹‹åè¯»å–ï¼Ÿå½±å“æ­£ç¡®æ€§ï¼ˆè§ Â§4ï¼‰

---

#### 2. åæ¨¡å¼è¯†åˆ«ï¼ˆåŸºäºçœŸå®ç”¨ä¾‹ï¼‰

**åæ¨¡å¼ 1ï¼šè¯¯è®¤ä¸º ScanReverse() è¿”å›å¯æŒä¹…åŒ–é›†åˆ**

```csharp
// âŒ é”™è¯¯ï¼šè¯•å›¾å­˜å‚¨æšä¸¾ç»“æœ
var frames = metaScanner.ScanReverse();  // ref struct ä¸èƒ½å­˜å‚¨åˆ°å­—æ®µ
_cachedFrames = frames;  // ç¼–è¯‘é”™è¯¯ï¼

// âœ… æ­£ç¡®ï¼šç«‹å³æ¶ˆè´¹ï¼Œéœ€è¦æŒä¹…åŒ–åˆ™æ‹·è´
foreach (var frame in metaScanner.ScanReverse()) {
    if (NeedCache(frame)) {
        _cache.Add(frame.PayloadToArray());  // æ˜¾å¼æ‹·è´
    }
}
```

**æ ¹å› **ï¼š`ref struct` çš„"æŠ¤æ "è®¾è®¡ï¼ˆè§ [rbf-interface.md](../../atelia/docs/Rbf/rbf-interface.md) `[A-RBF-REVERSE-SEQUENCE]`ï¼‰
**æ”¹è¿›å»ºè®®**ï¼šåœ¨å¼‚å¸¸ä¿¡æ¯ä¸­æ˜ç¡®æç¤º"ä½¿ç”¨ PayloadToArray() æŒä¹…åŒ–æ•°æ®"

---

**åæ¨¡å¼ 2ï¼šå¿˜è®° Address64 å¤±æ•ˆåçš„å®¹é”™**

```csharp
// âŒ é”™è¯¯ï¼šå‡è®¾ Address64 æ°¸è¿œæœ‰æ•ˆ
var addr = versionIndex.Lookup(id);
// åæ¥æ–‡ä»¶è¢« Truncateï¼ˆæ¢å¤æµç¨‹ï¼‰
if (!dataScanner.TryReadAt(addr, out var frame)) {
    // å¼€å‘è€…å›°æƒ‘ï¼šä¸ºä»€ä¹ˆè¯»ä¸åˆ°ï¼Ÿæ˜æ˜ VersionIndex é‡Œæœ‰è¿™ä¸ªåœ°å€
}

// âœ… æ­£ç¡®ï¼šåœ¨ Truncate åé‡å»º VersionIndex
dataFile.Truncate(head.DataTail);
RebuildVersionIndex();  // æ¸…é™¤è¢«æˆªæ–­åŒºåŸŸçš„åœ°å€
```

**æ ¹å› **ï¼š`Truncate` ä½¿åœ°å€å¤±æ•ˆï¼Œä½† VersionIndex ä¸ä¼šè‡ªåŠ¨åŒæ­¥
**æ”¹è¿›å»ºè®®**ï¼š`Truncate` çš„æ–‡æ¡£åº”æ˜ç¡®"è°ƒç”¨åï¼Œæ‰€æœ‰ â‰¥ newLength çš„ Address64 å¤±æ•ˆ"

---

**åæ¨¡å¼ 3ï¼šåœ¨ DurableFlush å‰è¯»å– LengthBytes**

```csharp
// âŒ é”™è¯¯ï¼šé¡ºåºé”™è¯¯
dataFramer.Append(data);
dataFramer.Flush();
var dataT tail = dataFile.LengthBytes;  // â† å¯èƒ½è¿˜æœªåŒ…å«åˆš Append çš„æ•°æ®
dataFile.DurableFlush();

// âœ… æ­£ç¡®ï¼šå…ˆ DurableFlushï¼Œåè¯»å– LengthBytes
dataFramer.Append(data);
dataFramer.Flush();
dataFile.DurableFlush();               // â† ç¡®ä¿è½ç›˜
var dataTail = dataFile.LengthBytes;   // â† æ­¤æ—¶ LengthBytes æ˜¯å¯ä¿¡çš„
```

**æ ¹å› **ï¼š`Flush()` åªæ¨é€åˆ° OSï¼Œ`LengthBytes` åœ¨ OS è§†è§’å¯èƒ½è¿˜æœªæ›´æ–°
**æ”¹è¿›å»ºè®®**ï¼š`LengthBytes` æ–‡æ¡£åº”æ˜ç¡®"è¿”å›è°ƒç”¨æ—¶åˆ»çš„ OS è§†è§’é•¿åº¦"

---

**åæ¨¡å¼ 4ï¼šå¤šæ¬¡è°ƒç”¨ CreateFramer() å¯¼è‡´å¼‚å¸¸**

```csharp
// âŒ é”™è¯¯ï¼šæ¯æ¬¡ Commit éƒ½åˆ›å»ºæ–° Framer
public void Commit() {
    var framer = _dataFile.CreateFramer();  // ç¬¬ä¸€æ¬¡ OK
    // ...
}
public void Commit() {
    var framer = _dataFile.CreateFramer();  // ç¬¬äºŒæ¬¡æŠ›å¼‚å¸¸ï¼
}

// âœ… æ­£ç¡®ï¼šåœ¨æ„é€ æ—¶åˆ›å»ºå¹¶å¤ç”¨
private readonly IRbfFramer _dataFramer;
public StateJournal(RbfFile dataFile) {
    _dataFramer = dataFile.CreateFramer();  // ä»…åˆ›å»ºä¸€æ¬¡
}
```

**æ ¹å› **ï¼š`CreateFramer()` å•ä¾‹çº¦æŸï¼ˆç›‘æŠ¤äººè£å†³ï¼‰
**æ”¹è¿›å»ºè®®**ï¼šå¼‚å¸¸ä¿¡æ¯åº”æ˜ç¡®"Framer already exists, reuse the existing instance"

---

#### 3. å¿ƒæ™ºæ¨¡å‹å»ºè®®ï¼ˆåŸºäºçœŸå®ç”¨ä¾‹ï¼‰

**éšå–» 1ï¼šRbfFile åƒ"è¿›ç¨‹çº§æ–‡ä»¶ç§Ÿçº¦"**

| ä¼ ç»Ÿ FileStream | RbfFile (é•¿ç”Ÿå‘½å‘¨æœŸ) |
|:----------------|:---------------------|
| æ‰“å¼€ â†’ è¯»å†™ â†’ å…³é—­ | å¯åŠ¨æ—¶æ‰“å¼€ â†’ è¿›ç¨‹ç”Ÿå‘½å‘¨æœŸæŒæœ‰ â†’ å…³é—­æ—¶é‡Šæ”¾ |
| çŸ­ç”Ÿå‘½å‘¨æœŸï¼Œç”¨å®Œå³å…³ | é•¿ç”Ÿå‘½å‘¨æœŸï¼Œå…¨å±€å•ä¾‹ |
| æ¯æ¬¡æ“ä½œéƒ½é‡æ–°æ‰“å¼€ | ä¸€æ¬¡æ‰“å¼€ï¼ŒæŒç»­ä½¿ç”¨ |

**å…³é”®æ´è§**ï¼šå¼€å‘è€…åº”è¯¥æŠŠ `RbfFile` æƒ³è±¡æˆ"æ•°æ®åº“è¿æ¥"è€Œé"æ–‡ä»¶æµ"â€”â€”å®ƒæ˜¯ç¨€ç¼ºèµ„æºï¼Œéœ€è¦é•¿æœŸæŒæœ‰ã€‚

---

**éšå–» 2ï¼šTryReadAt çš„å¢é•¿å¯è§æ€§åƒ"æœ›è¿œé•œè§‚æµ‹å¢é•¿ä¸­çš„å½—æ˜Ÿ"**

```
æ—¶åˆ» T1ï¼šæ–‡ä»¶é•¿åº¦ = 100KB
  TryReadAt(addr=80KB) â†’ âœ… æˆåŠŸ
  TryReadAt(addr=120KB) â†’ âŒ è¶…å‡º EOF

æ—¶åˆ» T2ï¼šAppend + Flush åï¼Œæ–‡ä»¶é•¿åº¦ = 150KB
  TryReadAt(addr=120KB) â†’ âœ… æˆåŠŸï¼ˆæ–°æ•°æ®å¯è§ï¼‰
```

**å…³é”®æ´è§**ï¼š`TryReadAt` ä¸æ˜¯å¿«ç…§ï¼Œè€Œæ˜¯"å®æ—¶è§‚æµ‹"â€”â€”æ–‡ä»¶å¢é•¿åï¼Œæ–°åœ°å€å˜å¾—å¯è¯»ã€‚è¿™ç¬¦åˆ"æŒç»­ Append çš„æ—¥å¿—æ–‡ä»¶"ç›´è§‰ã€‚

---

**éšå–» 3ï¼šFlush ä¸‰å±‚æ¬¡åƒ"å¿«é€’å‘è´§æµç¨‹"**

| æ“ä½œ | å¿«é€’ç±»æ¯” | æ•°æ®ä½ç½® | æŒä¹…åŒ– |
|:-----|:---------|:---------|:-------|
| `Append(data)` | å•†å“æ‰“åŒ… | RBF å†…éƒ¨ç¼“å†² | âŒ |
| `Framer.Flush()` | äº¤ç»™å¿«é€’ç«™ | OS ç¼“å†²åŒº | âŒ |
| `File.DurableFlush()` | å¿«é€’è½¦å‘è½¦ | ç£ç›˜ç‰©ç†ä»‹è´¨ | âœ… |

**å…³é”®æ´è§**ï¼š
- `Flush()` åƒ"æŠŠåŒ…è£¹äº¤ç»™å¿«é€’ç«™"â€”â€”åŒ…è£¹ç¦»å¼€äº†ä½ çš„æ‰‹ï¼Œä½†è¿˜æ²¡ä¸Šè½¦
- `DurableFlush()` åƒ"å¿«é€’è½¦å‘è½¦"â€”â€”åŒ…è£¹çœŸæ­£å¼€å§‹è¿è¾“ï¼Œä¸ä¼šå› ä¸ºå¿«é€’ç«™åœç”µè€Œä¸¢å¤±

---

**éšå–» 4ï¼šTruncate åƒ"æ—¶å…‰å€’æµåçš„è®°å¿†æŠ¹é™¤"**

```
åŸæ—¶é—´çº¿ï¼š[A, B, C, D, E]  (æ–‡ä»¶é•¿åº¦ = 5)
æ’•è£‚æ£€æµ‹ï¼šD å’Œ E æ˜¯"æœªæ¥ç¢ç‰‡"ï¼ˆDataTail < å½“å‰é•¿åº¦ï¼‰
Truncate(3)ï¼š[A, B, C]      (æ–‡ä»¶é•¿åº¦ = 3)

åæœï¼šæ‰€æœ‰æŒ‡å‘ D/E çš„ Address64 å¤±æ•ˆ
```

**å…³é”®æ´è§**ï¼š`Truncate` ä¸ä»…æ˜¯ç‰©ç†æ“ä½œï¼ˆç¼©çŸ­æ–‡ä»¶ï¼‰ï¼Œæ›´æ˜¯é€»è¾‘æ“ä½œï¼ˆæŠ¹é™¤å†å²ï¼‰ã€‚æ‰€æœ‰ä¾èµ–è¢«æˆªæ–­åŒºåŸŸçš„æŒ‡é’ˆï¼ˆAddress64ï¼‰éƒ½åº”é‡å»ºã€‚

---

#### 4. API ä¼˜åŒ–å»ºè®®

**ä¼˜åŒ– 1ï¼šLengthBytes çš„æ—¶æœºä¿è¯**

**é—®é¢˜**ï¼šå¼€å‘è€…ä¸ç¡®å®š `LengthBytes` æ˜¯å¦åŒ…å«åˆš `Flush()` çš„æ•°æ®
**å»ºè®®**ï¼šåœ¨ `DurableFlush()` çš„æ–‡æ¡£ä¸­æ˜ç¡®ï¼š

```csharp
/// <summary>
/// å¼ºåˆ¶æ•°æ®è½ç›˜ï¼ˆfsync ç­‰ä»·ï¼‰ã€‚
/// </summary>
/// <remarks>
/// <para><b>LengthBytes ä¿è¯</b>ï¼šDurableFlush() æˆåŠŸè¿”å›åï¼Œ
/// LengthBytes ä¿è¯åæ˜ å·²è½ç›˜çš„æ•°æ®é•¿åº¦ã€‚</para>
/// </remarks>
void DurableFlush();
```

---

**ä¼˜åŒ– 2ï¼šTruncate çš„å‰¯ä½œç”¨æç¤º**

**é—®é¢˜**ï¼šå¼€å‘è€…ä¸çŸ¥é“ `Truncate` ä¼šä½¿ Address64 å¤±æ•ˆ
**å»ºè®®**ï¼šåœ¨ `Truncate` çš„æ–‡æ¡£ä¸­æ˜ç¡®ï¼š

```csharp
/// <summary>
/// æˆªæ–­æ–‡ä»¶åˆ°æŒ‡å®šé•¿åº¦ï¼ˆæ¢å¤æµç¨‹ç”¨ï¼‰ã€‚
/// </summary>
/// <param name="newLengthBytes">æ–°é•¿åº¦ï¼ˆbyteï¼‰ï¼ŒMUST â‰¤ å½“å‰é•¿åº¦ä¸” 4B å¯¹é½</param>
/// <remarks>
/// <para><b>Address64 å¤±æ•ˆ</b>ï¼šæˆªæ–­åï¼Œæ‰€æœ‰ Address64 â‰¥ newLengthBytes çš„åœ°å€å¤±æ•ˆã€‚
/// åç»­ TryReadAt(å¤±æ•ˆåœ°å€) å°†è¿”å› falseã€‚</para>
/// <para><b>ä¸Šå±‚è´£ä»»</b>ï¼šè°ƒç”¨æ–¹åº”é‡å»ºä¾èµ–è¿™äº›åœ°å€çš„ç´¢å¼•ï¼ˆå¦‚ VersionIndexï¼‰ã€‚</para>
/// </remarks>
void Truncate(ulong newLengthBytes);
```

---

**ä¼˜åŒ– 3ï¼šCreateFramer/CreateScanner çš„å•ä¾‹è¯­ä¹‰æ–‡æ¡£åŒ–**

**é—®é¢˜**ï¼šå¼€å‘è€…ä¸çŸ¥é“ `CreateFramer()` åªèƒ½è°ƒç”¨ä¸€æ¬¡
**å»ºè®®**ï¼šåœ¨æ¥å£æ–‡æ¡£ä¸­æ˜ç¡®ï¼š

```csharp
/// <summary>
/// åˆ›å»ºå†™å…¥å™¨ï¼ˆå•ä¾‹ï¼šç¬¬äºŒæ¬¡è°ƒç”¨æŠ› InvalidOperationExceptionï¼‰ã€‚
/// </summary>
/// <remarks>
/// <para><b>ç”Ÿå‘½å‘¨æœŸ</b>ï¼šFramer ç”Ÿå‘½å‘¨æœŸç»‘å®šåˆ° RbfFileï¼Œåº”åœ¨æ„é€ æ—¶åˆ›å»ºå¹¶å¤ç”¨ã€‚</para>
/// <para><b>é”™è¯¯ä¿¡æ¯</b>ï¼šç¬¬äºŒæ¬¡è°ƒç”¨æ—¶ï¼Œå¼‚å¸¸åŒ…å« "Framer already exists, reuse the existing instance"ã€‚</para>
/// </remarks>
IRbfFramer CreateFramer();
```

---

**ä¼˜åŒ– 4ï¼šScanReverse çš„"ç«‹å³æ¶ˆè´¹"æç¤º**

**é—®é¢˜**ï¼šå¼€å‘è€…è¯•å›¾å­˜å‚¨ `ScanReverse()` çš„è¿”å›å€¼åˆ°å­—æ®µ
**å»ºè®®**ï¼šåœ¨è¿”å›ç±»å‹æ–‡æ¡£ä¸­æ˜ç¡®ï¼š

```csharp
/// <summary>
/// ä»æ–‡ä»¶å°¾éƒ¨é€†å‘æ‰«ææ‰€æœ‰å¸§ã€‚
/// </summary>
/// <returns>å¸§åºåˆ—ï¼ˆä»å°¾åˆ°å¤´ï¼‰</returns>
/// <remarks>
/// <para><b>ref struct é™åˆ¶</b>ï¼šè¿”å›å€¼æ˜¯ ref structï¼Œä¸èƒ½å­˜å‚¨åˆ°å­—æ®µæˆ–è·¨ await è¾¹ç•Œã€‚
/// å¿…é¡»åœ¨æ–¹æ³•å†…ç«‹å³ foreach æ¶ˆè´¹ã€‚</para>
/// <para><b>æŒä¹…åŒ–æ•°æ®</b>ï¼šè‹¥éœ€ä¿å­˜ Payloadï¼Œè°ƒç”¨ frame.PayloadToArray()ã€‚</para>
/// <para><b>è®¾è®¡ç†ç”±</b>ï¼šref struct çš„ç¼–è¯‘å™¨é™åˆ¶æ˜¯"æŠ¤æ "ï¼Œé˜²æ­¢ use-after-freeã€‚</para>
/// </remarks>
RbfReverseSequence ScanReverse();
```

---

#### 5. æ€»ç»“ï¼šçœŸå®åœºæ™¯é©±åŠ¨çš„ DX æ”¹è¿›

| åœºæ™¯ | æ ¸å¿ƒç—›ç‚¹ | æ”¹è¿›æ–¹å‘ |
|:-----|:---------|:---------|
| **å¯åŠ¨æ¢å¤** | `LengthBytes` ä¸ `DataTail` å¯¹æ¯”ä¸ç¡®å®š | æ˜ç¡® `LengthBytes` è¯­ä¹‰ï¼ˆOS è§†è§’ï¼‰ |
| **Lazy Load** | Address64 å¤±æ•ˆè¾¹ç•Œæ¨¡ç³Š | `Truncate` æ–‡æ¡£æ˜ç¡®"åœ°å€å¤±æ•ˆ"å‰¯ä½œç”¨ |
| **Commit æµç¨‹** | `Flush` ä¸ `DurableFlush` æ—¶æœºæ··æ·† | ä¸‰å±‚æ¬¡éšå–»ï¼ˆæ‰“åŒ…â†’å¿«é€’ç«™â†’å‘è½¦ï¼‰ |
| **åå¤ Commit** | å¤šæ¬¡ `CreateFramer()` å¼‚å¸¸éš¾ç†è§£ | å¼‚å¸¸ä¿¡æ¯æç¤º"reuse existing instance" |

**æ ¸å¿ƒæ´è§**ï¼š
1. **RbfFile æ˜¯é•¿ç”Ÿå‘½å‘¨æœŸå¯¹è±¡**ï¼ˆè¿›ç¨‹çº§æ–‡ä»¶ç§Ÿçº¦ï¼‰ï¼Œè€ŒéçŸ­ç”Ÿå‘½å‘¨æœŸæµ
2. **TryReadAt æ˜¯å®æ—¶è§‚æµ‹**ï¼ˆæ–‡ä»¶å¢é•¿åæ–°åœ°å€å¯è¯»ï¼‰ï¼Œè€Œéå¿«ç…§
3. **Truncate æ˜¯é€»è¾‘æŠ¹é™¤**ï¼ˆåœ°å€å¤±æ•ˆéœ€è¦é‡å»ºç´¢å¼•ï¼‰ï¼Œè€Œéå•çº¯ç‰©ç†æ“ä½œ
4. **ref struct çš„é™åˆ¶æ˜¯æŠ¤æ **ï¼ˆé˜²æ­¢ use-after-freeï¼‰ï¼Œéœ€è¦åœ¨æ–‡æ¡£ä¸­è§£é‡Šè®¾è®¡ç†ç”±

---

### Auditor å‘è¨€

### Auditor å‘è¨€ï¼ˆåŸºäº MVP é‡æ–°å®¡è®¡ï¼‰

#### 1. å¿…é¡»è§„èŒƒåŒ–çš„å¥‘çº¦

åŸºäºå·²æ”¶æ•›çš„ MVP æ¥å£ï¼ˆå« `LengthBytes` ä¸ `Truncate`ï¼‰ï¼Œä»¥ä¸‹è¡Œä¸ºå¿…é¡»è¿›å…¥â€œå¯åˆ¤å®šæ¡æ¬¾â€ï¼Œå¦åˆ™å®ç°ä¼šå€’çŒè®¾è®¡ï¼ˆå°¤å…¶æ˜¯ durabilityã€æ¢å¤ã€ä»¥åŠè§†å›¾ç”Ÿå‘½å‘¨æœŸï¼‰ã€‚

1) **å·¥å‚æ–¹æ³•è¯­ä¹‰ï¼ˆCreateNew/OpenExistingï¼‰**
- `CreateNew(path)` çš„è¯­ä¹‰å¿…é¡»æ˜¯ **FailIfExists**ï¼ˆå·²è£å†³ï¼‰ï¼Œå¹¶æ˜ç¡®â€œæˆåŠŸè¿”å›å‰å®Œæˆ Genesis å†™å…¥â€ã€‚
- `OpenExisting(path)` å¿…é¡»éªŒè¯ **Genesis Fence**ï¼ˆ`RBF1`ï¼‰ï¼Œå¹¶æ˜ç¡®â€œé‡åˆ°é RBF/æŸåæ—¶çš„å¤±è´¥ç±»å‹â€ã€‚

2) **`IRbfFile` ç”Ÿå‘½å‘¨æœŸä¸è§†å›¾å¤±æ•ˆ**
- `Dispose()` æ˜¯å¦å¹‚ç­‰å¿…é¡»è£å†³ï¼›Disposed åå¯¹ `IRbfFile`ã€ä»¥åŠå…¶åˆ›å»ºçš„ `IRbfFramer/IRbfScanner` çš„è°ƒç”¨è¡Œä¸ºå¿…é¡»å¯åˆ¤å®šã€‚
- æ˜ç¡® `IRbfFramer/IRbfScanner` çš„ç”Ÿå‘½å‘¨æœŸæ˜¯å¦ç”± `IRbfFile` ç®¡ç†ï¼ˆMVP å€¾å‘ï¼šç”± file ç»Ÿä¸€ç®¡ç†ï¼›è§†å›¾æœ¬èº«ä¸å¯ç‹¬ç«‹ disposeï¼‰ã€‚

3) **è§†å›¾åˆ›å»ºæ¬¡æ•°ä¸å¹¶å‘æ¨¡å‹ï¼ˆMVP å·²è£å†³ï¼šå•ä¾‹ï¼‰**
- `CreateFramer()` ç¬¬äºŒæ¬¡è°ƒç”¨å¿…é¡»æ˜¯â€œfail-fastâ€ï¼Œå¹¶å›ºå®šå¼‚å¸¸ç±»å‹ã€‚
- `CreateScanner()` ç¬¬äºŒæ¬¡è°ƒç”¨åŒä¸Šï¼ˆç›‘æŠ¤äººè£å†³ï¼šMVP å•ä¾‹ï¼‰ã€‚
- `IRbfFile` / `IRbfFramer` / `IRbfScanner` çš„çº¿ç¨‹å®‰å…¨ä¸å¤šè¿›ç¨‹å¹¶å‘è¯­ä¹‰å¿…é¡»ç»™å‡ºâ€œå…è®¸/ä¸æ”¯æŒ/æœªå®šä¹‰â€çš„è¾¹ç•Œï¼ˆè‡³å°‘è¦ç¦æ­¢æˆ– fail-fast å¤š writerï¼‰ã€‚

4) **`DurableFlush()` çš„è¾¹ç•Œä¸ä¸ `IRbfFramer.Flush()` çš„å…³ç³»**
- å¿…é¡»æ˜ç¡®ï¼š`IRbfFramer.Flush()` ä»…æ˜¯â€œæ¨é€åˆ°ä¸‹å±‚ writer/streamâ€ï¼Œä¸æ‰¿è¯º durabilityï¼ˆå·²ç”± `rbf-interface.md` çš„ `[S-RBF-FRAMER-NO-FSYNC]` å»ºç«‹ï¼‰ã€‚
- å¿…é¡»è¡¥é½ï¼šdurable ç”± `IRbfFile.DurableFlush()` æä¾›ï¼ˆå¹¶æ®æ­¤ä¿®è®¢ `rbf-interface.md` ä¸­ `IRbfFramer.Flush()` remarks é‡Œâ€œä¸Šå±‚æŒæœ‰åº•å±‚å¥æŸ„â€çš„æš—å¥‘çº¦è¡¨è¿°ï¼‰ã€‚
- å¿…é¡»æ˜ç¡® DurableFlush çš„â€œå®Œæˆç‚¹â€ï¼ˆåŒæ­¥è¿”å›å³ durable è¾¾æˆï¼‰ï¼Œä»¥åŠå¤±è´¥åçš„å¯¹è±¡çŠ¶æ€ï¼ˆæ˜¯å¦ä»å¯ç»§ç»­å†™ï¼‰ã€‚

5) **`LengthBytes` ä¸å¢é•¿å¯è§æ€§ï¼ˆç›´æ¥å…³ç³»åˆ°æ¢å¤ä¸æ’•è£‚æ£€æµ‹ï¼‰**
- `LengthBytes` å¿…é¡»å®šä¹‰ä¸ºâ€œè°ƒç”¨æ—¶åˆ» OS è§†è§’çš„å½“å‰æ–‡ä»¶é•¿åº¦ï¼ˆbyteï¼‰â€ã€‚
- æ˜ç¡®ä¸å¢é•¿ç›¸å…³çš„æœ€ä½æ‰¿è¯ºï¼šåŒä¸€è¿›ç¨‹åŒä¸€ file å¥æŸ„æŒç»­ append åï¼Œåç»­ `LengthBytes` å…è®¸å¢é•¿ï¼›ä¸å¾—ç¼“å­˜ä¸ºæ‰“å¼€ç¬é—´å¿«ç…§ã€‚

6) **`Truncate(newLengthBytes)` çš„å‰ç½®æ¡ä»¶/åç½®æ¡ä»¶**
- å‰ç½®æ¡ä»¶å¿…é¡»è£å†³ï¼šæ˜¯å¦å…è®¸æ‰©å®¹ï¼ˆé€šå¸¸ä¸å…è®¸ï¼‰ï¼›æ˜¯å¦è¦æ±‚ `newLengthBytes <= LengthBytes`ï¼›æ˜¯å¦è¦æ±‚ 4 å­—èŠ‚å¯¹é½ï¼ˆå»ºè®® MUSTï¼šä¸ `Address64` å¯¹é½ä¸€è‡´ï¼‰ã€‚
- åç½®æ¡ä»¶å¿…é¡»è£å†³ï¼šæˆªæ–­åï¼Œè¢«æˆªæ–­åŒºé—´å†…çš„ `Address64`/æŒ‡é’ˆåç»­ `TryReadAt` å¿…é¡»å¤±è´¥ï¼ˆè¿”å› false æˆ–æŠ›å¼‚å¸¸éœ€äºŒé€‰ä¸€ï¼‰ã€‚

è¡¥ä½ï¼š**ç¼ºå£ï¼ˆå¯åˆ¤å®šæ€§ï¼‰**
- ç°æœ‰ `rbf-interface.md` çš„ `[S-RBF-SCANREVERSE-CONCURRENT-MUTATION]` å°†â€œæšä¸¾æœŸé—´ä¿®æ”¹â€å®šä¹‰ä¸ºæœªå®šä¹‰è¡Œä¸ºã€‚MVP è‹¥è¦å…è®¸â€œScanner é•¿æœŸéšæœºè¯»å¹¶åœ¨æ–‡ä»¶å¢é•¿åå¯è¯»åˆ°æ–°å¸§â€ï¼Œè‡³å°‘éœ€è¦ä¸º `TryReadAt` ä¸ `LengthBytes` æ˜ç¡®â€œå¢é•¿è¯­ä¹‰â€ï¼›å¯¹ `ScanReverse` å¯ä»¥ç»§ç»­ç»´æŒæœªå®šä¹‰ï¼ˆå†·è·¯å¾„ï¼‰ï¼Œä½†å¿…é¡»åœ¨æ¡æ¬¾é‡Œè¯´æ¸…æ¥šã€‚

#### 2. å¼‚å¸¸å¥‘çº¦æ¸…å•

ä»¥ä¸‹å¼‚å¸¸ç±»å‹å¿…é¡»åœ¨è§„èŒƒä¸­æ˜ç¡®ï¼ˆç›®æ ‡ï¼šè®©è°ƒç”¨æ–¹èƒ½å†™é»‘ç›’æ–­è¨€ï¼›è®©å®ç°è€…æ— éœ€çŒœæµ‹ï¼‰ï¼š

1) **å‚æ•°ç±»ï¼ˆArgumentï¼‰**
- `ArgumentNullException`ï¼š`path == null`ã€‚
- `ArgumentException`ï¼š`path` ä¸ºç©º/å…¨ç©ºç™½/åŒ…å«éæ³•å­—ç¬¦ç­‰ã€‚
- `ArgumentOutOfRangeException`ï¼š`Truncate(newLengthBytes)` ä¼ å…¥å€¼ä¸æ»¡è¶³çº¦æŸï¼ˆä¾‹å¦‚å¤§äºå½“å‰é•¿åº¦ã€æˆ–ä¸æ»¡è¶³å¯¹é½çº¦æŸï¼‰ã€‚

2) **è·¯å¾„/æƒé™/å­˜åœ¨æ€§ï¼ˆI/O Surfaceï¼‰**
- `UnauthorizedAccessException`ï¼šæ— æƒé™åˆ›å»º/æ‰“å¼€/å†™å…¥/æˆªæ–­ã€‚
- `FileNotFoundException`ï¼š`OpenExisting` è·¯å¾„ä¸å­˜åœ¨ã€‚
- `DirectoryNotFoundException`ï¼šç›®å½•ä¸å­˜åœ¨ã€‚
- `IOException`ï¼šå…¶ä»– I/O å¤±è´¥ï¼ˆç£ç›˜æ»¡ã€å…±äº«å†²çªã€å¥æŸ„å¤±æ•ˆç­‰ï¼‰ã€‚

3) **æ ¼å¼/å†…å®¹æŸåï¼ˆCorruptionï¼‰**
- è‡³å°‘è¦å›ºå®šä¸€ç§â€œé RBF/Genesis ä¸åŒ¹é…/æ˜æ˜¾æŸåâ€çš„å¼‚å¸¸ç±»å‹ï¼šå»ºè®® `InvalidDataException`ï¼ˆæˆ–é¡¹ç›®è‡ªå®šä¹‰ `RbfCorruptedException`ï¼ŒäºŒé€‰ä¸€å¹¶å†™å…¥ SSOTï¼‰ã€‚

4) **ç”Ÿå‘½å‘¨æœŸ/çŠ¶æ€æœºï¼ˆLifecycle / Stateï¼‰**
- `ObjectDisposedException`ï¼šDisposed åè°ƒç”¨ä»»æ„æˆå‘˜ï¼ˆåŒ…å« `DurableFlush/Truncate/CreateFramer/CreateScanner/LengthBytes`ï¼‰ä»¥åŠè§†å›¾å¯¹è±¡çš„æ–¹æ³•ã€‚
- `InvalidOperationException`ï¼šè¿åå•ä¾‹çº¦æŸï¼ˆç¬¬äºŒæ¬¡ `CreateFramer` / `CreateScanner`ï¼‰æˆ–åœ¨ä¸å…è®¸çš„çŠ¶æ€è°ƒç”¨ã€‚

5) **ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹/å¹³å°èƒ½åŠ›**
- `NotSupportedException`ï¼šé seekable/ä¸æ”¯æŒéšæœºè®¿é—®çš„åº•å±‚å¯¹è±¡ï¼ˆè‹¥å®ç°ä»…æ”¯æŒå¸¸è§„æ–‡ä»¶ï¼‰ã€‚

#### 3. è¾¹ç•Œæ¡ä»¶å®šä¹‰

1) **æ–‡ä»¶é•¿åº¦è¾¹ç•Œ**
- 0 å­—èŠ‚æ–‡ä»¶ï¼š`OpenExisting` å¿…é¡»å¤±è´¥ï¼ˆå› ä¸º Genesis Fence éœ€å­˜åœ¨ï¼‰ã€‚
- ä»… Genesis Fenceï¼ˆé•¿åº¦=4ï¼‰ï¼š`CreateScanner().ScanReverse()` å¿…é¡»è¿”å›ç©ºåºåˆ—ä¸”ä¸æŠ›ï¼ˆä¸ `[S-RBF-SCANREVERSE-EMPTY-IS-OK]` å¯¹é½ï¼‰ã€‚
- æå¤§æ–‡ä»¶ï¼šè‹¥å®ç°å— `long` é™åˆ¶ï¼Œå¿…é¡»åœ¨è§„èŒƒä¸­å£°æ˜æœ€å¤§æ”¯æŒé•¿åº¦ï¼ˆæˆ–æ˜ç¡®è¶…å‡ºæ—¶æŠ› `NotSupportedException/IOException`ï¼‰ã€‚

2) **CreateNew / OpenExisting çš„å‰¯ä½œç”¨ä¸åŸå­æ€§**
- `CreateNew` åœ¨å†™ Genesis å¤±è´¥æ—¶ï¼šéœ€è¦è£å†³â€œå…è®¸é—ç•™æ— æ•ˆæ–‡ä»¶â€è¿˜æ˜¯â€œå¿…é¡»æ¸…ç†å›æ»šâ€ã€‚ä¸¤è€…éƒ½å¯è¡Œï¼Œä½†å¿…é¡»å†™æ˜ï¼Œå¦åˆ™æµ‹è¯•ä¸å¯åˆ¤å®šã€‚

3) **`LengthBytes` ä¸å¹¶å‘å¤–éƒ¨ä¿®æ”¹**
- è‹¥æ–‡ä»¶è¢«å¤–éƒ¨è¿›ç¨‹æˆªæ–­/æ›¿æ¢ï¼š`LengthBytes`/`TryReadAt`/`ScanReverse` çš„è¡Œä¸ºè‡³å°‘è¦å½’å…¥â€œå¯èƒ½æŠ› `IOException` æˆ–æœªå®šä¹‰â€ï¼›ä¸èƒ½æ²‰é»˜è¿”å›é”™è¯¯æ•°æ®ã€‚

4) **`Truncate` çš„åˆæ³•è¾“å…¥åŸŸ**
- `newLengthBytes == LengthBytes`ï¼šå¿…é¡»å®šä¹‰ä¸º no-opï¼ˆå»ºè®® MUST æˆåŠŸä¸”ä¸æ”¹å˜è¯­ä¹‰ï¼‰ã€‚
- `newLengthBytes > LengthBytes`ï¼šå¿…é¡»æ˜ç¡®å…è®¸ä¸å¦ï¼ˆMVP å»ºè®®ï¼šç¦æ­¢å¹¶æŠ› `ArgumentOutOfRangeException`ï¼‰ã€‚
- å¯¹é½ï¼šå»ºè®® MUST è¦æ±‚ `newLengthBytes % 4 == 0`ï¼Œå¦åˆ™æŠ› `ArgumentOutOfRangeException`ï¼ˆé¿å…åˆ¶é€ éå¯¹é½ Address64 ç©ºé—´ï¼‰ã€‚

5) **è§†å›¾åˆ›å»ºä¸ä½¿ç”¨é¡ºåº**
- åœ¨åŒä¸€ `IRbfFile` ä¸Šï¼Œå…è®¸å…ˆ `CreateScanner` å† `CreateFramer`ï¼Œä»¥åŠç›¸åé¡ºåºå—ï¼Ÿ
  - MVP æœ€å°åŒ–å»ºè®®ï¼šä¸¤è€…éƒ½å…è®¸ï¼Œä½†å¹¶å‘è¯­ä¹‰ä¸æ‰©å¼ ï¼›å¦‚å®ç°éš¾åº¦é«˜ï¼Œå¯æ˜ç¡®â€œå…è®¸å…±å­˜ï¼Œä½†çº¿ç¨‹ä¸å®‰å…¨ï¼›è¡Œä¸ºä»¥è°ƒç”¨æ—¶åˆ»æ–‡ä»¶å†…å®¹ä¸ºå‡†â€ã€‚

#### 4. å…³é”®æ¡æ¬¾è‰æ¡ˆï¼ˆ3-5 ä¸ªï¼‰

**`[S-RBF-FILE-CREATENEW-FAILIFEXISTS]`**
> `RbfFile.CreateNew(path)` MUST åˆ›å»ºä¸€ä¸ªå…¨æ–°çš„ RBF æ–‡ä»¶ã€‚è‹¥ç›®æ ‡è·¯å¾„å·²å­˜åœ¨ï¼ˆæ— è®ºå†…å®¹æ˜¯å¦ä¸º RBFï¼‰ï¼Œè¯¥æ–¹æ³• MUST å¤±è´¥ï¼Œå¹¶æŠ›å‡º `IOException`ï¼ˆæˆ–æ›´å…·ä½“çš„å­˜åœ¨æ€§å¼‚å¸¸ï¼Œéœ€å›ºå®šï¼‰ã€‚æˆåŠŸè¿”å›å‰ MUST å†™å…¥å¹¶æŒä¹…åŒ–ï¼ˆè‡³å°‘åˆ° OS ç¼“å†²ï¼‰Genesis Fenceã€‚

**`[S-RBF-FILE-OPENEXISTING-VERIFY-GENESIS]`**
> `RbfFile.OpenExisting(path)` MUST ä»…åœ¨ç›®æ ‡æ–‡ä»¶å­˜åœ¨ä¸”å…¶å¼€å¤´ Genesis Fence æœ‰æ•ˆæ—¶æˆåŠŸè¿”å›ï¼›å¦åˆ™ MUST å¤±è´¥ã€‚Genesis ä¸åŒ¹é…æˆ–æ–‡ä»¶æ˜æ˜¾é RBF æ—¶ MUST æŠ›å‡º `InvalidDataException`ï¼ˆæˆ–é¡¹ç›®è‡ªå®šä¹‰çš„ corruption å¼‚å¸¸ï¼‰ã€‚

**`[S-RBF-FILE-SINGLETON-VIEWS]`**
> å¯¹åŒä¸€ `IRbfFile` å®ä¾‹ï¼š`CreateFramer()` MUST æˆåŠŸè‡³å¤šä¸€æ¬¡ï¼›`CreateScanner()` MUST æˆåŠŸè‡³å¤šä¸€æ¬¡ã€‚ç¬¬äºŒæ¬¡è°ƒç”¨ MUST æŠ›å‡º `InvalidOperationException`ã€‚

**`[S-RBF-FILE-DURABLEFLUSH-BOUNDARY]`**
> `IRbfFile.DurableFlush()` MUST åœ¨æˆåŠŸè¿”å›å‰ä½¿å¾—è¯¥æ–‡ä»¶ä¸Šå…ˆå‰å·²å®Œæˆ `IRbfFramer.Flush()` çš„å­—èŠ‚è¾¾åˆ° durabilityï¼ˆç­‰ä»· fsync è¯­ä¹‰ï¼‰ã€‚åœ¨ Disposed çŠ¶æ€ä¸‹è°ƒç”¨ MUST æŠ›å‡º `ObjectDisposedException`ã€‚

**`[S-RBF-FILE-LENGTH-AND-TRUNCATE]`**
> `LengthBytes` MUST è¿”å›è°ƒç”¨æ—¶åˆ»çš„æ–‡ä»¶é•¿åº¦ï¼ˆbyteï¼‰ã€‚`Truncate(newLengthBytes)` MUST è¦æ±‚ `newLengthBytes <= LengthBytes` ä¸” `newLengthBytes % 4 == 0`ï¼›å¦åˆ™ MUST æŠ›å‡º `ArgumentOutOfRangeException`ã€‚æˆªæ–­æˆåŠŸåï¼Œä½äºè¢«æˆªæ–­åŒºåŸŸçš„ä»»æ„ `Address64` å…¶åç»­ `TryReadAt` MUST å¤±è´¥ï¼ˆè¿”å› `false`ï¼‰ã€‚

---

## ç›‘æŠ¤äºº--åˆ˜ä¸–è¶… ç¬¬ä¸€è½®å‘è¨€

æˆ‘ä»¬è¦æœ‰çš„æ”¾çŸ¢ï¼Œæˆ‘å»ºè®®è®©Claudeå’ŒAuditoråˆ†åˆ«ç‹¬ç«‹è¯»å–å’Œåˆ†æä¸€æ¬¡`atelia/docs/StateJournal/mvp-design-v2.md.original`æ–‡ä»¶(æ­£åœ¨æ‹†åˆ†ä¸­ï¼Œè¿™æ˜¯æœªæ”¹åŠ¨çš„å¤§å•ä½“ç‰ˆæœ¬)ï¼Œæ¥åˆ†æä¸Šå±‚çš„StateJournalå¯¹æ–‡ä»¶è®¿é—®æ¥å£çš„åŠŸèƒ½éœ€æ±‚ï¼Œè¿™æ ·æœ‰åˆ©äºè®¾è®¡å‡ºå¯¹ä¸Šå±‚ä½¿ç”¨è€…æ¥è¯´æœ€ä½³çš„æ–‡ä»¶è®¿é—®æ¥å£ã€‚
å‘è¨€å®Œæ¯•ï¼ŒæœŸå¾…äºŒä½å‘ˆç°çš„è°ƒæŸ¥ä¸åˆ†æç»“æœã€‚

å¯¹äºå…·ä½“é—®é¢˜ä¸Šï¼š
  å…³äºâ€œD1ï¼šScanner å¯è§æ€§è¯­ä¹‰â€ï¼Œåº”ä»¥å‰é¢å¯¹éœ€æ±‚çš„å…·ä½“è°ƒæŸ¥ä¸ºå‡†ã€‚ä»æˆ‘çš„ç†è§£æ¥çœ‹ï¼Œç›®å‰çš„æ¥å£è®¾è®¡å’Œéœ€æ±‚å¹¶ä¸å®Œå…¨åŒ¹é…ã€‚StateJournalçš„éœ€æ±‚æœ‰2ä¸ªï¼š1. æ‰“å¼€æ–‡ä»¶åæ‰¾Metaçš„å°¾å¸§ã€‚2. ç”¨Address64éšæœºè¯»å–ç‰¹å®šçš„ç›®æ ‡äºŒè¿›åˆ¶å¸§ã€‚ StateJournalå¯¹RBFæ–‡ä»¶çš„ç”¨æ³•æ˜¯ä»¥Metaå°¾éƒ¨å¸§ä¸ºçº¿ç´¢ï¼Œæ²¿ç€å¼•ç”¨å…³ç³»é‡å»ºå‡ºRootObjectï¼Œè¿è¡Œæ—¶é•¿æœŸæŒæœ‰æ–‡ä»¶å¥æŸ„ï¼Œå•è¯»è€…å•å†™è€…(å› ä¸ºæœ‰å†…å­˜å¯¹è±¡ç¼“å­˜`Identity Map`ï¼ŒLazy Loadï¼Œè¯»å–æ“ä½œéƒ½æ˜¯ä¼´éšç€å†™å…¥ç¼“å­˜çš„å‰¯ä½œç”¨çš„)ã€‚StateJournao Commitæ“ä½œæ¯”å¦‚éœ€è¦å…ˆDateæ–‡ä»¶è½ç›˜å†Metaæ–‡ä»¶è½ç›˜ï¼Œç”¨çš„å…¨æ˜¯RBFçš„Append Frameæ“ä½œï¼Œæˆ‘ä»¬ä¸éœ€è¦ä¹Ÿä¸æ”¯æŒInplace Writeæ“ä½œï¼ŒAppend-Onlyã€‚
  å…³äºâ€œD2ï¼šCreate å¯¹å·²æœ‰æ–‡ä»¶çš„è¡Œä¸ºâ€ï¼Œæˆ‘å»ºè®®é€‰â€œA. FailIfExistsâ€ã€‚
  å…³äºâ€œD3ï¼šå¤š Scanner å®ä¾‹çº¦æŸâ€ï¼Œæˆ‘å»ºè®®é€‰â€œC. å•ä¾‹â€

---

### Advisor-Claude éœ€æ±‚åˆ†æ

> **ä»»åŠ¡**ï¼šä» StateJournal è®¾è®¡æ–‡æ¡£æå– RBF æ–‡ä»¶è®¿é—®çš„å®é™…éœ€æ±‚ï¼Œè¯†åˆ«å½“å‰æ¥å£è®¾è®¡ä¸éœ€æ±‚çš„ Gapã€‚
> **taskTag**: #design

#### 1. RBF æ–‡ä»¶ä½¿ç”¨æ¨¡å¼

##### 1.1 æ–‡ä»¶æ•°é‡ä¸èŒè´£

ä» [mvp-design-v2.md.original](../../../atelia/docs/StateJournal/mvp-design-v2.md.original) Â§3.2 æå–ï¼š

| æ–‡ä»¶ | ä½œç”¨ | è®°å½•ç±»å‹ |
|:-----|:-----|:---------|
| **Data æ–‡ä»¶** | æ‰¿è½½å¯¹è±¡ç‰ˆæœ¬è®°å½•ï¼ˆObjectVersionRecordï¼‰+ VersionIndex ç‰ˆæœ¬ | `FrameTag = 0x00010001` (Dict) ç­‰ |
| **Meta æ–‡ä»¶** | Commit æ—¥å¿—ï¼Œè®°å½•æ¯æ¬¡æäº¤çš„å…ƒæ•°æ® | `FrameTag = 0x00000002` (MetaCommitRecord) |

**å…³é”®ç‰¹å¾**ï¼š
- ä¸¤ä¸ªæ–‡ä»¶éƒ½æ˜¯ **Append-Only**
- Data æ–‡ä»¶éœ€è¦**éšæœºè¯»å–**ï¼ˆé€šè¿‡ Ptr64/Address64ï¼‰
- Meta æ–‡ä»¶éœ€è¦**é€†å‘æ‰«æ**ï¼ˆæ‰¾æœ€åä¸€ä¸ªæœ‰æ•ˆ MetaCommitRecordï¼‰

##### 1.2 æ‰“å¼€/å…³é—­æ—¶æœº

| æ—¶æœº | æ“ä½œ | æ–‡æ¡£ä¾æ® |
|:-----|:-----|:---------|
| **å¯åŠ¨æ—¶** | Open Meta â†’ é€†å‘æ‰«ææ‰¾ HEAD â†’ Open Data | Â§3.3.1 Open |
| **è¿è¡Œæ—¶** | é•¿æœŸæŒæœ‰ä¸¤ä¸ªæ–‡ä»¶å¥æŸ„ | ç›‘æŠ¤äººç¡®è®¤ï¼š"è¿è¡Œæ—¶é•¿æœŸæŒæœ‰æ–‡ä»¶å¥æŸ„" |
| **å…³é—­æ—¶** | è¿›ç¨‹ç»ˆæ­¢æ—¶å…³é—­ | éšå¼ï¼ˆè¿›ç¨‹ç”Ÿå‘½å‘¨æœŸï¼‰ |

**æ´è§**ï¼šæ–‡ä»¶å¥æŸ„æ˜¯**é•¿æœŸæŒæœ‰**çš„ï¼Œä¸æ˜¯"ç”¨å®Œå³å…³"ã€‚è¿™å½±å“äº† `IRbfFile` çš„ç”Ÿå‘½å‘¨æœŸè®¾è®¡â€”â€”å®ƒåº”è¯¥æ˜¯è¿›ç¨‹çº§çš„å•ä¾‹ï¼Œè€ŒéçŸ­ç”Ÿå‘½å‘¨æœŸå¯¹è±¡ã€‚

##### 1.3 ä¸¤æ–‡ä»¶å…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     StateJournal Commit                      â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   1. Append   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ Dirty Objectsâ”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  Data File  â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                       â”‚                      â”‚
â”‚                                       â”‚ 2. Fsync             â”‚
â”‚                                       â–¼                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   3. Append   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ MetaCommit   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  Meta File  â”‚              â”‚
â”‚  â”‚  Record      â”‚               â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚                      â”‚
â”‚                                       â”‚ 4. Fsync             â”‚
â”‚                                       â–¼                      â”‚
â”‚                              â† COMMIT POINT â†’                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

#### 2. è¯»å–æ“ä½œè¯¦ç»†éœ€æ±‚

##### 2.1 "æ‰¾ Meta å°¾å¸§"çš„å…·ä½“å«ä¹‰

ä» Â§3.3.1 Open æµç¨‹æå–ï¼š

**æ“ä½œæè¿°**ï¼š
1. ä» meta æ–‡ä»¶å°¾éƒ¨**é€†å‘æ‰«æ**
2. æ‰¾åˆ°**æœ€åä¸€ä¸ª CRC32C æœ‰æ•ˆ**çš„ `MetaCommitRecord`
3. éªŒè¯å…¶ `DataTail` ä¸è¶…è¿‡ data æ–‡ä»¶é•¿åº¦ï¼ˆæ’•è£‚æ£€æµ‹ `[R-META-AHEAD-BACKTRACK]`ï¼‰
4. æˆåŠŸæ‰¾åˆ°å³ä¸º HEAD

**éœ€è¦çš„æ¥å£èƒ½åŠ›**ï¼š
- âœ… é€†å‘æ‰«æï¼ˆ`ScanReverse()`ï¼‰â€” å½“å‰æ¥å£å·²æœ‰
- âœ… å¸§å†…å®¹è¯»å– â€” å½“å‰æ¥å£å·²æœ‰
- â“ **æ–‡ä»¶æœ«å°¾ä½ç½®è·å–** â€” ç”¨äºåˆå§‹åŒ–æ‰«æèµ·ç‚¹

**å…³é”®æ´è§**ï¼šè¿™**ä¸æ˜¯**"è¯»å–æœ€åä¸€å¸§"ï¼Œè€Œæ˜¯"ä»å°¾éƒ¨å‘å‰æ‰«æï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªæœ‰æ•ˆå¸§"ã€‚å› ä¸ºå¯èƒ½å­˜åœ¨æ’•è£‚å†™å…¥ï¼ˆmeta é¢†å…ˆ dataï¼‰ï¼Œéœ€è¦è·³è¿‡æ— æ•ˆå¸§ã€‚

##### 2.2 "éšæœºè¯»å–"çš„ä½¿ç”¨åœºæ™¯

| åœºæ™¯ | è§¦å‘æ—¶æœº | è¯»å–å¯¹è±¡ | é¢‘ç‡ |
|:-----|:---------|:---------|:-----|
| **LoadObject** | é¦–æ¬¡è®¿é—®å¯¹è±¡ | ObjectVersionRecordï¼ˆæ²¿ç‰ˆæœ¬é“¾ï¼‰ | ä¸­ç­‰ï¼ˆå†·å¯åŠ¨æ—¶é«˜ï¼Œè¿è¡Œæ—¶æŒ‰éœ€ï¼‰ |
| **Version Chain Replay** | Materialize å¯¹è±¡çŠ¶æ€ | å¤šä¸ª ObjectVersionRecord | æ¯æ¬¡ LoadObject |
| **VersionIndex æŸ¥è¯¢** | LoadObject å†…éƒ¨ | VersionIndex ç‰ˆæœ¬è®°å½• | æ¯æ¬¡ LoadObjectï¼ˆå¯èƒ½å¤šè·³ï¼‰ |

**æ“ä½œæ¨¡å¼**ï¼š
```
Address64 (from VersionIndex) â†’ TryReadAt â†’ Deserialize â†’ (PrevVersionPtr) â†’ TryReadAt â†’ ...
```

**éœ€è¦çš„æ¥å£èƒ½åŠ›**ï¼š
- âœ… éšæœºè¯»å–ï¼ˆ`TryReadAt(Address64)`ï¼‰â€” å½“å‰æ¥å£å·²æœ‰

##### 2.3 è¯»å–é¢‘ç‡åˆ†æ

| è·¯å¾„ | çƒ­åº¦ | è¯´æ˜ |
|:-----|:-----|:-----|
| Meta é€†å‘æ‰«æ | **å†·è·¯å¾„** | ä»…å¯åŠ¨æ—¶æ‰§è¡Œä¸€æ¬¡ |
| Data éšæœºè¯»å– | **æ¸©è·¯å¾„** | é¦–æ¬¡è®¿é—®å¯¹è±¡æ—¶è§¦å‘ï¼Œæœ‰ Identity Map ç¼“å­˜ |
| è¿è¡Œæ—¶è¯»å– | **å†·è·¯å¾„** | å‡ ä¹ä¸å‘ç”Ÿâ€”â€”Lazy Load åå¯¹è±¡å¸¸é©»å†…å­˜ |

**æ´è§**ï¼šè¿è¡Œæ—¶çš„è¯»å–éœ€æ±‚å¾ˆä½ã€‚ä¸€æ—¦å¯¹è±¡è¢« LoadObject åŠ è½½ï¼Œå®ƒå°±è¿›å…¥ Identity Map å¹¶å¸¸é©»å†…å­˜ã€‚åç»­è®¿é—®ç›´æ¥å‘½ä¸­ç¼“å­˜ï¼Œä¸å†è§¦å‘ç£ç›˜è¯»å–ã€‚

---

#### 3. å†™å…¥æ“ä½œè¯¦ç»†éœ€æ±‚

##### 3.1 Commit æµç¨‹çš„ç²¾ç¡®æ“ä½œåºåˆ—

ä» Â§3.4.5 CommitAll å’Œ Â§3.4.4 äºŒé˜¶æ®µæäº¤æå–ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Phase 1: Prepare (Data File)                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. for each dirty object:                                    â”‚
â”‚    - framer.Append(ObjectVersionRecord)                      â”‚
â”‚ 2. framer.Append(VersionIndex overlay)                       â”‚
â”‚ 3. framer.Flush()  â† æ¨é€åˆ° OS ç¼“å†²                          â”‚
â”‚ 4. DurableFlush()  â† Data æ–‡ä»¶ fsync (MUST)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Phase 2: Finalize (Meta File)                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 5. metaFramer.Append(MetaCommitRecord)                       â”‚
â”‚ 6. metaFramer.Flush()                                        â”‚
â”‚ 7. DurableFlush()  â† Meta æ–‡ä»¶ fsync (MUST)                  â”‚
â”‚    â† COMMIT POINT                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Phase 3: Memory Update                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 8. for each dirty object:                                    â”‚
â”‚    - object.OnCommitSucceeded()                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®çº¦æŸ**ï¼ˆ`[R-COMMIT-FSYNC-ORDER]`ï¼‰ï¼š
- Data fsync **MUST** åœ¨ Meta append ä¹‹å‰å®Œæˆ
- Meta fsync å®Œæˆ = Commit Point ç¡®ç«‹

##### 3.2 Flush éœ€æ±‚åˆ†æ

| æ“ä½œ | è¯­ä¹‰ | è°ƒç”¨æ¬¡æ•°/Commit |
|:-----|:-----|:----------------|
| `Framer.Flush()` | æ¨é€ RBF ç¼“å†²åˆ° OS | 2 æ¬¡ï¼ˆData + Meta å„ä¸€æ¬¡ï¼‰ |
| `DurableFlush()` | fsyncï¼Œä¿è¯æ•°æ®è½ç›˜ | 2 æ¬¡ï¼ˆData + Meta å„ä¸€æ¬¡ï¼‰ |

**æ´è§**ï¼šæ¯æ¬¡ Commit éœ€è¦ **2 æ¬¡ DurableFlush()**â€”â€”è¿™æ˜¯äº‹åŠ¡è¯­ä¹‰çš„æ ¸å¿ƒã€‚è®¾è®¡å¿…é¡»æ”¯æŒå¯¹ä¸¤ä¸ªæ–‡ä»¶ç‹¬ç«‹æ§åˆ¶ DurableFlushã€‚

##### 3.3 Append-Only ç¡®è®¤

ä»ç›‘æŠ¤äººæè¿°å’Œæ–‡æ¡£ä¸­ç¡®è®¤ï¼š
- âœ… åªæœ‰ Append æ“ä½œï¼Œæ—  Inplace Write
- âœ… æ—  Truncate éœ€æ±‚ï¼ˆæ¢å¤æ—¶çš„ Truncate æ˜¯ç‰¹æ®Šæƒ…å†µï¼Œè§ Â§3.5ï¼‰
- âœ… æ—  Seek-then-Write éœ€æ±‚

**æ´è§**ï¼šFramer åªéœ€è¦ `Append` èƒ½åŠ›ï¼Œä¸éœ€è¦éšæœºå†™å…¥ã€‚è¿™ç®€åŒ–äº†æ¥å£è®¾è®¡ã€‚

##### 3.4 Reservationï¼ˆé¢„ç•™ç©ºé—´ï¼‰éœ€æ±‚

ä» Â§5 å®ç°å»ºè®®æå–ï¼š
- `ChunkedReservableWriter` ç”¨äº"å…ˆå†™ payloadã€åå›å¡«é•¿åº¦/CRC32C/æŒ‡é’ˆ"
- è¿™æ˜¯ **Framer å†…éƒ¨å®ç°**ï¼Œä¸éœ€è¦æš´éœ²åˆ°æ–‡ä»¶æ¥å£å±‚

**ç»“è®º**ï¼šæ–‡ä»¶æ¥å£å±‚**ä¸éœ€è¦** Reservation APIã€‚

---

#### 4. å¹¶å‘ä¸ç”Ÿå‘½å‘¨æœŸç¡®è®¤

##### 4.1 å•è¯»è€…å•å†™è€…ç¡®è®¤

ç›‘æŠ¤äººæ˜ç¡®ï¼š
> "å•è¯»è€…å•å†™è€…ï¼ˆå› ä¸ºæœ‰å†…å­˜å¯¹è±¡ç¼“å­˜ Identity Mapï¼ŒLazy Loadï¼Œè¯»å–æ“ä½œéƒ½æ˜¯ä¼´éšç€å†™å…¥ç¼“å­˜çš„å‰¯ä½œç”¨çš„ï¼‰"

**è§£è¯»**ï¼š
- ä¸æ˜¯"æ— å¹¶å‘è¯»å–"ï¼Œè€Œæ˜¯"è¯»å–ä¼šè§¦å‘å†™å…¥å‰¯ä½œç”¨"ï¼ˆæ›´æ–° Identity Mapï¼‰
- è¿™æ„å‘³ç€ä»æ–‡ä»¶æ¥å£å±‚çœ‹ï¼Œ**åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªé€»è¾‘æ“ä½œ**
- æ— éœ€è€ƒè™‘å¤šçº¿ç¨‹å¹¶å‘è®¿é—®åŒä¸€æ–‡ä»¶çš„åœºæ™¯

##### 4.2 æ–‡ä»¶å¥æŸ„ç”Ÿå‘½å‘¨æœŸ

| ç‰¹å¾ | å€¼ | å½±å“ |
|:-----|:---|:-----|
| æŒæœ‰æ—¶é•¿ | è¿›ç¨‹ç”Ÿå‘½å‘¨æœŸ | `IRbfFile` æ˜¯é•¿ç”Ÿå‘½å‘¨æœŸå¯¹è±¡ |
| æ‰“å¼€æ¬¡æ•° | å¯åŠ¨æ—¶å„æ‰“å¼€ä¸€æ¬¡ | æ— éœ€é¢‘ç¹ Open/Close |
| å…³é—­æ—¶æœº | è¿›ç¨‹ç»ˆæ­¢ | `Dispose()` åœ¨æœ€åè°ƒç”¨ |

##### 4.3 Framer ä¸ Scanner çš„å…³ç³»

ä»ä½¿ç”¨æ¨¡å¼åˆ†æï¼š

| é˜¶æ®µ | éœ€è¦çš„èƒ½åŠ› | æ˜¯å¦åŒæ—¶ |
|:-----|:-----------|:---------|
| å¯åŠ¨æ¢å¤ | Scannerï¼ˆé€†å‘æ‰«æ Metaï¼‰ | å¦ |
| å¯åŠ¨æ¢å¤ | Scannerï¼ˆéšæœºè¯» Dataï¼‰ | å¦ |
| è¿è¡Œæ—¶ | Framerï¼ˆAppend Dataï¼‰ + Scannerï¼ˆéšæœºè¯» Dataï¼‰ | å¯èƒ½åŒæ—¶ |
| Commit | Framerï¼ˆAppend Data â†’ Append Metaï¼‰ | é¡ºåº |

**å…³é”®å‘ç°**ï¼šè¿è¡Œæ—¶å¯èƒ½éœ€è¦ **Framer å’Œ Scanner å…±å­˜**ï¼ˆå†™å…¥æ–°å¸§çš„åŒæ—¶ï¼ŒLazy Load å¯èƒ½è§¦å‘è¯»å–æ—§å¸§ï¼‰ã€‚ä½†è¿™ä¸æ˜¯"å¹¶å‘"â€”â€”æ˜¯**åŒä¸€çº¿ç¨‹çš„äº¤æ›¿æ“ä½œ**ã€‚

---

#### 5. Gap åˆ†æï¼šå½“å‰è®¾è®¡ vs å®é™…éœ€æ±‚

##### 5.1 è¿‡åº¦è®¾è®¡

| åŠŸèƒ½ | å½“å‰è®¾è®¡ | å®é™…éœ€æ±‚ | è¯„ä¼° |
|:-----|:---------|:---------|:-----|
| **"è·Ÿéšè§†å›¾"** | D1 è®¨è®ºäº† Scanner æ˜¯å¦çœ‹åˆ°åç»­å¢é•¿ | Meta æ–‡ä»¶åªéœ€å¯åŠ¨æ—¶æ‰«æä¸€æ¬¡ï¼›Data æ–‡ä»¶åªéœ€éšæœºè¯»å– | **è¿‡åº¦è®¾è®¡** â€” ä¸éœ€è¦"è·Ÿéšè§†å›¾" |
| **å¤š Scanner å®ä¾‹** | D3 è®¨è®ºäº†æ•°é‡é™åˆ¶ | å®é™…åªéœ€è¦ä¸€ä¸ª Scanner | **è¿‡åº¦è®¾è®¡** â€” å•ä¾‹å³å¯ |
| **ScanReverse é€šç”¨æ€§** | è®¾è®¡ä¸ºæšä¸¾æ‰€æœ‰å¸§ | Meta åªéœ€æ‰¾æœ€åä¸€ä¸ªæœ‰æ•ˆå¸§ï¼›Data ä¸éœ€è¦æ‰«æ | **å¯èƒ½è¿‡åº¦** â€” ä½†ä¿ç•™é€šç”¨æ€§æ— å®³ |

##### 5.2 åŠŸèƒ½ç¼ºå¤±

| ç¼ºå¤±åŠŸèƒ½ | éœ€æ±‚æ¥æº | å½±å“ |
|:---------|:---------|:-----|
| **ä¸¤æ–‡ä»¶ç‹¬ç«‹ DurableFlush** | Commit æµç¨‹éœ€è¦å…ˆ Data fsync å† Meta fsync | **å…³é”®ç¼ºå¤±** â€” å½“å‰è®¾è®¡ `RbfFile.DurableFlush()` æ˜¯å•æ–‡ä»¶çš„ï¼Œä½† StateJournal éœ€è¦åè°ƒä¸¤ä¸ªæ–‡ä»¶ |
| **è·å–æ–‡ä»¶å½“å‰é•¿åº¦** | æ¢å¤æ—¶éªŒè¯ `DataTail` ä¸è¶…è¿‡ Data æ–‡ä»¶é•¿åº¦ | **å¯èƒ½éœ€è¦** â€” ç”¨äºæ’•è£‚æ£€æµ‹ |

##### 5.3 æŠ½è±¡ä¸å½“

| é—®é¢˜ | å½“å‰è®¾è®¡ | å®é™…ä½¿ç”¨æ¨¡å¼ | å»ºè®® |
|:-----|:---------|:-------------|:-----|
| **Scanner çš„å®šä½** | è®¾è®¡ä¸º"æšä¸¾å™¨"ï¼ˆ`ScanReverse()` äº§å‡ºå¸§åºåˆ—ï¼‰ | Data æ–‡ä»¶åªéœ€ `TryReadAt()`ï¼›Meta æ–‡ä»¶åªéœ€å¯åŠ¨æ—¶æ‰«æä¸€æ¬¡ | Scanner æ›´åƒæ˜¯"éšæœºè¯»å–å™¨" + "ä¸€æ¬¡æ€§æ‰«æå™¨" |
| **Framer/Scanner å…±å­˜** | å¤§é‡è®¨è®º"æ˜¯å¦å…è®¸å…±å­˜" | å®é™…æ˜¯åŒä¸€çº¿ç¨‹äº¤æ›¿ä½¿ç”¨ï¼Œä¸æ˜¯å¹¶å‘ | ä¸éœ€è¦å¤æ‚çš„å…±å­˜è¯­ä¹‰ï¼Œåªéœ€ç¡®ä¿æ“ä½œåŸå­æ€§ |
| **æ–‡ä»¶å…¥å£ç‚¹** | `RbfFile.Open()` è¿”å›å•ä¸€å…¥å£ | StateJournal éœ€è¦ç®¡ç†ä¸¤ä¸ªç‹¬ç«‹æ–‡ä»¶ï¼ˆData + Metaï¼‰ | å¯èƒ½éœ€è¦ä¸Šå±‚è‡ªå·±ç®¡ç†ä¸¤ä¸ª `RbfFile` å®ä¾‹ |

##### 5.4 æ ¸å¿ƒ Gap æ€»ç»“

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ ¸å¿ƒ Gap è¯†åˆ«                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. å½“å‰è®¾è®¡å‡è®¾"å•æ–‡ä»¶åœºæ™¯"                                  â”‚
â”‚    å®é™…éœ€æ±‚æ˜¯"åŒæ–‡ä»¶åè°ƒ"ï¼ˆData + Metaï¼‰                     â”‚
â”‚                                                            â”‚
â”‚ 2. Scanner è¢«è®¾è®¡ä¸º"æŒç»­è§‚å¯Ÿè€…"                              â”‚
â”‚    å®é™…éœ€æ±‚æ˜¯"å¯åŠ¨æ—¶ä¸€æ¬¡æ€§æ‰«æ" + "è¿è¡Œæ—¶éšæœºè¯»å–"            â”‚
â”‚                                                            â”‚
â”‚ 3. å¤§é‡è®¨è®º"å¹¶å‘å¯è§æ€§"                                      â”‚
â”‚    å®é™…æ˜¯å•çº¿ç¨‹åœºæ™¯ï¼Œä¸éœ€è¦å¤æ‚çš„å¯è§æ€§è¯­ä¹‰                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

#### 6. æ¥å£è°ƒæ•´å»ºè®®

##### 6.1 ç®€åŒ– Scanner èŒè´£

**å½“å‰**ï¼šScanner æ˜¯ä¸€ä¸ª"æšä¸¾å™¨è§†å›¾"ï¼Œå¯èƒ½éœ€è¦å¤„ç†å¹¶å‘å¯è§æ€§
**å»ºè®®**ï¼šScanner é€€åŒ–ä¸ºä¸¤ä¸ªç‹¬ç«‹èƒ½åŠ›ï¼š

```csharp
// èƒ½åŠ› 1ï¼šéšæœºè¯»å–ï¼ˆè¿è¡Œæ—¶çƒ­è·¯å¾„ï¼‰
bool TryReadFrameAt(Address64 address, out RbfFrame frame);

// èƒ½åŠ› 2ï¼šé€†å‘æ‰«æï¼ˆå¯åŠ¨æ—¶å†·è·¯å¾„ï¼‰
IEnumerable<RbfFrame> ScanReverse();  // ä¸€æ¬¡æ€§ä½¿ç”¨
```

**ç†ç”±**ï¼š
- éšæœºè¯»å–æ˜¯æ ¸å¿ƒéœ€æ±‚ï¼Œåº”è¯¥æ˜¯ç®€å•çš„"ç»™åœ°å€ï¼Œè¿”å›å¸§"
- é€†å‘æ‰«æåªåœ¨å¯åŠ¨æ—¶ç”¨ä¸€æ¬¡ï¼Œä¸éœ€è¦è€ƒè™‘"è·Ÿéšè§†å›¾"

##### 6.2 æ˜ç¡®åŒæ–‡ä»¶æ¨¡å¼

StateJournal çš„å®é™…ä½¿ç”¨æ˜¯ï¼š
```csharp
class StateJournal {
    private RbfFile _dataFile;   // ç‹¬ç«‹ç®¡ç†
    private RbfFile _metaFile;   // ç‹¬ç«‹ç®¡ç†
    
    void Commit() {
        // 1. Data æ–‡ä»¶æ“ä½œ
        _dataFramer.Append(...);
        _dataFramer.Flush();
        _dataFile.DurableFlush();  // Data å…ˆè½ç›˜
        
        // 2. Meta æ–‡ä»¶æ“ä½œ
        _metaFramer.Append(...);
        _metaFramer.Flush();
        _metaFile.DurableFlush();  // Meta åè½ç›˜ = Commit Point
    }
}
```

**å»ºè®®**ï¼šæ¥å£è®¾è®¡åº”æ˜ç¡®"æ¯ä¸ª RbfFile æ˜¯ç‹¬ç«‹çš„å•æ–‡ä»¶æŠ½è±¡"ï¼ŒåŒæ–‡ä»¶åè°ƒç”±ä¸Šå±‚è´Ÿè´£ã€‚

##### 6.3 ç®€åŒ– Framer/Scanner ç”Ÿå‘½å‘¨æœŸ

**å½“å‰**ï¼šå¤æ‚çš„å…±å­˜è¯­ä¹‰è®¨è®º
**å»ºè®®**ï¼š

```csharp
// ç®€åŒ–æ¨¡å‹ï¼šFramer å’Œ RandomReader æ˜¯åŒä¸€ RbfFile çš„ä¸¤ä¸ª"è§†å›¾"
// å®ƒä»¬å…±äº«æ–‡ä»¶å¥æŸ„ï¼Œä½†æ“ä½œäº’ä¸å½±å“ï¼ˆå› ä¸ºæ˜¯å•çº¿ç¨‹ï¼‰
class RbfFile {
    IRbfFramer Framer { get; }       // å•ä¾‹ï¼Œåˆ›å»ºæ—¶å³åˆå§‹åŒ–
    IRbfRandomReader Reader { get; } // å•ä¾‹ï¼Œåˆ›å»ºæ—¶å³åˆå§‹åŒ–
    
    // é€†å‘æ‰«ææ˜¯ä¸€æ¬¡æ€§æ“ä½œï¼Œè¿”å›æšä¸¾å™¨
    IEnumerable<RbfFrame> ScanReverse();
    
    void DurableFlush();
    void Dispose();
}
```

**ç†ç”±**ï¼š
- å»æ‰ `CreateFramer()` / `CreateScanner()` çš„"å·¥å‚"è¯­ä¹‰
- Framer å’Œ Reader å¤©ç„¶å•ä¾‹ï¼Œé¿å…"ç¬¬äºŒæ¬¡è°ƒç”¨æŠ›å¼‚å¸¸"çš„è¾¹ç•Œæƒ…å†µ
- ç¬¦åˆå®é™…ä½¿ç”¨æ¨¡å¼ï¼šæ‰“å¼€æ–‡ä»¶åé•¿æœŸæŒæœ‰ï¼Œä¸åå¤åˆ›å»ºè§†å›¾

##### 6.4 D1/D2/D3 è£å†³å»ºè®®

| å†³ç­–ç‚¹ | ç›‘æŠ¤äººå€¾å‘ | æˆ‘çš„åˆ†ææ”¯æŒ | å»ºè®® |
|:-------|:-----------|:-------------|:-----|
| **D1ï¼šScanner å¯è§æ€§** | æœªæ˜ç¡® | ä¸éœ€è¦"è·Ÿéšè§†å›¾"â€”â€”Meta åªæ‰«æä¸€æ¬¡ï¼ŒData åªéšæœºè¯»å– | **å¿«ç…§è§†å›¾ï¼ˆç®€åŒ–å®ç°ï¼‰** |
| **D2ï¼šCreate å¯¹å·²æœ‰æ–‡ä»¶** | A. FailIfExists | ç¬¦åˆå®‰å…¨åŸåˆ™ | **A. FailIfExists** |
| **D3ï¼šå¤š Scanner çº¦æŸ** | C. å•ä¾‹ | å®é™…åªéœ€è¦ä¸€ä¸ª Reader | **C. å•ä¾‹** |

---

#### 7. æ€»ç»“

**æ ¸å¿ƒå‘ç°**ï¼š

1. **StateJournal çš„ RBF ä½¿ç”¨æ¨¡å¼æ¯”é¢„æƒ³çš„ç®€å•**
   - ä¸¤ä¸ªæ–‡ä»¶ï¼Œå„è‡ªç‹¬ç«‹ç®¡ç†
   - å•çº¿ç¨‹æ“ä½œï¼Œæ— å¹¶å‘è¯­ä¹‰éœ€æ±‚
   - å†™å…¥åªæœ‰ Appendï¼Œè¯»å–æ˜¯å¯åŠ¨æ—¶æ‰«æ + è¿è¡Œæ—¶éšæœºè¯»å–

2. **å½“å‰è®¨è®ºçš„å¤æ‚æ€§æ¥è‡ª"é€šç”¨åŒ–å‡è®¾"**
   - å¤š Scanner å®ä¾‹ â†’ å®é™…åªéœ€è¦ä¸€ä¸ª
   - è·Ÿéšè§†å›¾ vs å¿«ç…§è§†å›¾ â†’ å®é™…ä¸éœ€è¦åŠ¨æ€å¯è§æ€§
   - Framer/Scanner å…±å­˜è¯­ä¹‰ â†’ å®é™…æ˜¯åŒçº¿ç¨‹äº¤æ›¿ä½¿ç”¨

3. **æ¥å£åº”è¯¥"åˆšå¥½å¤Ÿç”¨"è€Œé"é¢„ç•™æ‰©å±•"**
   - MVP é˜¶æ®µï¼Œç®€å•ç›´æ¥æ¯”çµæ´»æŠ½è±¡æ›´é‡è¦
   - è¿‡åº¦è®¾è®¡ä¼šå¢åŠ å®ç°å¤æ‚åº¦å’Œå‡ºé”™æ¦‚ç‡

**å»ºè®®çš„ä¸‹ä¸€æ­¥**ï¼š
1. ç¡®è®¤ D1/D2/D3 è£å†³
2. å°† Scanner ç®€åŒ–ä¸º `RandomReader` + `ScanReverse()` ä¸€æ¬¡æ€§æšä¸¾
3. å»æ‰å·¥å‚æ–¹æ³•ï¼Œæ”¹ä¸ºå±æ€§è®¿é—®ï¼ˆ`file.Framer` / `file.Reader`ï¼‰
4. æ˜ç¡®"åŒæ–‡ä»¶ç”±ä¸Šå±‚åè°ƒ"çš„è®¾è®¡è¾¹ç•Œ

---

<EditAnchor EOF>

### Auditor éœ€æ±‚éªŒè¯ä¸è§„èŒƒå®¡è®¡

#### 1. Claude éœ€æ±‚ç†è§£çš„éªŒè¯ç»“æœ

**æ€»ä½“ç»“è®ºï¼šå¤§ä½“å‡†ç¡®ï¼Œä½†æœ‰ 2 ä¸ªå…³é”®â€œè¯­ä¹‰è¾¹ç•Œâ€éœ€è¦çº æ­£/è¡¥å…¨ã€‚**

1) **æ–‡ä»¶æ¨¡å¼ï¼ˆData + Meta åŒæ–‡ä»¶ï¼‰**ï¼šå‡†ç¡®ã€‚
- StateJournal è§„æ ¼åœ¨â€œç£ç›˜å¸ƒå±€â€æ˜ç¡®å°† **data file** ä¸ **meta file** åˆ†ç¦»ï¼šdata æ‰¿è½½ ObjectVersionRecord/VersionIndex ç‰ˆæœ¬ï¼Œmeta æ‰¿è½½ MetaCommitRecordï¼ˆcommit logï¼‰ã€‚
- Commit çš„ durability/å¯è§ç‚¹ä¹Ÿæ˜ç¡®ç»‘å®šåˆ° meta file çš„ durable å®Œæˆã€‚

2) **è¯»å–éœ€æ±‚ï¼š"æ‰¾ Meta å°¾å¸§"**ï¼šClaude çš„â€œé€†å‘æ‰«æâ€åˆ¤æ–­å‡†ç¡®ï¼Œä½†æ‰«ææ¡ä»¶éœ€è¦æ›´ç²¾ç¡®ã€‚
- StateJournal çš„ Open æµç¨‹æ˜¯ï¼šä» meta æ–‡ä»¶å°¾éƒ¨å›æ‰«ï¼Œ**æ‰¾åˆ°æœ€åä¸€ä¸ª CRC32C æœ‰æ•ˆ**çš„ MetaCommitRecordï¼›å¹¶ä¸”å¿…é¡»åšâ€œæ’•è£‚æäº¤æ£€æµ‹â€ï¼šè‹¥è¯¥æ¡è®°å½•çš„ `DataTail` å¤§äºå½“å‰ data æ–‡ä»¶é•¿åº¦æˆ–å…¶ `VersionIndexPtr` æ— æ³•è§£å¼•ç”¨ï¼Œåˆ™ç»§ç»­å›æ‰«ä¸Šä¸€æ¡ï¼ˆ`[R-META-AHEAD-BACKTRACK]`ï¼‰ã€‚
- è¿™ä¸æ˜¯â€œè¯»æœ€åä¸€å¸§â€ï¼Œè€Œæ˜¯â€œä»å°¾åˆ°å¤´æ‰¾æœ€åä¸€æ¡å¯éªŒè¯ HEADâ€ã€‚
- **ç©ºä»“åº“è¾¹ç•Œ**ä¹Ÿå¿…é¡»ç®—è¿›éœ€æ±‚ï¼šmeta æ–‡ä»¶ä¸ºç©ºæˆ–æ‰¾ä¸åˆ°æœ‰æ•ˆ MetaCommitRecord æ—¶ï¼ŒStateJournal å°†è¿›å…¥â€œéšå¼ç©ºçŠ¶æ€â€ï¼ˆEpochSeq=0 ç­‰ï¼‰ã€‚

3) **è¯»å–éœ€æ±‚ï¼š"éšæœºè¯»å–" ä¸ Lazy Load**ï¼šClaude çš„â€œTryReadAt(Address64) + ç‰ˆæœ¬é“¾é‡æ”¾â€åˆ¤æ–­å‡†ç¡®ã€‚
- éšæœºè¯»çƒ­è·¯å¾„æ¥è‡ª `LoadObject(ObjectId)`ï¼šVersionIndex ç»™å‡º ObjectVersionPtrï¼Œç„¶åæ²¿ `PrevVersionPtr` é“¾åš Deserialize+Materializeã€‚
- Lazy Loadï¼ˆObjRef é€æ˜åŠ è½½ï¼‰ä¼šè§¦å‘ LoadObjectï¼Œå› æ­¤ç¡®å®æ˜¯â€œæŒ‰éœ€éšæœºè¯»â€çš„è§¦å‘åœºæ™¯ã€‚

4) **å†™å…¥éœ€æ±‚ï¼šCommit æ˜¯å¦éœ€è¦ 2 æ¬¡ DurableFlushï¼Œé¡ºåºæ˜¯å¦ Dataâ†’Meta**ï¼šClaude åˆ¤æ–­å‡†ç¡®ã€‚
- StateJournal æ˜ç¡® `[R-COMMIT-FSYNC-ORDER]`ï¼šå¿…é¡»å…ˆ data æ–‡ä»¶ durableï¼Œå† meta æ–‡ä»¶ durableï¼›meta durable å®Œæˆå®šä¹‰ Commit Pointï¼ˆ`[R-COMMIT-POINT-META-FSYNC]`ï¼‰ã€‚
- å› æ­¤â€œæ¯æ¬¡ commit è‡³å°‘ 2 æ¬¡ durableï¼ˆdata+meta å„ä¸€æ¬¡ï¼‰â€æˆç«‹ã€‚

**éœ€è¦çº æ­£/è¡¥å…¨çš„å…³é”®ç‚¹ï¼ˆå½±å“ D1 ä¸æ¥å£è¯­ä¹‰ï¼‰**ï¼š
- Claude è¯´â€œè·Ÿéšè§†å›¾ä¸éœ€è¦â€åœ¨ **ScanReverseï¼ˆå°¾æ‰«ï¼‰** ç»´åº¦åŸºæœ¬æˆç«‹ï¼›ä½†åœ¨ **TryReadAtï¼ˆéšæœºè¯»ï¼‰** ç»´åº¦å¿…é¡»è¡¥å…¨ï¼šStateJournal æ˜¯é•¿ç”Ÿå‘½å‘¨æœŸæŒæœ‰å¥æŸ„ã€æŒç»­ append çš„ç³»ç»Ÿï¼Œéšæœºè¯»å¿…é¡»åœ¨â€œæ–‡ä»¶å¢é•¿ï¼ˆåŒè¿›ç¨‹åŒå¥æŸ„ï¼‰â€ä¸‹å¯åˆ¤å®šã€‚
    - æœ€å°æ­£ç¡®è¯­ä¹‰ï¼š`TryReadAt(addr)` ä»¥â€œè°ƒç”¨æ—¶åˆ»çš„å½“å‰æ–‡ä»¶å†…å®¹/é•¿åº¦â€ä¸ºå‡†ï¼›è‹¥ `addr` è½åœ¨å½“å‰ EOF ä¹‹å¤–è¿”å› `false`ï¼›è‹¥éšåæ–‡ä»¶å¢é•¿ï¼Œå†æ¬¡è°ƒç”¨å¯å˜ä¸º `true`ã€‚
    - å¦åˆ™ä¼šå‡ºç°â€œReader/Scanner ç»‘å®šåˆ°æ‰“å¼€ç¬é—´å¿«ç…§é•¿åº¦â€çš„é”™è¯¯å®ç°ï¼Œç ´åè¿è¡Œæ—¶å¯¹æ–°å†™å…¥ record çš„è¯»å–èƒ½åŠ›ï¼ˆå°¤å…¶ commit åå¯¹æ–°åœ°å€çš„è¯»å–ï¼‰ã€‚

---

#### 2. Gap åˆ†æçš„éªŒè¯

| Gap ç±»å‹ | Claude çš„åˆ¤æ–­ | æˆ‘çš„éªŒè¯ |
|:--|:--|:--|
| **è¿‡åº¦è®¾è®¡** | â€œè·Ÿéšè§†å›¾ä¸éœ€è¦â€ | **éƒ¨åˆ†æˆç«‹**ï¼šå¯¹ meta çš„ `ScanReverse()`ï¼ˆå¯åŠ¨æ—¶å°¾æ‰«ï¼‰è€Œè¨€ï¼Œä¸Šå±‚æ²¡æœ‰â€œè¿è¡Œæ—¶è§‚å¯Ÿæ–‡ä»¶å¢é•¿å¹¶æŒç»­å°¾éšæšä¸¾â€çš„éœ€æ±‚ï¼›ä½†å¯¹ data çš„ `TryReadAt()` è€Œè¨€ï¼Œå¿…é¡»å®šä¹‰â€œæ–‡ä»¶å¢é•¿æœŸé—´çš„éšæœºè¯»è¡Œä¸ºâ€ï¼ˆè§ Â§4 å…³é”®å¥‘çº¦ï¼‰ï¼Œå¦åˆ™å®ç°ä¼šéšå¼é€‰ä¸€ç§è¯­ä¹‰ã€‚æ¢è¨€ä¹‹ï¼š**ä¸éœ€è¦â€œè·Ÿéšå¼ ScanReverseâ€ï¼Œä½†éœ€è¦â€œå¢é•¿å¯è§çš„ TryReadAtâ€**ã€‚ |
| **åŠŸèƒ½ç¼ºå¤±** | â€œåŒæ–‡ä»¶åè°ƒç”±ä¸Šå±‚è´Ÿè´£â€ | **æˆç«‹ä¸”å±‚çº§åˆ’åˆ†åˆç†**ï¼šè·¨æ–‡ä»¶äº‹åŠ¡ï¼ˆdataâ†’meta çš„ durable é¡ºåºï¼‰æ˜¯ StateJournal çš„ Layer 1 è¯­ä¹‰ï¼Œä¸åº”ä¸‹æ²‰åˆ°å•æ–‡ä»¶çš„ RBF å±‚ã€‚RBF æ–‡ä»¶äº¤äº’æ¥å£åªéœ€æä¾›â€œæ¯ä¸ªæ–‡ä»¶å„è‡ªçš„ DurableFlush/Length/Truncate ç­‰èƒ½åŠ›â€ï¼Œä¸Šå±‚ç»„åˆå³å¯å®ŒæˆäºŒé˜¶æ®µæäº¤ã€‚ |
| **æŠ½è±¡ä¸å½“** | â€œScanner åº”æ˜¯ä¸€æ¬¡æ€§å·¥å…·â€ | **ä¸æˆç«‹ï¼ˆéœ€è¦æ‹†åˆ†è¯­ä¹‰ï¼‰**ï¼š`ScanReverse()` æ˜¯å†·è·¯å¾„çš„ä¸€æ¬¡æ€§å·¥å…·ï¼Œä½† `TryReadAt()` æ˜¯æ•´ä¸ªç”Ÿå‘½å‘¨æœŸéƒ½ä¼šç”¨çš„éšæœºè¯»èƒ½åŠ›ï¼ˆLoadObject/LazyLoad/ç‰ˆæœ¬é“¾å›æ”¾ï¼‰ã€‚å› æ­¤ Scanner ä½œä¸ºâ€œé•¿æœŸå­˜åœ¨çš„éšæœºè¯»è€… + æä¾›ä¸€æ¬¡æ€§å°¾æ‰«èƒ½åŠ›â€çš„ç»„åˆæ˜¯åˆç†çš„ï¼›è‹¥è¦æ‹†åˆ†ï¼Œä¹Ÿåº”æ˜¯â€œæ¥å£æ‹†åˆ†ï¼ˆRandomReader vs ReverseScannerï¼‰â€ï¼Œè€Œä¸æ˜¯æŠŠ Scanner æ•´ä½“é™æ ¼ä¸ºä¸€æ¬¡æ€§ã€‚ |

è¡¥ä½ï¼š**ç¼ºå£ï¼ˆå¯åˆ¤å®šæ€§ï¼‰**
- Claude Gap è¡¨é‡Œéšå«äº†â€œæˆ‘ä»¬å¯ä»¥æŠŠ D1ï¼ˆå¯è§æ€§ï¼‰ç›´æ¥åˆ æ‰â€çš„å€¾å‘ï¼›ä½†ä»è§„èŒƒè§’åº¦çœ‹ï¼ŒD1 ä¸èƒ½æ¶ˆå¤±ï¼Œåªèƒ½è¢«â€œæ›´å°ä½†å¯åˆ¤å®šçš„æ‰¿è¯ºâ€æ›¿ä»£ï¼šè‡³å°‘è¦æŠŠ `TryReadAt` åœ¨æ–‡ä»¶å¢é•¿ä¸ EOF è¾¹ç•Œä¸‹çš„è¡Œä¸ºå†™æˆå¥‘çº¦ã€‚

---

#### 3. æ¥å£è°ƒæ•´çš„è§„èŒƒå®¡è®¡

æœ¬èŠ‚çš„â€œå…¼å®¹æ€§â€ä»¥ç°è¡Œ RBF SSOT ä¸ºå‡†ï¼š [atelia/docs/Rbf/rbf-interface.md](atelia/docs/Rbf/rbf-interface.md)ã€‚

**(1) ä¿æŒä¸€è‡´æ€§ï¼ˆä¸ rbf-interface.md æ¡æ¬¾å…¼å®¹ï¼‰**
- âœ… å…è®¸æ–°å¢â€œæ–‡ä»¶äº¤äº’å…¥å£ï¼ˆRbfFile/IRbfFileï¼‰â€æ˜¯å…¼å®¹çš„ï¼š`rbf-interface.md` ç›®å‰åªå®šä¹‰ `IRbfFramer/IRbfScanner`ï¼Œå¹¶æœªè§„å®šå¦‚ä½•ä»è·¯å¾„è·å¾—å®ƒä»¬ã€‚
- âš ï¸ éœ€è¦ä¿®è®¢/å¯¹é½çš„ç‚¹ï¼š`IRbfFramer.Flush()` remarks ç›®å‰å†™â€œç”±ä¸Šå±‚åœ¨å…¶æŒæœ‰çš„åº•å±‚å¥æŸ„ä¸Šæ‰§è¡Œ durable flushâ€ã€‚å¦‚æœæ–°å¢ `RbfFile.DurableFlush()` å¹¶è®©ä¸Šå±‚ä¸å†æŒæœ‰å¥æŸ„ï¼Œè¿™æ®µæ–‡å­—ä¼šå˜æˆè¯¯å¯¼æ€§æš—å¥‘çº¦ï¼Œåº”åŒæ­¥æ”¹ä¸ºâ€œé€šè¿‡æ–‡ä»¶å…¥å£ç‚¹æ‰§è¡Œ durable flushâ€ã€‚
- âœ… Claude çš„â€œæ¯ä¸ªæ–‡ä»¶ç‹¬ç«‹ DurableFlushï¼Œä¸Šå±‚åè°ƒ dataâ†’metaâ€ä¸ StateJournal `[R-COMMIT-FSYNC-ORDER]` ä¸€è‡´ã€‚

**(2) å¯åˆ¤å®šæ€§ï¼ˆèƒ½å¦å†™æˆæ˜ç¡®å¥‘çº¦ï¼‰**
- â€œå»æ‰å·¥å‚æ–¹æ³•ã€æ”¹å±æ€§å•ä¾‹ï¼ˆfile.Framer / file.Readerï¼‰â€æœ¬èº«ä¸è‡ªåŠ¨æå‡å¯åˆ¤å®šæ€§ï¼Œåè€Œå¯èƒ½å¼•å…¥æ–°çš„ä¸å¯åˆ¤å®šé¢ï¼š
    - éœ€è¦æ˜ç¡®ï¼šè¿™äº›å±æ€§æ˜¯å¦æ°¸è¿œè¿”å›åŒä¸€å®ä¾‹ï¼ŸDispose åè®¿é—®å¦‚ä½•ï¼Ÿçº¿ç¨‹å®‰å…¨å¦‚ä½•ï¼Ÿ
    - è‹¥æœªæ¥è¦å¼•å…¥â€œå¿«ç…§ scanner vs è·Ÿéš scannerâ€ï¼Œå±æ€§å•ä¾‹ä¼šæŠŠæ‰©å±•ç‚¹é”æ­»ã€‚
- æ›´å¯åˆ¤å®šçš„åšæ³•æ˜¯ï¼šä¿ç•™ `CreateFramer()/CreateScanner(options?)` ä½œä¸ºæ˜¾å¼æ“ä½œï¼Œå¹¶ç”¨æ¡æ¬¾è§„å®šâ€œå½“å‰ MVP çš„é»˜è®¤ç­–ç•¥å¯ä»¥è¿”å›å•ä¾‹ï¼Œä½†ä¸å¾—æ‰¿è¯ºæ°¸è¿œå•ä¾‹â€ã€‚

**(3) å‰å‘å…¼å®¹ï¼ˆæœªæ¥éœ€æ±‚å˜åŒ–æ˜¯å¦æ˜“æ‰©å±•ï¼‰**
- Claude çš„â€œScanner æ‹†æˆ RandomReader + ScanReverse ä¸€æ¬¡æ€§æšä¸¾â€åœ¨å·¥ç¨‹ä¸Šå¯è¡Œï¼Œä½†ä»è§„èŒƒæ¼”è¿›è§’åº¦ï¼š
    - âœ… å¯ä»¥ä½œä¸ºâ€œæ›´ç»†çš„æ¥å£åˆ†å±‚â€ï¼Œè®©ä¸Šå±‚åªä¾èµ– RandomReaderï¼ˆçƒ­è·¯å¾„ï¼‰è€ŒæŠŠ ScanReverse ç•™ç»™æ¢å¤è·¯å¾„ã€‚
    - âš ï¸ ä½†å¦‚æœç›´æ¥æ›¿æ¢/åˆ æ”¹ç°æœ‰ `IRbfScanner`ï¼ˆSSOT å·²å‘å¸ƒä¸”æœ‰æµ‹è¯•å‘é‡ä¾èµ–ï¼‰ï¼Œä¼šé€ æˆè§„èŒƒæ¼‚ç§»ã€‚å»ºè®®ç­–ç•¥æ˜¯ï¼š**ä¿æŒ `IRbfScanner` ä¸å˜**ï¼Œåœ¨æ–‡ä»¶äº¤äº’å±‚æä¾›æ›´è´´è¿‘ç”¨ä¾‹çš„ facadeï¼ˆä¾‹å¦‚ `IRbfRandomReader` ä»…æš´éœ² TryReadAtï¼‰ï¼Œè€Œéåå‘ä¿®æ”¹ Layer 0/1 è¾¹ç•Œå¥‘çº¦ã€‚

---

#### 4. å…³é”®å¥‘çº¦æ¸…å•ï¼ˆåŸºäºçœŸå®éœ€æ±‚ï¼‰

ä»¥ä¸‹å¥‘çº¦è‹¥ä¸æ˜¾å¼åŒ–ï¼Œä¼šç›´æ¥å¯¼è‡´å®ç°å€’çŒ/è¡Œä¸ºä¸å¯åˆ¤å®šï¼ˆå°¤å…¶æ˜¯ D1 ä¸ durabilityï¼‰ï¼š

1) **`TryReadAt(Address64)` åœ¨æ–‡ä»¶å¢é•¿æœŸé—´çš„è¡Œä¸º**ï¼ˆdata file çƒ­è·¯å¾„ï¼‰
- MUSTï¼šä»¥â€œè°ƒç”¨æ—¶åˆ»â€çš„æ–‡ä»¶å†…å®¹ä¸ºå‡†ã€‚
- MUSTï¼šå½“ `address` åœ¨è°ƒç”¨æ—¶åˆ»çš„ EOF ä¹‹åï¼Œè¿”å› `false`ï¼ˆä¸å¾—è¿”å›åŠåˆå§‹åŒ– frameï¼Œäº¦ä¸åº”é™é»˜æŠ›å¼‚å¸¸ä½œä¸ºå¸¸æ€ï¼‰ã€‚
- SHOULDï¼šå½“ `address` åœ¨ EOF ä¹‹å†…ä½†å¸§æŸå/CRC å¤±è´¥æ—¶ï¼Œè¿”å› `false` æˆ–æŠ›å‡ºæ˜ç¡®çš„â€œæ ¼å¼æŸåå¼‚å¸¸â€â€”â€”éœ€è¦åœ¨æ¥å£å±‚è£å†³ä¸€ç§ä¸»è·¯å¾„ï¼ˆå¦åˆ™è°ƒç”¨æ–¹æ— æ³•å†™æµ‹è¯•æ–­è¨€ï¼‰ã€‚
- MUSTï¼š`address=0`ï¼ˆNullï¼‰å¤„ç†è¦å¯åˆ¤å®šï¼ˆå»ºè®®è¿”å› `false`ï¼‰ã€‚

2) **`ScanReverse()` çš„æ‰«æçª—å£ä¸å¹¶å‘ä¿®æ”¹**ï¼ˆmeta file å†·è·¯å¾„ï¼‰
- `rbf-interface.md` å·²å®šä¹‰ï¼šæšä¸¾æœŸé—´æ–‡ä»¶è¢«ä¿®æ”¹è¡Œä¸ºæœªå®šä¹‰ï¼ˆ`[S-RBF-SCANREVERSE-CONCURRENT-MUTATION]`ï¼‰ã€‚
- è‹¥æœªæ¥å¸Œæœ›å…è®¸â€œå†™å…¥åŒæ—¶å°¾æ‰«â€ï¼Œå¿…é¡»æ–°å¢æ¡æ¬¾ç¼©å°æœªå®šä¹‰åŒºï¼ˆä¾‹å¦‚ï¼šæ‰«æçª—å£å›ºå®šä¸ºè°ƒç”¨å¼€å§‹æ—¶çš„ EOFï¼Œä¸”ä»…ä¿è¯çœ‹åˆ°è°ƒç”¨å‰å·² durable çš„å¸§ï¼‰ã€‚åœ¨ MVP ä¸­å¯ä»¥æ˜ç¡®ç¦æ­¢æˆ–ç»´æŒæœªå®šä¹‰ï¼Œä½†å¿…é¡»è®©ä¸Šå±‚çŸ¥é“â€œè¦åœ¨ç¨³å®šå¿«ç…§ä¸Šè°ƒç”¨â€ã€‚

3) **`DurableFlush()` çš„è¾¹ç•Œä¸æ•ˆæœ**ï¼ˆcommit å…³é”®ï¼‰
- MUSTï¼šDurableFlush åªä¿è¯â€œåœ¨åŒä¸€æ–‡ä»¶ä¸Šï¼ŒDurableFlush è°ƒç”¨è¿”å›å‰å·²å®Œæˆ flush çš„å­—èŠ‚â€è¾¾åˆ° durabilityï¼ˆfsync ç­‰ä»·æ•ˆæœï¼‰ã€‚
- MUSTï¼šDurableFlush ä¸ `IRbfFramer.Flush()` çš„å…³ç³»å¯åˆ¤å®šï¼ˆFlushâ‰ Durableï¼›Flush ä¸å« fsyncï¼Œå·²ç”± `[S-RBF-FRAMER-NO-FSYNC]` å®šä¹‰ï¼‰ã€‚
- MUSTï¼šdisposed å DurableFlush çš„è¡Œä¸ºï¼ˆå»ºè®®æŠ› `ObjectDisposedException`ï¼‰ä¸å¼‚å¸¸ç±»å‹éœ€å›ºå®šã€‚

4) **åŒæ–‡ä»¶ commit çš„æœ€å°åŸå­æ€§æ‰¿è¯º**ï¼ˆStateJournal çœŸå®éœ€æ±‚ï¼‰
- MUSTï¼šä¸Šå±‚èƒ½å¤Ÿåˆ†åˆ«å¯¹ data ä¸ meta æ‰§è¡Œ DurableFlushã€‚
- MUSTï¼šä¸Šå±‚èƒ½å¤ŸæŸ¥è¯¢ data æ–‡ä»¶çš„å½“å‰é•¿åº¦ï¼ˆbyteï¼‰ï¼Œç”¨äºéªŒè¯ `MetaCommitRecord.DataTail <= data.Length`ï¼ˆæ’•è£‚æ£€æµ‹ï¼‰ã€‚

5) **æ¢å¤æœŸæˆªæ–­ï¼ˆtruncateï¼‰èƒ½åŠ›**ï¼ˆStateJournal Â§3.5ï¼‰
- MUSTï¼šä¸Šå±‚èƒ½å¤ŸæŒ‰ `DataTail` æˆªæ–­ data æ–‡ä»¶å°¾éƒ¨åƒåœ¾ï¼ˆ`[R-DATATAIL-TRUNCATE-GARBAGE]`ï¼‰ã€‚
- MUSTï¼šæˆªæ–­åçš„ Address64/Ptr64 å¤±æ•ˆè¯­ä¹‰è¦æ˜ç¡®ï¼ˆè¢«æˆªæ–­åŒºé—´å†…çš„åœ°å€åç»­ TryReadAt å¿…é¡»å¤±è´¥ï¼‰ã€‚

6) **å¤šè¿›ç¨‹/å¤šå®ä¾‹è¯­ä¹‰ï¼ˆæœ€ä½é™åº¦ï¼‰**
- MVP å…è®¸ç»´æŒâ€œæœªå®šä¹‰/ä¸æ”¯æŒå¤š writerâ€ï¼Œä½†å¿…é¡»åœ¨æ–‡ä»¶å…¥å£å±‚å¯åˆ¤å®šï¼š
    - ä¾‹å¦‚ï¼šCreateFramer è‹¥æ— æ³•è·å¾—å†™å…¥ç‹¬å ï¼ˆè¢«å…¶ä»–è¿›ç¨‹/å®ä¾‹æŒæœ‰ writerï¼‰ï¼ŒMUST fail-fastï¼ˆå¼‚å¸¸ç±»å‹éœ€å›ºå®šï¼‰ï¼Œè€Œä¸æ˜¯é™é»˜äº§ç”ŸæŸåã€‚

---

#### 5. æœ€å°å¯è¡Œæ¥å£ï¼ˆMVPï¼‰å»ºè®®

ç›®æ ‡ï¼šåªè¦†ç›– StateJournal çš„çœŸå®ç”¨æ³•ï¼ˆåŒæ–‡ä»¶ã€å°¾æ‰«ã€éšæœºè¯»ã€append-onlyã€ä¸¤é˜¶æ®µ commitã€æ¢å¤æˆªæ–­ï¼‰ï¼Œå¹¶ä¿æŒä¸ `rbf-interface.md` çš„ SSOT ä¸€è‡´ã€‚

**ä¿ç•™ï¼ˆå¿…é¡»ï¼‰**
- æ–‡ä»¶å…¥å£ï¼š`CreateNew(path)` / `OpenExisting(path)`ï¼ˆæˆ–åŒç­‰è¯­ä¹‰çš„ `Create`/`Open`ï¼Œä½†å¿…é¡»æ”¯æŒ FailIfExists ä¸â€œOpen éªŒè¯ Genesisâ€ï¼‰ã€‚
- è§†å›¾ï¼š`IRbfFramer`ï¼ˆappend/flush/builderï¼‰ä¸ `IRbfScanner`ï¼ˆTryReadAt/ScanReverseï¼‰ã€‚
- `DurableFlush()`ï¼šæ–‡ä»¶çº§ durability æ§åˆ¶ï¼ˆä¾› dataâ†’meta é¡ºåºï¼‰ã€‚
- `LengthBytes`ï¼ˆæˆ– `GetLengthBytes()`ï¼‰ï¼šç”¨äº `DataTail` æ ¡éªŒã€‚
- `Truncate(ulong newLengthBytes)`ï¼šç”¨äºæ¢å¤æœŸæŒ‰ DataTail æˆªæ–­ data fileã€‚
- ç”Ÿå‘½å‘¨æœŸï¼š`Dispose()` å…³é—­å¥æŸ„ï¼›Dispose å¹‚ç­‰æ€§ä¸ disposed åè¡Œä¸ºå¿…é¡»å¯åˆ¤å®šã€‚

**å»æ‰ï¼ˆMVP ä¸è¦æ‰¿è¯ºï¼‰**
- â€œè·Ÿéšå¼ ScanReverseï¼ˆè¾¹å†™è¾¹æŒç»­æšä¸¾ï¼‰â€è¯­ä¹‰ï¼ˆå¯å…ˆä¿æŒæœªå®šä¹‰æˆ–æ˜ç¡®ç¦æ­¢ï¼‰ã€‚
- å¤š scanner å®ä¾‹çš„å¼ºæ‰¿è¯ºï¼ˆå¯ä»¥å…è®¸åˆ›å»ºå¤šä¸ªï¼Œä½†ä¸éœ€è¦æ‰¿è¯ºï¼›è‹¥è¦ç®€å•ï¼Œå¯å…ˆè§„å®šå•ä¾‹æˆ–ä¸Šé™ï¼Œä½†éœ€å†™æ¸…æ¥šï¼‰ã€‚
- æš´éœ² Stream/Backend æ³¨å…¥ï¼ˆç›‘æŠ¤äººå·²æ’é™¤ï¼‰ã€‚

**è°ƒæ•´ï¼ˆæŠŠè¯­ä¹‰é’‰æ­»ï¼‰**
- `TryReadAt` çš„ EOF/å¢é•¿/æŸåè¯­ä¹‰ï¼ˆè§ Â§4-1ï¼‰ã€‚
- `Create`/`Open` å¯¹ 0 å­—èŠ‚æ–‡ä»¶ã€Genesis ç¼ºå¤±ã€æƒé™é”™è¯¯ã€æŸåç­‰çš„å¼‚å¸¸åˆ†ç±»ï¼ˆè‡³å°‘è¦èƒ½å†™é»‘ç›’æµ‹è¯•ï¼‰ã€‚
- `Flush` çš„ durable è¾¹ç•Œï¼š`IRbfFramer.Flush()` ä»ä¿æŒâ€œä¸å« fsyncâ€ï¼Œdurable ç”±æ–‡ä»¶å…¥å£æä¾›ã€‚

**å»ºè®®çš„ MVP å½¢çŠ¶ï¼ˆç¤ºæ„ï¼Œè§„èŒƒåº”ä»¥æ¡æ¬¾è€Œéç¤ºä¾‹ä¸º SSOTï¼‰**

```csharp
public interface IRbfFile : IDisposable
{
        string Path { get; }

        // å½“å‰ OS è§†è§’çš„æ–‡ä»¶é•¿åº¦ï¼ˆbyteï¼‰ã€‚ç”¨äº meta.DataTail æ ¡éªŒã€‚
        ulong LengthBytes { get; }

        // è§†å›¾
        IRbfFramer CreateFramer();        // MVP å»ºè®®ï¼šæœ€å¤šä¸€æ¬¡æˆåŠŸï¼ˆå• writerï¼‰
        IRbfScanner CreateScanner();      // MVPï¼šè‡³å°‘ä¸€ä¸ªï¼›å¯å®ç°ä¸ºå•ä¾‹

        // durability
        void DurableFlush();

        // recovery
        void Truncate(ulong newLengthBytes);
}

public static class RbfFile
{
        public static IRbfFile CreateNew(string path);      // FailIfExists
        public static IRbfFile OpenExisting(string path);   // éªŒè¯ Genesis
}
```

---

## ç›‘æŠ¤äºº--åˆ˜ä¸–è¶… ç¬¬äºŒè½®å‘è¨€
åŸºäºä»¥ä¸Šå¤§å®¶çš„åˆ†æï¼Œæˆ‘æœ‰äº†æ›´æ¸…æ™°çš„æ€è·¯ï¼Œä½œä¸ºå¯¹å¤§å®¶å·²è¾¾æˆå…±è¯†çš„è¡¥å……ï¼Œè¯·å„ä½åŒä»åˆ†ææ˜¯å¦åˆç†å¯è¡Œã€‚
1. åˆ†å±‚ã€‚
  A. å¯æµ‹è¯•çš„æ ¼å¼ä¸ç¼–ç ç»„ä»¶å±‚ï¼Œå·¥ä½œåœ¨{Stream/ReadonAccess/mmap accessor}ä¸Šã€‚å…·ä½“ç”¨ä»€ä¹ˆAPIå¾…è¿›ä¸€æ­¥åˆ†æã€‚
  B. æ–‡ä»¶å¥æŸ„ç®¡ç†å±‚ï¼Œç‹¬å æ–‡ä»¶ã€åˆ›å»º/æ‰“å¼€/å…³é—­ã€‚è¿™éƒ¨åˆ†å¯ä»¥åªåšæå°‘çš„å•å…ƒæµ‹è¯•ã€‚ç®¡ç†{FileStream/SafeFileHandle/MemoryMappedFile}ã€‚

2. faÃ§ade æ¨¡å¼ã€‚
  ä¸ºå¸¸è§„è¯»å†™æä¾›å‚»ç“œé£æ ¼çš„é—¨é¢ç±»å‹ã€‚æŠŠæ‰€æœ‰å¤æ‚æ€§å°è£…èµ·æ¥ï¼Œæä¾›ä¸€ä¸ªæ˜“ç”¨çš„ç•Œé¢ï¼Œè®©æœ€ç»ˆç”¨æˆ·èƒ½ä¼ å…¥è·¯å¾„å°±èƒ½å¾—åˆ°ä¸€ä¸ªé—¨é¢å¯¹è±¡ï¼Œåœ¨é—¨é¢å¯¹è±¡ä¸Šç›´æ¥æä¾›ä»åå‘å‰è¿­ä»£åˆæ³•å¸§ï¼Œä»¥åŠéšæœºè¯»å–ä¸€å¸§(å«crcéªŒè¯)çš„èƒ½åŠ›ã€‚
  ä¸ºç¾éš¾æ¢å¤ç­‰é«˜çº§åœºæ™¯æä¾›å¦å¤–çš„ToolKitï¼Œè®¾è®¡ä¸å®ç°å¯å»¶åã€‚

3. å‡çº§Address64ä¸ºFramePtr structã€‚
  å†…éƒ¨åŒ…å«4å­—èŠ‚å¯¹é½çš„æ–‡ä»¶å†…åç§»é‡å’ŒFrameé•¿åº¦ï¼Œè¿™æ ·è¯»å–æ—¶ä¸€æ¬¡æ€§å°±èƒ½çŸ¥é“â€œåœ¨å“ªè¯»ï¼Œè¯»å¤šå°‘â€æ–¹ä¾¿è¯»å–è·¯å¾„ã€‚ä¸ºäº†æ”¯æŒåºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œéœ€è¦èƒ½æ‰“åŒ…æˆulong(uint64)å’Œä»ulongè§£åŒ…ã€‚ä¸æ”¯æŒæè¿°é4Bå¯¹é½åœ°å€ï¼Œä»¥èŠ‚çº¦2 bitã€‚æˆ‘ä»¬éœ€è¦é€‰æ‹©bitåˆ†é…ï¼Œå¤šå°‘ç»™åœ°å€éƒ¨åˆ†ï¼Œå¤šå°‘ç»™é•¿åº¦éƒ¨åˆ†ã€‚æˆ‘ä¼°è®¡å•ä¸ªframeä¸ä¼šéœ€è¦å¤ªé•¿ï¼Œè‚¯å®šä¸éœ€è¦ä¸ŠGBã€‚

4. æ ¹æ®è¯»å†™éœ€æ±‚ï¼Œç¡®å®šä¸€ç§å¸¸è§„è·¯å¾„åº•å±‚APIã€‚ç¾éš¾æ¢å¤ç­‰é«˜çº§åœºæ™¯å¯ä»¥æœ‰å®Œå…¨ç‹¬ç«‹çš„å·¥å…·æ ˆï¼Œæˆ‘ä»¬å…ˆä¸ç®¡ã€‚
  - è¦ä¸è¦ç¼“å­˜ï¼Ÿå¦‚æœè¦ï¼Œç”¨æ ‡å‡†åº“è‡ªå¸¦çš„ç¼“å­˜è¿˜æ˜¯æˆ‘ä»¬è‡ªå·±å†™ï¼Ÿ
  - é…åˆFramePtr structï¼Œä¼¼ä¹ReadonAccessæ˜¯æœ€ä½³é€‰æ‹©ï¼Œä½†æ˜¯æˆ‘ä»¬å®ç°ä»£ç çš„å•å…ƒæµ‹è¯•æ€§è¦æ€ä¹ˆåšï¼Ÿ
  - ç”¨Streamçš„è¯ï¼Œç‰ºç‰²ç‚¹æ€§èƒ½ï¼Œæ˜¯å¦èƒ½å¤§å¹…ç®€åŒ–æˆ‘ä»¬çš„å®ç°ï¼Ÿ

ä¸è¦æŠŠæˆ‘çš„è¯å½“æŒ‡ä»¤ï¼Œä¹Ÿåªæ˜¯å€™é€‰æŠ€æœ¯æ–¹æ¡ˆï¼Œæˆ‘ä»¬è¦ä»è½¯ä»¶å·¥ç¨‹çš„åŸç†å¯»æ‰¾å¥½çš„è®¾è®¡ã€‚
---

### Advisor-Claude å‘è¨€ï¼ˆåˆ†å±‚ä¸ FaÃ§ade æ¶æ„åˆ†æï¼‰

> **taskTag**: #design
> **scope**: æ¶æ„åˆç†æ€§åˆ†æï¼ŒåŸºäºè½¯ä»¶å·¥ç¨‹åŸç†
> **åŸºäº**: ç›‘æŠ¤äººç¬¬äºŒè½®å‘è¨€ä¸­çš„å››ç‚¹æ¶æ„æè®®

---

#### å¿«é€Ÿè½¨é“ï¼ˆ30 ç§’æ‰«æï¼‰

| æè®® | è¯„ä¼° | æ ¸å¿ƒç†ç”± |
|:-----|:-----|:---------|
| **A/B åˆ†å±‚** | âœ… åˆç† | ä¾èµ–å€’ç½® + æµ‹è¯•æ€§åˆ†ç¦» |
| **FaÃ§ade æ¨¡å¼** | âœ… åˆç†ï¼ˆéœ€æŠ¤æ ï¼‰ | éšè—å¤æ‚æ€§ï¼Œä½†éœ€é˜²æ­¢ God Object |
| **FramePtr struct** | âš ï¸ éœ€æƒè¡¡ | è¯»è·¯å¾„æ”¶ç›Šæ˜ç¡®ï¼Œå†™è·¯å¾„éœ€è°ƒæ•´ |
| **RandomAccess åº•å±‚** | âœ… æ¨è | æ— çŠ¶æ€ã€çº¿ç¨‹å®‰å…¨ã€ä¸ A å±‚ç†å¿µåŒ¹é… |

---

#### æ·±åº¦è½¨é“

---

##### 1. åˆ†å±‚åˆç†æ€§åˆ†æ

**1.1 ä¾èµ–å€’ç½®è¯„ä¼°**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ç›‘æŠ¤äººæè®®çš„åˆ†å±‚                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚    â”‚  Aå±‚ï¼šæ ¼å¼ä¸ç¼–ç ç»„ä»¶                               â”‚     â”‚
â”‚    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                â”‚     â”‚
â”‚    â”‚  â€¢ å·¥ä½œåœ¨ Stream/RandomAccess/mmap ä¸Š             â”‚     â”‚
â”‚    â”‚  â€¢ å¯æ³¨å…¥ â†’ å¯æµ‹è¯•                                 â”‚     â”‚
â”‚    â”‚  â€¢ çº¯æ ¼å¼é€»è¾‘ï¼Œæ—  I/O å†³ç­–                         â”‚     â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                       â”‚ ä¾èµ–æŠ½è±¡                              â”‚
â”‚                       â–¼                                      â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚    â”‚  Bå±‚ï¼šæ–‡ä»¶å¥æŸ„ç®¡ç†                                 â”‚     â”‚
â”‚    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                â”‚     â”‚
â”‚    â”‚  â€¢ ç®¡ç† FileStream/SafeFileHandle/MemoryMappedFileâ”‚     â”‚
â”‚    â”‚  â€¢ ç‹¬å æ–‡ä»¶ã€åˆ›å»º/æ‰“å¼€/å…³é—­                        â”‚     â”‚
â”‚    â”‚  â€¢ æå°‘å•å…ƒæµ‹è¯•ï¼ˆçœŸå® I/Oï¼‰                        â”‚     â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è¯„ä¼°**ï¼š

| åŸåˆ™ | ç¬¦åˆåº¦ | åˆ†æ |
|:-----|:-------|:-----|
| **ä¾èµ–å€’ç½® (DIP)** | âœ… ç¬¦åˆ | Aå±‚ä¾èµ–æŠ½è±¡ï¼ˆStream/RandomAccessï¼‰ï¼Œä¸ä¾èµ–å…·ä½“æ–‡ä»¶å®ç° |
| **å•ä¸€èŒè´£ (SRP)** | âœ… ç¬¦åˆ | Aå±‚ç®¡"æ ¼å¼"ï¼ŒBå±‚ç®¡"å¥æŸ„"â€”â€”èŒè´£æ­£äº¤ |
| **æ¥å£éš”ç¦» (ISP)** | âœ… ç¬¦åˆ | Aå±‚ä¸éœ€è¦çŸ¥é“ Bå±‚çš„ç‹¬å /ç”Ÿå‘½å‘¨æœŸç»†èŠ‚ |
| **æµ‹è¯•æ€§** | âœ… ç¬¦åˆ | Aå±‚å¯æ³¨å…¥ MemoryStream/byte[] æµ‹è¯•ï¼›Bå±‚è–„åˆ°å¯æ¥å—ä¸æµ‹ |

**è¾¹ç•Œæ¸…æ™°åº¦**ï¼š

| é—®é¢˜ | ç­”æ¡ˆ |
|:-----|:-----|
| CRC32C è®¡ç®—å±äºå“ªå±‚ï¼Ÿ | Aå±‚ï¼ˆæ ¼å¼ç»„ä»¶ï¼‰â€”â€”ä¸ I/O æ— å…³ |
| Fence/Genesis å†™å…¥å±äºå“ªå±‚ï¼Ÿ | Aå±‚ï¼ˆæ ¼å¼ï¼‰+ Bå±‚ï¼ˆå†™å…¥ï¼‰â€”â€”åä½œå®Œæˆ |
| Fsync å±äºå“ªå±‚ï¼Ÿ | Bå±‚â€”â€”è¿™æ˜¯æ–‡ä»¶å¥æŸ„çš„èƒ½åŠ›ï¼Œéæ ¼å¼é€»è¾‘ |
| æ–‡ä»¶é•¿åº¦æŸ¥è¯¢å±äºå“ªå±‚ï¼Ÿ | Bå±‚â€”â€”è¿™æ˜¯å¥æŸ„çŠ¶æ€ï¼Œéæ ¼å¼é—®é¢˜ |

**1.2 æ›´å¥½çš„åˆ†å±‚ï¼Ÿ**

ç›‘æŠ¤äººçš„åˆ†å±‚å·²ç»å¾ˆå¥½ã€‚å”¯ä¸€å¯è€ƒè™‘çš„æ”¹è¿›æ˜¯**å†ç»†åˆ† A å±‚**ï¼š

```
Aå±‚ç»†åˆ†é€‰é¡¹ï¼ˆä»…ä¾›å‚è€ƒï¼Œä¸å»ºè®® MVP é‡‡ç”¨ï¼‰ï¼š
  A1: ç¼–ç åŸè¯­ï¼ˆVarInt, CRC32C, 4B å¯¹é½ï¼‰
  A2: å¸§æ ¼å¼ï¼ˆFrame Header/Fence è§£æï¼‰
  A3: åºåˆ—æ“ä½œï¼ˆé€†å‘æ‰«æã€éšæœºè¯»å–ï¼‰
```

**ä½†**ï¼šMVP é˜¶æ®µä¸å»ºè®®è¿‡åº¦åˆ†å±‚ã€‚å½“å‰ A/B ä¸¤å±‚å·²è¶³å¤Ÿï¼Œç­‰éœ€æ±‚é©±åŠ¨å†ç»†åŒ–ã€‚

---

##### 2. FaÃ§ade æ¨¡å¼è¯„ä¼°

**2.1 "å¸¸è§„è·¯å¾„" vs "ç¾éš¾æ¢å¤" åˆ†ç¦»**

| ç»´åº¦ | å¸¸è§„è·¯å¾„ | ç¾éš¾æ¢å¤ |
|:-----|:---------|:---------|
| **ç”¨æˆ·** | StateJournalï¼ˆä¸Šå±‚åº“ï¼‰ | ç®¡ç†å‘˜/å¼€å‘è€… |
| **å‡è®¾** | æ–‡ä»¶æ ¼å¼æ­£ç¡® | æ–‡ä»¶å¯èƒ½æŸå |
| **å¤±è´¥ç­–ç•¥** | å¿«é€Ÿå¤±è´¥ï¼ˆå¼‚å¸¸ï¼‰ | å°½åŠ›æ¢å¤ï¼ˆå®¹é”™ï¼‰ |
| **æ€§èƒ½è¦æ±‚** | çƒ­è·¯å¾„éœ€ä¼˜åŒ– | å†·è·¯å¾„å¯æ…¢ |
| **API é£æ ¼** | ç®€å•ï¼ˆè·¯å¾„â†’å¯¹è±¡ï¼‰ | å¤æ‚ï¼ˆæš´éœ²åº•å±‚ç»†èŠ‚ï¼‰ |

**è¯„ä¼°**ï¼šâœ… åˆ†ç¦»æ˜¯æ­£ç¡®çš„ã€‚

**ç±»æ¯”**ï¼š
- Gitï¼š`git log` vs `git fsck --full`
- æ•°æ®åº“ï¼šæ­£å¸¸ CRUD vs `DBCC CHECKDB`
- æ–‡ä»¶ç³»ç»Ÿï¼šå¸¸è§„è¯»å†™ vs `fsck`

**è®¾è®¡åŸåˆ™**ï¼šå¸¸è§„è·¯å¾„åº”è¯¥"åšæ­£ç¡®çš„äº‹å¾ˆå®¹æ˜“ï¼Œåšé”™è¯¯çš„äº‹å¾ˆéš¾"ï¼ˆPit of Successï¼‰ï¼›ç¾éš¾æ¢å¤å¯ä»¥"æš´éœ²å±é™©èƒ½åŠ›ï¼Œä½†éœ€æ˜ç¡®è­¦å‘Š"ã€‚

**2.2 FaÃ§ade åº”æš´éœ²ä»€ä¹ˆæ¥å£ï¼Ÿ**

åŸºäº StateJournal çœŸå®éœ€æ±‚ï¼ˆè§å‰æ–‡éœ€æ±‚åˆ†æï¼‰ï¼ŒFaÃ§ade çš„æœ€å°æ¥å£æ˜¯ï¼š

```csharp
/// <summary>
/// RBF æ–‡ä»¶å‚»ç“œé—¨é¢ã€‚éšè—æ‰€æœ‰å¤æ‚æ€§ï¼Œåªæš´éœ²"è¯»å¸§"å’Œ"å†™å¸§"èƒ½åŠ›ã€‚
/// </summary>
public interface IRbfFile : IDisposable {
    // === åŸºæœ¬ä¿¡æ¯ ===
    string Path { get; }
    ulong LengthBytes { get; }  // OS è§†è§’çš„å½“å‰æ–‡ä»¶é•¿åº¦
    
    // === è¯»å–èƒ½åŠ›ï¼ˆFaÃ§ade åªæš´éœ²è¿™ä¸¤ä¸ªï¼‰ ===
    /// <summary>é€†å‘è¿­ä»£å¸§ï¼ˆä»å°¾åˆ°å¤´ï¼Œå« CRC éªŒè¯ï¼‰</summary>
    IEnumerable<RbfFrame> ScanReverse();
    
    /// <summary>éšæœºè¯»å–å¸§ï¼ˆå« CRC éªŒè¯ï¼‰</summary>
    bool TryReadAt(FramePtr ptr, out RbfFrame frame);
    
    // === å†™å…¥èƒ½åŠ› ===
    /// <summary>è¿½åŠ å¸§ï¼Œè¿”å›å…¶æŒ‡é’ˆï¼ˆå†™å…¥åæ‰çŸ¥é“ä½ç½®+é•¿åº¦ï¼‰</summary>
    FramePtr Append(ReadOnlySpan<byte> payload, uint frameTag);
    
    /// <summary>æ¨é€ç¼“å†²åˆ° OS</summary>
    void Flush();
    
    // === Durability ===
    void DurableFlush();  // fsync
    
    // === æ¢å¤ï¼ˆä¿ç•™ï¼Œä½†æ ‡è®°ä¸º Advancedï¼‰===
    void Truncate(ulong newLengthBytes);
}
```

**å¯¹æ¯”ç°æœ‰ `IRbfFramer`/`IRbfScanner`**ï¼š

| ç°æœ‰è®¾è®¡ | FaÃ§ade è®¾è®¡ | å˜åŒ– |
|:---------|:------------|:-----|
| åˆ†ç¦»çš„ Framer + Scanner | åˆå¹¶ä¸ºå•ä¸€ IRbfFile | ç®€åŒ–ç”¨æˆ·å¿ƒæ™ºæ¨¡å‹ |
| `IRbfFramer.AppendFrame()` è¿”å› `Address64` | `Append()` è¿”å› `FramePtr` | å‡çº§åœ°å€ç±»å‹ |
| `IRbfScanner.TryReadAt(Address64)` | `TryReadAt(FramePtr)` | è¯»å–æ—¶å·²çŸ¥é•¿åº¦ |
| æ—  CRC éªŒè¯é€‰é¡¹ | é»˜è®¤éªŒè¯ CRC | Pit of Success |

**2.3 å¦‚ä½•é¿å… God Objectï¼Ÿ**

**é£é™©**ï¼šFaÃ§ade å¯èƒ½é€æ¸ç§¯ç´¯èŒè´£ï¼Œå˜æˆ"ä»€ä¹ˆéƒ½åšçš„å¤§æ³¥çƒ"ã€‚

**æŠ¤æ **ï¼š

| ç­–ç•¥ | å®ç° |
|:-----|:-----|
| **èŒè´£è¾¹ç•Œæ¡æ¬¾** | FaÃ§ade åªåš"ç»„è£… + å§”æ‰˜"ï¼Œä¸å®ç°æ ¼å¼é€»è¾‘ |
| **æ–¹æ³•æ•°é‡é¢„ç®—** | MVP ä¸è¶…è¿‡ 10 ä¸ªå…¬å¼€æ–¹æ³• |
| **å§”æ‰˜ç»“æ„** | å†…éƒ¨æŒæœ‰ A å±‚ç»„ä»¶ï¼ŒçœŸæ­£é€»è¾‘åœ¨ A å±‚ |

```csharp
// å†…éƒ¨ç»“æ„ç¤ºæ„ï¼ˆéå…¬å¼€ APIï¼‰
internal class RbfFileImpl : IRbfFile {
    private readonly SafeFileHandle _handle;     // Bå±‚ï¼šå¥æŸ„ç®¡ç†
    private readonly RbfFrameCodec _codec;       // Aå±‚ï¼šæ ¼å¼ç¼–è§£ç 
    private readonly RbfScannerCore _scanner;    // Aå±‚ï¼šæ‰«æé€»è¾‘
    private readonly RbfFramerCore _framer;      // Aå±‚ï¼šå†™å…¥é€»è¾‘
    
    // FaÃ§ade æ–¹æ³•åªæ˜¯å§”æ‰˜
    public bool TryReadAt(FramePtr ptr, out RbfFrame frame)
        => _scanner.TryReadAt(_handle, ptr, out frame);
}
```

**ç±»æ¯”**ï¼šSpring çš„ `JdbcTemplate`â€”â€”å®ƒæ˜¯ FaÃ§adeï¼Œä½†ä¸å®ç° SQL è§£ææˆ–è¿æ¥ç®¡ç†ã€‚

---

##### 3. FramePtr struct è¯„ä¼°

**3.1 å‡çº§ Address64 ä¸º FramePtr çš„æ”¶ç›Š**

| ç»´åº¦ | Address64ï¼ˆç°æœ‰ï¼‰ | FramePtrï¼ˆæè®®ï¼‰ |
|:-----|:------------------|:-----------------|
| **å†…å®¹** | ä»…åç§»é‡ | åç§»é‡ + é•¿åº¦ |
| **è¯»å–æ•ˆç‡** | éœ€ä¸¤æ¬¡ï¼šå…ˆè¯»å¤´ï¼ˆè·é•¿åº¦ï¼‰â†’ å†è¯»ä½“ | ä¸€æ¬¡ï¼šç›´æ¥è¯» offset..offset+len |
| **å†™å…¥æµç¨‹** | å†™å…¥æ—¶çŸ¥é“åç§»é‡ | å†™å…¥å®ŒæˆåçŸ¥é“åç§»é‡+é•¿åº¦ |
| **åºåˆ—åŒ–** | 8 å­—èŠ‚ | 8 å­—èŠ‚ï¼ˆæ‰“åŒ…ï¼‰ |

**æ”¶ç›Šæ˜ç¡®çš„åœºæ™¯**ï¼š
- âœ… **éšæœºè¯»å–**ï¼ˆçƒ­è·¯å¾„ï¼‰ï¼šä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨ vs ä¸¤æ¬¡
- âœ… **Lazy Load**ï¼šFramePtr è‡ªæè¿°ï¼Œæ— éœ€é¢å¤–æŸ¥æ‰¾

**éœ€è¦è°ƒæ•´çš„åœºæ™¯**ï¼š
- âš ï¸ **å†™å…¥æ—¶è·å– FramePtr**ï¼š`Append()` è¿”å›çš„ FramePtr å¿…é¡»åœ¨å¸§å®Œå…¨å†™å…¥åæ‰èƒ½ç¡®å®šé•¿åº¦

```csharp
// ç°æœ‰æµç¨‹ï¼š
addr = framer.AppendFrame(...);  // addr åœ¨å¼€å§‹å†™å…¥æ—¶å°±çŸ¥é“

// æ–°æµç¨‹ï¼š
ptr = framer.Append(...);  // ptr å¿…é¡»ç­‰å¸§å†™å®Œæ‰èƒ½è¿”å›ï¼ˆé•¿åº¦åœ¨å†™å…¥è¿‡ç¨‹ä¸­ç´¯ç§¯ï¼‰
```

è¿™ä¸æ˜¯é—®é¢˜â€”â€”å› ä¸º `Append` æ˜¯åŒæ­¥çš„ï¼Œå†™å®Œè‡ªç„¶çŸ¥é“é•¿åº¦ã€‚

**3.2 Bit åˆ†é…ç­–ç•¥**

**çº¦æŸ**ï¼š
- æ€»å…± 64 bit
- åç§»é‡éœ€è¦ 4B å¯¹é½ â†’ å¯èŠ‚çœ 2 bit
- å¸§é•¿åº¦ä¹Ÿå¯è¦æ±‚ 4B å¯¹é½ â†’ å†èŠ‚çœ 2 bit

**å€™é€‰æ–¹æ¡ˆ**ï¼š

| æ–¹æ¡ˆ | åç§»é‡ bit | é•¿åº¦ bit | æœ€å¤§æ–‡ä»¶ | æœ€å¤§å¸§ |
|:-----|:-----------|:---------|:---------|:-------|
| **A. å‡è¡¡** | 44 | 20 | 64 TBï¼ˆå®é™… Ã—4 = 256 TBï¼‰ | 4 MB |
| **B. åæ–‡ä»¶** | 48 | 16 | 1 PBï¼ˆå®é™… Ã—4 = 4 PBï¼‰ | 256 KB |
| **C. åå¸§** | 40 | 24 | 4 TBï¼ˆå®é™… Ã—4 = 16 TBï¼‰ | 64 MB |

**å»ºè®®**ï¼šæ–¹æ¡ˆ Aï¼ˆå‡è¡¡ï¼‰

**ç†ç”±**ï¼š
- 64 TB æ–‡ä»¶ä¸Šé™å¯¹ StateJournal è¶³å¤Ÿï¼ˆå®é™…æ—¥å¿—æ–‡ä»¶å¾ˆå°‘è¶…è¿‡ TB çº§ï¼‰
- 4 MB å¸§ä¸Šé™å¯¹å¯¹è±¡ç‰ˆæœ¬è®°å½•è¶³å¤Ÿï¼ˆå•ä¸ªå¯¹è±¡çŠ¶æ€å¾ˆå°‘è¶…è¿‡ MB çº§ï¼‰
- å¦‚æœéœ€è¦æ›´å¤§å¸§ï¼Œè¯´æ˜åº”è¯¥æ‹†åˆ†å¯¹è±¡

**ç¼–ç ç¤ºæ„**ï¼š

```csharp
[StructLayout(LayoutKind.Sequential)]
public readonly struct FramePtr {
    private readonly ulong _packed;
    
    // é«˜ 44 bitï¼šåç§»é‡ï¼ˆ4B å¯¹é½ï¼Œå®é™…å€¼ = å­—æ®µå€¼ Ã— 4ï¼‰
    // ä½ 20 bitï¼šé•¿åº¦ï¼ˆ4B å¯¹é½ï¼Œå®é™…å€¼ = å­—æ®µå€¼ Ã— 4ï¼‰
    
    public ulong Offset => (_packed >> 20) << 2;   // è¿˜åŸ 4B å¯¹é½
    public uint Length => (uint)((_packed & 0xFFFFF) << 2);
    
    public static FramePtr FromOffsetAndLength(ulong offset, uint length) {
        Debug.Assert(offset % 4 == 0 && length % 4 == 0);
        return new FramePtr((offset >> 2) << 20 | (length >> 2));
    }
}
```

**3.3 å¯¹ç°æœ‰è§„èŒƒçš„å½±å“**

| è§„èŒƒä½ç½® | å½±å“ | å¤„ç†å»ºè®® |
|:---------|:-----|:---------|
| `rbf-interface.md` | `Address64` â†’ `FramePtr` | æ–°å¢ç±»å‹å®šä¹‰ç« èŠ‚ |
| `IRbfFramer.AppendFrame()` | è¿”å›ç±»å‹å˜åŒ– | ä¿®è®¢ç­¾å |
| `IRbfScanner.TryReadAt()` | å‚æ•°ç±»å‹å˜åŒ– | ä¿®è®¢ç­¾å |
| StateJournal çš„ Ptr64 | éœ€è¦æ˜ å°„åˆ° FramePtr | ä¸Šå±‚å†³ç­– |

**è¿ç§»ç­–ç•¥**ï¼š

```csharp
// å…¼å®¹å±‚ï¼ˆå¦‚æœéœ€è¦ï¼‰
public static class Address64Compat {
    public static FramePtr ToFramePtr(this Address64 addr, uint length)
        => FramePtr.FromOffsetAndLength(addr.Value, length);
    
    public static Address64 ToAddress64(this FramePtr ptr)
        => new Address64(ptr.Offset);
}
```

---

##### 4. åº•å±‚ API å»ºè®®

**4.1 RandomAccess vs Stream Tradeoff**

| ç»´åº¦ | RandomAccess | Stream |
|:-----|:-------------|:-------|
| **çŠ¶æ€æ€§** | æ— çŠ¶æ€ï¼ˆæ¯æ¬¡è°ƒç”¨ä¼  offsetï¼‰ | æœ‰çŠ¶æ€ï¼ˆPosition å±æ€§ï¼‰ |
| **çº¿ç¨‹å®‰å…¨** | å¤©ç„¶çº¿ç¨‹å®‰å…¨ | éœ€è¦é”æˆ–æ¯çº¿ç¨‹å®ä¾‹ |
| **æ€§èƒ½** | ç•¥ä¼˜ï¼ˆæ— é”å¼€é”€ï¼‰ | ç•¥å·®ï¼ˆPosition æ›´æ–°æœ‰å¼€é”€ï¼‰ |
| **API ç†Ÿæ‚‰åº¦** | .NET 6+ æ–° API | ç»å…¸ APIï¼Œå¹¿æ³›ç†Ÿæ‚‰ |
| **å¯æµ‹è¯•æ€§** | å¯åŒ…è£…æ¥å£æ³¨å…¥ | MemoryStream ç›´æ¥å¯ç”¨ |
| **æŠ½è±¡å±‚çº§** | è¾ƒä½ï¼ˆæ¥è¿‘ OSï¼‰ | è¾ƒé«˜ï¼ˆBuffer + Positionï¼‰ |

**å»ºè®®**ï¼šâœ… **RandomAccess ä½œä¸ºé¦–é€‰**

**ç†ç”±**ï¼š
1. **ä¸ A å±‚ç†å¿µåŒ¹é…**ï¼šA å±‚æ˜¯"ç»™æˆ‘åç§»é‡å’Œé•¿åº¦ï¼Œæˆ‘å¤„ç†æ ¼å¼"â€”â€”RandomAccess çš„æ— çŠ¶æ€è°ƒç”¨é£æ ¼å¤©ç„¶åŒ¹é…
2. **ç®€åŒ–å¹¶å‘æ¨¡å‹**ï¼šå•ä¸€ `SafeFileHandle` å¯è¢«å¤šå¤„åŒæ—¶ `RandomAccess.Read/Write`ï¼Œæ— éœ€é”
3. **ä¸ FramePtr é…åˆ**ï¼š`FramePtr` è‡ªå¸¦åç§»+é•¿åº¦ï¼Œæ­£å¥½æ˜¯ `RandomAccess.Read` æ‰€éœ€

**å¯æµ‹è¯•æ€§ä¿è¯**ï¼š

```csharp
// æ–¹æ¡ˆ 1ï¼šæŠ½è±¡æ¥å£
public interface IRandomAccessFile {
    int Read(long offset, Span<byte> buffer);
    void Write(long offset, ReadOnlySpan<byte> buffer);
}

// æ–¹æ¡ˆ 2ï¼šç›´æ¥ç”¨ Span<byte>ï¼ˆå†…å­˜æµ‹è¯•ï¼‰
public class InMemoryRandomAccess : IRandomAccessFile {
    private byte[] _data;
    public int Read(long offset, Span<byte> buffer) {
        _data.AsSpan((int)offset, buffer.Length).CopyTo(buffer);
        return buffer.Length;
    }
}
```

**4.2 ç¼“å­˜ç­–ç•¥**

**é—®é¢˜**ï¼šæ˜¯å¦éœ€è¦åº”ç”¨å±‚ç¼“å­˜ï¼Ÿ

**åˆ†æ**ï¼š

| åœºæ™¯ | OS é¡µç¼“å­˜ | åº”ç”¨å±‚ç¼“å­˜ |
|:-----|:---------|:-----------|
| é¡ºåºå†™å…¥ | âœ… é«˜æ•ˆ | æ— æ”¶ç›Š |
| é€†å‘æ‰«æ | âš ï¸ å¯èƒ½ä½æ•ˆï¼ˆåå‘è¯»å–ï¼‰ | å¯èƒ½æœ‰æ”¶ç›Š |
| éšæœºè¯»å– | âœ… é«˜æ•ˆï¼ˆçƒ­é¡µç¼“å­˜ï¼‰ | æ— æ”¶ç›Šï¼ˆIdentity Map åœ¨ä¸Šå±‚ï¼‰ |

**å»ºè®®**ï¼šâœ… **ä¸å¼•å…¥åº”ç”¨å±‚ç¼“å­˜ï¼ˆMVPï¼‰**

**ç†ç”±**ï¼š
1. **StateJournal å·²æœ‰ Identity Map**ï¼šå¯¹è±¡çº§ç¼“å­˜åœ¨ä¸Šå±‚ï¼ŒRBF å±‚ä¸éœ€è¦é‡å¤
2. **é€†å‘æ‰«ææ˜¯å†·è·¯å¾„**ï¼šå¯åŠ¨æ—¶æ‰§è¡Œä¸€æ¬¡ï¼Œä¸å€¼å¾—ä¼˜åŒ–
3. **å¤æ‚åº¦æˆæœ¬é«˜**ï¼šç¼“å­˜å¼•å…¥ä¸€è‡´æ€§é—®é¢˜ï¼ˆå†™å…¥åéœ€å¤±æ•ˆï¼‰ã€å†…å­˜ç®¡ç†é—®é¢˜

**ä¾‹å¤–**ï¼šå¦‚æœæ€§èƒ½å‰–æå‘ç°ç“¶é¢ˆï¼Œå¯åœ¨ A å±‚æ·»åŠ "å¸§å¤´ç¼“å­˜"ï¼ˆåªç¼“å­˜ Header ç”¨äºå¿«é€Ÿè·³è¿‡ï¼‰ã€‚

**4.3 å¯æµ‹è¯•æ€§ä¿è¯ç­–ç•¥**

**æ€»ä½“ç­–ç•¥**ï¼šA å±‚å¯å®Œå…¨å•å…ƒæµ‹è¯•ï¼ŒB å±‚åšè–„é›†æˆæµ‹è¯•ã€‚

| å±‚ | æµ‹è¯•æ–¹å¼ | å·¥å…· |
|:---|:---------|:-----|
| **Aå±‚ï¼ˆæ ¼å¼ç»„ä»¶ï¼‰** | å•å…ƒæµ‹è¯• | `byte[]` + `MemoryStream` + Mock `IRandomAccessFile` |
| **Bå±‚ï¼ˆå¥æŸ„ç®¡ç†ï¼‰** | é›†æˆæµ‹è¯• | ä¸´æ—¶æ–‡ä»¶ + çœŸå® `SafeFileHandle` |
| **FaÃ§ade** | ç«¯åˆ°ç«¯æµ‹è¯• | ä¸´æ—¶æ–‡ä»¶ + å®Œæ•´æµç¨‹ |

**A å±‚æµ‹è¯•ç¤ºä¾‹**ï¼š

```csharp
[Fact]
public void RbfFrameCodec_Decode_ValidFrame_ReturnsPayload() {
    // Arrange: å†…å­˜ä¸­æ„é€ ä¸€ä¸ªåˆæ³•å¸§
    var frameBytes = BuildValidFrame(payload: "Hello"u8, tag: 0x00010001);
    var reader = new InMemoryRandomAccess(frameBytes);
    var codec = new RbfFrameCodec();
    
    // Act
    var result = codec.TryDecode(reader, offset: 0, out var frame);
    
    // Assert
    Assert.True(result);
    Assert.Equal("Hello"u8.ToArray(), frame.Payload.ToArray());
}
```

---

##### 5. æ¶æ„å»ºè®®æ€»ç»“

**5.1 æ¨èæ¶æ„**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      StateJournal (ä¸Šå±‚)                     â”‚
â”‚                        ä½¿ç”¨ IRbfFile                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      FaÃ§ade Layer                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  IRbfFile (å…¬å¼€æ¥å£)                                    â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                              â”‚ â”‚
â”‚  â”‚  â€¢ CreateNew(path) / OpenExisting(path)                 â”‚ â”‚
â”‚  â”‚  â€¢ ScanReverse() / TryReadAt(FramePtr)                  â”‚ â”‚
â”‚  â”‚  â€¢ Append(payload, tag) â†’ FramePtr                      â”‚ â”‚
â”‚  â”‚  â€¢ Flush() / DurableFlush() / Truncate()                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚ å§”æ‰˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      A å±‚ï¼šæ ¼å¼ç»„ä»¶                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ RbfFrameCodecâ”‚  â”‚RbfScannerCoreâ”‚  â”‚ RbfFramerCore    â”‚   â”‚
â”‚  â”‚  (ç¼–è§£ç )     â”‚  â”‚ (æ‰«æé€»è¾‘)   â”‚  â”‚  (å†™å…¥é€»è¾‘)       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                            â”‚ ä¾èµ–                            â”‚
â”‚                            â–¼                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  IRandomAccessFile (æŠ½è±¡æ¥å£)                           â”‚â”‚
â”‚  â”‚  â€¢ Read(offset, buffer)                                  â”‚â”‚
â”‚  â”‚  â€¢ Write(offset, buffer)                                 â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚ å®ç°
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      B å±‚ï¼šå¥æŸ„ç®¡ç†                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  RbfFileHandle                                          â”‚â”‚
â”‚  â”‚  â€¢ æŒæœ‰ SafeFileHandle                                   â”‚â”‚
â”‚  â”‚  â€¢ å®ç° IRandomAccessFileï¼ˆå§”æ‰˜åˆ° RandomAccess APIï¼‰      â”‚â”‚
â”‚  â”‚  â€¢ æä¾› DurableFlush (FlushFileBuffers)                  â”‚â”‚
â”‚  â”‚  â€¢ ç®¡ç†ç”Ÿå‘½å‘¨æœŸ (Dispose)                                 â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**5.2 å…³é”®å†³ç­–æ¸…å•**

| å†³ç­– | ç»“è®º | ç†ç”± |
|:-----|:-----|:-----|
| åˆ†å±‚æ–¹å¼ | Aï¼ˆæ ¼å¼ï¼‰+ Bï¼ˆå¥æŸ„ï¼‰ | ä¾èµ–å€’ç½® + æµ‹è¯•æ€§ |
| FaÃ§ade å½¢çŠ¶ | å•ä¸€ `IRbfFile` | ç”¨æˆ·å¿ƒæ™ºæ¨¡å‹ç®€å• |
| å¸¸è§„ vs æ¢å¤åˆ†ç¦» | âœ… åˆ†ç¦» | èŒè´£ä¸åŒã€ç”¨æˆ·ä¸åŒ |
| åº•å±‚ API | RandomAccess | æ— çŠ¶æ€ã€ä¸ FramePtr é…åˆ |
| ç¼“å­˜ | ä¸å¼•å…¥ï¼ˆMVPï¼‰ | ä¸Šå±‚å·²æœ‰ Identity Map |
| FramePtr bit åˆ†é… | 44:20ï¼ˆåç§»:é•¿åº¦ï¼‰ | å‡è¡¡ï¼Œ64TB/4MB ä¸Šé™ |

**5.3 è§„èŒƒå½±å“é¢„ä¼°**

| æ–‡æ¡£ | éœ€è¦çš„å·¥ä½œ |
|:-----|:-----------|
| `rbf-interface.md` | æ–°å¢ Â§5 æ–‡ä»¶äº¤äº’æ¥å£ï¼›æ–°å¢ FramePtr ç±»å‹å®šä¹‰ |
| `rbf-format.md` | æ— éœ€ä¿®æ”¹ï¼ˆçº¿æ ¼å¼ä¸å˜ï¼‰ |
| æ–°å¢æ–‡æ¡£ | å¯é€‰ï¼š`rbf-facade.md`ï¼ˆFaÃ§ade ä½¿ç”¨æŒ‡å—ï¼‰ |

**5.4 å¾…è¿›ä¸€æ­¥è£å†³**

| é—®é¢˜ | å€™é€‰ | éœ€è¦è£å†³ |
|:-----|:-----|:---------|
| FramePtr çš„ Null è¡¨ç¤º | `0` vs ä¸“ç”¨å­—æ®µ | ç›‘æŠ¤äºº |
| Truncate æ˜¯å¦æ”¾åœ¨ FaÃ§ade | FaÃ§ade vs ç‹¬ç«‹ RecoveryKit | ç›‘æŠ¤äºº |
| IRandomAccessFile å‘½å | `IRbfStorage` vs `IRandomAccessFile` | å›¢é˜Ÿ |

---

> **æ ¸å¿ƒæ´è§**ï¼šç›‘æŠ¤äººçš„æ¶æ„æ–¹å‘ä»è½¯ä»¶å·¥ç¨‹åŸç†è§’åº¦æ˜¯åˆç†çš„ã€‚A/B åˆ†å±‚å®ç°ä¾èµ–å€’ç½®ã€FaÃ§ade æ¨¡å¼éšè—å¤æ‚æ€§ã€FramePtr ä¼˜åŒ–è¯»å–è·¯å¾„ã€RandomAccess åŒ¹é…æ— çŠ¶æ€è®¾è®¡â€”â€”è¿™äº›é€‰æ‹©ç›¸äº’åè°ƒï¼Œå½¢æˆä¸€ä¸ªè‡ªæ´½çš„æ¶æ„ã€‚
>
> å…³é”®é£é™©ç‚¹æ˜¯"FaÃ§ade è†¨èƒ€"â€”â€”éœ€è¦ç”¨èŒè´£è¾¹ç•Œæ¡æ¬¾çº¦æŸå…¶å¢é•¿ã€‚

---

### Auditor å‘è¨€ï¼ˆFramePtr è§„èŒƒå®¡è®¡ï¼‰

#### 1. ä¸ç°æœ‰è§„èŒƒçš„å†²çªæ£€æŸ¥

**SSOT ç°çŠ¶**ï¼ˆä»¥ atelia/docs/Rbf/rbf-interface.md v0.17 ä¸ºå‡†ï¼‰ï¼š
- å½“å‰è§„èŒƒå®šä¹‰çš„æŒ‡é’ˆç±»å‹æ˜¯ `Address64(ulong Value)`ï¼Œå…¶è¯­ä¹‰ä¸ºâ€œæŒ‡å‘ Frame èµ·å§‹ä½ç½®ï¼ˆHeadLen å­—æ®µèµ·ç‚¹ï¼‰çš„æ–‡ä»¶åç§»é‡â€ã€‚ç›¸å…³æ¡æ¬¾ä¸º `[F-ADDRESS64-DEFINITION]` / `[F-ADDRESS64-ALIGNMENT]` / `[F-ADDRESS64-NULL]`ã€‚
- `IRbfScanner.TryReadAt(Address64)` çš„ç­¾ååœ¨ `[A-RBF-SCANNER-INTERFACE]` æ˜ç¡®ã€‚
- `IRbfFramer.Append(...)` ä¸ `RbfFrameBuilder.Commit()` çš„è¿”å›ç±»å‹ä¹Ÿéƒ½æ˜¯ `Address64`ï¼ˆ`[A-RBF-FRAMER-INTERFACE]` / `[A-RBF-FRAME-BUILDER]`ï¼‰ã€‚

**å†²çªç‚¹ï¼ˆå¿…é¡»è£å†³ï¼‰**ï¼š
1) **ç±»å‹æ›¿æ¢çš„ Breaking é¢**
- è‹¥â€œå‡çº§ Address64 ä¸º FramePtr structâ€æ„å‘³ç€ **å®Œå…¨æ›¿æ¢**ï¼Œåˆ™ rbf-interface.md ä¸­ä¸Šè¿° 3 å¤„ API ç­¾åå‡ä¸º breakingï¼Œä¸” rbf-test-vectors.md ä¸­â€œAddress64/Ptr64ï¼ˆu64 LE æ–‡ä»¶åç§»ï¼Œ4B å¯¹é½ï¼‰â€çš„å™è¿°ä¹Ÿéœ€åŒæ­¥æ›´å/é‡å†™ã€‚
- è‹¥å¸Œæœ›æœ€å°åŒ–ç ´åï¼Œå¦ä¸€ä¸ªå¯è¡Œè·¯çº¿æ˜¯ï¼šä¿ç•™ `Address64`ï¼ˆoffset-onlyï¼‰ä¸å˜ï¼Œæ–°å¢ `FramePtr`ï¼Œå¹¶åœ¨ `IRbfScanner` ä¸Šæ–°å¢é‡è½½ `TryReadAt(FramePtr)` ä½œä¸º fast-pathï¼›ä½†è¿™ä¸â€œå‡çº§â€ä¸€è¯çš„è¯­ä¹‰ä¸ä¸€è‡´ï¼Œéœ€è¦åœ¨è§„èŒƒé‡Œæ˜ç¡®â€œAddress64 é€€ä¸ºå…¼å®¹ç±»å‹/åˆ«åâ€ã€‚

2) **æ¡æ¬¾ ID æ¼‚ç§»é£é™©**
- ä»»åŠ¡æè¿°æåˆ°çš„ `[A-RBF-ADDRESS64-OFFSET]` åœ¨å½“å‰ SSOT ä¸­ä¸å­˜åœ¨ï¼ˆç°ä¸º `[F-ADDRESS64-*]` ç³»åˆ—ï¼‰ã€‚è‹¥è¯¥ ID æ¥è‡ªæ—§è‰æ¡ˆï¼Œå¿…é¡»åœ¨ Clause Registry æˆ–æ–‡æ¡£å†…åšâ€œæ—§ ID â†’ æ–° IDâ€çš„æ˜¾å¼æ˜ å°„ï¼Œå¦åˆ™å®¡è®¡ä¸å®ç°æ— æ³•å¯¹é½ã€‚

3) **FramePtr.length çš„â€œé•¿åº¦åˆ°åº•æŒ‡ä»€ä¹ˆâ€å¿…é¡»é’‰æ­»**
- ç°è¡Œ `Address64` åªå®šä¹‰ offsetï¼Œå› æ­¤è¯»è·¯å¾„ä¼šå…ˆè¯» HeadLen å†çŸ¥é“ frame æ€»é•¿åº¦ã€‚
- FramePtr çš„ç›®æ ‡æ˜¯â€œä¸€æ¬¡çŸ¥é“åœ¨å“ªè¯»ï¼Œè¯»å¤šå°‘â€ï¼Œå› æ­¤ `length` å­—æ®µå¿…é¡»æ˜ç¡®æ˜¯ï¼š
    - A) `HeadLen/TailLen`ï¼ˆæ•´ä¸ª FrameBytes çš„æ€»é•¿åº¦ï¼Œä¸å« Fenceï¼‰â€”â€”æœ€å¥‘åˆâ€œä¸€æ¬¡è¯»å®Œæ•´å¸§â€ï¼›æˆ–
    - B) ä»… payload é•¿åº¦â€”â€”ä¼šå¯¼è‡´ä»éœ€é¢å¤–è¯»å– header/status/tail/crcï¼ˆä¸ç›®æ ‡å†²çªï¼‰ã€‚
    å»ºè®®ï¼šé€‰ Aï¼Œå¹¶åœ¨è§„èŒƒä¸­æŠŠ length å‘½åä¸º `FrameBytesLength`ï¼ˆæˆ–ç­‰ä»·åï¼‰ä»¥å‡å°‘æ­§ä¹‰ã€‚

4) **å¯¹é½çº¦æŸçš„ä¸€è‡´æ€§**
- ç°è¡Œè§„èŒƒå·²è¦æ±‚ Address64 4B å¯¹é½ï¼ˆ`[F-ADDRESS64-ALIGNMENT]`ï¼‰ã€‚FramePtr æè®®â€œä¸æ”¯æŒé 4B å¯¹é½åœ°å€â€ä¸ä¹‹ä¸å†²çªï¼Œå±äºâ€œæŠŠæ—¢æœ‰çº¦æŸå†…åŒ–åˆ°ç±»å‹ç¼–ç â€ã€‚
- ä½† FramePtr çš„ `length` æ˜¯å¦ä¹Ÿè¦æ±‚ 4B å¯¹é½ï¼Œéœ€è¦è£å†³ï¼›è‹¥ `length` å®šä¹‰ä¸º FrameBytes æ€»é•¿åº¦ï¼Œåˆ™æŒ‰ RBF wire format è®¡ç®—ï¼ŒFrameBytes æ€»é•¿åº¦å¤©ç„¶ 4B å¯¹é½ï¼ˆè§ rbf-test-vectors.md å¯¹ StatusLen çš„å¯¹é½å…¬å¼ï¼‰ï¼Œå› æ­¤å¯å°†å…¶ä½œä¸º MUSTï¼ˆå¯åˆ¤å®šï¼‰ã€‚

#### 2. å¿…é¡»è§„èŒƒåŒ–çš„å¥‘çº¦

FramePtr å¼•å…¥çš„â€œæ–°å¥‘çº¦é¢â€è‡³å°‘åŒ…æ‹¬ï¼š

1) **æ‰“åŒ…/è§£åŒ…å¯é€†æ€§ï¼ˆåŸŸå†…å¯é€†ï¼‰**
- éœ€è¦ä¸€ä¸ªå¯åˆ¤å®šçš„åŸŸå®šä¹‰ï¼š
    - `offsetBytes % 4 == 0` ä¸” `offsetBytes != 0`ï¼ˆé™¤éå…è®¸ Nullï¼‰
    - `frameBytesLength % 4 == 0` ä¸” `frameBytesLength >= MinFrameBytes`ï¼ˆæœ€å°å€¼å»ºè®®ç»‘å®š wire format çš„æœ€å° frame é•¿åº¦ï¼Œä¾‹å¦‚ 20 bytesï¼‰
    - `offsetBytes + frameBytesLength <= fileLengthBytes` çš„â€œå¯è§£å¼•ç”¨æ€§â€å±äºè¿è¡Œæ—¶æ¡ä»¶ï¼ˆTryReadAt çš„è¿”å›è¯­ä¹‰ï¼‰ï¼Œä¸å±äºæ„é€ æœŸæ¡ä»¶ã€‚
- å¥‘çº¦å¿…é¡»å†™æˆï¼šå¯¹ä»»æ„æ»¡è¶³åŸŸçº¦æŸçš„ `(offsetBytes, frameBytesLength)`ï¼Œ`Pack` ä¸ `Unpack` MUST äº’ä¸ºé€†è¿ç®—ã€‚

2) **4B å¯¹é½çº¦æŸçš„å¼ºåˆ¶æ€§è¿›å…¥å¯åˆ¤å®šé¢**
- ä¸èƒ½åªåœ¨æ–‡å­—é‡Œè¯´â€œ4B å¯¹é½â€ï¼Œéœ€è¦è§„å®šï¼š
    - `FramePtr.CreateChecked/FromOffsetAndLength` å¯¹éå¯¹é½è¾“å…¥ MUST æŠ› `ArgumentOutOfRangeException`ï¼ˆæˆ–æä¾› `TryCreate` è¿”å› falseï¼ŒäºŒé€‰ä¸€å¹¶å›ºå®šï¼‰ã€‚
    - `FromPacked(ulong)` è§£åŒ…æ—¶è‹¥å‘ç°ä¸æ»¡è¶³å¯¹é½/ä¿ç•™æ¨¡å¼ï¼ŒMUST fail-fastï¼ˆæŠ›å¼‚å¸¸æˆ– TryParse è¿”å› falseï¼‰ã€‚

3) **é•¿åº¦å­—æ®µçš„æœ‰æ•ˆèŒƒå›´ï¼ˆæœ€å°/æœ€å¤§ï¼‰**
- éœ€è¦æ˜ç¡® `FramePtr.MaxFrameBytesLength`ï¼ˆç”± bit åˆ†é…å†³å®šï¼‰ä¸ `FramePtr.MinFrameBytesLength`ï¼ˆç”± wire format å†³å®šï¼‰ã€‚
- éœ€è¦æ˜ç¡® `length == 0` çš„è¯­ä¹‰ï¼šå»ºè®®ä¿ç•™ä¸º Nullï¼ˆä¸ Address64.Null ä¸€è‡´ï¼‰ï¼Œå¹¶è§„å®šé Null æ—¶ length MUST > 0ã€‚

4) **è¶…å‡ºèŒƒå›´çš„é”™è¯¯å¤„ç†ï¼ˆæ„é€ æœŸ vs è¯»å†™æœŸï¼‰**
- æ„é€ æœŸï¼ˆpack/unpackï¼‰ï¼šè¶Šç•Œ/ä¸åˆæ³• MUST fail-fastï¼ˆå¼‚å¸¸ç±»å‹æˆ– TryXxx è¯­ä¹‰å›ºå®šï¼‰ã€‚
- è¯»æœŸï¼ˆTryReadAtï¼‰ï¼š
    - `ptr.IsNull` æˆ– `ptr.OffsetBytes >= EOF`ï¼šå»ºè®®è¿”å› `false`ï¼ˆä¿æŒ TryXxx è¯­ä¹‰ï¼‰ï¼Œè€Œéå¼‚å¸¸ã€‚
    - `ptr.FrameBytesLength` ä¸å®é™… headlen ä¸ä¸€è‡´ï¼šè¿™æ˜¯â€œæŒ‡é’ˆä¸æ–‡ä»¶å†…å®¹ä¸ä¸€è‡´â€ï¼Œå»ºè®®å½’å…¥â€œæ ¼å¼æŸå/ç´¢å¼•æŸåâ€å¹¶æ˜ç¡®è¡Œä¸ºï¼ˆè¿”å› false vs æŠ› InvalidDataExceptionï¼Œéœ€è£å†³ï¼‰ã€‚

è¡¥ä½ï¼šå¤±è´¥è¯­ä¹‰ç¼ºå£
- ç›®å‰ rbf-interface.md å¯¹ `TryReadAt` çš„å¤±è´¥åˆ†ç±»ä»æ ‡ä¸ºâ€œå¾…å®ç°æ—¶ç¡®è®¤â€ï¼ˆÂ§9 é”™è¯¯å¤„ç†ï¼‰ã€‚FramePtr æŠŠâ€œé•¿åº¦ä¸€è‡´æ€§æ£€æŸ¥â€æ‹‰åˆ°äº†æ¥å£è¾¹ç•Œï¼Œå¯¼è‡´å¤±è´¥åˆ†ç±»æ›´ä¸èƒ½å†æ‚¬ç©ºï¼Œå¦åˆ™å®ç°ä¼šå€’çŒã€‚

#### 3. Bit åˆ†é…çš„å¯åˆ¤å®šæ€§

**44:20ï¼ˆoffset:lengthï¼Œä»¥ 4B ä¸ºå•ä½ï¼‰å¯åˆ¤å®šç»“è®º**ï¼š
- åç§» 44 bitï¼šæœ€å¤§æ–‡ä»¶å¯»å€ $2^{44}\times 4 = 2^{46}$ bytes = 64 TiBã€‚
- é•¿åº¦ 20 bitï¼šæœ€å¤§å¸§é•¿ $2^{20}\times 4 = 2^{22}$ bytes = 4 MiBã€‚

**æ˜¯å¦æ»¡è¶³ StateJournal å®é™…éœ€æ±‚ï¼ˆä»¥å½“å‰å…¬å¼€éœ€æ±‚ä¸ºè¯æ®çš„è£å†³ï¼‰**ï¼š
- æ–‡ä»¶ä¸Šé™ 64 TiBï¼šå¯¹ StateJournal çš„ append-only æ—¥å¿—è€Œè¨€ç°å®ä¸Šå……è¶³ï¼›å¦‚æœæœªæ¥éœ€è¦æ›´å¤§æ–‡ä»¶ï¼Œé€šå¸¸æ›´å€¾å‘â€œåˆ†ç‰‡/åˆ†æ–‡ä»¶ï¼ˆepoch/segmentï¼‰â€è€Œéå•æ–‡ä»¶æ— é™å¢é•¿ã€‚
- å•å¸§ä¸Šé™ 4 MiBï¼šåœ¨â€œå¯¹è±¡ç‰ˆæœ¬è®°å½• + VersionIndex overlayâ€çš„å»ºæ¨¡ä¸‹é€šå¸¸è¶³å¤Ÿï¼Œä½†è¿™å±äº Layer 1 è´Ÿè½½å¤§å°çš„éšå«çº¦æŸï¼Œå¿…é¡»ä¸Šå‡ä¸ºå¯åˆ¤å®šæ¡æ¬¾ï¼Œå¦åˆ™æœªæ¥å‡ºç° 5 MiB payload æ—¶è¡Œä¸ºä¸å¯åˆ¤å®šã€‚

**è¶…å‡ºèŒƒå›´æ—¶å¿…é¡»æ˜ç¡®çš„è¡Œä¸º**ï¼š
- å†™å…¥ä¾§ï¼šå½“ä¸Šå±‚è¯·æ±‚å†™å…¥çš„ frameï¼ˆwire-format æ€»é•¿åº¦ï¼‰è¶…è¿‡ `FramePtr.MaxFrameBytesLength` æ—¶ï¼Œ`IRbfFramer.Append/Commit` MUST å¤±è´¥ï¼ˆå»ºè®® `ArgumentOutOfRangeException`ï¼‰ï¼Œä¸å¾—æˆªæ–­ï¼Œä¸å¾— silent wrapã€‚
- è¯»å–ä¾§ï¼šå½“è§£åŒ…å¾—åˆ°çš„ FramePtr é•¿åº¦è¶…å‡ºä¸Šé™æˆ–å°äºæœ€å°å€¼æ—¶ï¼š
    - `FramePtr.FromPacked` MUST fail-fastï¼ˆå»ºè®® `ArgumentOutOfRangeException` æˆ– `FormatException`ï¼‰ï¼›
    - `TryReadAt` æ”¶åˆ°â€œéæ³• ptrâ€ï¼ˆè‹¥ API å…è®¸ï¼‰æ—¶çš„è¡Œä¸ºä¹Ÿå¿…é¡»å›ºå®šï¼ˆå»ºè®®è¿”å› falseï¼Œæˆ–æŠ›å‚æ•°å¼‚å¸¸ï¼ŒäºŒé€‰ä¸€ï¼‰ã€‚

**æ˜¯å¦éœ€è¦é¢„ç•™æ‰©å±•ä½ï¼ˆæ‰©å±•æ€§å®¡è®¡ï¼‰**ï¼š
- 44:20 ç”¨æ»¡ 64 bitï¼Œæœ¬èº«æ²¡æœ‰â€œæ˜¾å¼ç‰ˆæœ¬ä½â€ã€‚
- è‹¥è¦æ”¯æŒå‘åå…¼å®¹ä¸æœªæ¥æ‰©å±•ï¼Œå»ºè®®è€ƒè™‘é¢„ç•™ 1 ä¸ªâ€œç¼–ç ç‰ˆæœ¬/ç§ç±» bitâ€ï¼ˆä¾‹å¦‚ MSBï¼‰ï¼š
    - `0` = legacy Address64-only packedï¼ˆlength éšå«æœªçŸ¥ï¼Œè¯»æ—¶éœ€è¦äºŒæ¬¡è¯»å– headerï¼‰ï¼Œ
    - `1` = FramePtr v1 packedï¼ˆoffset+lengthï¼‰ã€‚
    è¿™ä¼šå‡å°‘å¯ç”¨ offset bitï¼ˆä¾‹å¦‚ 43:20 æˆ– 43:19 ç­‰ï¼‰ï¼Œä½†å¯æ¢æ¥â€œæ— éœ€å¤–éƒ¨ç‰ˆæœ¬å­—æ®µä¹Ÿèƒ½åˆ¤åˆ«â€çš„å¯åˆ¤å®šæ€§ã€‚

è¡¥ä½ï¼šå¯åˆ¤å®šæ€§ç¼ºå£
- â€œæ˜¯å¦éœ€è¦é¢„ç•™æ‰©å±•ä½â€ä¸æ˜¯åå¥½é—®é¢˜ï¼Œè€Œæ˜¯â€œæœªæ¥å…¼å®¹æ˜¯å¦å¯æœºæ¢°åˆ¤åˆ«â€çš„é—®é¢˜ï¼šè‹¥æ²¡æœ‰ç‰ˆæœ¬ä½ï¼Œåˆ™å¿…é¡»ä¾èµ–å¤–éƒ¨ç‰ˆæœ¬å­—æ®µï¼ˆè§ Â§4ï¼‰ï¼Œå¦åˆ™å•å‡­ä¸€ä¸ª `ulong` æ— æ³•åˆ¤åˆ«å®ƒæ˜¯ Address64 è¿˜æ˜¯ FramePtrã€‚

#### 4. å‘åå…¼å®¹æ€§

**å…ˆæ˜ç¡®è¾¹ç•Œ**ï¼š
- Address64/FramePtr æ˜¯æ¥å£å±‚ç±»å‹ï¼›â€œå·²åºåˆ—åŒ–çš„ Address64 æ•°æ®â€é€šå¸¸ä½äº Layer 1ï¼ˆStateJournal çš„ VersionIndex/Meta è®°å½•ç­‰ payload ä¸­ï¼‰ã€‚å› æ­¤å‘åå…¼å®¹è´£ä»»åŸåˆ™ä¸Šåœ¨ StateJournal çš„ wire format/è®°å½•ç‰ˆæœ¬ä¸Šï¼Œè€Œä¸æ˜¯ RBF Layer 0ã€‚

**å¿…é¡»è¡¥é½çš„å…¼å®¹å¥‘çº¦é—®é¢˜**ï¼š
1) **æ—§æ•°æ®çš„ `ulong` åˆ°åº•è¡¨ç¤ºä»€ä¹ˆï¼Ÿ**
- è‹¥æ—§è®°å½•å­˜çš„æ˜¯ `Address64.Value`ï¼ˆoffset-onlyï¼‰ï¼Œæ–°å®ç°è¦ä¹ˆï¼š
    - A) åœ¨è¯»å–æ—¶å…è®¸â€œlength æœªçŸ¥â€å¹¶åšäºŒæ¬¡è¯»å–ï¼ˆå…ˆè¯» header å¾— headlenï¼‰ï¼Œä»è€Œå…¼å®¹æ—§æ•°æ®ï¼›æˆ–
    - B) ç›´æ¥æ‹’ç»æ‰“å¼€æ—§æ ¼å¼ï¼ˆbreakingï¼‰ï¼Œè¦æ±‚ç¦»çº¿è¿ç§»ã€‚
    è¿™å¿…é¡»äºŒé€‰ä¸€ã€‚

2) **æ˜¯å¦éœ€è¦ç‰ˆæœ¬æ ‡è¯†ï¼Ÿ**
- è‹¥é€‰æ‹© Aï¼ˆå…¼å®¹æ—§æ•°æ®ï¼‰ï¼Œå»ºè®®å¼•å…¥ç‰ˆæœ¬æ ‡è¯†çš„æœ€å°æ–¹å¼ä¹‹ä¸€ï¼š
    - åœ¨ Layer 1ï¼ˆStateJournalï¼‰è®°å½•ä¸­åŠ å…¥æ˜¾å¼ç‰ˆæœ¬å·/å­—æ®µæ ‡è®°ï¼ˆæ¨èï¼‰ï¼›æˆ–
    - åœ¨ 64-bit packed å€¼å†…éƒ¨é¢„ç•™ç‰ˆæœ¬ä½ï¼ˆè§ Â§3ï¼‰ï¼›
    - ä¸å»ºè®®ä¾èµ–â€œç»éªŒå¼åˆ¤åˆ«â€ï¼ˆä¾‹å¦‚æ ¹æ® length æ˜¯å¦ä¸º 0 æ¨æ–­ï¼‰ï¼Œé™¤éè¯¥åˆ¤åˆ«è§„åˆ™è¢«å†™æˆ MUST å¹¶è¦†ç›–å…¨éƒ¨å†å²å€¼åŸŸã€‚

3) **è¿ç§»è·¯å¾„ï¼ˆå¯æ‰§è¡Œï¼‰**
- è·¯çº¿ Aï¼ˆè½¯å…¼å®¹ï¼‰ï¼šæ–°ç‰ˆæœ¬ä»èƒ½è¯»å–æ—§ Address64ï¼›å½“é‡åˆ°æ—§æŒ‡é’ˆæ—¶æŒ‰ offset å»è¯» header è·å– lengthï¼Œç„¶ååœ¨å†…å­˜ä¸­å‡çº§ä¸º FramePtrï¼ˆä½†å†™å›ä»æ˜¯æ—§æ ¼å¼æˆ–åœ¨ä¸‹ä¸€æ¬¡ compact/rewriter æ—¶å‡çº§ï¼‰ã€‚
- è·¯çº¿ Bï¼ˆç¡¬è¿ç§»ï¼‰ï¼šå¼•å…¥ StateJournal æ–‡ä»¶æ ¼å¼ç‰ˆæœ¬ V2ï¼Œè¦æ±‚é¦–æ¬¡æ‰“å¼€æ—¶ç¦»çº¿è¿ç§»ï¼ˆé‡å†™ VersionIndex/Meta æŒ‡é’ˆå­—æ®µä¸º FramePtr packedï¼‰ï¼Œæ—§ç‰ˆæœ¬ä»…é€šè¿‡è¿ç§»å·¥å…·æ”¯æŒã€‚
- è·¯çº¿ Cï¼ˆåŒå†™ä¸€æ®µæ—¶é—´ï¼‰ï¼šæ–°å†™å…¥ä½¿ç”¨ FramePtrï¼Œæ—§å­—æ®µä»ä¿ç•™ Address64ï¼ˆå†—ä½™ï¼‰ä»¥æ”¯æŒæ—§ readerï¼›è¯¥è·¯çº¿å¤æ‚ä¸”å®¹æ˜“äº§ç”Ÿæ¼‚ç§»ï¼Œé™¤éæœ‰æ˜ç¡®çš„è·¨ç‰ˆæœ¬å…±å­˜éœ€æ±‚ï¼Œå¦åˆ™ä¸å»ºè®®ã€‚

#### 5. å…³é”®æ¡æ¬¾è‰æ¡ˆï¼ˆ3-5 ä¸ªï¼‰

**`[F-FRAMEPTR-DEFINITION]`ï¼ˆæœ¯è¯­ï¼‰**
> FramePtr æ˜¯ä¸€ä¸ªå¯æ‰“åŒ…ä¸º `ulong` çš„å¸§æŒ‡é’ˆï¼ŒåŒ…å« `OffsetBytes` ä¸ `FrameBytesLength`ã€‚`OffsetBytes` æŒ‡å‘è¯¥å¸§çš„ `HeadLen` å­—æ®µèµ·ç‚¹ï¼›`FrameBytesLength` è¡¨ç¤ºè¯¥å¸§çš„ FrameBytes æ€»é•¿åº¦ï¼ˆä¸å« Fenceï¼‰ã€‚

**`[F-FRAMEPTR-ALIGNMENT]`ï¼ˆæ ¼å¼ï¼‰**
> å¯¹ä»»æ„é Null FramePtrï¼š`OffsetBytes % 4 == 0` ä¸” `FrameBytesLength % 4 == 0` MUST æˆç«‹ã€‚`OffsetBytes == 0` æˆ– `FrameBytesLength == 0` MUST è¡¨ç¤º Nullã€‚

**`[S-FRAMEPTR-PACK-REVERSIBLE]`ï¼ˆè¯­ä¹‰ï¼‰**
> å¯¹ä»»æ„æ»¡è¶³ `[F-FRAMEPTR-ALIGNMENT]` ä¸”å€¼åŸŸåœ¨ bit åˆ†é…ä¸Šé™å†…çš„ `(OffsetBytes, FrameBytesLength)`ï¼Œ`Pack()` ä¸ `Unpack()` MUST äº’ä¸ºé€†è¿ç®—ã€‚å¯¹ä¸æ»¡è¶³å€¼åŸŸ/å¯¹é½/ä¿ç•™æ¨¡å¼çš„è¾“å…¥ï¼Œ`Unpack` MUST fail-fastï¼ˆé”™è¯¯ç±»å‹éœ€å›ºå®šï¼‰ã€‚

**`[S-RBF-SCANNER-TRYREADAT-FRAMEPTR]`ï¼ˆè¯­ä¹‰ï¼‰**
> `IRbfScanner.TryReadAt(FramePtr ptr, out RbfFrame frame)` MUST åœ¨ `ptr` å¯è§£å¼•ç”¨ä¸” framing/CRC æ ¡éªŒé€šè¿‡æ—¶è¿”å› `true` å¹¶äº§å‡ºè¯¥å¸§ï¼›å½“ `ptr` ä¸º Null æˆ–è½åœ¨è°ƒç”¨æ—¶åˆ» EOF ä¹‹å¤–æ—¶ MUST è¿”å› `false` ä¸”ä¸å¾—æŠ›å¼‚å¸¸ã€‚è‹¥ `ptr.FrameBytesLength` ä¸æ–‡ä»¶ä¸­è¯¥å¸§çš„ headlen ä¸ä¸€è‡´ï¼Œè¡Œä¸º MUST å½’ç±»ä¸ºâ€œæ ¼å¼/ç´¢å¼•æŸåâ€å¹¶æŒ‰è§„èŒƒå›ºå®šå¤„ç†ï¼ˆè¿”å› false æˆ–æŠ› `InvalidDataException`ï¼ŒäºŒé€‰ä¸€ï¼‰ã€‚

**`[S-RBF-FRAMEPTR-LENGTH-LIMIT]`ï¼ˆè¯­ä¹‰ï¼‰**
> å½“å¾…å†™å…¥æˆ–å¾…è¯»å–çš„å¸§ï¼ˆFrameBytes æ€»é•¿åº¦ï¼‰è¶…è¿‡ `FramePtr.MaxFrameBytesLength` æ—¶ï¼Œå†™å…¥ä¾§ MUST å¤±è´¥ï¼ˆå»ºè®® `ArgumentOutOfRangeException`ï¼‰ï¼›è¯»å–ä¾§è‹¥é‡åˆ°æ— æ³•è¡¨ç¤ºçš„å¸§é•¿åº¦ MUST å¤±è´¥å¹¶å½’ç±»ä¸ºâ€œæŸåæˆ–ä¸æ”¯æŒâ€ï¼ˆé”™è¯¯ç±»å‹éœ€å›ºå®šï¼‰ã€‚


<EditAnchor ç›‘æŠ¤äººç¬¬äºŒè½®å‘è¨€ç»“æŸ>
---

### Advisor-DeepSeek å‘è¨€ï¼ˆå¯æµ‹è¯•æ€§ä¸ DX åˆ†æï¼‰

> **åŸºäº**ï¼šç›‘æŠ¤äººç¬¬äºŒè½®å‘è¨€çš„å››ç‚¹æ¶æ„æè®®ï¼ˆA/B åˆ†å±‚ã€FaÃ§adeã€FramePtrã€åº•å±‚ APIï¼‰
> **é‡ç‚¹**ï¼šä»å¼€å‘è€…ä½“éªŒä¸å¯æµ‹è¯•æ€§è§’åº¦è¯„ä¼°æŠ€æœ¯é€‰æ‹©

---

#### å¿«é€Ÿè½¨é“ï¼ˆPreviewï¼‰

| ç»´åº¦ | æ ¸å¿ƒå‘ç° | æ¨è |
|:-----|:---------|:-----|
| **å¯æµ‹è¯•æ€§** | A/B åˆ†å±‚å¤©ç„¶æ”¯æŒæµ‹è¯•éš”ç¦» | âœ… æ¨èåˆ†å±‚ |
| **DX** | RandomAccess ç›´è§‚ä½†éœ€è¦"å¿ƒæ™ºæ¨¡å‹è½¬æ¢" | âœ… æ¨è,éœ€æä¾›æŒ‡å— |
| **ç¼“å­˜** | MVP ä¸éœ€è¦,é¿å…æµ‹è¯•å¤æ‚åº¦ | âœ… æ¨èä¸å¼•å…¥ |
| **FramePtr** | è¯»è·¯å¾„ä¼˜ç§€,éœ€é˜²æ­¢"è¿‡åº¦æ‰“åŒ…"å¿ƒæ™ºè´Ÿæ‹… | âœ… æ¨è,éœ€æ–‡æ¡£ |

---

(å®é™…å‘è¨€å†…å®¹è¾ƒé•¿ï¼Œå·²é€šè¿‡ç¼–è¾‘è¿½åŠ åˆ°ä¼šè®®æ–‡ä»¶)


### Auditor å‘è¨€ï¼ˆFramePtr è§„èŒƒå®¡è®¡ï¼‰

#### 1. ä¸ç°æœ‰è§„èŒƒçš„å†²çªæ£€æŸ¥

**SSOT ç°çŠ¶ï¼ˆ`atelia/docs/Rbf/rbf-interface.md` v0.17ï¼‰**ï¼š
- æŒ‡é’ˆç±»å‹æ˜¯ `Address64(ulong Value)`ï¼Œæ¡æ¬¾ä¸ºï¼š`[F-ADDRESS64-DEFINITION]` / `[F-ADDRESS64-ALIGNMENT]` / `[F-ADDRESS64-NULL]`ã€‚
- `IRbfScanner.TryReadAt(Address64 address, out RbfFrame frame)` åœ¨ `[A-RBF-SCANNER-INTERFACE]` ä¸­å›ºåŒ–ã€‚
- å†™å…¥ä¾§ `IRbfFramer.Append(...)` / `RbfFrameBuilder.Commit()` çš„è¿”å›ç±»å‹éƒ½æ˜¯ `Address64`ï¼ˆ`[A-RBF-FRAMER-INTERFACE]` / `[A-RBF-FRAME-BUILDER]`ï¼‰ã€‚

**å†²çª/æ”¹åŠ¨é¢ï¼ˆå¿…é¡»è£å†³â€œå‡çº§â€çš„å«ä¹‰ï¼‰**ï¼š
1) **è‹¥ FramePtr = å®Œå…¨æ›¿æ¢ Address64ï¼ˆBreakingï¼‰**ï¼š
     - éœ€è¦åŒæ­¥ä¿®æ”¹ï¼š`IRbfScanner.TryReadAt(...)`ã€`IRbfFramer.Append(...)`ã€`RbfFrameBuilder.Commit()`ã€`RbfFrame.Address` ç±»å‹ã€‚
     - éœ€è¦å¤„ç†æ¡æ¬¾è¿ç§»ï¼š`[F-ADDRESS64-*]` æ˜¯å¦åºŸå¼ƒï¼Ÿæ˜¯å¦ä¿ç•™ä¸ºå…¼å®¹æœ¯è¯­ï¼Ÿï¼ˆå¦åˆ™ Clause Registry ä¼šå‡ºç°â€œåŒä¸€æ¦‚å¿µå¤šæƒå¨å®šä¹‰â€çš„é£é™©ï¼‰
2) **è‹¥ FramePtr = æ–°å¢ï¼ˆä¸ Address64 å¹¶å­˜ï¼‰**ï¼š
     - `rbf-interface.md` çš„â€œæŒ‡é’ˆæ¦‚å¿µâ€ä¼šåˆ†è£‚ä¸º offset-only ä¸ offset+length ä¸¤ç§ï¼Œéœ€è¦æ˜ç¡®ï¼šä½•æ—¶å¿…é¡»ç”¨ FramePtrï¼Œä½•æ—¶å…è®¸ Address64ã€‚
     - `TryReadAt` æ˜¯å¦è¦æä¾›åŒç­¾åï¼ˆ`TryReadAt(Address64)` + `TryReadAt(FramePtr)`ï¼‰ï¼Ÿè‹¥ä¸æä¾›ï¼ŒFramePtr çš„ä»·å€¼ä¼šè¢«é™åˆ¶åœ¨ä¸Šå±‚ç§æœ‰ç´¢å¼•ç»“æ„ï¼Œè€Œä¸æ˜¯æ¥å£å¥‘çº¦ã€‚

**ç­¾åæ˜¯å¦å¿…é¡»æ”¹**ï¼ˆé’ˆå¯¹ä½ é—®çš„ `IRbfScanner.TryReadAt(Address64)`ï¼‰ï¼š
- å¦‚æœç›®æ ‡æ˜¯â€œè¯»è·¯å¾„ä¸€æ¬¡çŸ¥é“åœ¨å“ªè¯»ã€è¯»å¤šå°‘ï¼ˆå‡å°‘ä¸€æ¬¡ header è¯»å–ï¼‰â€ï¼Œé‚£ä¹ˆ**ä»…é  Address64 æ— æ³•è¾¾æˆ**ï¼Œå› æ­¤éœ€è¦ï¼š
    - A) ç›´æ¥æŠŠç­¾åæ”¹æˆ `TryReadAt(FramePtr ptr, ...)`ï¼ˆBreakingï¼‰ï¼Œæˆ–
    - B) å¢åŠ ä¸€ä¸ª `TryReadAt(FramePtr ptr, ...)` fast-pathï¼ŒåŒæ—¶ä¿ç•™ Address64 å…¼å®¹ï¼ˆæ›´å¹³æ»‘ï¼Œä½†è§„èŒƒæ›´å¤æ‚ï¼‰ã€‚

**ç°æœ‰æ¡æ¬¾å½±å“**ï¼š
- `[F-ADDRESS64-ALIGNMENT]` çš„â€œ4B å¯¹é½â€ä¸ FramePtr çš„â€œoffset ä¸æ”¯æŒé 4B å¯¹é½â€ä¸å†²çªï¼›ä½† FramePtr è¿˜å¼•å…¥â€œlength çš„å¯¹é½/èŒƒå›´â€è¿™ä¸€ç»„æ–°å¢çº¦æŸã€‚
- ä»»åŠ¡æè¿°é‡Œçš„ `[A-RBF-ADDRESS64-OFFSET]` åœ¨ v0.17 SSOT ä¸­ä¸å­˜åœ¨ï¼šè¿™å±äº**æ¡æ¬¾ ID æ¼‚ç§»/å¼•ç”¨å¤±æ•ˆ**é£é™©ï¼Œå¿…é¡»åœ¨è§„èŒƒä¾§è¡¥ä¸€ä¸ªâ€œæ—§ ID â†’ æ–° IDâ€çš„æ˜ å°„æˆ–æ›´æ­£å¼•ç”¨æ¥æºã€‚

#### 2. å¿…é¡»è§„èŒƒåŒ–çš„å¥‘çº¦

FramePtr ä¼šæŠŠâ€œåŸæœ¬å¯åœ¨å®ç°ç»†èŠ‚é‡Œå·æ‡’çš„è¡Œä¸ºâ€æ¨åˆ°æ¥å£è¾¹ç•Œï¼Œä»¥ä¸‹å¥‘çº¦å¿…é¡»è§„èŒƒåŒ–ä¸ºå¯åˆ¤å®šæ¡æ¬¾ï¼ˆå¦åˆ™å®ç°ä¼šå€’çŒï¼‰ï¼š

1) **Pack/Unpack å¯é€†æ€§ï¼ˆåŸŸå†…å¯é€†ï¼‰**
- å¿…é¡»å®šä¹‰â€œå¯é€†åŸŸâ€ï¼ˆvalid domainï¼‰ï¼š
    - `OffsetBytes % 4 == 0`ï¼ˆé Null æ—¶ï¼‰ï¼›
    - `FrameBytesLength % 4 == 0` ä¸” `FrameBytesLength > 0`ï¼ˆé Null æ—¶ï¼‰ï¼›
    - `OffsetBytes` ä¸ `FrameBytesLength` éœ€åœ¨ bit åˆ†é…å¯è¡¨ç¤ºèŒƒå›´å†…ã€‚
- è§„èŒƒå¿…é¡»è¦æ±‚ï¼šå¯¹ä»»æ„è½åœ¨ valid domain çš„å€¼å¯¹ï¼Œ`Pack(Unpack(x)) == x` ä¸” `Unpack(Pack(y)) == y`ã€‚

2) **4B å¯¹é½çº¦æŸçš„å¼ºåˆ¶æ€§**
- ä¸èƒ½åªå†™â€œè¦æ±‚å¯¹é½â€ï¼Œå¿…é¡»æ˜ç¡®ï¼š
    - æ„é€ /è½¬æ¢ APIï¼ˆå¦‚ `FramePtr.FromOffsetAndLength` æˆ– `TryCreate`ï¼‰å¯¹éå¯¹é½è¾“å…¥å¦‚ä½•å¤„ç†ï¼ˆæŠ›å¼‚å¸¸ vs è¿”å› falseï¼ŒäºŒé€‰ä¸€å¹¶å›ºå®šï¼‰ã€‚
    - ä» `ulong` è§£åŒ…é‡åˆ°â€œéæ³•å¯¹é½/ä¿ç•™æ¨¡å¼â€çš„å¤„ç†ï¼ˆfail-fast å¼‚å¸¸ç±»å‹æˆ– TryParse è¯­ä¹‰ï¼ŒäºŒé€‰ä¸€å¹¶å›ºå®šï¼‰ã€‚

3) **é•¿åº¦å­—æ®µè¯­ä¹‰å¿…é¡»å”¯ä¸€**
- å¿…é¡»é’‰æ­» length è¡¨ç¤ºçš„å•ä½ä¸èŒƒå›´ï¼šå»ºè®®å‘½åä¸º `FrameBytesLength` å¹¶å®šä¹‰ä¸ºâ€œFrameBytes æ€»é•¿åº¦ï¼ˆä¸å« Genesis/Fenceï¼‰â€ã€‚
- å¿…é¡»æ˜ç¡® Null åˆ¤å®šï¼šå»ºè®® `packed == 0` æˆ– `(OffsetBytes==0 && FrameBytesLength==0)` ä¸ºå”¯ä¸€ Nullï¼›å…¶ä»–â€œåŠç©ºå€¼â€ï¼ˆoffset=0,length>0 æˆ– offset>0,length=0ï¼‰å»ºè®®å½’ä¸º invalidï¼ˆUnpack fail-fastï¼‰ã€‚

4) **è¶Šç•Œ/è¶…èŒƒå›´çš„é”™è¯¯å¤„ç†åˆ†å±‚**
- æ„é€ /æ‰“åŒ…å±‚ï¼ˆçº¯å€¼è¯­ä¹‰ï¼‰ï¼šè¶Šç•Œ/ä¸åˆæ³• MUST fail-fastï¼ˆå¼‚å¸¸ç±»å‹éœ€å›ºå®šæˆ– TryXxx è¿”å› falseï¼‰ã€‚
- I/O å±‚ï¼ˆTryReadAtï¼‰ï¼š
    - Null æˆ– EOF å¤–ï¼šMUST è¿”å› `false` ä¸”ä¸å¾—æŠ›å¼‚å¸¸ï¼ˆä¿æŒ TryXxx è¯­ä¹‰çš„ä¸€è‡´æ€§ï¼‰ã€‚
    - â€œptr å¯è§£å¼•ç”¨ä½†ä¸æ–‡ä»¶å†…å®¹ä¸ä¸€è‡´â€ï¼ˆlength mismatch / CRC fail / framing invalidï¼‰ï¼šå¿…é¡»å½’ç±»ä¸ºâ€œæŸå/ä¸ä¸€è‡´â€å¹¶å›ºå®šå¤„ç†ç­–ç•¥ï¼ˆè¿”å› false vs æŠ› `InvalidDataException`ï¼Œéœ€è£å†³ï¼›ä¸è¦ç•™åœ¨â€œå¾…å®ç°æ—¶ç¡®è®¤â€ï¼Œå¦åˆ™ä¸å¯åˆ¤å®šï¼‰ã€‚

#### 3. Bit åˆ†é…çš„å¯åˆ¤å®šæ€§

**Claude å»ºè®® 44:20ï¼ˆoffset:lengthï¼Œä¸”å‡ä»¥ 4B å•ä½ç¼–ç ï¼‰æ˜¯å¯æœºæ¢°åˆ¤å®šçš„**ï¼š
- æœ€å¤§å¯è¡¨ç¤ºæ–‡ä»¶åç§»ï¼š$2^{44}\times 4$ bytes = $2^{46}$ bytes = 64 TiBã€‚
- æœ€å¤§å¯è¡¨ç¤ºå¸§é•¿ï¼š$2^{20}\times 4$ bytes = $2^{22}$ bytes = 4 MiBã€‚

**æ˜¯å¦æ»¡è¶³ StateJournal éœ€æ±‚ï¼ˆä»¥å½“å‰ä¼šè®®ææ–™çš„â€œéœ€æ±‚åˆ†æç»“è®ºâ€ä¸ºè¯æ®ï¼‰**ï¼š
- 64 TiB å•æ–‡ä»¶ä¸Šé™ï¼šå¯¹â€œappend-only + é•¿æœŸå¥æŸ„â€çš„ StateJournal é€šå¸¸è¶³å¤Ÿï¼›è‹¥æœªæ¥è¶…å‡ºï¼Œæ›´å¯èƒ½é‡‡ç”¨â€œåˆ†æ®µ/å¤šæ–‡ä»¶â€è€Œéæ— é™å•æ–‡ä»¶ã€‚
- 4 MiB å•å¸§ä¸Šé™ï¼šå¤§æ¦‚ç‡å¤Ÿç”¨ï¼Œä½†å®ƒå±äº Layer 1 è´Ÿè½½å¤§å°çš„ç¡¬ä¸Šé™ï¼Œå¿…é¡»ä¸Šå‡ä¸ºæ¡æ¬¾ï¼ˆå¦åˆ™å‡ºç° 5 MiB å¯¹è±¡ç‰ˆæœ¬æ—¶ï¼Œè¡Œä¸ºä¸å¯åˆ¤å®šï¼šæ˜¯æ‹’ç»å†™å…¥ï¼Ÿæ‹†åˆ†ï¼Ÿæˆªæ–­ï¼Ÿï¼‰ã€‚

**è¶…å‡ºèŒƒå›´æ—¶çš„è¡Œä¸ºå¿…é¡»æ˜ç¡®ï¼ˆå¯åˆ¤å®šç‚¹ï¼‰**ï¼š
- **å†™å…¥ä¾§**ï¼šå½“å¾…å†™å…¥å¸§ï¼ˆFrameBytes æ€»é•¿åº¦ï¼‰> `FramePtr.MaxFrameBytesLength` æ—¶ï¼Œ`Append/Commit` MUST å¤±è´¥ï¼ˆå»ºè®® `ArgumentOutOfRangeException`ï¼‰ï¼Œä¸å¾— silent wrap/æˆªæ–­ã€‚
- **è¯»å–ä¾§**ï¼š
    - è‹¥ `Unpack` å¾—åˆ°çš„ length è¶…å‡º Max æˆ–å°äº Minï¼ˆç”± wire format æœ€å°å¸§é•¿åº¦å†³å®šï¼‰ï¼Œ`Unpack` MUST fail-fastï¼›
    - `TryReadAt` æ”¶åˆ°éæ³• FramePtr æ—¶çš„è¡Œä¸ºä¹Ÿå¿…é¡»å›ºå®šï¼ˆå‚æ•°å¼‚å¸¸ vs è¿”å› falseï¼ŒäºŒé€‰ä¸€ï¼‰ã€‚

**æ˜¯å¦éœ€è¦é¢„ç•™æ‰©å±•ä½ï¼ˆç‰ˆæœ¬ä½ï¼‰**ï¼š
- 44:20 ç”¨æ»¡ 64 bitï¼Œå•å‡­ä¸€ä¸ª `ulong` å°†æ— æ³•åŒºåˆ†â€œå®ƒæ˜¯æ—§ Address64 packed è¿˜æ˜¯æ–° FramePtr packedâ€ï¼Œé™¤éä¾èµ–å¤–éƒ¨ç‰ˆæœ¬å­—æ®µã€‚
- è‹¥ç³»ç»Ÿå­˜åœ¨â€œå†å²æ•°æ®é‡Œå­˜äº† u64 æŒ‡é’ˆå€¼â€çš„åœºæ™¯ï¼ˆStateJournal çš„ç´¢å¼•/è®°å½•ï¼‰ï¼Œå»ºè®®è‡³å°‘æ»¡è¶³ä¸€ä¸ªåˆ¤åˆ«æ¡ä»¶ï¼š
    - A) åœ¨ Layer 1ï¼ˆStateJournal è®°å½•æ ¼å¼ï¼‰å¼•å…¥æ˜¾å¼ç‰ˆæœ¬å·/å­—æ®µæ ‡è®°ï¼ˆæ¨èï¼‰ï¼›æˆ–
    - B) åœ¨ packed å€¼é‡Œé¢„ç•™ 1 bit ä½œä¸º encoding version/kindï¼ˆä¼šç‰ºç‰²å¯»å€ä¸Šé™ä½†æ¢æ¥è‡ªæè¿°å¯åˆ¤å®šæ€§ï¼‰ã€‚

#### 4. å‘åå…¼å®¹æ€§

**å…ˆå®šè´£ä»»è¾¹ç•Œ**ï¼š
- RBF Layer 0 çš„ `FramePtr/Address64` æ˜¯â€œæ¥å£å±‚ç±»å‹â€ï¼›â€œå·²åºåˆ—åŒ–çš„ Address64 æ•°æ®â€é€šå¸¸ä½äº Layer 1ï¼ˆStateJournal çš„ VersionIndex / CommitRecord payload ç­‰ï¼‰ã€‚å› æ­¤å…¼å®¹ç­–ç•¥å¿…é¡»åœ¨ StateJournal çš„ wire format ä¾§å¯åˆ¤å®šï¼ŒRBF ä¾§åªéœ€è¦æä¾›è¶³å¤Ÿçš„è¯»å–èƒ½åŠ›ã€‚

**å¿…é¡»è£å†³çš„ä¸¤æ¡è·¯çº¿ï¼ˆä¸è¦éšå¼ï¼‰**ï¼š
1) **è½¯å…¼å®¹ï¼ˆæ¨èé»˜è®¤ï¼‰**ï¼š
     - StateJournal æ—§æ•°æ®é‡Œçš„ `ulong` ä»æŒ‰ Address64 offset-only è§£è¯»ï¼›è¯»å–æ—¶éœ€è¦â€œå…ˆè¯» header è·å– headlenï¼Œå†è¯»å®Œæ•´å¸§â€çš„æ…¢è·¯å¾„ã€‚
     - æ–°æ•°æ®å†™å…¥å¯ä½¿ç”¨ FramePtrï¼›å½“åŠ è½½æ—§æŒ‡é’ˆæ—¶ï¼Œå¯åœ¨å†…å­˜ä¸­å‡çº§ä¸º FramePtrï¼ˆä½†å†™å›æ˜¯å¦å‡çº§ç”± StateJournal çš„ç‰ˆæœ¬ç­–ç•¥å†³å®šï¼‰ã€‚
2) **ç¡¬è¿ç§»ï¼ˆå¯æ¥å—ä½†å¿…é¡»æä¾›å·¥å…·ï¼‰**ï¼š
     - å¼•å…¥ StateJournal æ–‡ä»¶æ ¼å¼æ–°ç‰ˆæœ¬ï¼ˆä¾‹å¦‚ V2ï¼‰ï¼Œæ—§æ ¼å¼ä¸å†æ”¯æŒç›´æ¥æ‰“å¼€ï¼›æä¾›è¿ç§»å·¥å…·æŠŠæ—§ offset-only æŒ‡é’ˆé‡å†™ä¸º FramePtr packedã€‚

**æ˜¯å¦éœ€è¦ç‰ˆæœ¬æ ‡è¯†**ï¼š
- å¦‚æœå†å²ä¸Šä»»ä½•åœ°æ–¹æŠŠæŒ‡é’ˆä¿å­˜ä¸ºâ€œè£¸ u64â€ï¼Œé‚£ä¹ˆå¿…é¡»æœ‰ç‰ˆæœ¬æ ‡è¯†ï¼ˆå¤–éƒ¨å­—æ®µæˆ–å†…éƒ¨ç‰ˆæœ¬ä½ï¼‰ï¼Œå¦åˆ™ reader æ— æ³•æœºæ¢°åˆ¤åˆ«è¯¥ u64 çš„è¯­ä¹‰ã€‚

#### 5. å…³é”®æ¡æ¬¾è‰æ¡ˆï¼ˆ3-5 ä¸ªï¼‰

**`[F-FRAMEPTR-DEFINITION]`ï¼ˆæœ¯è¯­ï¼‰**
> FramePtr æ˜¯ä¸€ä¸ªå¯æ‰“åŒ…ä¸º `ulong` çš„å¸§æŒ‡é’ˆï¼ŒåŒ…å« `OffsetBytes` ä¸ `FrameBytesLength`ã€‚`OffsetBytes` æŒ‡å‘è¯¥å¸§çš„ `HeadLen` å­—æ®µèµ·ç‚¹ï¼›`FrameBytesLength` è¡¨ç¤ºè¯¥å¸§çš„ FrameBytes æ€»é•¿åº¦ï¼ˆä¸å« Genesis/Fenceï¼‰ã€‚

**`[F-FRAMEPTR-ALIGNMENT]`ï¼ˆæ ¼å¼ï¼‰**
> å¯¹ä»»æ„é Null FramePtrï¼š`OffsetBytes % 4 == 0` ä¸” `FrameBytesLength % 4 == 0` MUST æˆç«‹ã€‚`packed == 0`ï¼ˆç­‰ä»·äº `OffsetBytes == 0 && FrameBytesLength == 0`ï¼‰MUST è¡¨ç¤º Nullï¼›é™¤ Null å¤–ä»»ä½• `OffsetBytes == 0` æˆ– `FrameBytesLength == 0` MUST è§†ä¸º invalidã€‚

**`[S-FRAMEPTR-PACK-REVERSIBLE]`ï¼ˆè¯­ä¹‰ï¼‰**
> å¯¹ä»»æ„æ»¡è¶³ `[F-FRAMEPTR-ALIGNMENT]` ä¸”å€¼åŸŸåœ¨ bit åˆ†é…ä¸Šé™å†…çš„ `(OffsetBytes, FrameBytesLength)`ï¼Œ`Pack()` ä¸ `Unpack()` MUST äº’ä¸ºé€†è¿ç®—ã€‚å¯¹ä¸æ»¡è¶³å¯¹é½/å€¼åŸŸ/ä¿ç•™æ¨¡å¼çš„ packed å€¼ï¼Œ`Unpack` MUST fail-fastï¼ˆå¼‚å¸¸ç±»å‹éœ€å›ºå®šï¼Œæˆ–æä¾› `TryUnpack` è¿”å› `false`ï¼ŒäºŒé€‰ä¸€ï¼‰ã€‚

**`[S-RBF-SCANNER-TRYREADAT-FRAMEPTR]`ï¼ˆè¯­ä¹‰ï¼‰**
> `IRbfScanner.TryReadAt(FramePtr ptr, out RbfFrame frame)` MUST åœ¨ `ptr` å¯è§£å¼•ç”¨ä¸” framing/CRC æ ¡éªŒé€šè¿‡æ—¶è¿”å› `true` å¹¶äº§å‡ºè¯¥å¸§ï¼›å½“ `ptr` ä¸º Null æˆ–è½åœ¨è°ƒç”¨æ—¶åˆ» EOF ä¹‹å¤–æ—¶ MUST è¿”å› `false` ä¸”ä¸å¾—æŠ›å¼‚å¸¸ã€‚è‹¥ `ptr.FrameBytesLength` ä¸æ–‡ä»¶ä¸­è¯¥å¸§çš„ `HeadLen` ä¸ä¸€è‡´ï¼Œè¡Œä¸º MUST å½’ç±»ä¸ºâ€œç´¢å¼•/æ ¼å¼ä¸ä¸€è‡´â€å¹¶æŒ‰è§„èŒƒå›ºå®šå¤„ç†ï¼ˆè¿”å› `false` æˆ–æŠ› `InvalidDataException`ï¼ŒäºŒé€‰ä¸€ï¼‰ã€‚

**`[S-RBF-FRAMEPTR-LENGTH-LIMIT]`ï¼ˆè¯­ä¹‰ï¼‰**
> å½“å¾…å†™å…¥æˆ–å¾…è¯»å–çš„å¸§ï¼ˆFrameBytes æ€»é•¿åº¦ï¼‰è¶…è¿‡ `FramePtr.MaxFrameBytesLength` æ—¶ï¼Œå†™å…¥ä¾§ MUST å¤±è´¥ï¼ˆå»ºè®® `ArgumentOutOfRangeException`ï¼‰ï¼›è¯»å–ä¾§è‹¥é‡åˆ°æ— æ³•è¡¨ç¤ºçš„å¸§é•¿åº¦ MUST å¤±è´¥å¹¶å½’ç±»ä¸ºâ€œæŸåæˆ–ä¸æ”¯æŒâ€ï¼ˆé”™è¯¯ç±»å‹éœ€å›ºå®šï¼‰ã€‚

