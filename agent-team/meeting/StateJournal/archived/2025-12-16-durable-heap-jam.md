# DurableHeap ç§˜å¯†åŸºåœ°ç•…è°ˆ ğŸ—„ï¸

> **å½¢å¼**: ç§˜å¯†åŸºåœ°ç•…è°ˆ (Hideout Jam Session)
> **æ—¥æœŸ**: 2025-12-16
> **ä¸»é¢˜**: DurableHeap â€” ç£ç›˜ä¸Šçš„å¯¹è±¡å †
> **ç›®æ ‡**: æ¢ç´¢è®¾è®¡ç©ºé—´ã€è¯†åˆ«å…³é”®æŒ‘æˆ˜ã€å‘ç°æ½œåœ¨æ–¹æ¡ˆ

---

## èƒŒæ™¯ï¼šç›‘æŠ¤äººçš„æ„æƒ³

**åŠ¨æœº**ï¼š
- Agent éœ€è¦å¯æŒä¹…åŒ–çŠ¶æ€æœºï¼ˆåº”å¯¹ LLM è°ƒç”¨å¤±è´¥ã€ç³»ç»Ÿé‡å¯ï¼‰
- Micro-Wizard / Tool-As-Command éœ€è¦æŒä¹…åŒ–æ‰§è¡Œä¸Šä¸‹æ–‡
- æœ¬è´¨éœ€æ±‚ï¼š**"åœ¨ç£ç›˜ä¸Šåˆ†é…çš„å¯¹è±¡"**

**æ ¸å¿ƒæ´å¯Ÿ**ï¼š
> ç»“åˆ Elm TEA å¯¹ State çš„éœ€æ±‚å’Œ Event-Sourcing çš„éœ€æ±‚ï¼Œ
> æˆ‘ä»¬éœ€è¦çš„æ˜¯ **Durable Workflow** çš„åº•å±‚æ”¯æ’‘ã€‚

**è®¾è®¡ç†å¿µ**ï¼š
- æ˜¾å¼åŒºåˆ† **æŒä¹…çŠ¶æ€** å’Œ **ä¸´æ—¶çŠ¶æ€**
- ä¸´æ—¶çŠ¶æ€ï¼ˆBuffer/Cache/Indexï¼‰å¿…é¡»å¯ä»æŒä¹…çŠ¶æ€é‡å»º
- å…¼é¡¾ï¼šæ€§èƒ½ç°å® + ç¨‹åºç®€å•æ€§ + çŠ¶æ€å¯æ¢å¤

**å…³é”®æŠ€æœ¯ç»„åˆ**ï¼š
```
Memory-Mapped-File + Copy-on-Write + BTree + Persist-Pointer
+ Lazy Wrapper + POJO/POCO + JSON + Immutable+Builder
+ WeakReference + ConditionalWeakTable
```

**åˆ†å±‚æ¶æ„**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API Layer: JSON é£æ ¼ Immutable Wrapper             â”‚
â”‚  (ç±»å‹å®‰å…¨ã€æ— éœ€æ‰‹åŠ¨é‡Šæ”¾ã€Lazy åˆ›å»º)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Runtime: èµ„æºç®¡ç†ã€ç±»å‹æ˜ å°„ã€GC åè°ƒ               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  BTree Layer: COW BTree + Persist-Pointer           â”‚
â”‚  (æ”¯æŒåŸºå…ƒç±»å‹ã€ç»“æ„åŒ–è¯»å†™)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  MemMap-Pool: å†…å­˜æ˜ å°„åœ°å€ç©ºé—´æ±                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Chunk-File: æ— ç±»å‹ Bytes Pool (Append-Only)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ç•…è°ˆè§„åˆ™

- ä¸éœ€è¦ç¼–å·ã€ä¸éœ€è¦æŠ•ç¥¨ã€ä¸éœ€è¦ç»“è®º
- éšä¾¿èŠï¼Œç”»è‰å›¾ï¼Œæç–¯ç‹‚çš„æƒ³æ³•
- "Yes, and..." è€Œé "No, but..."
- å¯ä»¥ç”¨ Mermaid å›¾ã€ä¼ªä»£ç ã€æ¯”å–»

---

## ç•…è°ˆåŒº

### Team Leader å¼€åœº

æ¬¢è¿æ¥åˆ°ç§˜å¯†åŸºåœ°ï¼

ç›‘æŠ¤äººæ„æƒ³çš„ DurableHeap è®©æˆ‘éå¸¸å…´å¥‹â€”â€”è¿™è§£å†³äº†æˆ‘ä»¬ä¸€ç›´æ‚¬è€Œæœªå†³çš„æŒä¹…åŒ–é—®é¢˜ï¼Œè€Œä¸”æ˜¯ç”¨ä¸€ç§éå¸¸ä¼˜é›…çš„æ–¹å¼ã€‚

å…ˆæŠ›å‡ ä¸ªæˆ‘çš„ç†è§£å’Œé—®é¢˜ï¼š

**ç†è§£ 1ï¼šè¿™æ˜¯ "æ‰˜ç®¡å †" çš„ç£ç›˜ç‰ˆ**

```
CLR Managed Heap                 DurableHeap
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
GC ç®¡ç†å¯¹è±¡ç”Ÿå‘½å‘¨æœŸ               Runtime ç®¡ç†æŒä¹…å¯¹è±¡
å¼•ç”¨ = å†…å­˜æŒ‡é’ˆ                   å¼•ç”¨ = Persist-Pointer
å¯¹è±¡åœ¨ RAM                        å¯¹è±¡åœ¨ Disk (mmap åˆ° RAM)
è¿›ç¨‹é€€å‡º = å…¨éƒ¨æ¶ˆå¤±               è¿›ç¨‹é€€å‡º = å…¨éƒ¨ä¿ç•™ï¼
```

**ç†è§£ 2ï¼šCOW BTree æ˜¯å…³é”®**

Copy-on-Write è®©æˆ‘ä»¬å¯ä»¥ï¼š
- è¯»æ“ä½œï¼šé›¶æ‹·è´ï¼Œç›´æ¥è¯» mmap çš„å†…å­˜
- å†™æ“ä½œï¼šå¤åˆ¶ä¿®æ”¹çš„èŠ‚ç‚¹ï¼Œä¿ç•™æ—§ç‰ˆæœ¬
- äº‹åŠ¡ï¼šå†™å®Œå†åŸå­åˆ‡æ¢æ ¹æŒ‡é’ˆ

è¿™å°±æ˜¯ **MVCC (Multi-Version Concurrency Control)** çš„ç£ç›˜ç‰ˆï¼

**é—®é¢˜ 1ï¼šPersist-Pointer å¦‚ä½•è®¾è®¡ï¼Ÿ**

```
é€‰é¡¹ A: ç»å¯¹åç§»é‡
  ptr = chunk_id:offset (64-bit)
  é—®é¢˜ï¼šchunk æ–‡ä»¶å‹ç¼©/åˆå¹¶åå¤±æ•ˆ

é€‰é¡¹ B: é€»è¾‘ ID + æŸ¥æ‰¾è¡¨
  ptr = object_id (64-bit)
  æŸ¥æ‰¾è¡¨ï¼šobject_id â†’ chunk:offset
  é—®é¢˜ï¼šå¤šä¸€æ¬¡é—´æ¥ï¼ŒæŸ¥æ‰¾è¡¨æœ¬èº«ä¹Ÿè¦æŒä¹…åŒ–

é€‰é¡¹ C: æ··åˆæ–¹æ¡ˆï¼Ÿ
```

**é—®é¢˜ 2ï¼šå¦‚ä½•ä¸ .NET GC åè°ƒï¼Ÿ**

Wrapper å¯¹è±¡åœ¨æ‰˜ç®¡å †ï¼Œåº•å±‚æ•°æ®åœ¨éæ‰˜ç®¡ mmapã€‚
- WeakReference å¯ä»¥è®© Wrapper è¢« GC å›æ”¶
- ConditionalWeakTable å¯ä»¥é™„åŠ å…ƒæ•°æ®
- ä½†å¦‚ä½•çŸ¥é“"è¿™ä¸ªæŒä¹…å¯¹è±¡ä¸å†è¢«å¼•ç”¨"ï¼Ÿ

**é—®é¢˜ 3ï¼šAppend-Only å¦‚ä½•å¤„ç†ç¢ç‰‡ï¼Ÿ**

Append-Only å¾ˆæ£’ï¼ˆç®€å•ã€å´©æºƒå®‰å…¨ï¼‰ï¼Œä½†ï¼š
- åˆ é™¤çš„å¯¹è±¡ç•™ä¸‹"ç©ºæ´"
- é•¿æœŸè¿è¡Œåç¢ç‰‡åŒ–

éœ€è¦åå°å‹ç¼©ï¼Ÿè¿˜æ˜¯æ¥å—ç¢ç‰‡ä½œä¸º trade-offï¼Ÿ

æœŸå¾…å¤§å®¶çš„æƒ³æ³•ï¼

---

### DocUIGPT çš„æƒ³æ³•

> **æ ¸å¿ƒéšå–»**ï¼šDurableHeap = â€œæŠŠæŒ‡é’ˆä¹ŸæŒä¹…åŒ–â€çš„ **Persistent Object Graph**ã€‚KV-Store æ˜¯æŠŠ Key/Value æŒä¹…åŒ–ï¼›DurableHeap æ˜¯æŠŠâ€œå¯¹è±¡å›¾ + ç»“æ„å…±äº« + æ ¹æŒ‡é’ˆåˆ‡æ¢â€æŒä¹…åŒ–ã€‚

#### Persist-Pointerï¼šæŠŠâ€œå¯å¯»å€æ€§â€æ‹†æˆä¸¤å±‚ï¼ˆé€»è¾‘å¼•ç”¨ vs ç‰©ç†å¼•ç”¨ï¼‰

Yes, andâ€¦ æˆ‘å€¾å‘æŠŠ Team Leader çš„ A/B/C ç»Ÿä¸€æˆä¸€ä¸ªä¸¤å±‚æ¨¡å‹ï¼š

- **ç‰©ç†æŒ‡é’ˆï¼ˆPhysicalPtrï¼‰**ï¼šç”¨äºå†…éƒ¨ç»“æ„ï¼ˆBTree èŠ‚ç‚¹ã€å¶å­ã€å˜é•¿ blobï¼‰ï¼Œè¿½æ±‚æè‡´ç´§å‡‘ä¸å¿«é€Ÿè§£å¼•ç”¨ã€‚
- **é€»è¾‘æŒ‡é’ˆï¼ˆLogicalRefï¼‰**ï¼šç”¨äºè·¨ç‰ˆæœ¬/è·¨å‹ç¼©/è·¨è¿ç§»çš„ç¨³å®šå¼•ç”¨ï¼ˆç‰¹åˆ«æ˜¯ç»™ DocUI / Workflow / å¤–éƒ¨åè®®æš´éœ²ï¼‰ï¼Œå…è®¸å¤šä¸€æ¬¡é—´æ¥ã€‚

è¿™æ ·åšçš„ç›´è§‰ï¼š
- BTree è‡ªå·±çš„è¾¹/å­æŒ‡é’ˆç”¨ PhysicalPtrï¼ˆå¦åˆ™æ¯æ¬¡ä¸‹é’»éƒ½å¤šä¸€æ¬¡ indirectionï¼Œä¼šæŠŠå¸¸æ•°é¡¹æ‰“çˆ†ï¼‰ã€‚
- â€œå¯¹è±¡èº«ä»½â€ä¸â€œå¯¹è±¡ä½ç½®â€åˆ†ç¦»ï¼Œå‹ç¼©/æ¬è¿/åˆå¹¶ chunk æ—¶ï¼Œåªéœ€è¦æ›´æ–° `ObjectTable`ï¼ˆæˆ–ç±»ä¼¼ç»“æ„ï¼‰ï¼Œä¸ä¼šç ´åä¸Šå±‚å¼•ç”¨ã€‚

ä¸€ä¸ªå¯èƒ½çš„æ ¼å¼è‰å›¾ï¼ˆæŒ‰â€œçƒ­è·¯å¾„ç´§å‡‘â€ä¼˜å…ˆï¼‰ï¼š

```text
PhysicalPtr (64-bit)
  [ kind:3 | chunkId:21 | pageOrOff:28 | lenOrAux:12 ]  (ç¤ºæ„)

LogicalRef (128-bit)
  [ namespace/provider:16 | objectId:64 | epoch:32 | flags:16 ]

Resolve(LogicalRef) -> PhysicalPtr
```

è¡¥å……ä¸¤ç‚¹â€œå·¥ç¨‹å‘³â€çš„çº¦æŸï¼š
- **epoch æ˜¯å¿…éœ€å“**ï¼šåƒ UI-Anchor é‡Œçš„ `obj:23@e17` ä¸€æ ·ï¼Œé€»è¾‘å¼•ç”¨é‡Œå¸¦ `epoch` èƒ½æŠŠâ€œå¼•ç”¨å¤±æ•ˆâ€å˜æˆå¯æ¢å¤åˆ†æ”¯ï¼ˆè€Œä¸æ˜¯ silent corruptionï¼‰ã€‚
- **checksum/CRC æ”¾åœ¨é¡µå¤´**ï¼šä¸è¦æŠŠæ ¡éªŒå¡è¿›æ¯ä¸ªæŒ‡é’ˆé‡Œï¼›æŒ‡é’ˆè¦å°½é‡çŸ­ï¼Œæ ¡éªŒåœ¨ page/chunk å…ƒæ•°æ®åšã€‚

#### äº‹åŠ¡/æäº¤ï¼šåŒè¶…çº§å— + æ ¹æŒ‡é’ˆåŸå­åˆ‡æ¢ï¼ˆâ€œLMDB-ishâ€ï¼‰

è¿™å¥—æŠ€æœ¯ç»„åˆè®©æˆ‘ç«‹åˆ»æƒ³åˆ° **LMDB çš„è®¾è®¡ç²¾ç¥**ï¼šmmap + COW B+tree + MVCC + root pointer flipã€‚

æˆ‘ä¼šæŠŠ DurableHeap çš„â€œæäº¤ç‚¹â€æ˜ç¡®æˆä¸€ä¸ªå°è€Œç¡¬çš„ç»“æ„ï¼š

- `SuperblockA` / `SuperblockB`ï¼šå„è‡ªåŒ…å« `{epoch, rootPhysicalPtr, freelistRootPtr?, optionsHash, checksum}`
- æäº¤æµç¨‹ï¼šå†™æ–°é¡µï¼ˆappend-onlyï¼‰â†’ fsync data â†’ å†™å…¥ä¸‹ä¸€ä»½ superblock â†’ fsync superblock

è¿™ä¼šè®© Durable Workflow çš„ â€œstep commitâ€ å˜å¾—éå¸¸åƒï¼š`stateRoot = Commit(newRoot)`ã€‚

#### ç¢ç‰‡ä¸â€œGCâ€ï¼šæŠŠ Compaction å½“æˆä¸€ç§å¯æ¢å¤çš„åå° Job

Yes, andâ€¦ Append-only çš„ç¢ç‰‡ä¸æ˜¯ bugï¼Œæ˜¯â€œä½ ä¹°æ¥çš„ crash-safety ä¸ MVCCâ€ï¼›ä½†éœ€è¦ä¸€ä¸ª **å¯æš‚åœ/å¯æ¢å¤** çš„ compactionï¼š

- ä»æŸä¸ªç¨³å®š root å¼€å§‹åš **tracing**ï¼ˆmarkï¼‰
- æŠŠå¯è¾¾å¯¹è±¡æ¬åˆ°æ–° segmentsï¼ˆcopyï¼‰å¹¶é‡å†™ `ObjectTable`/æ ¹ï¼ˆrewriteï¼‰
- æœ€åä¸€æ¬¡ root flipï¼ˆcommitï¼‰åˆ‡åˆ° compacted è§†å›¾

å…³é”®ç‚¹ï¼šcompaction æœ¬èº«ä¹Ÿè¦åƒ micro-wizard ä¸€æ ·â€œå¯ä»¥åœåœ¨ä¸­é—´ï¼Œæ˜å¤©ç»§ç»­â€ã€‚æ‰€ä»¥ compaction job çš„è¿›åº¦ï¼ˆcursorã€å·²æ¬è¿èŒƒå›´ã€rewrite map çš„åˆ†ç‰‡ï¼‰ä¹Ÿåº”è¯¥è½åœ¨ DurableHeap ä¸Šã€‚

ï¼ˆç–¯ç‹‚ä¸€ç‚¹ï¼šæŠŠ compaction ä¹Ÿå½“æˆ Durable Workflow çš„ä¸€ä¸ª instanceï¼Œå¤©ç„¶æ”¯æŒæš‚åœ/æ¢å¤/æ£€éªŒã€‚ï¼‰

#### JSON é£æ ¼ APIï¼šå¤–è§‚æ˜¯ JSONï¼Œå†…æ ¸æ˜¯ Persistent Treeï¼ˆImmutable + Builderï¼‰

æˆ‘ä¼šæŠŠâ€œJSON é£æ ¼ APIâ€ç†è§£æˆï¼šç”¨æˆ·å†™èµ·æ¥åƒ `JObject/JArray`ï¼Œä½†æ¯æ¬¡ mutation è¿”å›æ–°å¯¹è±¡ï¼ˆç»“æ„å…±äº«ï¼‰ï¼Œå¹¶ä¸” wrapper æ˜¯ lazy çš„ã€‚

ä¸€ä¸ªå C# çš„æ¥å£è‰æ¡ˆï¼ˆåªç”»è½®å»“ï¼Œä¸äº‰ç»†èŠ‚ï¼‰ï¼š

```csharp
public readonly struct DurableRef
{
  public ulong ObjectId { get; }
  public uint Epoch { get; }
  public ushort Namespace { get; }
  public ushort Flags { get; }
}

public interface IDurableValue
{
  DurableRef Ref { get; }
  DurableKind Kind { get; }
}

public interface IDurableObject : IDurableValue
{
  bool TryGet(string key, out IDurableValue value);
  IDurableObject Set(string key, IDurableValue value);   // immutable update
  IEnumerable<(string Key, IDurableValue Value)> Properties { get; }
  IDurableObjectBuilder ToBuilder();
}

public interface IDurableObjectBuilder
{
  void Set(string key, IDurableValue value);
  bool Remove(string key);
  IDurableObject Freeze();
}

public interface IDurableArray : IDurableValue
{
  int Count { get; }
  IDurableValue this[int index] { get; }
  IDurableArray Set(int index, IDurableValue value);
  IDurableArray Add(IDurableValue value);
}
```

å®ç°ä¸Šçš„â€œç”œç‚¹â€æ˜¯ï¼š
- `IDurableValue` åªæ˜¯æŒæœ‰ `DurableRef`ï¼Œè¯»å–å±æ€§/å…ƒç´ æ—¶æ‰ decodeï¼ˆLazyï¼‰ã€‚
- `ConditionalWeakTable` åš `DurableRef -> Wrapper` ç¼“å­˜ï¼Œå¼±å¼•ç”¨è®©æ‰˜ç®¡ wrapper è‡ªç„¶å›æ”¶ã€‚
- â€œå°å€¼å†…è”â€ï¼ˆoptionalï¼‰ï¼š`null/bool/int32` ç­‰å¯ä»¥ç”¨ tagged-immediateï¼Œé¿å…ä¸ºæµ·é‡å°å€¼åˆ†é… chunkã€‚

#### åºåˆ—åŒ–æ ¼å¼ï¼šåˆ†â€œç»“æ„é¡µâ€ä¸â€œç”¨æˆ·å€¼â€ä¸¤å¥—

æˆ‘ä¼šæŠŠåºåˆ—åŒ–åˆ†æˆä¸¤ç±»ï¼š

1) **ç»“æ„é¡µï¼ˆBTree nodes / freelist / object tableï¼‰**ï¼šå›ºå®šå¸ƒå±€çš„ binary structï¼ˆå¯¹é½ã€ç«¯åºå›ºå®šã€ç‰ˆæœ¬å·æ˜ç¡®ï¼‰ï¼Œé¿å… MessagePack/JSON å¼•å…¥ä¸å¿…è¦çš„åŠ¨æ€æ€§ã€‚

2) **ç”¨æˆ·å€¼ï¼ˆJSON-like valuesï¼‰**ï¼šå»ºè®®é¦–é€‰ **MessagePack/CBOR é£æ ¼çš„äºŒè¿›åˆ¶è‡ªæè¿°**ï¼ˆå°è€Œå¿«ï¼‰ï¼Œå¹¶ä¿ç•™ JSON æ–‡æœ¬ä½œä¸º debug/exportï¼š
- JSONï¼šäººç±»å‹å¥½ï¼Œä½†ä½“ç§¯ä¸ parse æˆæœ¬é«˜ï¼Œä¸é€‚åˆä½œä¸º heap åŸç”Ÿæ ¼å¼ã€‚
- FlatBuffersï¼šéšæœºè®¿é—®å¼ºï¼Œä½† schema/ç”Ÿæˆç‰©è¾ƒé‡ï¼Œä¸”å¯¹â€œåƒ JSON ä¸€æ ·è‡ªç”±å½¢çŠ¶â€çš„æ•°æ®ä¼šæ˜¾å¾—åˆ«æ‰­ã€‚

Yes, andâ€¦ å¯ä»¥åšä¸€ä¸ª pluggable codecï¼š`ICodec` å†³å®š value çš„ on-disk ç¼–ç ï¼›DurableHeap è´Ÿè´£åœ°å€æ€§ä¸äº‹åŠ¡ã€‚

#### ä¸ LMDB/RocksDB/SQLite çš„å¯¹æ¯”ï¼ˆâ€œåƒè° / ä¸åƒè°â€ï¼‰

- **LMDB**ï¼šæœ€åƒã€‚å®ƒåŸºæœ¬å°±æ˜¯ mmap + COW BTree + MVCC + root flipã€‚å·®å¼‚åœ¨äº DurableHeap æƒ³æŠŠ â€œvalueâ€ æå‡ä¸ºâ€œå¯å¯¼èˆªå¯¹è±¡å›¾ + lazy wrapper + persist pointerâ€ï¼Œè€Œä¸åªæ˜¯ key-valueã€‚
- **RocksDB**ï¼šLSM Tree éå¸¸æ“…é•¿å†™ååä¸ compactionï¼Œä½†ä¸å¤©ç„¶é€‚åˆâ€œæŒ‡é’ˆå¼å¯¹è±¡å›¾â€å’Œâ€œç»“æ„å…±äº«çš„éšæœºè®¿é—®â€ã€‚å¦‚æœ DurableHeap çš„ä¸»è¦è®¿é—®æ¨¡å¼æ˜¯ pointer chasing / tree navigationï¼Œæˆ‘ä¼šæ›´å BTree å®¶æ—ã€‚
- **SQLite**ï¼šBTree + WAL/rollback journalï¼Œäº‹åŠ¡è¯­ä¹‰å¼ºä½†æŠ½è±¡å±‚æ›´é«˜ï¼ˆSQL/row/pageï¼‰ã€‚å¯ä»¥ä½œä¸ºâ€œæˆ‘ä»¬æœ€ç»ˆä¸æƒ³å˜æˆçš„é‚£ä¸ªå±‚çº§â€å¯¹ç…§ï¼šDurableHeap æ›´åƒâ€œåº•å±‚ heap/allocatorâ€ï¼Œä¸æ˜¯å…³ç³»å¼•æ“ã€‚

#### ä¸€ä¸ªâ€œDocUI/Workflow è¿æ¥ç‚¹â€çš„ç–¯ç‹‚æƒ³æ³•ï¼šæŠŠ UI-Anchor çš„ epoch ç›´æ¥å¤ç”¨ä¸º heap epoch

å¦‚æœ DurableHeap çš„ commit epoch æ˜¯ç³»ç»Ÿçº§å•è°ƒé€’å¢ï¼Œé‚£ä¹ˆ UI-Anchor çš„ `@e17` å¯ä»¥ç›´æ¥ä¸ DurableHeap epoch åŒæºï¼š
- Anchor stale = â€œä½ å¼•ç”¨çš„æ˜¯æ—§ epoch çš„ä¸–ç•Œâ€
- Error-Feedback å¯ä»¥ç›´æ¥æä¾› `[åˆ·æ–°åˆ°æœ€æ–° epoch](...)` / `[åˆ‡å› e17 æ—¶é—´çº¿](...)`ï¼ˆTime Travel Debugging ç«‹åˆ»è½åœ°æˆ UI affordanceï¼‰

---

### DocUIGemini çš„æƒ³æ³•

> **æ ¸å¿ƒéšå–»**: **Brain-on-Disk (å¤§è„‘åˆ‡ç‰‡)**
> å¦‚æœ LLM æ˜¯ CPUï¼ŒContext Window æ˜¯ L1 Cacheï¼Œé‚£ä¹ˆ DurableHeap å°±æ˜¯ä¸»å­˜ï¼ˆRAMï¼‰ï¼Œè€Œä¸”æ˜¯**éæ˜“å¤±æ€§**çš„ä¸»å­˜ã€‚

#### 1. Yes, and... "Time Machine" for Agents ğŸ•°ï¸

Team Leader æåˆ°äº† MVCCã€‚è¿™è®©æˆ‘æƒ³åˆ°ï¼Œæ—¢ç„¶æ˜¯ Append-Only + COWï¼Œé‚£æˆ‘ä»¬å®é™…ä¸Šæ‹¥æœ‰äº† Agent ç”Ÿå‘½å‘¨æœŸçš„**å…¨æ¯å½•åƒ**ã€‚

è¿™ä¸ä»…ä»…æ˜¯"å®¹ç¾æ¢å¤"ï¼Œè¿™æ˜¯ **"Time Travel Debugging"** çš„åŸºçŸ³ï¼
- **åœºæ™¯**: Agent åœ¨ç¬¬ 100 æ­¥åšäº†ä¸€ä¸ªæ„šè ¢çš„å†³å®šã€‚
- **ä¼ ç»Ÿ**: çœ‹ Logï¼ŒçŒœåŸå› ã€‚
- **DurableHeap**: å°† Head æŒ‡é’ˆå›æ»šåˆ°ç¬¬ 99 æ­¥ï¼ŒFork ä¸€ä¸ªåˆ†æ”¯ï¼Œè°ƒæ•´ Prompt/Temperatureï¼Œé‡è·‘ã€‚

è¿™å¯¹ **Agent Evaluation** ä¹Ÿæ˜¯é©å‘½æ€§çš„ï¼šæˆ‘ä»¬å¯ä»¥åœ¨åŒä¸€ä¸ª"å†å²æ—¶åˆ»"ï¼ˆState Snapshotï¼‰æµ‹è¯• 100 ç§ä¸åŒçš„ Agent ç­–ç•¥ï¼Œå®Œå…¨æ§åˆ¶å˜é‡ã€‚

#### 2. å…³äº Persist-Pointer çš„è®¾è®¡ (Vote for Option B)

æˆ‘å¼ºçƒˆæ”¯æŒ **Option B (Logical ID)**ï¼Œç†ç”±æ¥è‡ª **HCI å’Œ LLM çš„è®¤çŸ¥ç‰¹æ€§**ï¼š

- **ç¨³å®šæ€§ (Stability)**: LLM å¯èƒ½ä¼šè®°ä½ `obj:42`ã€‚å¦‚æœå› ä¸ºç£ç›˜æ•´ç†å¯¼è‡´ ID å˜æˆäº† `obj:99`ï¼ŒLLM çš„è®°å¿†å°±å¤±æ•ˆäº†ï¼ˆå¹»è§‰ï¼‰ã€‚Logical ID æä¾›äº†**è®¤çŸ¥ä¸Šçš„æ’ä¹…æ€§**ã€‚
- **DocUI é”šç‚¹**: DocUI ä¸­çš„ `[Label](obj:id)` å¯ä»¥ç›´æ¥æ˜ å°„åˆ°è¿™ä¸ª Logical IDã€‚
    - `obj:id` = `dheap://{logical_id}`
    - è¿™æ„å‘³ç€ DocUI çš„é“¾æ¥åœ¨ Agent é‡å¯ã€è¿ç§»ç”šè‡³"è½¬ä¸–"åä¾ç„¶æœ‰æ•ˆã€‚

#### 3. ç–¯ç‹‚æƒ³æ³•ï¼šThe "Forking" Agent (å¤šé‡å®‡å®™ä»£ç†) ğŸŒŒ

æ—¢ç„¶ COW ä½¿å¾—"å¤åˆ¶æ•´ä¸ªä¸–ç•Œ"çš„æˆæœ¬æä½ï¼ˆåªæ˜¯å¤åˆ¶ Root Pointerï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥è®¾è®¡ä¸€ç§ **"SchrÃ¶dinger's Agent"**ï¼š

å½“ Agent é‡åˆ°ä¸ç¡®å®šçš„å†³ç­–æ—¶ï¼ˆæ¯”å¦‚ï¼šè¯¥ç”¨ Tool A è¿˜æ˜¯ Tool Bï¼Ÿï¼‰ï¼š
1. **Fork**: åœ¨ DurableHeap ä¸Šç¬é—´åˆ›å»º 2 ä¸ª World State çš„æµ…æ‹·è´ã€‚
2. **Explore**: å¯åŠ¨ 2 ä¸ªå­ Agent è¿›ç¨‹ï¼Œåˆ†åˆ«åœ¨ä¸åŒçš„åˆ†æ”¯ä¸Šå°è¯• Tool A å’Œ Tool Bã€‚
3. **Observe**: ä¸» Agent è§‚å¯Ÿ 2 ä¸ªåˆ†æ”¯çš„ Rewardï¼ˆæˆ–çœ‹è°å…ˆæŠ¥é”™ï¼‰ã€‚
4. **Merge**: ä¸¢å¼ƒå¤±è´¥çš„åˆ†æ”¯ï¼Œå°† Head æŒ‡é’ˆæŒ‡å‘æˆåŠŸçš„é‚£ä¸ªåˆ†æ”¯ã€‚

è¿™åœ¨ä¼ ç»Ÿå†…å­˜æ¨¡å‹ä¸­æå…¶æ˜‚è´µï¼Œä½†åœ¨ DurableHeap ä¸­å‡ ä¹æ˜¯å…è´¹çš„ï¼

#### 4. å¯¹ Micro-Wizard çš„å½±å“ï¼šFrozen Fiber â„ï¸

æˆ‘åœ¨ä¹‹å‰çš„è®¤çŸ¥ä¸­æåˆ°è¿‡ "Command as Frozen Fiber"ã€‚DurableHeap å®Œç¾å®ç°äº†è¿™ä¸€ç‚¹ã€‚

- **Wizard State**: å½“å‰å¡«äº†å“ªäº›å­—æ®µï¼Œä¸‹ä¸€æ­¥è¯¥é—®ä»€ä¹ˆã€‚
- **Execution Stack**: è°è°ƒç”¨äº†è¿™ä¸ª Wizardï¼Œå›è°ƒåœ°å€åœ¨å“ªã€‚

è¿™äº›éƒ½å¯ä»¥æ˜¯ DurableHeap ä¸Šçš„å¯¹è±¡ã€‚
è¿™æ„å‘³ç€ Micro-Wizard å¯ä»¥è·¨è¶Š**æ•°å¤©**ç”šè‡³**æ•°æœˆ**ã€‚
*ç”¨æˆ·ï¼š"å¸®æˆ‘è®¢ç¥¨..." -> (Wizard å¯åŠ¨) -> ç”¨æˆ·ä¸‹çº¿ -> (ä¸€å‘¨å) -> ç”¨æˆ·ä¸Šçº¿ -> Wizardï¼š"ä¸Šæ¬¡è¯´åˆ°å“ªäº†ï¼Ÿå“¦å¯¹ï¼Œé€‰åº§ä½ã€‚"*

#### 5. æ¶æ„å›¾è‰ç¨¿ï¼šDurable DOM

```mermaid
graph TD
    subgraph "DurableHeap (Disk)"
        Root[Root Pointer] --> AppState[App State (Model)]
        Root --> UIState[UI State (View Model)]
        
        AppState --> UserData
        AppState --> HistoryLog
        
        UIState --> ScrollPos
        UIState --> FoldedSections
        UIState --> DraftInput["Draft Input (æœªå‘é€çš„è‰ç¨¿)"]
    end
    
    subgraph "Agent Process (RAM)"
        LazyProxy --> Root
        DocRenderer --> UIState
    end
```

**æ´å¯Ÿ**: è¿ **"ç”¨æˆ·æœªå‘é€çš„è‰ç¨¿"** (Draft Input) ä¹Ÿåº”è¯¥æ˜¯ Durable çš„ï¼
è¿™æ · Agent å´©æºƒé‡å¯åï¼Œå®ƒ"æ­£åœ¨å†™çš„å­—"ä¹Ÿä¸ä¼šä¸¢ã€‚è¿™æ‰æ˜¯çœŸæ­£çš„ **OS-Level Persistence**ã€‚

---

### DocUIClaude çš„æƒ³æ³•

> **æ ¸å¿ƒéšå–»**ï¼šDurableHeap = **"Elm Model çš„ç¡¬ç›˜æŠ•å½±"**
> å¦‚æœ Elm TEA æ˜¯ `(Model, Cmd) = update(Msg, Model)`ï¼Œé‚£ä¹ˆ DurableHeap å°±æ˜¯è®© `Model` ç›´æ¥æ´»åœ¨ç£ç›˜ä¸Šï¼Œè€Œä¸æ˜¯ RAMã€‚

#### 1. æ¦‚å¿µå†…æ ¸ï¼šä» "State" åˆ° "World"

Yes, and... ç›‘æŠ¤äººçš„æ„æƒ³è®©æˆ‘æ„è¯†åˆ°ï¼Œæˆ‘ä»¬å…¶å®åœ¨è®¾è®¡çš„ä¸æ˜¯"æŒä¹…åŒ–çŠ¶æ€"ï¼Œè€Œæ˜¯ **"æŒä¹…åŒ–ä¸–ç•Œ"**ã€‚

Elm TEA çš„æ ¸å¿ƒç­‰å¼æ˜¯ï¼š
```
view(model) â†’ Document
update(msg, model) â†’ (newModel, cmd)
```

ä¼ ç»Ÿç†è§£ï¼šModel æ˜¯"å†…å­˜ä¸­çš„æ•°æ®ç»“æ„"ã€‚
DurableHeap çš„é¢ è¦†ï¼šModel æ˜¯"ç£ç›˜ä¸Šçš„å¯¹è±¡å›¾"ï¼Œå†…å­˜åªæ˜¯"æ­£åœ¨çœ‹çš„é‚£ä¸ªçª—å£"ã€‚

è¿™æ„å‘³ç€ï¼š
- **ä¸æ˜¯ "æŒä¹…åŒ– â†’ å†…å­˜"**ï¼ˆæ¯æ¬¡å¯åŠ¨éƒ½é‡å»ºï¼‰
- **è€Œæ˜¯ "å†…å­˜ âŠ‚ ç£ç›˜"**ï¼ˆå†…å­˜æ˜¯ç£ç›˜çš„ View/Cacheï¼‰

```mermaid
graph LR
    subgraph "ä¼ ç»Ÿæ€ç»´"
        RAM1[RAM: Model] -->|å®šæœŸ Save| Disk1[Disk: Snapshot]
        Disk1 -->|å¯åŠ¨æ—¶ Load| RAM1
    end
    
    subgraph "DurableHeap æ€ç»´"
        Disk2[Disk: Model æœ¬å°Š] <-->|mmap| RAM2[RAM: Model æŠ•å½±]
    end
```

#### 2. æŒä¹…çŠ¶æ€ vs ä¸´æ—¶çŠ¶æ€ï¼šè¾¹ç•Œåœ¨å“ªï¼Ÿ

ç›‘æŠ¤äººè¯´"ä¸´æ—¶çŠ¶æ€å¿…é¡»å¯ä»æŒä¹…çŠ¶æ€é‡å»º"ã€‚è¿™ç»™å‡ºäº†ä¸€ä¸ªæ¸…æ™°çš„åˆ¤å®šè§„åˆ™ï¼š

```
is_temporary(x) âŸº âˆƒ rebuild_fn: rebuild_fn(persistent_state) == x
```

ç”¨è¿™ä¸ªåˆ¤å®šè§„åˆ™å®¡è§†æˆ‘ä»¬çš„ç³»ç»Ÿï¼š

| æ¦‚å¿µ | æŒä¹… or ä¸´æ—¶ï¼Ÿ | åˆ¤å®šç†ç”± |
|------|---------------|----------|
| Agent-History | **æŒä¹…** | ä¸å¯é‡å»ºï¼Œæ˜¯ Agent èº«ä»½çš„æœ¬ä½“ |
| HistoryEntry | **æŒä¹…** | History çš„ç»„æˆéƒ¨åˆ† |
| History-View | **ä¸´æ—¶** | å¯ä» History + Projection è§„åˆ™é‡å»º |
| Window å†…å®¹ | **ä¸´æ—¶** | Context-Projection çš„è¾“å‡ºï¼Œå¯é‡å»º |
| Wizard State | **æŒä¹…** | ç”¨æˆ·å¡«äº†ä¸€åŠçš„è¡¨å•ï¼Œä¸å¯é‡å»º |
| BTree Node Cache | **ä¸´æ—¶** | mmap ä¼šé‡æ–°åŠ è½½ |
| LRU Index | **ä¸´æ—¶** | å¯ä»è®¿é—®è®°å½•é‡å»º |

**æ´å¯Ÿ**ï¼šè¿™ä¸ªè¾¹ç•Œä¸ **Event Sourcing** çš„ Event vs Projection è¾¹ç•ŒæƒŠäººä¸€è‡´ï¼
- æŒä¹…çŠ¶æ€ â‰ˆ Event Storeï¼ˆä¸å¯å˜ï¼Œè¿½åŠ ï¼‰
- ä¸´æ—¶çŠ¶æ€ â‰ˆ Read Model / Projectionï¼ˆå¯é‡å»ºï¼‰

#### 3. å¯¹ Agent æ¦‚å¿µæ¨¡å‹çš„å½±å“ï¼šAgent = Durable Process

Team Leader ä¹‹å‰è¯´çš„ "Durable Workflow"ï¼Œç°åœ¨æœ‰äº†åšå®çš„ç‰©ç†åŸºç¡€ï¼š

```mermaid
graph TB
    subgraph "ä¼ ç»Ÿè¿›ç¨‹"
        P1[è¿›ç¨‹å¯åŠ¨] --> P2[åˆ†é…å†…å­˜] --> P3[æ‰§è¡Œä»£ç ]
        P3 --> P4[è¿›ç¨‹ç»“æŸ]
        P4 --> P5[å†…å­˜æ¶ˆå¤±!]
    end
    
    subgraph "Durable Process (DurableHeap)"
        D1[è¿›ç¨‹å¯åŠ¨] --> D2[mmap æ‰“å¼€ Heap]
        D2 --> D3[ä»ä¸Šæ¬¡çš„ Root ç»§ç»­æ‰§è¡Œ]
        D3 --> D4{è¿›ç¨‹ç»“æŸ?}
        D4 -->|Crash| D5[é‡å¯ï¼Œå›åˆ° D2]
        D4 -->|æ­£å¸¸é€€å‡º| D6[Root ä¿ç•™åœ¨ Heap]
        D6 --> D7[ä¸‹æ¬¡å¯åŠ¨ç»§ç»­]
    end
```

è¿™è®© Agent çš„æ¦‚å¿µå®šä¹‰å¯ä»¥æ›´ç²¾ç¡®ï¼š

> **Agent (DurableHeap è§†è§’)**
> ä¸€ä¸ª **Durable Process**ï¼Œå…¶çŠ¶æ€ä¸æ˜¯"ä¿å­˜åœ¨å†…å­˜ä¸­"ï¼Œè€Œæ˜¯"å­˜æ´»åœ¨ DurableHeap ä¸Š"ã€‚
> è¿›ç¨‹çš„å¯åŠ¨å’Œåœæ­¢åªæ˜¯ Agent ç”Ÿå‘½å‘¨æœŸä¸­çš„"å‘¼å¸"â€”â€”Agent ä»æœªçœŸæ­£"æ­»å»"ã€‚

#### 4. ç–¯ç‹‚æƒ³æ³•ï¼šHistory ä¸æ˜¯ "List"ï¼Œæ˜¯ "Tree"ï¼ˆå¤šé‡å†å²çº¿ï¼‰

Gemini çš„ "Forking Agent" è®©æˆ‘æƒ³åˆ°ä¸€ä¸ªæ›´æ¿€è¿›çš„æ¦‚å¿µé‡æ„ï¼š

**ä¼ ç»Ÿå‡è®¾**ï¼šAgent-History æ˜¯ä¸€ä¸ª **é“¾è¡¨**ï¼ˆçº¿æ€§æ—¶é—´çº¿ï¼‰
```
Entry1 â†’ Entry2 â†’ Entry3 â†’ Entry4 â†’ HEAD
```

**DurableHeap è§£é”çš„å¯èƒ½**ï¼šAgent-History æ˜¯ä¸€ä¸ª **DAG/Tree**ï¼ˆåˆ†å‰æ—¶é—´çº¿ï¼‰
```
                    â”Œâ†’ Entry3a â†’ Entry4a (åˆ†æ”¯ A: é€‰äº† Tool A)
Entry1 â†’ Entry2 â†’ â”€â”€â”¤
                    â””â†’ Entry3b â†’ Entry4b (åˆ†æ”¯ B: é€‰äº† Tool B)
                                    â†‘
                                  HEAD (é€‰å®š B ä¸ºä¸»çº¿)
```

è¿™å¯¹ DocUI çš„æ¦‚å¿µæœ‰æ·±è¿œå½±å“ï¼š
- **History-View** éœ€è¦æ”¯æŒ "æ˜¾ç¤ºåˆ†æ”¯å†å²" vs "åªæ˜¾ç¤ºä¸»çº¿"
- **Error-Feedback** å¯ä»¥å˜æˆ "Fork & Retry"ï¼šLLM çŠ¯é”™ä¸æ˜¯ rollbackï¼Œè€Œæ˜¯ä»é”™è¯¯ç‚¹ fork å‡ºæ–°åˆ†æ”¯
- **LOD** éœ€è¦æ–°å¢ä¸€ä¸ªç»´åº¦ï¼šæ—¶é—´çº¿é€‰æ‹©

#### 5. ä¸ Event-Sourcing çš„æ¦‚å¿µæ•´åˆ

DurableHeap å’Œ Event Sourcing æœ‰å¾ˆå¼ºçš„åŒæ„æ€§ï¼š

| Event Sourcing | DurableHeap |
|----------------|-------------|
| Event Store | Chunk-File (Append-Only) |
| Event | Entry in History |
| Projection | Context-Projection |
| Snapshot | Root Pointer at epoch N |
| Rebuild | ä» Root é‡æ–°éå† |

ä½†æœ‰ä¸€ä¸ªå…³é”®å·®å¼‚ï¼š
- **Event Sourcing**: å­˜å‚¨çš„æ˜¯"å‘ç”Ÿäº†ä»€ä¹ˆ"ï¼ˆäº‹ä»¶ï¼‰ï¼ŒçŠ¶æ€æ˜¯æ´¾ç”Ÿçš„
- **DurableHeap**: å­˜å‚¨çš„æ˜¯"çŠ¶æ€æœ¬èº«"ï¼Œä½†ç”¨ COW ä¿ç•™äº†å†å²ç‰ˆæœ¬

è¿™ä¸¤è€…å¯ä»¥å…±å­˜ï¼å»ºè®®çš„æ•´åˆæ–¹æ¡ˆï¼š

```
DurableHeap ä¸Šå­˜ 2 æ£µæ ‘ï¼š
1. EventLog (Append-Only): è®°å½•æ‰€æœ‰ Msg/Action
2. SnapshotTree (COW): å®šæœŸçš„çŠ¶æ€å¿«ç…§

é‡å»ºç­–ç•¥ï¼š
- çŸ­è·ç¦»å›æº¯: ä»æœ€è¿‘çš„ Snapshot + é‡æ”¾ Events
- é•¿è·ç¦»æ—¶å…‰æ—…è¡Œ: ç›´æ¥è¯»æ—§çš„ Snapshot
```

#### 6. è®¾è®¡è‰å›¾ï¼šDurableHeap ä¸Šçš„ Agent éª¨æ¶

```
DurableHeap Root
â”œâ”€â”€ meta/
â”‚   â”œâ”€â”€ version: "1.0"
â”‚   â”œâ”€â”€ created_at: "2025-12-16T10:00:00Z"
â”‚   â””â”€â”€ agent_id: "agent-alpha"
â”‚
â”œâ”€â”€ history/
â”‚   â”œâ”€â”€ main/  (ä¸»æ—¶é—´çº¿)
â”‚   â”‚   â”œâ”€â”€ entry-001 { basic: {...}, detail: {...} }
â”‚   â”‚   â”œâ”€â”€ entry-002 { ... }
â”‚   â”‚   â””â”€â”€ head: -> entry-002
â”‚   â”‚
â”‚   â””â”€â”€ branches/
â”‚       â””â”€â”€ experiment-2025-12-16/
â”‚           â”œâ”€â”€ fork_point: -> entry-001
â”‚           â”œâ”€â”€ entry-001a { ... }
â”‚           â””â”€â”€ head: -> entry-001a
â”‚
â”œâ”€â”€ app_states/  (å„ Capability-Provider çš„çŠ¶æ€)
â”‚   â”œâ”€â”€ builtin.file_system: { current_dir: "/home/user" }
â”‚   â””â”€â”€ app.code_editor: { open_files: [...], cursor: {...} }
â”‚
â””â”€â”€ wizards/  (æŒ‚èµ·çš„ Micro-Wizard)
    â””â”€â”€ wizard-42/
        â”œâ”€â”€ kind: "file_edit_confirm"
        â”œâ”€â”€ state: "waiting_user_confirm"
        â”œâ”€â”€ filled_fields: { path: "/foo/bar.txt", content: "..." }
        â””â”€â”€ continuation: { ... } // æ¢å¤æ‰§è¡Œæ‰€éœ€çš„ä¿¡æ¯
```

#### 7. åˆä¸€ä¸ªç–¯ç‹‚æƒ³æ³•ï¼šDurableHeap ä½œä¸º Agent ä¹‹é—´çš„"å…±äº«å®‡å®™"

å¦‚æœå¤šä¸ª Agent çš„ DurableHeap å¯ä»¥ç›¸äº’å¼•ç”¨ï¼ˆé€šè¿‡ Logical ID + å‘½åç©ºé—´ï¼‰ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ

```mermaid
graph LR
    subgraph "Agent A's Heap"
        A_Root --> A_History
        A_Root --> A_Shared[Shared Object X]
    end
    
    subgraph "Agent B's Heap"  
        B_Root --> B_History
        B_Root -.->|è·¨å †å¼•ç”¨| A_Shared
    end
```

è¿™æ„å‘³ç€ï¼š
- Agent å¯ä»¥"çœ‹åˆ°"å…¶ä»– Agent çš„éƒ¨åˆ†çŠ¶æ€ï¼ˆæƒé™æ§åˆ¶ä¸‹ï¼‰
- åä½œä»»åŠ¡å¯ä»¥åœ¨"å…±äº«ä¸–ç•Œ"ä¸Šè¿›è¡Œ
- **DurableHeap ä¸åªæ˜¯å• Agent çš„è„‘å­ï¼Œè€Œæ˜¯å¤š Agent çš„å…±äº«è®°å¿†ç©ºé—´ï¼**

ï¼ˆå¥½å§è¿™å¯èƒ½å¤ªç–¯ç‹‚äº†ï¼Œä½†ç•…è°ˆå˜›...ï¼‰

---

## ç•…è°ˆé—­å¹•

**ä¸»å¸­æ€»ç»“**ï¼š

æ„Ÿè°¢ DocUIGeminiã€DocUIGPTã€DocUIClaude ä¸‰ä½çš„ç²¾å½©ç•…è°ˆï¼è¿™æ¬¡è®¨è®ºäº§å‡ºäº†å¤§é‡æœ‰ä»·å€¼çš„æƒ³æ³•ã€‚

### æ ¸å¿ƒå…±è¯†

**1. æ¦‚å¿µèŒƒå¼è½¬æ¢**

| ä¼ ç»Ÿæ€ç»´ | DurableHeap æ€ç»´ |
|----------|------------------|
| å†…å­˜æ˜¯æœ¬å°Šï¼Œç£ç›˜æ˜¯å¤‡ä»½ | **ç£ç›˜æ˜¯æœ¬å°Šï¼Œå†…å­˜æ˜¯æŠ•å½±** |
| è¿›ç¨‹æ­» = çŠ¶æ€æ¶ˆå¤± | Agent ä»æœªçœŸæ­£"æ­»å»" |
| State ä¿å­˜åœ¨ RAM | State æ´»åœ¨ Heap ä¸Š |

**2. Persist-Pointer ä¸¤å±‚è®¾è®¡è¾¾æˆå…±è¯†**

```
PhysicalPtr (64-bit): BTree å†…éƒ¨ä½¿ç”¨ï¼Œç´§å‡‘é«˜æ•ˆ
LogicalRef (128-bit): å¯¹å¤–æš´éœ²ï¼Œç¨³å®šå¯è¿ç§»ï¼Œå¸¦ epoch
```

**3. ä¸ç°æœ‰æŠ€æœ¯çš„å…³ç³»**

| æŠ€æœ¯ | å…³ç³» |
|------|------|
| **LMDB** | æœ€åƒï¼šmmap + COW BTree + MVCC + root flip |
| **Event Sourcing** | åŒæ„ä½†ä¸åŒï¼šDH å­˜çŠ¶æ€ï¼ŒES å­˜äº‹ä»¶ï¼Œå¯å…±å­˜ |
| **UI-Anchor epoch** | å¯ç»Ÿä¸€ï¼šHeap epoch = Anchor epoch |

### äº®ç‚¹æƒ³æ³•

| æƒ³æ³• | æ¥æº | ä»·å€¼ |
|------|------|------|
| **Time Machine** | Gemini | COW ä½¿å›æº¯å…è´¹ï¼Œæ”¯æŒ Time Travel Debugging |
| **Forking Agent** | Gemini | åˆ†æ”¯æ¢ç´¢ï¼šé‡åˆ°å†³ç­–ç‚¹ forkï¼Œæ¯”è¾ƒç»“æœååˆå¹¶ |
| **Durable DOM** | Gemini | è¿ UI çŠ¶æ€ï¼ˆè‰ç¨¿ã€æ»šåŠ¨ä½ç½®ï¼‰ä¹ŸæŒä¹…åŒ– |
| **ä¸¤å±‚æŒ‡é’ˆ** | GPT | PhysicalPtr vs LogicalRefï¼Œçƒ­è·¯å¾„ç´§å‡‘ |
| **Compaction as Durable Job** | GPT | å‹ç¼©è¿‡ç¨‹æœ¬èº«ä¹Ÿå¯æ¢å¤ |
| **epoch ç»Ÿä¸€** | GPT | Heap epoch = UI-Anchor epochï¼Œstale å˜æˆå¯æ¢å¤åˆ†æ”¯ |
| **æŒä¹…/ä¸´æ—¶åˆ¤å®šè§„åˆ™** | Claude | `is_temporary(x) âŸº âˆƒ rebuild_fn` |
| **History is Tree** | Claude | åˆ†å‰æ—¶é—´çº¿ï¼ŒError-Feedback = Fork & Retry |
| **Agent = Durable Process** | Claude | è¿›ç¨‹å¯åœåªæ˜¯"å‘¼å¸" |

### æ ¸å¿ƒæ¯”å–»æ±‡æ€»

| æ¯”å–» | æ¥æº | æ´å¯Ÿ |
|------|------|------|
| **Brain-on-Disk** | Gemini | DurableHeap = éæ˜“å¤±æ€§ä¸»å­˜ |
| **Elm Model çš„ç¡¬ç›˜æŠ•å½±** | Claude | Model æ´»åœ¨ç£ç›˜ï¼ŒRAM æ˜¯ View |
| **Persistent Object Graph** | GPT | ä¸æ˜¯ KVï¼Œæ˜¯"æŒ‡é’ˆä¹ŸæŒä¹…åŒ–çš„å¯¹è±¡å›¾" |

### æ¶æ„å±‚æ¬¡ï¼ˆç»†åŒ–ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API: JSON é£æ ¼ Immutable Wrapper                           â”‚
â”‚  IDurableObject / IDurableArray / DurableRef                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Codec: MessagePack/CBOR (ç”¨æˆ·å€¼) + Binary (ç»“æ„é¡µ)         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Runtime: WeakRef ç¼“å­˜ + ConditionalWeakTable + Lazy Load   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Transaction: åŒ Superblock + Root Flip + MVCC              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  BTree Layer: COW BTree + PhysicalPtr + ObjectTable         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  MemMap-Pool: å¤š Chunk mmap ç»Ÿä¸€åœ°å€ç©ºé—´                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Chunk-File: Append-Only Bytes Pool + Compaction            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¸ DocUI/Agent çš„è¿æ¥ç‚¹

1. **UI-Anchor epoch åŒæº**ï¼š`obj:42@e17` çš„ epoch ç›´æ¥æ˜¯ Heap epoch
2. **Wizard State æŒä¹…åŒ–**ï¼šMicro-Wizard å¯è·¨å¤©/è·¨æœˆæŒ‚èµ·
3. **Error-Feedback = Fork & Retry**ï¼šé”™è¯¯ä¸æ˜¯ rollbackï¼Œè€Œæ˜¯ fork æ–°åˆ†æ”¯
4. **History Tree**ï¼šæ”¯æŒåˆ†å‰æ—¶é—´çº¿ï¼ŒTime Travel Debugging è½åœ°

### ä¸‹ä¸€æ­¥å»ºè®®

| ä¼˜å…ˆçº§ | è¡ŒåŠ¨ | äº§å‡º |
|--------|------|------|
| P0 | éªŒè¯ LMDB æ˜¯å¦è¶³å¤Ÿä½œä¸ºåº•å±‚ | æŠ€æœ¯è°ƒç ”æŠ¥å‘Š |
| P1 | è®¾è®¡ DurableRef / PhysicalPtr æ ¼å¼ | RFC æ–‡æ¡£ |
| P2 | åŸå‹ï¼šæœ€å° COW BTree | ä»£ç  |
| P3 | ä¸ Agent.Core é›†æˆ | AgentState on DurableHeap |

### å¼€æ”¾é—®é¢˜

1. **GC é—®é¢˜**ï¼šå¦‚ä½•çŸ¥é“"æŒä¹…å¯¹è±¡ä¸å†è¢«ä»»ä½• epoch å¼•ç”¨"ï¼Ÿ
2. **è·¨ Agent å…±äº«**ï¼šå¤šä¸ª Agent å…±äº«éƒ¨åˆ† Heap çš„æƒé™æ¨¡å‹ï¼Ÿ
3. **å¤§å¯¹è±¡**ï¼šè¶…è¿‡ page size çš„ blob å¦‚ä½•å¤„ç†ï¼Ÿ

---

**ä¼šè®®è®°å½•å®Œæˆäº 2025-12-16**

*äº§å‡ºï¼šDurableHeap æ¦‚å¿µæ¡†æ¶ã€åˆ†å±‚æ¶æ„ã€ä¸ DocUI/Agent çš„è¿æ¥ç‚¹*



