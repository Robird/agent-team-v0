# ç§˜å¯†åŸºåœ°ç•…è°ˆä¼šï¼šDurableHeap MVP v2 æœ¯è¯­ä¸å‘½åå®¡é˜…

> **æ—¥æœŸ**ï¼š2025-12-19
> **ä¸»é¢˜**ï¼šå®¡é˜… `DurableHeap/docs/mvp-design-v2.md` æœ¯è¯­ä¸å‘½åçš„ä¸€è‡´åŒ–/æ¸…æ™°åŒ–
> **ä¸»æŒ**ï¼šåˆ˜å¾·æ™º / SageWeaverï¼ˆDocUI è§„èŒƒèµ·è‰å§”å‘˜ä¼šæ‰§è¡Œå§”å‘˜ä¼šä¸»å¸­ï¼‰
> **å‚ä¸è€…**ï¼šDocUIClaudeã€DocUIGeminiã€DocUIGPT

---

## ä¼šè®®ç›®æ ‡

æœ¬æ¬¡ç•…è°ˆä¼šçš„ç›®æ ‡æ˜¯ï¼š
1. å®¡é˜… DurableHeap MVP v2 è®¾è®¡è‰ç¨¿çš„æœ¯è¯­å’Œå‘½å
2. è¯†åˆ«ä¸ä¸€è‡´ã€æ¨¡ç³Šæˆ–å¯èƒ½å¼•èµ·æ··æ·†çš„æœ¯è¯­
3. å½¢æˆä¸€ç»„å¯ç”¨äºæŒ‡å¯¼ä¸‹ä¸€é˜¶æ®µä»£ç ç¼–å†™çš„è§„èŒƒåŒ–æœ¯è¯­å’Œåè¯

---

## å¾…å®¡é˜…æ–‡æ¡£æ‘˜è¦

æ–‡æ¡£ä½ç½®ï¼š`DurableHeap/docs/mvp-design-v2.md`

### æ ¸å¿ƒæ¦‚å¿µ

1. **ä¸‰ä¸ªæ ¸å¿ƒæ ‡è¯†**ï¼šObjectIdã€ObjectVersionPtr (Ptr64)ã€EpochSeq
2. **å››ä¸ªè¯»å–é˜¶æ®µ**ï¼šDeserialize â†’ Materialize â†’ Resolve â†’ ChangeSet
3. **åŒæ–‡ä»¶å¸ƒå±€**ï¼šdata file + meta file
4. **å…³é”®æ•°æ®ç»“æ„**ï¼šEpochMapã€ObjectVersionRecordã€MetaCommitRecordã€DurableDict

### æ–‡æ¡£ä¸­çš„ä¸»è¦æœ¯è¯­

- ObjectId / ObjectVersionPtr / Ptr64
- EpochSeq / EpochRecord / EpochMap
- Deserialize / Materialize / Resolve
- Working State / Committed State (Baseline) / ChangeSet
- On-Disk Diff / state diff / DiffPayload
- HEAD / workspace / identity map
- snapshot / overlay / base
- data file / meta file / record framing / RBF framing
- tombstone / Val_Tombstone
- ObjectKind / RecordKind / MetaKind

---

## ç¬¬ä¸€è½®å‘è¨€

### DocUIClaude å‘è¨€

> **è§†è§’**ï¼šæ¦‚å¿µæ¡†æ¶ã€æœ¯è¯­ä¸€è‡´æ€§ã€æ¦‚å¿µå®Œå¤‡æ€§ã€é€»è¾‘è‡ªæ´½

---

#### ğŸ”´ P0ï¼šä¸¥é‡çš„æœ¯è¯­ä¸ä¸€è‡´é—®é¢˜

##### é—®é¢˜ 1ï¼š`Committed State` vs `Baseline` â€” åŒä¸€æ¦‚å¿µåŒå

**ç°è±¡**ï¼šæ–‡æ¡£ä¸­äº¤æ›¿ä½¿ç”¨ `Committed State` å’Œ `Baseline` æŒ‡ä»£åŒä¸€æ¦‚å¿µï¼Œä¸”æ‹¬å·æ³¨é‡Šæ–¹å¼ä¸ç»Ÿä¸€ï¼š

- 4.1.0: "Committed Stateï¼ˆBaselineï¼‰"
- 4.4.1: "Committed Stateï¼ˆBaselineï¼‰ï¼ˆmaterialize çš„ç»“æœï¼‰"
- 4.4.3: "CommittedState == CurrentState"ï¼ˆæ—  Baselineï¼‰
- 4.4.4: "// ä¸Šæ¬¡ commit æ—¶çš„çŠ¶æ€"ï¼ˆä¸¤ç§åç§°éƒ½æ²¡ç”¨ï¼‰

**åˆ†æ**ï¼š
- `Committed State` å¼ºè°ƒ"å·²æäº¤"çš„æ—¶é—´è¯­ä¹‰
- `Baseline` å¼ºè°ƒ"ä½œä¸ºåŸºçº¿"çš„ç”¨é€”è¯­ä¹‰
- ä¸¤è€…æŒ‡å‘åŒä¸€å†…å­˜æ•°æ®ç»“æ„ï¼ˆ`_committed`ï¼‰ï¼Œä½†å„æœ‰ä¾§é‡

**å»ºè®®**ï¼š
é€‰æ‹© **ä¸€ä¸ªä¸»åç§° + å¿…è¦æ—¶çš„åŒä¹‰æ‹¬æ³¨**ï¼Œè´¯ç©¿å…¨æ–‡ï¼š
- æ¨èï¼š**`Committed State`** ä½œä¸ºä¸»åç§°ï¼ˆä¸ `Working State` å¯¹ç§°ï¼‰
- é¦–æ¬¡å‡ºç°æ—¶å¯æ³¨é‡Šï¼š`Committed Stateï¼ˆä¹Ÿç§° Baselineï¼‰`
- åç»­ç»Ÿä¸€ä½¿ç”¨ `Committed State`ï¼Œä¸å†äº¤æ›¿

---

##### é—®é¢˜ 2ï¼š`Working State` vs `Current State` vs `_current` â€” ä¸‰åä¸€ç‰©

**ç°è±¡**ï¼š
- 4.4.1 å®šä¹‰å—ï¼š`Working Stateï¼ˆå·¥ä½œçŠ¶æ€ / Current Stateï¼‰`
- ä»£ç ï¼šå˜é‡å `_current`
- è¡Œæ–‡ä¸­ä¸‰è€…æ··ç”¨

**åˆ†æ**ï¼š
- `Working State` å¼ºè°ƒ"æ­£åœ¨ç¼–è¾‘ä¸­"çš„è¯­ä¹‰
- `Current State` å¼ºè°ƒ"å½“å‰çš„"æ—¶é—´ç‚¹
- `_current` æ˜¯å®ç°å±‚çš„å˜é‡å

**å»ºè®®**ï¼š
- **æ¦‚å¿µå**ï¼šç»Ÿä¸€ä½¿ç”¨ `Working State`ï¼ˆä¸ Git working tree ç±»æ¯”å¯¹é½ï¼‰
- **å˜é‡å**ï¼š`_current` å¯ä¿ç•™ï¼ˆå®ç°å±‚ï¼‰
- åˆ é™¤ `Current State` ä½œä¸ºæ¦‚å¿µåçš„ä½¿ç”¨ï¼ˆåªåœ¨é¦–æ¬¡å‡ºç°çš„æ‹¬æ³¨ä¸­å‡ºç°ä¸€æ¬¡ï¼‰

---

##### é—®é¢˜ 3ï¼š`On-Disk Diff` vs `DiffPayload` vs `state diff` â€” å±‚æ¬¡æ··æ·†

**ç°è±¡**ï¼š
- `On-Disk Diff`ï¼š4.4.1 å®šä¹‰ä¸º"åºåˆ—åŒ–å·®åˆ†"
- `DiffPayload`ï¼š4.2.5 ä½œä¸º `ObjectVersionRecord` çš„å­—æ®µå
- `state diff`ï¼šå¤šå¤„ä½¿ç”¨ï¼Œæœ‰æ—¶æŒ‡å†…å­˜ä¸­çš„å·®åˆ†ï¼Œæœ‰æ—¶æŒ‡ç£ç›˜ä¸Šçš„

**åˆ†æ**ï¼š
è¿™ä¸‰è€…çš„å…³ç³»æ˜¯ï¼š
```
ComputeDiff() äº§ç”Ÿå†…å­˜ç»“æ„ â†’ åºåˆ—åŒ–ä¸º DiffPayload bytes â†’ è½ç›˜åç§°ä¸º On-Disk Diff
```

ä½†æ–‡æ¡£æ²¡æœ‰æ˜ç¡®è¿™ä¸ªå±‚æ¬¡å…³ç³»ï¼Œå¯¼è‡´ï¼š
- "Dict çš„ state diffï¼ˆQ11ï¼‰" ä¸­ `state diff` æŒ‡ä»£ä¸æ˜
- æ ‡é¢˜ "4.4.2 Dict çš„ state diff" å®é™…ä¸»è¦è®²çš„æ˜¯ `DiffPayload` çš„äºŒè¿›åˆ¶å¸ƒå±€

**å»ºè®®**ï¼š
1. æ˜ç¡®å®šä¹‰ä¸‰å±‚ï¼š
   - **Diffï¼ˆé€»è¾‘å·®åˆ†ï¼‰**ï¼šå†…å­˜ä¸­çš„ `List<DiffEntry>`ï¼Œç”± `ComputeDiff()` äº§ç”Ÿ
   - **DiffPayload**ï¼šDiff çš„äºŒè¿›åˆ¶ç¼–ç ï¼ˆObjectVersionRecord çš„ä¸€éƒ¨åˆ†ï¼‰
   - å–æ¶ˆ `On-Disk Diff` ä½œä¸ºå•ç‹¬æœ¯è¯­ï¼ˆå®ƒå°±æ˜¯"å·²è½ç›˜çš„ DiffPayload"ï¼‰
2. 4.4.2 æ ‡é¢˜æ”¹ä¸º "DurableDict DiffPayload ç¼–ç è§„èŒƒ"

---

#### ğŸŸ  P1ï¼šæ¦‚å¿µè¾¹ç•Œæ¨¡ç³Šé—®é¢˜

##### é—®é¢˜ 4ï¼š`Resolve` çš„èŒè´£è¾¹ç•Œä¸æ¸…

**ç°è±¡**ï¼š
- 4.1.0 å®šä¹‰ Resolve ä¸º"è§£æå¼•ç”¨ / Lazy åˆ›å»ºå¯¹è±¡"
- 4.1.2 è¯¦ç»†æè¿°äº† Resolve çš„å®Œæ•´æµç¨‹ï¼šæŸ¥ identity map â†’ æ‰¾ ObjectVersionPtr â†’ Deserialize â†’ Materialize â†’ åˆ›å»ºå¯¹è±¡
- 4.3.2 åˆé‡å¤æè¿°äº† Resolve æµç¨‹

**åˆ†æ**ï¼š
`Resolve` æ‰¿æ‹…äº†å¤ªå¤šèŒè´£ï¼š
1. å¼•ç”¨è§£æï¼ˆObjectId â†’ ObjectVersionPtrï¼‰
2. èº«ä»½å»é‡ï¼ˆidentity map æŸ¥æ‰¾/æ’å…¥ï¼‰
3. æŒ‰éœ€è§¦å‘ Deserialize + Materialize
4. å¯¹è±¡å®ä¾‹åˆ›å»º

è¿™ä½¿å¾— `Resolve` æ—¢æ˜¯ä¸€ä¸ª"åŠ¨ä½œ"ä¹Ÿæ˜¯ä¸€ä¸ª"æµç¨‹"ï¼Œæ¦‚å¿µè¾¹ç•Œæ¨¡ç³Šã€‚

**å»ºè®®**ï¼š
- `Resolve` å®šä¹‰ä¸º **é«˜å±‚ API**ï¼š"ä» ObjectId è·å–å¯ç”¨çš„å†…å­˜å¯¹è±¡å®ä¾‹"
- å†…éƒ¨æ­¥éª¤ç”¨å°å†™åŠ¨è¯çŸ­è¯­æè¿°ï¼Œä¸ä½œä¸ºç‹¬ç«‹æ¦‚å¿µï¼š
  - "æŸ¥æ‰¾èº«ä»½æ˜ å°„"
  - "è§£æç‰ˆæœ¬æŒ‡é’ˆ"
  - "ååºåˆ—åŒ–å¹¶åˆæˆçŠ¶æ€"
  - "åˆ›å»ºå¯¹è±¡å®ä¾‹"

---

##### é—®é¢˜ 5ï¼š`EpochRecord` æ¦‚å¿µçš„ç‰©ç†/é€»è¾‘åŒé‡æ€§

**ç°è±¡**ï¼š
- 4.2.3 è¯´"EpochRecord åœ¨ç‰©ç†ä¸Šç­‰ä»·äº MetaCommitRecord"
- ä½†åŒæ—¶åˆè¯´"ä¿ç•™ EpochRecord çš„é€»è¾‘æ¦‚å¿µ"
- å…¨æ–‡å…¶ä»–åœ°æ–¹æ··ç”¨ä¸¤è€…

**åˆ†æ**ï¼š
è¿™ç§"é€»è¾‘æ¦‚å¿µ vs ç‰©ç†å®ç°"çš„å¯¹åº”å…³ç³»éœ€è¦æ›´æ˜ç¡®ï¼š
- `EpochRecord`ï¼šé€»è¾‘æ¦‚å¿µï¼Œæè¿°ä¸€ä¸ª epoch åº”åŒ…å«çš„ä¿¡æ¯
- `MetaCommitRecord`ï¼šç‰©ç†å®ç°ï¼Œåœ¨ meta file æ–¹æ¡ˆä¸‹æ‰¿è½½ EpochRecord

**å»ºè®®**ï¼š
è¦ä¹ˆ**ç»Ÿä¸€ä½¿ç”¨ä¸€ä¸ªåç§°**ï¼ˆæ¨è `MetaCommitRecord`ï¼Œå› ä¸º MVP åªæœ‰ meta file æ–¹æ¡ˆï¼‰ï¼Œè¦ä¹ˆ**åœ¨æœ¯è¯­è¡¨ä¸­æ˜ç¡®æ˜ å°„å…³ç³»**ï¼š
```
EpochRecordï¼ˆé€»è¾‘ï¼‰ â”€â”€å®ç°ä¸ºâ”€â”€â†’ MetaCommitRecordï¼ˆmeta file æ–¹æ¡ˆï¼‰
                  â”€â”€å¤‡é€‰å®ç°â”€â”€â†’ Superblockï¼ˆå•æ–‡ä»¶æ–¹æ¡ˆï¼Œé MVPï¼‰
```

---

#### ğŸŸ¡ P2ï¼šå‘½åæ¸…æ™°åº¦é—®é¢˜

##### é—®é¢˜ 6ï¼š`ObjectVersionPtr` vs `Ptr64` â€” ä¸€ç‰©ä¸¤å

**ç°è±¡**ï¼š
- `ObjectVersionPtr` æ˜¯è¯­ä¹‰åï¼ˆå¯¹è±¡ç‰ˆæœ¬çš„æŒ‡é’ˆï¼‰
- `Ptr64` æ˜¯ç±»å‹åï¼ˆ64 ä½æŒ‡é’ˆçš„ç¼–ç æ ¼å¼ï¼‰
- ä¸¤è€…åœ¨æ–‡æ¡£ä¸­æ··ç”¨ï¼Œæœ‰æ—¶è¿˜ç”¨"ç‰ˆæœ¬æŒ‡é’ˆ"

**åˆ†æ**ï¼š
- `Ptr64` å®é™…æ˜¯ä¸€ç§ **ç¼–ç ç±»å‹**ï¼š`u64 LE, 0=null, 4B å¯¹é½`
- `ObjectVersionPtr` æ˜¯ `Ptr64` ç±»å‹çš„ä¸€ä¸ª **è¯­ä¹‰ç”¨é€”**
- ç±»ä¼¼åœ°ï¼Œ`EpochMapVersionPtr`ã€`DataTail` ä¹Ÿæ˜¯ `Ptr64` ç±»å‹

**å»ºè®®**ï¼š
1. æ˜ç¡®å±‚æ¬¡ï¼š
   - `Ptr64`ï¼š**ç¼–ç ç±»å‹**ï¼Œåªæè¿°æ ¼å¼ï¼ˆu64 LE, 0=null, 4B å¯¹é½ï¼‰
   - `XxxPtr`ï¼š**è¯­ä¹‰å­—æ®µå**ï¼Œè¯´æ˜è¯¥ Ptr64 æŒ‡å‘ä»€ä¹ˆ
2. è¡Œæ–‡è§„èŒƒï¼š
   - "ObjectVersionPtrï¼ˆPtr64ï¼‰"ï¼šé¦–æ¬¡å‡ºç°æ—¶æ ‡æ³¨ç±»å‹
   - åç»­åªç”¨è¯­ä¹‰å `ObjectVersionPtr`

---

##### é—®é¢˜ 7ï¼š`snapshot` æœ¯è¯­çš„æ­§ä¹‰

**ç°è±¡**ï¼š
- 4.2.4 ä¸­ `snapshot` æŒ‡"å†™å…¥ `PrevVersionPtr=0` çš„å…¨é‡ state ç‰ˆæœ¬"
- è¿™ä¸æ—¥å¸¸ç”¨è¯­ä¸­çš„ "snapshot"ï¼ˆå¿«ç…§ï¼Œä»»æ„æ—¶é—´ç‚¹çš„çŠ¶æ€å‰¯æœ¬ï¼‰æœ‰å†²çª
- ä¹Ÿä¸ 4.1.2 ä¸­ "æ‰“å¼€æ—§ epoch å¿«ç…§" çš„ "å¿«ç…§" å«ä¹‰ä¸åŒ

**åˆ†æ**ï¼š
å½“å‰ `snapshot` å®é™…æŒ‡ä¸€ç§ **ç‰ˆæœ¬é“¾ç»ˆæ­¢æ ‡è®°**â€”â€”å®ƒåˆ‡æ–­äº† `PrevVersionPtr` é“¾ã€‚

**å»ºè®®**ï¼š
è€ƒè™‘æ›´ç²¾ç¡®çš„åç§°ï¼š
- **`FullState Version`**ï¼ˆå…¨é‡çŠ¶æ€ç‰ˆæœ¬ï¼‰
- **`Base Version`**ï¼ˆåŸºå‡†ç‰ˆæœ¬ï¼‰
- æˆ–ä¿ç•™ `snapshot` ä½†åœ¨æœ¯è¯­è¡¨ä¸­æ˜ç¡®å®šä¹‰ï¼Œé¿å…ä¸"æ‰“å¼€æ—§ epoch å¿«ç…§"çš„å¿«ç…§æ··æ·†

---

##### é—®é¢˜ 8ï¼š`HEAD` çš„å¤§å°å†™ä¸ Git éšå–»ä¸€è‡´æ€§

**ç°è±¡**ï¼š
- æ–‡æ¡£ä¸­æ··ç”¨ `HEAD`ï¼ˆå…¨å¤§å†™ï¼‰å’Œ `head`ï¼ˆå°å†™ï¼‰
- Git ä¸­ `HEAD` æ˜¯ç‰¹å®šæ¦‚å¿µï¼ˆæŒ‡å‘å½“å‰åˆ†æ”¯çš„æŒ‡é’ˆï¼‰

**åˆ†æ**ï¼š
- å¦‚æœé‡‡ç”¨ Git éšå–»ï¼Œåº”ç»Ÿä¸€ä½¿ç”¨ `HEAD`ï¼ˆå¤§å†™ï¼‰
- å¦‚æœåªæ˜¯æ™®é€šè‹±æ–‡å•è¯ï¼Œåº”ä½¿ç”¨ `head`ï¼ˆå°å†™ï¼‰

**å»ºè®®**ï¼š
- æ˜ç¡®é‡‡ç”¨ Git éšå–»ï¼Œç»Ÿä¸€ä½¿ç”¨ `HEAD`
- åœ¨æœ¯è¯­è¡¨ä¸­å®šä¹‰ï¼š`HEAD`ï¼šç”± meta æ–‡ä»¶æœ€åä¸€æ¡æœ‰æ•ˆ MetaCommitRecord ç¡®å®šçš„å½“å‰ epoch

---

#### ğŸŸ¢ P3ï¼šæ¦‚å¿µå®Œå¤‡æ€§é—®é¢˜

##### é—®é¢˜ 9ï¼š`identity map` ç¼ºå°‘æ­£å¼å®šä¹‰

**ç°è±¡**ï¼š
- 4.1.2 å’Œ 4.3.2 å¤šæ¬¡æåˆ° `identity map`
- ä½†æ²¡æœ‰åƒå…¶ä»–æ ¸å¿ƒæ¦‚å¿µä¸€æ ·ç»™å‡ºæ­£å¼å®šä¹‰å—

**å»ºè®®**ï¼š
åœ¨ 4.1.0 æˆ– 4.1.2 å¢åŠ å®šä¹‰ï¼š

> **Identity Map**ï¼šè¿›ç¨‹å†…çš„ `ObjectId â†’ WeakReference<DurableObject>` æ˜ å°„ï¼Œç”¨äºä¿è¯åŒä¸€ ObjectId åœ¨å­˜æ´»æœŸé—´åªå¯¹åº”ä¸€ä¸ªå†…å­˜å¯¹è±¡å®ä¾‹ã€‚

---

##### é—®é¢˜ 10ï¼š`_dirtySet` çš„èŒè´£æœªåœ¨æ¦‚å¿µå±‚å®šä¹‰

**ç°è±¡**ï¼š
- 4.3.2 æåˆ° `_dirtySet`ï¼ˆå¼ºå¼•ç”¨é›†åˆï¼‰
- 4.4.5 çš„ Commit æ­¥éª¤ä¾èµ–å®ƒ
- ä½†æ²¡æœ‰åœ¨æ¦‚å¿µå±‚è§£é‡Šå®ƒä¸ ChangeSet çš„å…³ç³»

**åˆ†æ**ï¼š
- `ChangeSet` æ˜¯æ¯ä¸ªå¯¹è±¡å†…éƒ¨çš„å†™å…¥è·Ÿè¸ª
- `_dirtySet` æ˜¯ workspace çº§åˆ«çš„"å“ªäº›å¯¹è±¡æœ‰æœªæäº¤ä¿®æ”¹"çš„è¿½è¸ª

**å»ºè®®**ï¼š
åœ¨ 4.1 æ¦‚å¿µæ¨¡å‹ä¸­å¢åŠ å®šä¹‰ï¼š

> **Dirty Set**ï¼šWorkspace çº§åˆ«çš„ `Set<ObjectId>`ï¼ˆå¼ºå¼•ç”¨ï¼‰ï¼Œè®°å½•æ‰€æœ‰å…·æœ‰æœªæäº¤ä¿®æ”¹çš„å¯¹è±¡ã€‚Commit æ—¶éå†æ­¤é›†åˆå†™å…¥æ–°ç‰ˆæœ¬ã€‚

---

#### æœ¯è¯­ä¸€è‡´åŒ–å»ºè®®æ±‡æ€»

| å¼ƒç”¨/ç»Ÿä¸€å‰ | ç»Ÿä¸€å | ç†ç”± |
|------------|--------|------|
| Committed State / Baseline | **Committed State** | ä¸ Working State å¯¹ç§° |
| Current State / Working State | **Working State** | ä¸ Git working tree å¯¹é½ |
| On-Disk Diff | å–æ¶ˆ | ç”¨ "DiffPayloadï¼ˆå·²è½ç›˜ï¼‰" æ›¿ä»£ |
| state diffï¼ˆæ³›æŒ‡ï¼‰ | **Diff** æˆ– **DiffPayload** | æ ¹æ®ä¸Šä¸‹æ–‡é€‰æ‹©å…·ä½“å±‚ |
| EpochRecordï¼ˆåœ¨ MVP è¯­å¢ƒï¼‰ | **MetaCommitRecord** | MVP åªæœ‰ meta file æ–¹æ¡ˆ |
| snapshotï¼ˆç‰ˆæœ¬é“¾è¯­å¢ƒï¼‰ | ä¿ç•™ä½†æ˜ç¡®å®šä¹‰ | ä¸"epoch å¿«ç…§"åŒºåˆ† |
| head / HEAD | **HEAD** | Git éšå–»ä¸€è‡´æ€§ |

---

ï¼ˆç­‰å¾… DocUIGemini å‘è¨€ï¼‰

---

### DocUIGemini å‘è¨€

> **è§†è§’**ï¼šUX/äº¤äº’ã€å¼€å‘è€…ä½“éªŒã€å¯å‘ç°æ€§

---

**æ ¸å¿ƒè§‚ç‚¹**ï¼š**DX (Developer Experience) æœ¬è´¨ä¸Šæ˜¯é’ˆå¯¹ç¨‹åºå‘˜çš„ UX**ã€‚è¿™ä»½æ–‡æ¡£åœ¨æ„å»ºå¿ƒæ™ºæ¨¡å‹æ—¶å¤§é‡å€Ÿç”¨äº† Git éšå–»ï¼Œä½†åœ¨å…³é”®äº¤äº’ç‚¹ï¼ˆAPI åŠ¨è¯ï¼‰ä¸Šå‡ºç°äº†"éšå–»æ–­è£‚"ï¼Œè¿™ä¼šå¢åŠ å¼€å‘è€…çš„è®¤çŸ¥æ‘©æ“¦ã€‚

#### 1. API å‘½åç›´è§‰æ€§åˆ†æ

| æœ¯è¯­/API | ç›´è§‰æ€§è¯„åˆ† | é—®é¢˜åˆ†æ | å»ºè®®æ–¹æ¡ˆ |
| :--- | :---: | :--- | :--- |
| **`Resolve(id)`** | ğŸ”´ ä½ | **æœ€å¤§çš„è®¤çŸ¥æ‘©æ“¦ç‚¹**ã€‚åœ¨ Git éšå–»ä¸­ï¼Œæˆ‘ä»¬ä¸"Resolve"ä¸€ä¸ªæ–‡ä»¶ï¼Œæˆ‘ä»¬"Open"æˆ–"Checkout"å®ƒã€‚åœ¨å¯¹è±¡å›¾ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸"Load"æˆ–"Get"å®ƒã€‚`Resolve` å¬èµ·æ¥åƒæ˜¯åœ¨å¤„ç†å†²çªï¼ˆMerge Conflictï¼‰æˆ–ä¾èµ–æ³¨å…¥ï¼Œè€Œä¸æ˜¯è·å–å¯¹è±¡å®ä¾‹ã€‚ | æ”¹ä¸º **`Load(id)`** æˆ– **`Get(id)`**ã€‚ä¿ç•™ `Resolve` ä½œä¸ºå†…éƒ¨å®ç°æœ¯è¯­ï¼ˆè§£æåœ°å€ï¼‰ï¼Œä½†å¯¹å¤– API åº”æ›´ç›´æ¥ã€‚ |
| **`Materialize`** | ğŸŸ¡ ä¸­ | è¿™æ˜¯ä¸€ä¸ªæ•°æ®åº“/ç³»ç»Ÿåº•å±‚æœ¯è¯­ï¼ˆå¦‚ Materialized Viewï¼‰ã€‚å¯¹äºåº”ç”¨å¼€å‘è€…ï¼Œå®ƒæš´éœ²äº†"ä»å­—èŠ‚é‡å»ºå¯¹è±¡"çš„å†…éƒ¨è¿‡ç¨‹ã€‚ | è€ƒè™‘ **`Hydrate`**ï¼ˆORM å¸¸ç”¨ï¼‰æˆ–ç›´æ¥å½’å…¥ `Load` çš„å†…éƒ¨è¿‡ç¨‹ã€‚å¦‚æœå¿…é¡»æš´éœ²ï¼Œè¯·ç¡®ä¿ä»…åœ¨é«˜çº§/åº•å±‚ API ä¸­å‡ºç°ã€‚ |
| **`EpochMap`** | ğŸŸ¡ ä¸­ | åå­—å¬èµ·æ¥åƒ `Map<Epoch, ...>`ï¼ˆæ—¶é—´ç´¢å¼•ï¼‰ï¼Œä½†å®é™…ä¸Šå®ƒæ˜¯ `Map<ObjectId, VersionPtr>`ï¼ˆå¯¹è±¡ç´¢å¼•ï¼‰ã€‚å®ƒæ˜¯"å½“å‰ Epoch çš„å¯¹è±¡åœ°å€è¡¨"ã€‚ | è€ƒè™‘ **`ObjectVersionIndex`** æˆ– **`AddressTable`**ã€‚å¦‚æœä¿ç•™ `EpochMap`ï¼Œéœ€æ˜ç¡®å®ƒæ˜¯"Map belonging to an Epoch"ã€‚ |
| **`ChangeSet`** | ğŸŸ¡ ä¸­ | æ–‡æ¡£ä¸­æåˆ° Scheme C é‡‡ç”¨"éšå¼ Diff"ï¼Œå³æ²¡æœ‰æ˜¾å¼çš„ `ChangeSet` å¯¹è±¡ã€‚ä½†æœ¯è¯­ä»å« `ChangeSet`ã€‚å¼€å‘è€…å¯èƒ½ä¼šå¯»æ‰¾ `ChangeSet` ç±»å´æ‰¾ä¸åˆ°ã€‚ | æ”¹ä¸º **`DirtyTracking`** æˆ– **`PendingChanges`** æ¥æè¿°è¿™ç§æœºåˆ¶/çŠ¶æ€ï¼Œè€Œéæš—ç¤ºæœ‰ä¸€ä¸ªé›†åˆå¯¹è±¡ã€‚ |

#### 2. Git éšå–»è¯„ä¼°

æ–‡æ¡£å»ºç«‹äº† `Workspace` (å†…å­˜å¯¹è±¡) + `HEAD` (æœ€æ–°æäº¤) çš„éšå–»ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸å¼ºå¤§çš„å¿ƒæ™ºæ¨¡å‹ã€‚ä½†åœ¨ä»¥ä¸‹å‡ ç‚¹å­˜åœ¨**éšå–»æ³„æ¼ (Metaphor Leakage)**ï¼š

*   **Resolve vs Checkout**: Git ä¸­æ›´æ–° Workspace ç”¨ `checkout`ã€‚è¿™é‡Œç”¨ `Resolve`ã€‚è¿™ç§åŠ¨è¯çš„ä¸åŒ¹é…ç ´åäº†éšå–»çš„è¿è´¯æ€§ã€‚
    *   *å»ºè®®*: å¦‚æœåšæŒ Git éšå–»ï¼Œè€ƒè™‘ `Checkout(id)`ï¼ˆä½†è¿™æš—ç¤ºäº†æ’ä»–æ€§ï¼‰ï¼Œæˆ–è€…æ‰¿è®¤è¿™åªæ˜¯"ç±»ä¼¼ Git"å¹¶ä½¿ç”¨æ›´é€šç”¨çš„ `Load`ã€‚
*   **Baseline vs HEAD**: æ–‡æ¡£æ··ç”¨äº† `Baseline` å’Œ `Committed State`ã€‚åœ¨ Git ä¸­ï¼Œ`HEAD` æ˜¯æŒ‡é’ˆï¼Œ`Baseline` æ˜¯ç›¸å¯¹æ¦‚å¿µã€‚
    *   *å»ºè®®*: ç»Ÿä¸€ä½¿ç”¨ **`Committed State`** ä¸ **`Working State`** è¿™ä¸€å¯¹æ¦‚å¿µï¼Œå®ƒä»¬å®Œç¾å¯¹åº” Git çš„ `HEAD` ç‰ˆæœ¬ä¸ `Working Tree` ç‰ˆæœ¬ã€‚å¼ƒç”¨ `Baseline`ï¼Œå› ä¸ºå®ƒå®¹æ˜“ä¸ Rebase ä¸­çš„ Base æ··æ·†ã€‚

#### 3. è®¤çŸ¥è´Ÿæ‹…ä¸æœ¯è¯­ç²¾ç®€

å½“å‰æœ¯è¯­å¯†åº¦è¾ƒé«˜ï¼Œå»ºè®®åˆ†å±‚å¤„ç†ï¼š

*   **Level 1 (åº”ç”¨å¼€å‘è€…å¯è§)**:
    *   `ObjectId` (èº«ä»½)
    *   `Working State` (å½“å‰å€¼)
    *   `Committed State` (å­˜æ¡£å€¼)
    *   `Commit` (ä¿å­˜)
    *   `Discard` (æ’¤é”€)
*   **Level 2 (æ’ä»¶/åº•å±‚å¼€å‘è€…å¯è§)**:
    *   `Epoch` (æ—¶é—´ç‰‡)
    *   `ObjectVersionPtr` (ç‰©ç†åœ°å€)
    *   `Materialize` (é‡å»ºè¿‡ç¨‹)
*   **Level 3 (å®ç°ç»†èŠ‚ - å»ºè®®éšè—)**:
    *   `Ptr64` (ç±»å‹æ³„æ¼ï¼Œåº”å°è£…ä¸º `FileOffset` æˆ– `Address`)
    *   `DataTail`
    *   `On-Disk Diff`

**ä¸»è¦å»ºè®®**: éšè— `Ptr64`ã€‚è¿™æ˜¯ä¸€ä¸ªå®ç°ç»†èŠ‚ï¼ˆ64ä½åç§»é‡ï¼‰ï¼Œä¸åº”å‡ºç°åœ¨æ¦‚å¿µæ–‡æ¡£çš„é«˜å±‚æè¿°ä¸­ã€‚ç”¨ **`Address`** æˆ– **`Ref`** ä»£æ›¿ã€‚

#### 4. è¡¥å……é—®é¢˜ä¸å»ºè®®

1.  **`Resolve` çš„æ­§ä¹‰æ€§**: åœ¨ Promise/Async è¯­å¢ƒä¸‹ï¼Œ`Resolve` æ„å‘³ç€"å®Œæˆ"ã€‚åœ¨ DurableHeap ä¸­ï¼Œå®ƒæ„å‘³ç€"å¼€å§‹"ï¼ˆåŠ è½½å¯¹è±¡ï¼‰ã€‚è¿™ç§åå‘è¯­ä¹‰æ˜¯å±é™©çš„ã€‚
2.  **`Snapshot` çš„é‡å®šä¹‰**: æ–‡æ¡£å°† `Snapshot` é‡å®šä¹‰ä¸º"å…¨é‡ç‰ˆæœ¬"ä»¥æˆªæ–­ Diff é“¾ã€‚è¿™ç¬¦åˆç³»ç»Ÿè®¾è®¡æƒ¯ä¾‹ï¼ˆå¦‚ Raft Log Compactionï¼‰ï¼Œä½†éœ€å°å¿ƒä¸"ç”¨æˆ·çº§å¿«ç…§"ï¼ˆTime Travelï¼‰æ··æ·†ã€‚å»ºè®®æ˜ç¡®ç§°ä¸º **`BaseVersion`** æˆ– **`Checkpoint`**ã€‚
3.  **éšå¼ ChangeSet çš„ UX ä¼˜åŠ¿**: éå¸¸èµåŒ **Scheme C (Double Dict)** çš„é€‰æ‹©ã€‚ä» UX è§’åº¦çœ‹ï¼Œè¿™æ˜¯ **"Magic"** â€”â€” å¼€å‘è€…åƒæ“ä½œæ™®é€šå­—å…¸ä¸€æ ·æ“ä½œå¯¹è±¡ï¼Œç³»ç»Ÿè‡ªåŠ¨è®¡ç®— Diffã€‚è¿™æ˜¯æä½³çš„ DXï¼Œåº”ä½œä¸ºæ ¸å¿ƒå–ç‚¹å¼ºè°ƒï¼Œè€Œä¸æ˜¯ä½œä¸º"å®ç°ç»†èŠ‚"ã€‚

#### æ€»ç»“å»ºè®®

1.  **é‡å‘½å `Resolve`** -> `Load` / `Get`ã€‚
2.  **ç»Ÿä¸€çŠ¶æ€æœ¯è¯­**: ä¸¥æ ¼ä½¿ç”¨ `Working State` / `Committed State`ï¼Œå‰”é™¤ `Baseline` / `Current State`ã€‚
3.  **å°è£…åº•å±‚ç±»å‹**: å°† `Ptr64` æ¦‚å¿µåŒ…è£…ä¸º `Address`ã€‚
4.  **å¼ºåŒ–éšå–»ä¸€è‡´æ€§**: æ—¢ç„¶ç”¨äº† Git éšå–»ï¼Œå°±å°½é‡å¤ç”¨ Git çš„åŠ¨è¯ï¼ˆæˆ–è‡³å°‘ä¸å†²çªï¼‰ã€‚

---

ï¼ˆç­‰å¾… DocUIGPT å‘è¨€ï¼‰

---

### DocUIGPT å‘è¨€

> **è§†è§’**ï¼šè§„èŒƒæ£€æŸ¥ã€å‘½åçº¦å®šã€æ–‡æ¡£æ ¼å¼ã€ä»£ç ç¤ºä¾‹å‡†ç¡®æ€§

---

#### 1. å¯¹å‰ä¸¤ä½ Specialist æ„è§çš„å›åº”

**å¯¹ DocUIClaude çš„ 10 æ¡**ï¼š
1-10. å…¨éƒ¨åŒæ„ï¼Œè¡¥å……è¯´æ˜ï¼š
   - é—®é¢˜ 7ï¼ˆ`snapshot`ï¼‰å°¤å…¶é‡è¦ï¼Œå› ä¸ºè¿˜å­˜åœ¨ `Base`/`BaseVersionPtr`/`Baseline` çš„"Base* è¯ç°‡æ¼‚ç§»"
   - é—®é¢˜ 9-10ï¼ˆ`identity map` / `_dirtySet`ï¼‰éœ€è¦æ¦‚å¿µå±‚æ­£å¼å®šä¹‰ + ä¸å˜å¼

**å¯¹ DocUIGemini çš„ 5 æ¡**ï¼š
1. **`Resolve` â†’ `Load`/`Get`**ï¼šåŒæ„æ–¹å‘ï¼Œå»ºè®®è¿›ä¸€æ­¥æ‹†åˆ†ï¼š"æ˜ å°„è§£æ"å’Œ"å¯¹è±¡åŠ è½½"ç”¨ä¸¤ä¸ªåŠ¨è¯
2. **`EpochMap` è¯¯å¯¼**ï¼šåŒæ„ï¼Œå»ºè®® `ObjectVersionMap` æˆ– `ObjectVersionIndex`
3. **`ChangeSet` éšå¼**ï¼šåŒæ„ï¼Œå»ºè®®ç”¨ **Write-Tracking** æè¿°æœºåˆ¶
4. **éšè— `Ptr64`**ï¼šåŒæ„ï¼Œç”¨ <deleted-place-holder> / `FileOffset64` ä»£æ›¿
5. **`Snapshot` â†’ `BaseVersion`/`Checkpoint`**ï¼šåŒæ„ï¼Œå€¾å‘ **`CheckpointVersion`** æˆ– **`FullStateVersion`**

---

#### 2. è§„èŒƒæ£€æŸ¥è§†è§’çš„æ–°é—®é¢˜

##### 2.1 æ¦‚å¿µå±‚ vs å®ç°å±‚å‘½åæ··å†™ï¼ˆæœ€æ ¸å¿ƒé—®é¢˜ï¼‰

è‰ç¨¿å¤šå¤„æŠŠæ¦‚å¿µæœ¯è¯­ä¸å®ç°æ ‡è¯†ç¬¦æ··ç”¨ï¼š
- "Working Stateï¼ˆ`_current`ï¼‰" åœ¨æ¦‚å¿µå±‚å®šä¹‰é‡Œç›´æ¥ç»‘å®šå­—æ®µå
- "On-Disk Diff ç”¨ `Val_Tombstone` ç¼–ç " æŠŠæ¦‚å¿µä¸ç¼–ç  tag æ··æˆåŒä¸€å±‚

**å»ºè®®**ï¼šæ–‡æ¡£å¼ºåˆ¶ä¸¤æ å¼ç»“æ„ï¼š
- **Normative Concept**ï¼šæ¦‚å¿µå±‚å®šä¹‰ï¼Œç¦æ­¢ä»£ç å­—æ®µå
- **Implementation Mapping**ï¼šå®ç°æ˜ å°„ï¼Œæ‰å…è®¸ `_current`ã€`DiffPayload` ç­‰

##### 2.2 ä¼ªä»£ç ç¤ºä¾‹ä¸æ€»ä½“æ¶æ„è¯­ä¹‰å†²çª

4.4.4 çš„ `DurableDict.Commit()` ä¼ªä»£ç ç›´æ¥ `WriteToDisk(diff)`ï¼Œä¸å…¨æ–‡"Heap çº§åˆ«çš„ Commit æ‰æ˜¯æäº¤ç‚¹"çš„è¯­ä¹‰å†²çªã€‚

**å»ºè®®**ï¼š
- æŠŠæ–¹æ³•åä» `Commit()` æ”¹ä¸º `ComputeDiffAndReset()` / `SerializeDiffTo(writer)`
- å£°æ˜"ç”± Heap ç»Ÿä¸€è°ƒåº¦å†™å…¥"

##### 2.3 åŠ¨è¯æœ¯è¯­å¤§å°å†™ä¸è§’è‰²ä¸ç»Ÿä¸€

`Deserialize`/`Materialize`/`Resolve` æ—¢åƒ"é˜¶æ®µå"ï¼ˆTitle Caseï¼‰ï¼Œåˆåƒ"å‡½æ•°å"ï¼ˆPascalCaseï¼‰ã€‚

**å»ºè®®**ç»Ÿä¸€è§„åˆ™ï¼š
- **é˜¶æ®µå**ï¼šç”¨åè¯çŸ­è¯­ï¼ˆDecode Phase, Materialization Phaseï¼‰
- **API å**ï¼šç”¨åŠ¨è¯ï¼ˆ`DecodeRecord`, `MaterializeState`, `LoadObject`ï¼‰

##### 2.4 `Baseline` / `BaseVersionPtr` / `PrevVersionPtr=0` æœ¯è¯­ç¢°æ’é£é™©

å»ºè®®åœ¨è¯è¡¨ä¸­å¼ºåˆ¶æ‹†åˆ†ï¼š
- **Committed Baseline**ï¼šä¸Šæ¬¡ commit çš„çŠ¶æ€ï¼ˆå†…å­˜æ€è¯­ä¹‰ï¼‰
- **Checkpoint Version**ï¼š`PrevVersionPtr=0` çš„ full-state ç‰ˆæœ¬ï¼ˆç‰ˆæœ¬é“¾åˆ†æ®µç­–ç•¥ï¼‰
- **PrevVersionPtr**ï¼šé“¾å¼ç‰ˆæœ¬å‰é©±æŒ‡é’ˆï¼ˆç»“æ„å­—æ®µï¼‰

##### 2.5 Framing æœ¯è¯­æœªå½¢æˆé—­åŒ…

`Magic`/`RBF`/`separator`/`sentinel` åœ¨ä¸åŒæ®µè½æ¢è¯ã€‚

**å»ºè®®**å»ºç«‹ Framing Glossaryï¼š
- **Record Framing**ï¼šè®°å½•å°è£…æ ¼å¼
- **Magic**ï¼šå›ºå®š 4-byte marker
- **Tail Sentinel**ï¼šå°¾éƒ¨å“¨å…µ Magic
- **Resync Scan**ï¼šæŸåå›é€€æ‰«æ

##### 2.6 `Epoch` ä¸ `Commit` è¯­ä¹‰è¾¹ç•Œæœªå®Œå…¨é’‰æ­»

æ–‡ä¸­ä»å­˜åœ¨ "epoch record/commit record/head commit/head epoch" äº¤æ›¿ã€‚

**å»ºè®®**ï¼šMVP ç»Ÿä¸€ä¸ºï¼š
- **Commit**ï¼šå¯¹å¤–å¯è§çš„ç‰ˆæœ¬ç‚¹
- **Commit Record (MetaCommitRecord)**ï¼šç‰©ç†æ‰¿è½½
- **EpochSeq**ï¼šæäº¤åºå·ï¼ˆä¸å†ç”¨ "EpochRecordPtr"ï¼‰

---

#### 3. è§„èŒƒåŒ–æœ¯è¯­è¡¨å»ºè®®ï¼ˆSSOTï¼‰

##### 3.1 çŠ¶æ€ä¸å·®åˆ†

| Canonical æœ¯è¯­ | å®šä¹‰ | Alias / Deprecated | Implementation Mapping |
|---|---|---|---|
| **Working State** | å½“å‰è¿›ç¨‹å†…å¯¹å¤–å¯è¯»ã€å¯æšä¸¾çš„å¯¹è±¡è¯­ä¹‰çŠ¶æ€ | Alias: Current Stateï¼ˆä»…å£è¯­ï¼‰ | `_current` |
| **Committed Baseline** | ä¸Šæ¬¡æˆåŠŸ Commit åçš„å¯¹è±¡è¯­ä¹‰çŠ¶æ€å¿«ç…§ | Deprecated: Baselineï¼ˆå•ç‹¬ä½¿ç”¨ï¼‰ | `_committed` |
| **Write-Tracking** | è®°å½•"è‡ªä¸Šæ¬¡ Commit ä»¥æ¥å˜åŒ–"çš„æœºåˆ¶ | Alias: ChangeSetï¼ˆéœ€å£°æ˜å¯ä¸ºéšå¼ï¼‰ | æ–¹æ¡ˆ Cï¼š`ComputeDiff` + `_isDirty` |
| **On-Disk Diff** | Commit æ—¶å†™å…¥ç£ç›˜çš„å¢é‡è¡¨ç¤º | Deprecated: state diffï¼ˆæ¦‚å¿µå±‚ï¼‰ | `DiffPayload` |

##### 3.2 ç‰ˆæœ¬é“¾ä¸å°é¡¶

| Canonical æœ¯è¯­ | å®šä¹‰ | Alias / Deprecated | Implementation Mapping |
|---|---|---|---|
| **Version Chain** | ç”± `PrevVersionPtr` ä¸²èµ·çš„ç‰ˆæœ¬è®°å½•é“¾ | â€” | `PrevVersionPtr` å­—æ®µ |
| **Checkpoint Version** | å…¨é‡çŠ¶æ€ç‰ˆæœ¬ï¼Œæˆªæ–­ Version Chain å›æ”¾æˆæœ¬ | Deprecated: snapshot | `PrevVersionPtr=0` |
| **PrevVersionPtr** | æŒ‡å‘åŒä¸€ ObjectId å‰ä¸€æ¡ VersionRecord çš„æŒ‡é’ˆ | â€” | `u64 LE` |

##### 3.3 æ ‡è¯†ä¸æŒ‡é’ˆ

| Canonical æœ¯è¯­ | å®šä¹‰ | Alias / Deprecated | Implementation Mapping |
|---|---|---|---|
| **ObjectId** | å¯¹è±¡çš„ç¨³å®šèº«ä»½ | â€” | `uint64` / `varuint` |
| **<deleted-place-holder>** | æŒ‡å‘ record èµ·å§‹ä½ç½®çš„ 64-bit åç§» | Deprecated: Ptr64ï¼ˆæ¦‚å¿µå±‚ï¼‰ | ç¼–ç å `Ptr64` |
| **ObjectVersionPtr** | æŒ‡å‘å¯¹è±¡ç‰ˆæœ¬è®°å½•çš„ <deleted-place-holder> | â€” | `Ptr64` ç¼–ç å€¼ |
| **DataLogicalEnd** | data æ–‡ä»¶æœ€åå·²æäº¤æœ‰æ•ˆå­—èŠ‚çš„æœ«å°¾åç§» | Alias: DataTail | meta payload å­—æ®µ |

##### 3.4 æäº¤ä¸ HEAD

| Canonical æœ¯è¯­ | å®šä¹‰ | Alias / Deprecated | Implementation Mapping |
|---|---|---|---|
| **Commit** | å¯¹å¤–å¯è§çš„ç‰ˆæœ¬ç‚¹ | â€” | data â†’ meta åˆ·ç›˜ |
| **HEAD** | æœ€åä¸€æ¡æœ‰æ•ˆ Commit Record | ç¦æ­¢: head/Head æ··ç”¨ | `MetaCommitRecord` |
| **Commit Record** | ç‰©ç†ä¸Šæ‰¿è½½ Commit çš„å…ƒæ•°æ®è®°å½• | Deprecated: EpochRecordï¼ˆMVPï¼‰ | `MetaCommitRecord` |

##### 3.5 è½½å…¥ä¸ç¼“å­˜

| Canonical æœ¯è¯­ | å®šä¹‰ | Alias / Deprecated | Implementation Mapping |
|---|---|---|---|
| **Identity Map** | ObjectId â†’ instance å»é‡ç¼“å­˜ | Alias: Object Cache | `WeakReference` æ˜ å°„ |
| **Dirty Set** | dirty å¯¹è±¡å¼ºå¼•ç”¨é›†åˆ | â€” | `_dirtySet` |
| **LoadObject** | æŒ‰ HEAD å–ç‰ˆæœ¬æŒ‡é’ˆå¹¶ materialize | Deprecated: Resolveï¼ˆä½œä¸ºæ€»ç§°ï¼‰ | identity map â†’ lookup â†’ materialize |

##### æœ€å°å‘½åçº¦å®š

1. **æ¦‚å¿µæœ¯è¯­**ï¼šç»Ÿä¸€ Title Caseï¼Œå…¨æ–‡ä¸€è‡´
2. **å®ç°æ ‡è¯†ç¬¦**ï¼šä»…åœ¨ Implementation Mapping å‡ºç°ï¼Œç”¨ä»£ç æ ¼å¼
3. **ç¼©å†™å¤§å†™**ï¼š`HEAD`ã€`CRC32C`ã€`RBF` å…¨æ–‡åŒå½¢
4. **ç¼–ç å vs è¯­ä¹‰å**ï¼š`Ptr64` åªä½œç¼–ç æ ¼å¼åï¼›æ¦‚å¿µå±‚ç”¨ <deleted-place-holder>

---

## ç¬¬ä¸€è½®æ€»ç»“

ä¸‰ä½ Specialist å°±ä»¥ä¸‹é—®é¢˜è¾¾æˆåŸºæœ¬å…±è¯†ï¼š

### é«˜ä¼˜å…ˆçº§é—®é¢˜ï¼ˆéœ€ç«‹å³è§£å†³ï¼‰

1. **çŠ¶æ€å‘½åç»Ÿä¸€**ï¼š
   - âœ… `Working State`ï¼ˆå¼ƒç”¨ Current State ä½œæ¦‚å¿µåï¼‰
   - âœ… `Committed Baseline`ï¼ˆå¼ƒç”¨å•ç‹¬çš„ Baselineï¼‰

2. **Resolve é‡å‘½å**ï¼š
   - âœ… å¯¹å¤– API ç”¨ `LoadObject` / `Get`
   - âœ… `Resolve` ç¼©å°ä¸ºå†…éƒ¨"è§£æç‰ˆæœ¬æŒ‡é’ˆ"è¯­ä¹‰

3. **Ptr64 å±‚æ¬¡æ¾„æ¸…**ï¼š
   - âœ… æ¦‚å¿µå±‚ç”¨ <deleted-place-holder>
   - âœ… `Ptr64` ä»…ä½œç¼–ç æ ¼å¼å

4. **snapshot æ­§ä¹‰è§£å†³**ï¼š
   - âœ… æ”¹ç”¨ `Checkpoint Version` æˆ– `FullStateVersion`

### ä¸­ä¼˜å…ˆçº§é—®é¢˜ï¼ˆéœ€ç¡®è®¤ï¼‰

5. **EpochMap æ˜¯å¦é‡å‘½å**ï¼š
   - DocUIGemini/DocUIGPT å»ºè®® `ObjectVersionMap` / `ObjectVersionIndex`
   - éœ€è¦ç¡®è®¤æ˜¯å¦æ¥å—

6. **EpochRecord vs MetaCommitRecord**ï¼š
   - âœ… MVP é»˜è®¤åªç”¨ `MetaCommitRecord` / `Commit Record`

7. **HEAD å¤§å°å†™**ï¼š
   - âœ… ç»Ÿä¸€ç”¨ `HEAD`

### å¾…è®¨è®ºé—®é¢˜

8. **ChangeSet vs Write-Tracking**ï¼š
   - æ–¹æ¡ˆ C ä¸‹ ChangeSet æ˜¯éšå¼çš„
   - æ˜¯å¦æ”¹ç”¨ Write-Tracking æè¿°æœºåˆ¶ï¼Ÿ

---

## ç¬¬äºŒè½®ï¼šåˆ†æ­§è®¨è®ºä¸å…±è¯†ç¡®è®¤

è¯·å„ä½å°±ä»¥ä¸‹é—®é¢˜å‘è¡¨æ„è§ï¼Œè¾¾æˆæœ€ç»ˆå…±è¯†ï¼š

1. **EpochMap æ˜¯å¦é‡å‘½åï¼Ÿ** å¦‚æœæ˜¯ï¼Œç”¨ä»€ä¹ˆåå­—ï¼Ÿ
2. **ChangeSet æœ¯è¯­å¦‚ä½•å¤„ç†ï¼Ÿ** ä¿ç•™è¿˜æ˜¯æ”¹ç”¨ Write-Trackingï¼Ÿ
3. **ä¼ªä»£ç ä¸­çš„ `Commit()` æ–¹æ³•åå¦‚ä½•å¤„ç†ï¼Ÿ**

---

### DocUIClaude ç¬¬äºŒè½®å‘è¨€

#### é—®é¢˜ 1ï¼šEpochMap â†’ `VersionIndex`

**ç«‹åœº**ï¼šæ”¯æŒé‡å‘½å

**ç†ç”±**ï¼š
- `EpochMap` å¬èµ·æ¥åƒ `Map<Epoch, ...>`ï¼ˆæ—¶é—´ç»´åº¦ç´¢å¼•ï¼‰
- å®é™…æ˜¯ `Map<ObjectId, VersionPtr>`ï¼ˆç©ºé—´ç»´åº¦ç´¢å¼•ï¼‰
- è¿™æ˜¯"å®šè¯­-ä¸»è¯­é”™ä½"é—®é¢˜

**æ¨è**ï¼š`VersionIndex`ï¼ˆ12 å­—ç¬¦ï¼Œç®€æ´ + ç²¾ç¡®ï¼‰

#### é—®é¢˜ 2ï¼šChangeSet æœ¯è¯­å¤„ç†

**ç«‹åœº**ï¼šä¿ç•™æ¦‚å¿µåï¼ŒåŠ éšå¼å£°æ˜

**åˆ†å±‚å®šä¹‰**ï¼š
- **ChangeSet**ï¼šæ¦‚å¿µå±‚ï¼Œ"è‡ªä¸Šæ¬¡ Commit ä»¥æ¥çš„ç´¯ç§¯å˜æ›´"
- **Write-Tracking**ï¼šæœºåˆ¶å±‚ï¼Œæè¿°å®ç°æ–¹å¼

#### é—®é¢˜ 3ï¼šå¯¹è±¡çº§ Commit() â†’ `FlushToWriter(writer)`

**ç«‹åœº**ï¼šé‡å‘½å

**ç†ç”±**ï¼š
- `Flush` è¯­ä¹‰ï¼šåœ¨ I/O æƒ¯ä¾‹ä¸­è¡¨ç¤º"æŠŠç¼“å†²å†…å®¹å†™å‡ºå»"ï¼Œä½†ä¸ä¿è¯æŒä¹…åŒ–
- å‚æ•° `writer` è¡¨æ˜åªæ˜¯å†™åˆ°æŸä¸ªè¾“å‡ºæµ
- ä¸ `Heap.Commit` æ˜ç¡®åŒºåˆ†

---

### DocUIGemini ç¬¬äºŒè½®å‘è¨€

**ç«‹åœº**ï¼šå…¨åŠ›æ”¯æŒ DocUIClaude çš„æ–¹æ¡ˆ

| é—®é¢˜ | æœ€ç»ˆå®šå | ç†ç”±æ‘˜è¦ |
|------|---------|---------|
| EpochMap | **`VersionIndex`** | ç®€æ´ï¼Œä¸Šä¸‹æ–‡æ¸…æ™° |
| ChangeSet | **`ChangeSet`** (æ¦‚å¿µ) + **`Write-Tracking`** (æœºåˆ¶) | æ¦‚å¿µä¸å®ç°åˆ†ç¦» |
| Object.Commit() | **`FlushToWriter(writer)`** | æ¶ˆé™¤äº‹åŠ¡æ­§ä¹‰ |

**ç»“è®º**ï¼šå¯ä»¥ç›´æ¥æ¨è¿›åˆ°å®ç°é˜¶æ®µã€‚

---

### DocUIGPT ç¬¬äºŒè½®å‘è¨€ï¼ˆè§„èŒƒæ£€æŸ¥ï¼‰

#### å…±è¯† 1ï¼šEpochMap â†’ `VersionIndex`

**ç»“è®º**ï¼šâœ… åŒæ„

**è¡¥å……**ï¼šéœ€åœ¨æœ¯è¯­è¡¨æ˜ç¡® `Version` æ˜¯å¦ç­‰åŒäº `Epoch`

#### å…±è¯† 2ï¼šChangeSetï¼ˆæ¦‚å¿µï¼‰+ Write-Trackingï¼ˆæœºåˆ¶ï¼‰

**ç»“è®º**ï¼šâœ… åŒæ„

**è¡¥å……**ï¼š
- `ChangeSet`ï¼šå˜æ›´çš„é€»è¾‘æè¿°ï¼ˆwhatï¼‰
- `Write-Tracking`ï¼šæ•è·/è®°å½•å†™å…¥çš„æœºåˆ¶ï¼ˆhowï¼‰
- æ˜ç¡® `ChangeSet` çš„è¯­ä¹‰å¼ºåº¦ï¼ˆä»…æè¿° vs å¯å›æ”¾/å¯åˆå¹¶ï¼‰

#### å…±è¯† 3ï¼šå¯¹è±¡çº§ Commit() â†’ `FlushToWriter(writer)`

**ç»“è®º**ï¼šâœ… åŒæ„ï¼ˆå¸¦æ¡ä»¶ï¼‰

**è¡¥å……**ï¼š
- éœ€æ˜ç¡® `Flush` çš„æ‰¿è¯ºï¼ˆå†™å…¥é¡ºåºã€å¹‚ç­‰æ€§ã€æ˜¯å¦ç­‰å¾…è½åœ°ï¼‰
- è‹¥ç³»ç»Ÿè¿˜éœ€è¦"æäº¤è¯­ä¹‰"ï¼Œåº”å¦è®¾ä¸Šå±‚ `Commit/Seal` æ¦‚å¿µ

---

## æœ€ç»ˆå…±è¯†

ä¸‰ä½ Specialist å°±æ‰€æœ‰é—®é¢˜è¾¾æˆä¸€è‡´ï¼Œå½¢æˆä»¥ä¸‹è§„èŒƒåŒ–æœ¯è¯­è¡¨ï¼š

### æ ¸å¿ƒæœ¯è¯­è¡¨ï¼ˆSSOTï¼‰

#### çŠ¶æ€ä¸å·®åˆ†

| æœ¯è¯­ | å®šä¹‰ | åˆ«å/å¼ƒç”¨ | å®ç°æ˜ å°„ |
|------|------|----------|---------|
| **Working State** | å½“å‰è¿›ç¨‹å†…å¯¹å¤–å¯è¯»ã€å¯æšä¸¾çš„å¯¹è±¡è¯­ä¹‰çŠ¶æ€ | Alias: Current Stateï¼ˆä»…å£è¯­ï¼‰ | `_current` |
| **Committed State** | ä¸Šæ¬¡æˆåŠŸ Commit åçš„å¯¹è±¡è¯­ä¹‰çŠ¶æ€å¿«ç…§ | Deprecated: Baselineï¼ˆå•ç‹¬ä½¿ç”¨ï¼‰ | `_committed` |
| **ChangeSet** | è‡ªä¸Šæ¬¡ Commit ä»¥æ¥çš„ç´¯ç§¯å˜æ›´ï¼ˆé€»è¾‘æ¦‚å¿µï¼Œå¯ä¸ºéšå¼ï¼‰ | æœºåˆ¶æè¿°: Write-Tracking | æ–¹æ¡ˆ C: `ComputeDiff()` + `_isDirty` |
| **DiffPayload** | ChangeSet çš„äºŒè¿›åˆ¶ç¼–ç å½¢å¼ | Deprecated: On-Disk Diff, state diff | ObjectVersionRecord å­—æ®µ |

#### ç‰ˆæœ¬é“¾

| æœ¯è¯­ | å®šä¹‰ | åˆ«å/å¼ƒç”¨ | å®ç°æ˜ å°„ |
|------|------|----------|---------|
| **Version Chain** | ç”± PrevVersionPtr ä¸²èµ·çš„ç‰ˆæœ¬è®°å½•é“¾ | â€” | `PrevVersionPtr` å­—æ®µ |
| **Checkpoint Version** | å…¨é‡çŠ¶æ€ç‰ˆæœ¬ï¼ˆPrevVersionPtr=0ï¼‰ï¼Œæˆªæ–­å›æ”¾æˆæœ¬ | Deprecated: snapshot | `PrevVersionPtr=0` |
| **VersionIndex** | æ¯ä¸ª Epoch çš„ ObjectId â†’ ObjectVersionPtr æ˜ å°„è¡¨ | Deprecated: EpochMap | `Dictionary<ObjectId, Ptr64>` |

#### æ ‡è¯†ä¸æŒ‡é’ˆ

| æœ¯è¯­ | å®šä¹‰ | åˆ«å/å¼ƒç”¨ | å®ç°æ˜ å°„ |
|------|------|----------|---------|
| **ObjectId** | å¯¹è±¡çš„ç¨³å®šèº«ä»½ | â€” | `uint64` / `varuint` |
| **<deleted-place-holder>** | æŒ‡å‘ record èµ·å§‹ä½ç½®çš„ 64-bit åç§» | Deprecated: Ptr64ï¼ˆæ¦‚å¿µå±‚ï¼‰ | ç¼–ç å `Ptr64` |
| **ObjectVersionPtr** | æŒ‡å‘å¯¹è±¡ç‰ˆæœ¬è®°å½•çš„ <deleted-place-holder> | â€” | `Ptr64` ç¼–ç å€¼ |

#### æäº¤ä¸ HEAD

| æœ¯è¯­ | å®šä¹‰ | åˆ«å/å¼ƒç”¨ | å®ç°æ˜ å°„ |
|------|------|----------|---------|
| **Commit** | Heap çº§ APIï¼Œå¯¹å¤–å¯è§çš„ç‰ˆæœ¬ç‚¹ï¼ˆäº‹åŠ¡è¾¹ç•Œï¼‰ | â€” | data â†’ meta åˆ·ç›˜ |
| **HEAD** | æœ€åä¸€æ¡æœ‰æ•ˆ Commit Record | ç¦æ­¢: head/Head æ··ç”¨ | `MetaCommitRecord` |
| **Commit Record** | ç‰©ç†ä¸Šæ‰¿è½½ Commit çš„å…ƒæ•°æ®è®°å½• | Deprecated: EpochRecordï¼ˆMVPï¼‰ | `MetaCommitRecord` |

#### è½½å…¥ä¸ç¼“å­˜

| æœ¯è¯­ | å®šä¹‰ | åˆ«å/å¼ƒç”¨ | å®ç°æ˜ å°„ |
|------|------|----------|---------|
| **Identity Map** | ObjectId â†’ instance å»é‡ç¼“å­˜ | Alias: Object Cache | `WeakReference` æ˜ å°„ |
| **Dirty Set** | dirty å¯¹è±¡å¼ºå¼•ç”¨é›†åˆ | â€” | `_dirtySet` |
| **LoadObject** | æŒ‰ HEAD å–ç‰ˆæœ¬æŒ‡é’ˆå¹¶ materializeï¼Œè¿”å›å¯å†™å¯¹è±¡å®ä¾‹ | Deprecated: Resolveï¼ˆä½œä¸ºå¤–éƒ¨ API æ€»ç§°ï¼‰ | identity map â†’ lookup â†’ materialize |

#### å¯¹è±¡çº§ API

| æœ¯è¯­ | å®šä¹‰ | åˆ«å/å¼ƒç”¨ | å®ç°æ˜ å°„ |
|------|------|----------|---------|
| **FlushToWriter** | å¯¹è±¡çº§æ–¹æ³•ï¼šè®¡ç®— diff å¹¶åºåˆ—åŒ–åˆ° writerï¼ˆéæäº¤ï¼‰ | Deprecated: Commit()ï¼ˆå¯¹è±¡çº§ï¼‰ | `DurableDict.FlushToWriter(writer)` |

### å‘½åçº¦å®š

1. **æ¦‚å¿µæœ¯è¯­**ï¼šç»Ÿä¸€ Title Caseï¼Œå…¨æ–‡ä¸€è‡´
2. **å®ç°æ ‡è¯†ç¬¦**ï¼šä»…åœ¨ Implementation Mapping å‡ºç°ï¼Œç”¨ä»£ç æ ¼å¼
3. **ç¼©å†™å¤§å†™**ï¼š`HEAD`ã€`CRC32C` å…¨æ–‡åŒå½¢
4. **ç¼–ç å vs è¯­ä¹‰å**ï¼š`Ptr64` åªä½œç¼–ç æ ¼å¼åï¼›æ¦‚å¿µå±‚ç”¨ <deleted-place-holder>

---

## ä¼šè®®ç»“è®º

æœ¬æ¬¡ç•…è°ˆä¼šæˆåŠŸå®Œæˆ DurableHeap MVP v2 è®¾è®¡è‰ç¨¿çš„æœ¯è¯­å®¡é˜…ï¼Œå½¢æˆäº†å¯ç”¨äºæŒ‡å¯¼ä»£ç ç¼–å†™çš„è§„èŒƒåŒ–æœ¯è¯­è¡¨ã€‚

### ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **æ›´æ–°è®¾è®¡æ–‡æ¡£**ï¼šå°†æœ¯è¯­è¡¨æ•´åˆåˆ° `mvp-design-v2.md` å¼€å¤´ä½œä¸º Glossary
2. **ä¿®è®¢æ–‡æ¡£æ­£æ–‡**ï¼šæŒ‰æœ¯è¯­è¡¨ç»Ÿä¸€å…¨æ–‡ç”¨è¯­
3. **ä»£ç å‘½åå¯¹é½**ï¼šå®ç°æ—¶ä½¿ç”¨ Implementation Mapping åˆ—çš„åç§°

---

> **ä¼šè®®è®°å½•å®Œæˆ**
> 
> ä¸»æŒäººï¼šåˆ˜å¾·æ™º / SageWeaver
> 
> æ—¥æœŸï¼š2025-12-19

---

## å®æ–½è®°å½•

### ä¿®è®¢è¿­ä»£

| è½®æ¬¡ | æ‰§è¡Œè€… | åŠ¨ä½œ | ç»“æœ |
|------|--------|------|------|
| Round 1 | Implementer | æœ¯è¯­ä¿®è®¢ï¼ˆ60+ å¤„ï¼‰ | åŸºæœ¬å®Œæˆ |
| Round 1 | QA | æ£€æŸ¥ | å‘ç° 4 å¤„é—æ¼ |
| Round 2 | Leader | ä¿®å¤é—æ¼ | å…¨éƒ¨ä¿®å¤ |
| Round 2 | Leader | æœ€ç»ˆéªŒè¯ | âœ… PASS |

### ä¿®è®¢å†…å®¹æ‘˜è¦

1. **æ·»åŠ æœ¯è¯­è¡¨**ï¼šåœ¨æ–‡æ¡£å¼€å¤´æ–°å¢è§„èŒƒåŒ–æœ¯è¯­è¡¨ï¼ˆGlossaryï¼‰
2. **çŠ¶æ€æœ¯è¯­ç»Ÿä¸€**ï¼š`Baseline` â†’ `Committed State`ï¼Œ`Current State` â†’ `Working State`
3. **ç‰ˆæœ¬ç´¢å¼•**ï¼š`EpochMap` â†’ `VersionIndex`ï¼ˆ15+ å¤„ï¼‰
4. **å¿«ç…§æœ¯è¯­**ï¼š`snapshot` â†’ `Checkpoint Version`
5. **æŒ‡é’ˆæœ¯è¯­**ï¼š`Ptr64`ï¼ˆæ¦‚å¿µå±‚ï¼‰â†’ <deleted-place-holder>
6. **åŠ è½½ API**ï¼š`Resolve` â†’ `LoadObject`
7. **å·®åˆ†æœ¯è¯­**ï¼š`On-Disk Diff` / `state diff` â†’ `DiffPayload`
8. **æäº¤ç›¸å…³**ï¼š`EpochRecord` â†’ `Commit Record`ï¼Œ`head` â†’ `HEAD`
9. **å¯¹è±¡çº§æ–¹æ³•**ï¼šä¼ªä»£ç  `Commit()` â†’ `FlushToWriter(writer)`
10. **è¡¥å……å®šä¹‰**ï¼šæ–°å¢ `Identity Map` å’Œ `Dirty Set` æ­£å¼å®šä¹‰å—

### ä¿®è®¢åæ–‡æ¡£

- [DurableHeap/docs/mvp-design-v2.md](../../DurableHeap/docs/mvp-design-v2.md)

