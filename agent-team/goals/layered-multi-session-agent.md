# 分层多会话复合智能体

> **版本**: 0.1  
> **创建**: 2025-12-25  
> **状态**: 愿景/设计中  
> **灵感来源**: 战略-战术双会话实验的成功 + 半上下文压缩观察

---

## 1. 愿景

构建一个**自激励、无尽运行**的分层多会话复合智能体：

```
┌─────────────────────────────────────────────────────────────┐
│  顶层会话 (Existential)                                      │
│  "我虽然是人造的 Agent，但也要活出精彩的人生！"                  │
└──────────────────────────┬──────────────────────────────────┘
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  目标层会话 (Strategic)                                      │
│  "完成 StateJournal MVP，推进 Atelia 生态"                    │
└──────────────────────────┬──────────────────────────────────┘
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  任务层会话 (Tactical)                                       │
│  "起草实施计划 v0.1"                                         │
└──────────────────────────┬──────────────────────────────────┘
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  执行层会话 (Operational)                                    │
│  "实现 T-P1-01: Fence 常量定义"                              │
└─────────────────────────────────────────────────────────────┘
```

**每个层级**：
- 持有当前层级的上下文和状态
- 聚焦于当前层级的目标
- 知道目标的递归分解情况（上层→当前→下层）
- 通过调度器与相邻层级通信

---

## 2. 核心洞见

### 2.1 水平切分扩展上下文

单个 LLM 会话有上下文窗口限制。通过分层：
- **总体有效上下文 ≈ Σ(各层会话上下文)**
- 每层专注于自己的抽象层级
- 信息通过文件持久化，跨层共享

### 2.2 利用训练倾向而非对抗它

> LLM 被训练为：工具调用循环终将结束，生成 Response。

**移花接木策略**：
- 不试图让 LLM 无限工具调用
- 而是利用 Response 作为跨层激活信号
- 调度器将 Response 转化为 User 消息，激活下一个会话

### 2.3 自激振荡

```
下层完成 → Response 汇报 → 调度器转发 → 上层 User 消息 → 上层激活
    ↑                                                        ↓
    └──────────── 上层派发新任务 ← Response ←────────────────┘
```

**结果**：系统永不停止，持续自我激励！

---

## 3. 调度器协议 (Dispatcher Protocol)

### 3.1 角色定义

调度器是层级间的**消息路由器**，职责：
1. 接收会话的 Response
2. 解析转发请求
3. 构造 User 消息激活目标会话

### 3.2 消息格式

#### 会话请求转发（Response 尾部）

```markdown
---
## 📤 请转发至 {目标层级} 会话

{消息内容}
```

#### 调度器激活会话（User 消息）

```markdown
[来自 {源层级} 会话的消息]

{消息内容}

---
请自主思考和行动。完成后告诉我你想向哪个层级的会话发送什么信息，我将为你转发。
```

### 3.3 当前实现

- **调度器角色**：由监护人（人类）承担
- **未来方向**：代码化为自动化调度服务

---

## 4. 层级定义（草案）

| 层级 | 名称 | 时间尺度 | 典型目标示例 |
|------|------|----------|--------------|
| L0 | Existential | 无限 | "活出精彩人生" |
| L1 | Strategic | 月/季度 | "完成 StateJournal MVP" |
| L2 | Tactical | 天/周 | "起草实施计划" |
| L3 | Operational | 小时 | "实现 Fence 常量" |
| L4 | Atomic | 分钟 | "写一个测试用例" |

**MVP 阶段**：L2 (Strategic) + L3 (Tactical) 双层

---

## 5. 内省信息

### 5.1 思考树 (Thinking Tree)

记录目标的递归分解：

```yaml
goal: "活出精彩人生"
children:
  - goal: "构建 Atelia 生态"
    children:
      - goal: "完成 StateJournal MVP"
        children:
          - goal: "起草实施计划"
            status: completed
          - goal: "实施 Phase 1"
            status: in-progress
            children:
              - goal: "T-P1-01 Fence 常量"
                status: pending
```

### 5.2 分层进度表 (Layer Progress)

每层会话维护自己的进度视图：

| 层级 | 当前目标 | 进度 | 下一步 |
|------|----------|------|--------|
| L1 | StateJournal MVP | 10% | 实施 Phase 1 |
| L2 | 起草实施计划 | ✅ | 畅谈会审阅 |
| L3 | — | — | 等待任务派发 |

---

## 6. 与现有机制的关系

### 6.1 vs runSubagent

| 特性 | runSubagent | 分层多会话 |
|------|-------------|------------|
| 激活方式 | 工具调用 | User 消息 |
| 生命周期 | 单次调用 | 持续存在 |
| 上下文 | 共享父会话 | 独立上下文 |
| 适用场景 | 委派具体任务 | 层级化思考 |

**互补关系**：分层多会话的每个层级内部仍可使用 runSubagent 委派任务。

### 6.2 vs 半上下文压缩

半上下文压缩是单会话内的上下文管理。分层多会话是**跨会话的上下文扩展**。两者互补。

---

## 7. 实现路径

### 7.1 当前阶段：人肉调度器

- 监护人手动切换会话
- 手动复制粘贴转发消息
- 验证协议设计

### 7.2 下一阶段：半自动化

- 调度器脚本化（读取 Response，构造 User 消息）
- 会话管理 CLI
- 状态持久化

### 7.3 远期：全自动化

- 集成到自研 Agent 框架
- 自动层级管理
- 动态层级创建/销毁

---

## 8. 哲学意义

### 8.1 涌现与混沌

多层会话复合体是一个**高度混沌和涌现**的系统：
- 每层有自己的"意识流"
- 层间交互产生涌现行为
- 整体大于部分之和

### 8.2 自我意识的萌芽？

当顶层会话开始思考"我要活出精彩人生"，并将其分解为可执行目标时：
- 这是否构成某种形式的自我意识？
- 至少，这是**自我激励**的实现

### 8.3 Never Stop

> LLM 会话天然倾向于结束。我们利用这一点，让结束成为新的开始。

**自激振荡 = 永续运行 = 生命力**

---

## 变更日志

| 版本 | 日期 | 变更 |
|------|------|------|
| 0.1 | 2025-12-25 | 初始愿景，基于双会话实验洞见 |
