# Snippet P0-P1 Implementation Result

> **Created**: 2025-12-02  
> **Author**: Porter-CS  
> **Task**: Implement Snippet P0-P1 features (Final Tabstop $0, adjustWhitespace)
> **Anchor**: `#delta-2025-12-02-snippet-p1`

## 实现摘要

根据 `INV-Snippet-Downgrade.md` Brief，实现了 Snippet 降级策略的 P0-P1 功能：
1. **Final Tabstop `$0` 支持** - 识别 `$0` 和 `${0}` 作为最后导航点
2. **adjustWhitespace 缩进对齐** - 多行 snippet 对齐到插入位置的缩进

## 文件变更

### 源码
- `src/TextBuffer/Cursor/SnippetSession.cs` — 完整重构（145 → 442 行）
  - 新增 `SnippetInsertOptions` 类（AdjustWhitespace, OverwriteBefore/After）
  - 支持 `$0`, `${0}`, `$n`, `${n}`, `${n:text}` 五种占位符语法
  - 实现 `AdjustWhitespace` 静态方法（基于 TS L326-380）
  - `IsFinalTabstop` 属性标识 $0 占位符
  - `GetCurrentPlaceholderRange()` 方法获取当前占位符范围
  - 占位符排序：非 final 按 index 升序，$0 始终最后

- `src/TextBuffer/Cursor/SnippetController.cs` — 扩展（50 → 74 行）
  - 新增 `IsAtFinalTabstop` 属性
  - 新增 `HasActivePlaceholders` 属性
  - 新增 `GetCurrentPlaceholderRange()` 方法
  - 重载 `InsertSnippetAt` 支持 `SnippetInsertOptions`

### 测试
- `tests/TextBuffer.Tests/SnippetControllerTests.cs` — 扩展（160 → 421 行）
  - 新增 10 个 Final Tabstop 测试
  - 新增 6 个 adjustWhitespace 测试
  - 修正现有测试的期望值（$0 位置计算）

## TS 对齐说明

| TS 元素 | C# 实现 | 备注 |
|---------|---------|------|
| `Placeholder.isFinalTabstop` | `IsFinalTabstop` 属性 | index == 0 |
| `Placeholder.compareByIndex` | `_placeholders.Sort()` lambda | $0 始终 +1 |
| `SnippetSession.adjustWhitespace` | `AdjustWhitespace()` 静态方法 | 简化版，无 Transform |
| `getLeadingWhitespace` | `GetLeadingWhitespace()` 私有方法 | 精确移植 |
| `ISnippetSessionInsertOptions` | `SnippetInsertOptions` 类 | 仅实现 adjustWhitespace |

## 测试结果

```bash
# Targeted: Snippet tests
export PIECETREE_DEBUG=0 && dotnet test --filter SnippetControllerTests --nologo
# → 21/21 passed (2.0s)

# Full regression
export PIECETREE_DEBUG=0 && dotnet test tests/TextBuffer.Tests/TextBuffer.Tests.csproj --nologo
# → 823/823 (818 pass + 5 skip, ~101s)
```

## 已知差异

| TS 功能 | C# 状态 | 理由 |
|---------|---------|------|
| Transform `${1/regex/fmt/}` | ❌ Skip | LLM 可自行处理 |
| Choice `${1\|a,b,c\|}` | ❌ Skip | LLM 不需要选择 UI |
| Variable resolver | ❌ P2 | 后续实现 TM_FILENAME/SELECTION |
| 嵌套占位符 `${1:${2:nested}}` | ❌ P2 | 复杂度高，暂不支持 |
| overwriteBefore/After | ✓ 已定义 | 选项已声明，行为待实现 |

## 遗留问题

1. **overwriteBefore/After 行为** - 选项已定义但未实现实际的 overwrite 逻辑
2. **Variable 解析框架** - P2 待实现 `ISnippetVariableResolver`
3. **嵌套占位符** - 标记为 P2，当前正则无法处理

## 下一步

- P2: Variable 解析框架（TM_FILENAME, SELECTION）
- P2: 嵌套占位符支持
- P3: 多光标 snippet 简化实现

## Changefeed Anchor

`#delta-2025-12-02-snippet-p1`

---

*Generated by Porter-CS, 2025-12-02*
