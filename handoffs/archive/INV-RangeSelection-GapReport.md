# INV-RangeSelection-GapReport
**Investigator:** Harper Lin  
**Date:** 2025-11-26  
**Scope:** `Range.Extensions.cs`, `Selection.cs`, `TextPosition.cs` compared with `ts/src/vs/editor/common/core/{range,selection,position}.ts`

## API Gap Table
| Function(s) | TS Semantics | C# Status | Notes / Impact | Priority |
| --- | --- | --- | --- | --- |
| `Range.containsPosition`, `Range.strictContainsPosition` | Inclusive / exclusive position checks (used by cursor, search, decorations) share identical comparison logic | Missing entirely; `Selection.Contains` duplicates partial logic but only for anchor-active range | `SearchRangeSet.FindContainingRange` (`src/TextBuffer/TextModelSearch.cs`) reimplements bounds; Cursor and DocUI have copy/paste comparisons, risking inconsistent edge handling | P0 |
| `Range.containsRange`, `Range.strictContainsRange` | Determines if one range fully or strictly nests another | Not implemented; callers compare line/column manually | DocUI find scopes (`BuildSearchScope` + `SearchRangeSet.MergeRanges`) cannot rely on canonical containment; overlapping scopes may be merged incorrectly | P0 |
| `Range.intersectRanges`, `Range.areIntersecting*` | Returns geometric intersection and touch/intersect booleans | Missing; `Range.Plus` exists but no counterpart for intersection or adjacency | `FindDecorations.MatchBeforePosition/MatchAfterPosition` scan every decoration because they cannot test intersection cheaply; decoration throttling and cursor merge logic stay bespoke | P0 |
| `Range.plusRange` (static) & normalized ctor | TS constructor swaps endpoints to guarantee `start <= end`; `plusRange` handles mixed line comparisons | C# record struct stores Start/End verbatim; only instance `Plus` helper, no normalization guard | Any caller that builds `new Range(end,start)` (e.g., `TextModel.GetValueInRangeInternal`) must reorder offsets manually; subtle bugs when callers forget to normalize | P0 |
| `Range.setStartPosition`, `setEndPosition`, `collapseToStart/End`, `delta`, `isSingleLine` | Cheap derivations without reallocating new TextPositions | Missing (only `IsEmpty` exists). `Selection` must new-up instances for every collapse | Cursor column select and DocUI scope shorthands duplicate these transforms, increasing allocations and diverging semantics from TS | P0 |
| `Range.compareRangesUsingStarts/Ends`, `equalsRange`, `spansMultipleLines` | Canonical comparers (null-safe) for sorting, equality, line-span predicates | Absent; record equality lacks null guards, no sorting helpers | `SearchRangeSet.MergeRanges` and `FindDecorations` implement bespoke sort logic; decoration ordering differs from TS when null ranges appear | P1 |
| `Selection.fromPositions`, `fromRange`, `createWithDirection`, `setStartPosition`, `setEndPosition`, `liftSelection` | Factory + orientation helpers keep anchor/active semantics aligned with Range | Constructors exist but no static factories or direction-aware setters; `Collapse*` only copies start/end | Cursor, Snippet, DocUI must recompute anchor/active order each time; features like `SelectionSeedMode.Multiple` cannot reuse TS helper semantics | P0 |
| `Selection.equalsSelection`, `Selection.selectionsEqual`, `Selection.selectionsArrEqual`, `Selection.isISelection` | Structural equality (null-safe, array-level) plus runtime type guards | None provided; equality falls back to record default and there is no interface for `ISelection` | `CursorCollection` + DocUI find rely on manual loops when comparing selections; multi-selection reconciliation diverges from TS logic called out in `docs/reports/alignment-audit/08-feature-tests.md` | P0 |
| `Selection.getPosition`, `getSelectionStart` (return `Position`) | Normalizes outputs to `Position` (line/column clamps) | `SelectionStart`/`End` return `TextPosition` but lack clamp; no `GetPosition()` alias | DocUI find/text-model callers must compensate for out-of-range anchors because helpers skip clamping or conversion | P1 |
| `TextPosition.with`, `TextPosition.delta`, `Position.isBefore*`, `Position.compare`, `Position.clone` | Provide safe 1-based arithmetic, bounds checking, and comparison utilities reused throughout VS Code | Only `CompareTo` + `<, <=, >=` operators exist; no delta/with helper or static comparisons | Cursor (`ValidatePosition`, `MoveUp/Down`) and DocUI convert via manual `Math.Clamp`, duplicating TS `Position` semantics and risking off-by-one issues noted in `docs/reports/alignment-audit/03-cursor.md` | P0 |

## Call-site Impact (Cursor / DocUI / Decorations)
- **Cursor –** `src/TextBuffer/Cursor/Cursor.cs` and `CursorColumns.cs` manually clamp lines/columns (`ValidatePosition`, `ColumnSelectTo`) and reconstruct selections because `TextPosition.delta/with` and `Selection.setStartPosition` do not exist. `CursorState` cannot serialize selection start kinds without `Selection.fromRange` and equality helpers, so multi-cursor merging (see `docs/reports/alignment-audit/03-cursor.md`) stays divergent from TS.
- **DocUI –** `src/TextBuffer/DocUI/DocUIFindController.cs` (`BuildSearchScope`, selection seeding) and `DocUI/FindUtilities.cs` duplicate single-line checks (`selection.SelectionStart.LineNumber == ...`) that should be `Range.isSingleLine`. `DocUI/FindDecorations.cs` re-implements range ordering in `MatchBeforePosition`/`MatchAfterPosition` because `Range.intersectRanges`/`compareRangesUsingStarts` are absent, which drives the audit finding in `03-cursor.md §Call-site parity`.
- **Decorations –** `src/TextBuffer/TextModel.cs` (`HighlightSearchMatches`, `GetLineDecorations`) and `src/TextBuffer/Rendering/MarkdownRenderer.cs` convert every `Range` to offsets and compare lines by hand to decide overlap with decorations. Without `Range.containsRange` or `Range.delta`, the decoration stack cannot reuse TS throttling logic (referenced in `docs/reports/alignment-audit/04-decorations.md`), and Markdown rendering markers drift in multi-line cases.

## Suggested Tests (tie-in to 07/08 audit items)
1. **`RangeExtensionsTests` (new)** – Deterministic coverage for `containsPosition/Range`, `intersectRanges`, `plusRange`, `delta`, and normalization edge cases (empty ranges, reversed inputs). Addresses the zero-coverage call-out in `docs/reports/alignment-audit/07-core-tests.md` ("Range/Selection helpers = 0% coverage").
2. **`SelectionParityTests` (extend `CursorTests`, `CursorMultiSelectionTests`)** – Add cases for `Selection.createWithDirection`, `setStartPosition`, and array equality to replace bespoke comparisons flagged in `docs/reports/alignment-audit/08-feature-tests.md` under "Cursor / Selection – ❌Gap".
3. **`DocUIFindControllerTests` additions** – Reuse new helpers to validate scoped find merge/containment (multi-selection, empty scope collapse) matching TS `findController.test.ts` Test07/08, fulfilling the DocUI backlog from `08-feature-tests.md`.
4. **`DecorationTests.HighlightSearchMatches`** – Cover multi-line search decorations and Markdown renderer markers using `Range.areIntersectingOrTouching` once available, aligning with the performance risks noted in `docs/reports/alignment-audit/04-decorations.md` and the test deficit recorded in `07-core-tests.md`.

*Word count: ~780 (≤1,200).*